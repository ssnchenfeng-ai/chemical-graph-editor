This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
public/
  demo-editor.png
  demo-graph.png
  vite.svg
src/
  assets/
    react.svg
  components/
    DevTools/
      AttributeDesigner.tsx
      ShapeDesigner.tsx
    Editor/
      Canvas/
        index.css
        index.tsx
      ContextMenu/
        index.css
        index.tsx
      Inspector/
        index.tsx
      Toolbar/
        index.css
        index.tsx
  config/
    rules.ts
  graph/
    cells/
      data/
        p-e101.json
        p-e13.json
        p-p101.json
        p-r101.json
        p-tappingpoint.json
        p-tee.json
        p-trap.json
        p-tvtrap.json
      svgs/
        cv-electric.svg
        cv-manual.svg
        cv-piston.svg
        cv-pneumatic.svg
        cv-positioner.svg
        cv-solenoid.svg
        E-13.svg
        exchanger-vertical.svg
        exchanger.svg
        frame-a2.svg
        gas-cooler.svg
        inst-local.svg
        inst-panel.svg
        inst-remote.svg
        p-e101.svg
        p-e13.svg
        p-p101.svg
        p-r101.svg
        p-tappingpoint.svg
        p-tee.svg
        p-trap.svg
        p-tvtrap.svg
        pump-centrifugal.svg
        pump-compressor.svg
        pump-diaphragm.svg
        pump-fan.svg
        pump-gear.svg
        pump-general.svg
        pump-jet.svg
        pump-liquid.svg
        pump-piston.svg
        reactor-fixed-bed.svg
        reactor.svg
        tank-horizontal.svg
        tank-vertical.svg
        tee.svg
        tower-packing.svg
        trap.svg
        tv-Trap.svg
      icons.ts
      registry.ts
  services/
    neo4j.ts
  App.css
  App.tsx
  index.css
  main.tsx
.env.example
.gitignore
eslint.config.js
index.html
LICENSE
package.json
README.md
tsconfig.app.json
tsconfig.json
tsconfig.node.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/graph/cells/data/p-e101.json">
{
  "width": 340,
  "height": 120,
  "ports": {
    "groups": {
      "shell": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      },
      "tube_left": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      },
      "tube_right": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      }
    },
    "items": [
      {
        "id": "n1",
        "group": "shell",
        "args": {
          "x": "35%",
          "y": "0%"
        },
        "data": {
          "desc": "壳程入口(N1)",
          "region": "ShellSide",
          "dir": "in"
        }
      },
      {
        "id": "n2",
        "group": "shell",
        "args": {
          "x": "75%",
          "y": "100%"
        },
        "data": {
          "desc": "壳程出口(N2)",
          "region": "ShellSide",
          "dir": "out"
        }
      },
      {
        "id": "n3",
        "group": "tube_left",
        "args": {
          "x": "0%",
          "y": "67.5%"
        },
        "data": {
          "desc": "管程入口(N3)",
          "region": "TubeSide",
          "dir": "in"
        }
      },
      {
        "id": "n4",
        "group": "tube_left",
        "args": {
          "x": "0%",
          "y": "32.5%"
        },
        "data": {
          "desc": "管程出口(N4)",
          "region": "TubeSide",
          "dir": "out"
        }
      },
      {
        "id": "n5",
        "group": "tube_right",
        "args": {
          "x": "98%",
          "y": "12%"
        },
        "data": {
          "desc": "放空(N5)",
          "region": "ShellSide",
          "dir": "out"
        }
      },
      {
        "id": "n6",
        "group": "tube_right",
        "args": {
          "x": "98%",
          "y": "88%"
        },
        "data": {
          "desc": "排净(N6)",
          "region": "ShellSide",
          "dir": "out"
        }
      }
    ]
  },
  "data": {
    "type": "Exchanger",
    "tag": "E-101",
    "spec": "Spec..."
  }
}
</file>

<file path="src/graph/cells/data/p-e13.json">
{
  "width": 1000,
  "height": 450,
  "ports": {
    "groups": {
      "top": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      },
      "left": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      },
      "bottom": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      },
      "heater": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      }
    },
    "items": [
      {
        "id": "t1",
        "group": "top",
        "args": {
          "x": "22%",
          "y": "1.1%"
        },
        "data": {
          "desc": "顶部接口-1",
          "region": "ShellSide:Vapor",
          "dir": "bi"
        }
      },
      {
        "id": "t2",
        "group": "top",
        "args": {
          "x": "34%",
          "y": "1.1%"
        },
        "data": {
          "desc": "顶部接口-2",
          "region": "ShellSide:Vapor",
          "dir": "bi"
        }
      },
      {
        "id": "t3",
        "group": "top",
        "args": {
          "x": "46%",
          "y": "1.1%"
        },
        "data": {
          "desc": "顶部接口-3",
          "region": "ShellSide:Vapor",
          "dir": "bi"
        }
      },
      {
        "id": "t4",
        "group": "top",
        "args": {
          "x": "58%",
          "y": "1.1%"
        },
        "data": {
          "desc": "顶部接口-4",
          "region": "ShellSide:Vapor",
          "dir": "bi"
        }
      },
      {
        "id": "l1",
        "group": "left",
        "args": {
          "x": "3%",
          "y": "17.7%"
        },
        "data": {
          "desc": "左侧接口-1(上)",
          "region": "ShellSide:Vapor",
          "dir": "in"
        }
      },
      {
        "id": "l2",
        "group": "left",
        "args": {
          "x": "3%",
          "y": "31.1%"
        },
        "data": {
          "desc": "左侧接口-2(上)",
          "region": "ShellSide:Vapor",
          "dir": "in"
        }
      },
      {
        "id": "l3",
        "group": "left",
        "args": {
          "x": "3%",
          "y": "44.4%"
        },
        "data": {
          "desc": "左侧接口-3(中上)",
          "region": "ShellSide:Vapor",
          "dir": "in"
        }
      },
      {
        "id": "b1",
        "group": "bottom",
        "args": {
          "x": "22%",
          "y": "98.9%"
        },
        "data": {
          "desc": "底部接口-1",
          "region": "ShellSide:Liquid",
          "dir": "bi"
        }
      },
      {
        "id": "b2",
        "group": "bottom",
        "args": {
          "x": "34%",
          "y": "98.9%"
        },
        "data": {
          "desc": "底部接口-2",
          "region": "ShellSide:Liquid",
          "dir": "bi"
        }
      },
      {
        "id": "b3",
        "group": "bottom",
        "args": {
          "x": "46%",
          "y": "98.9%"
        },
        "data": {
          "desc": "底部接口-3",
          "region": "ShellSide:Liquid",
          "dir": "bi"
        }
      },
      {
        "id": "b4",
        "group": "bottom",
        "args": {
          "x": "58%",
          "y": "98.9%"
        },
        "data": {
          "desc": "底部接口-4",
          "region": "ShellSide:Liquid",
          "dir": "bi"
        }
      },
      {
        "id": "l4",
        "group": "left",
        "args": {
          "x": "3%",
          "y": "57.7%"
        },
        "data": {
          "desc": "左侧接口-4(中下)",
          "region": "ShellSide:Liquid",
          "dir": "in"
        }
      },
      {
        "id": "l5",
        "group": "left",
        "args": {
          "x": "3%",
          "y": "71.1%"
        },
        "data": {
          "desc": "左侧接口-5(下)",
          "region": "ShellSide:Liquid",
          "dir": "in"
        }
      },
      {
        "id": "l6",
        "group": "left",
        "args": {
          "x": "3%",
          "y": "84.4%"
        },
        "data": {
          "desc": "左侧接口-6(下)",
          "region": "ShellSide:Liquid",
          "dir": "in"
        }
      },
      {
        "id": "h_in",
        "group": "heater",
        "args": {
          "x": "83%",
          "y": "51.1%"
        },
        "data": {
          "desc": "蒸汽入口",
          "region": "TubeSide",
          "dir": "in"
        }
      },
      {
        "id": "h_out",
        "group": "heater",
        "args": {
          "x": "83%",
          "y": "93.3%"
        },
        "data": {
          "desc": "冷凝水出口",
          "region": "TubeSide",
          "dir": "out"
        }
      }
    ]
  },
  "data": {
    "type": "Evaporator",
    "tag": "E-13",
    "spec": "Spec..."
  }
}
</file>

<file path="src/graph/cells/data/p-p101.json">
{
  "width": 100,
  "height": 100,
  "ports": {
    "groups": {
      "in": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      },
      "out": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      }
    },
    "items": [
      {
        "id": "in",
        "group": "in",
        "args": {
          "x": "50%",
          "y": "100%"
        },
        "data": {
          "desc": "泵入口",
          "region": "ShellSide",
          "dir": "in"
        }
      },
      {
        "id": "out",
        "group": "out",
        "args": {
          "x": "50%",
          "y": "0%"
        },
        "data": {
          "desc": "泵出口",
          "region": "ShellSide",
          "dir": "out"
        }
      }
    ]
  },
  "data": {
    "type": "CentrifugalPump",
    "tag": "P-101",
    "spec": "Spec..."
  }
}
</file>

<file path="src/graph/cells/data/p-r101.json">
{
  "width": 80,
  "height": 120,
  "ports": {
    "groups": {
      "top": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      },
      "left_side": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      },
      "right_side": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      },
      "jacket": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      },
      "bottom": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      }
    },
    "items": [
      {
        "id": "n1",
        "group": "top",
        "args": {
          "x": "15%",
          "y": "0%"
        },
        "data": {
          "desc": "釜顶接口N1",
          "region": "InnerVessel",
          "dir": "bi"
        }
      },
      {
        "id": "n2",
        "group": "top",
        "args": {
          "x": "30%",
          "y": "0%"
        },
        "data": {
          "desc": "釜顶接口N2",
          "region": "InnerVessel",
          "dir": "bi"
        }
      },
      {
        "id": "n3",
        "group": "top",
        "args": {
          "x": "70%",
          "y": "0%"
        },
        "data": {
          "desc": "釜顶接口N3",
          "region": "InnerVessel",
          "dir": "bi"
        }
      },
      {
        "id": "n4",
        "group": "top",
        "args": {
          "x": "85%",
          "y": "0%"
        },
        "data": {
          "desc": "釜顶接口N4",
          "region": "InnerVessel",
          "dir": "bi"
        }
      },
      {
        "id": "feed_in",
        "group": "left_side",
        "args": {
          "x": "0%",
          "y": "30%"
        },
        "data": {
          "desc": "进料口",
          "region": "InnerVessel",
          "dir": "in"
        }
      },
      {
        "id": "overflow",
        "group": "right_side",
        "args": {
          "x": "100%",
          "y": "30%"
        },
        "data": {
          "desc": "溢流口",
          "region": "InnerVessel",
          "dir": "out"
        }
      },
      {
        "id": "j_in",
        "group": "jacket",
        "args": {
          "x": "0%",
          "y": "45%"
        },
        "data": {
          "desc": "半管夹套入口",
          "region": "Jacket",
          "dir": "in"
        }
      },
      {
        "id": "j_out",
        "group": "jacket",
        "args": {
          "x": "100%",
          "y": "75%"
        },
        "data": {
          "desc": "半管夹套出口",
          "region": "Jacket",
          "dir": "out"
        }
      },
      {
        "id": "discharge",
        "group": "bottom",
        "args": {
          "x": "50%",
          "y": "100%"
        },
        "data": {
          "desc": "釜底出料口",
          "region": "InnerVessel",
          "dir": "out"
        }
      },
      {
        "id": "temp_point",
        "group": "bottom",
        "args": {
          "x": "25%",
          "y": "92%"
        },
        "data": {
          "desc": "釜底温度口",
          "region": "InnerVessel",
          "dir": "bi"
        }
      }
    ]
  },
  "data": {
    "type": "Reactor",
    "tag": "R-101",
    "spec": "Spec..."
  }
}
</file>

<file path="src/graph/cells/data/p-tappingpoint.json">
{
  "width": 12,
  "height": 12,
  "ports": {
    "groups": {},
    "items": []
  },
  "data": {
    "type": "TappingPoint",
    "tag": "TAPPING-POINT",
    "spec": "Spec..."
  }
}
</file>

<file path="src/graph/cells/data/p-tee.json">
{
  "width": 20,
  "height": 20,
  "ports": {
    "groups": {
      "all": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      }
    },
    "items": [
      {
        "id": "p1",
        "group": "all",
        "args": {
          "x": "0%",
          "y": "50%"
        },
        "data": {
          "desc": "三通接口-1",
          "region": "ShellSide",
          "dir": "bi"
        }
      },
      {
        "id": "p2",
        "group": "all",
        "args": {
          "x": "100%",
          "y": "50%"
        },
        "data": {
          "desc": "三通接口-2",
          "region": "ShellSide",
          "dir": "bi"
        }
      },
      {
        "id": "p3",
        "group": "all",
        "args": {
          "x": "50%",
          "y": "100%"
        },
        "data": {
          "desc": "三通接口-3",
          "region": "ShellSide",
          "dir": "bi"
        }
      }
    ]
  },
  "data": {
    "type": "Fitting",
    "tag": "TEE",
    "spec": "Spec..."
  }
}
</file>

<file path="src/graph/cells/data/p-trap.json">
{
  "width": 120,
  "height": 100,
  "ports": {
    "groups": {
      "top_in": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      },
      "top_out": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      },
      "side": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      }
    },
    "items": [
      {
        "id": "n1",
        "group": "top_in",
        "args": {
          "x": "73.3%",
          "y": "10%"
        },
        "data": {
          "desc": "入口(N1)",
          "region": "ShellSide",
          "dir": "in"
        }
      },
      {
        "id": "n2",
        "group": "top_out",
        "args": {
          "x": "31.6%",
          "y": "10%"
        },
        "data": {
          "desc": "出口(N2)",
          "region": "ShellSide",
          "dir": "out"
        }
      },
      {
        "id": "m1",
        "group": "side",
        "args": {
          "x": "8.3%",
          "y": "56%"
        },
        "data": {
          "desc": "排净/人孔(M1)",
          "region": "ShellSide",
          "dir": "bi"
        }
      }
    ]
  },
  "data": {
    "type": "Trap",
    "tag": "TRAP",
    "spec": "Spec..."
  }
}
</file>

<file path="src/graph/cells/data/p-tvtrap.json">
{
  "width": 250,
  "height": 100,
  "ports": {
    "groups": {
      "all": {
        "position": "absolute",
        "attrs": {
          "circle": {
            "r": 3,
            "magnet": true,
            "stroke": "#FFFFFF",
            "strokeWidth": 1,
            "fill": "#e3dedeff"
          }
        }
      }
    },
    "items": [
      {
        "id": "i",
        "group": "all",
        "args": {
          "x": "0%",
          "y": "49%"
        },
        "data": {
          "desc": "新接口",
          "region": "ShellSide",
          "dir": "bi"
        }
      },
      {
        "id": "o",
        "group": "all",
        "args": {
          "x": "100%",
          "y": "49%"
        },
        "data": {
          "desc": "新接口",
          "region": "ShellSide",
          "dir": "bi"
        }
      }
    ]
  },
  "data": {
    "type": "Trap",
    "tag": "tv-Trap",
    "spec": "Spec..."
  }
}
</file>

<file path="src/graph/cells/svgs/p-e101.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="-20 0 340 120" fill="none" stroke="black" stroke-width="2" style="background-color:transparent">
  <!-- 
     修正策略：调整绘制顺序 (Painter's Algorithm)
     1. 先画筒体 (白色背景)
     2. 再画内部管束 (叠在筒体上)
     3. 再画两端法兰和封头 (叠在最上层以遮挡多余线条)
  -->

  <!-- 1. 主筒体 (Shell) - 移到最前，作为底图 -->
  <rect x="50" y="20" width="230" height="80" fill="white" stroke-width="2" />

  <!-- 2. 内部管束 (Tubes) - 现在会显示在白色筒体之上 -->
  <g stroke="#333" stroke-width="1">
    <line x1="50" y1="30" x2="280" y2="30" />
    <line x1="50" y1="40" x2="280" y2="40" />
    <line x1="50" y1="50" x2="280" y2="50" />
    <line x1="50" y1="60" x2="280" y2="60" /> <!-- 中心线 -->
    <line x1="50" y1="70" x2="280" y2="70" />
    <line x1="50" y1="80" x2="280" y2="80" />
    <line x1="50" y1="90" x2="280" y2="90" />
  </g>

  <!-- 3. 左侧结构 (管箱 + 隔板) -->
  <!-- 左法兰 (直径90) -->
  <rect x="45" y="15" width="5" height="90" fill="white" />
  
  <!-- 左封头 (加长型) -->
  <path d="M45 20 C -5 20, -5 100, 45 100" fill="white" />
  
  <!-- 隔板 (虚线，画在封头之上) -->
  <line x1="45" y1="60" x2="5" y2="60" stroke-width="2" stroke-dasharray="4,2" />

  <!-- 4. 右侧结构 -->
  <!-- 右法兰 (直径90) -->
  <rect x="280" y="15" width="5" height="90" fill="white" />
  <!-- 右封头 -->
  <path d="M285 20 C 315 20, 315 100, 285 100" fill="white" />

  <!-- 5. 管口 (Nozzles) -->
  
  <!-- N1: 壳程入口 (上) -->
  <line x1="95" y1="20" x2="95" y2="5" stroke-width="2"/>
  <line x1="90" y1="5" x2="100" y2="5" stroke-width="2"/>

  <!-- N2: 壳程出口 (下) -->
  <line x1="235" y1="100" x2="235" y2="115" stroke-width="2"/>
  <line x1="230" y1="115" x2="240" y2="115" stroke-width="2"/>

  <!-- N4: 管程出口 (左上 - 位于隔板上方) -->
  <line x1="8" y1="35" x2="-15" y2="35" stroke-width="2"/>
  <line x1="-15" y1="30" x2="-15" y2="40" stroke-width="2"/>

  <!-- N3: 管程入口 (左下 - 位于隔板下方) -->
  <line x1="8" y1="85" x2="-15" y2="85" stroke-width="2"/>
  <line x1="-15" y1="80" x2="-15" y2="90" stroke-width="2"/>

  <!-- N5: 放空 (右上) -->
  <line x1="303" y1="23" x2="310" y2="15" stroke-width="2"/>
  <line x1="307" y1="12" x2="313" y2="18" stroke-width="2"/>

  <!-- N6: 排净 (右下) -->
  <line x1="303" y1="97" x2="310" y2="105" stroke-width="2"/>
  <line x1="307" y1="108" x2="313" y2="102" stroke-width="2"/>
</svg>
</file>

<file path="src/graph/cells/svgs/p-e13.svg">
<svg xmlns="http://www.w3.org/2000/svg" width="1000" height="450" viewBox="0 0 1000 450" fill="none" stroke="black" stroke-width="2">
  <defs>
    <!-- 定义主罐体轮廓路径 (左侧封头已镜像为向外凸) -->
    <path id="vessel-body" d="M100,25 L700,25 A50,200 0 0,1 700,425 L100,425 A50,200 0 0,1 100,25 Z" />
    
    <!-- 定义液位剪切蒙版 -->
    <clipPath id="liquid-clip">
      <use href="#vessel-body" />
    </clipPath>
  </defs>

  <g>
    <!-- 1. 右侧加热器 (Heater) - 底层 -->
    <rect x="500" y="250" width="310" height="150" fill="white" stroke="#000000" stroke-width="2"/>
    <line x1="810" y1="245" x2="810" y2="405" stroke-width="4" />
    <rect x="810" y="250" width="40" height="150" fill="white" stroke="#000000" stroke-width="2"/>
    <path d="M850,250 A40,75 0 0,1 850,400" fill="white" stroke="#000000" stroke-width="2"/>
    <line x1="810" y1="325" x2="890" y2="325" stroke-width="2" />
    
    <g stroke="#000000" stroke-width="1" opacity="0.6">
      <line x1="510" y1="270" x2="810" y2="270" />
      <line x1="510" y1="290" x2="810" y2="290" />
      <line x1="510" y1="310" x2="810" y2="310" />
      <line x1="510" y1="330" x2="810" y2="330" />
      <line x1="510" y1="350" x2="810" y2="350" />
      <line x1="510" y1="370" x2="810" y2="370" />
    </g>

    <!-- 2. 主罐体 (Main Vessel) - 顶层覆盖 -->
    
    <!-- 2.1 罐体背景 -->
    <use href="#vessel-body" fill="white" stroke="none" />
    
    <!-- 2.2 液相示意 (淡蓝色填充) -->
    <!-- 修改：y=225 (即 50% 高度) -->
    <rect x="0" y="225" width="800" height="300" fill="#e6f7ff" stroke="none" clip-path="url(#liquid-clip)" />
    
    <!-- 2.3 液面线 -->
    <!-- 修改：y1=225, y2=225 -->
    <line x1="50" y1="225" x2="750" y2="225" stroke="#1890ff" stroke-width="1" stroke-dasharray="4 2" clip-path="url(#liquid-clip)" />

    <!-- 2.4 罐体轮廓描边 -->
    <use href="#vessel-body" fill="none" stroke="black" stroke-width="2" />
  </g>
</svg>
</file>

<file path="src/graph/cells/svgs/p-p101.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <circle cx="50" cy="50" r="48" fill="white" />
  <path d="M 4 50 L 50 4 L 96 50" stroke-linejoin="round" />
  <!-- 中心垂直线 -->
  <line x1="50" y1="4" x2="50" y2="98" />
</svg>
</file>

<file path="src/graph/cells/svgs/p-r101.svg">
<svg viewBox="0 0 80 120" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="black" stroke-width="1.5">
  
  <!-- 1. 半管夹套 (Limpet Coil) -->
  <!-- 左侧半管组 -->
  <!-- 最上方半管 (入口) - 顶点在 x=6 -->
  <path d="M10,50 A4,4 0 0,0 10,58" fill="none"/> 
  <!-- 左侧入口连接线 (Jacket In) - 外接半圆顶点 -->
  <line x1="0" y1="54" x2="6" y2="54" stroke-width="2"/>
  
  <!-- 左侧其余半管 -->
  <path d="M10,62 A4,4 0 0,0 10,70" fill="none"/>
  <path d="M10,74 A4,4 0 0,0 10,82" fill="none"/>
  <path d="M10,86 A4,4 0 0,0 10,94" fill="none"/>

  <!-- 右侧半管组 -->
  <path d="M70,50 A4,4 0 0,1 70,58" fill="none"/>
  <path d="M70,62 A4,4 0 0,1 70,70" fill="none"/>
  <path d="M70,74 A4,4 0 0,1 70,82" fill="none"/>
  
  <!-- 最下方半管 (出口) - 顶点在 x=74 -->
  <path d="M70,86 A4,4 0 0,1 70,94" fill="none"/>
  <!-- 右侧出口连接线 (Jacket Out) - 外接半圆顶点 -->
  <line x1="74" y1="90" x2="80" y2="90" stroke-width="2"/>

  <!-- 2. 釜体 (Main Vessel) -->
  <path d="M10,30 Q40,10 70,30 L70,100 Q40,120 10,100 Z" fill="white" stroke="black" stroke-width="2"/>

  <!-- 3. 搅拌系统 (Agitator) -->
  <!-- 电机 (M) - 位于正中，半径8，占据 x=32~48 -->
  <circle cx="40" cy="5" r="8" fill="white" stroke="black" stroke-width="1.5"/>
  <text x="40" y="8" font-family="Arial" font-size="10" text-anchor="middle" fill="black" stroke="none">M</text>
  
  <!-- 搅拌轴 -->
  <line x1="40" y1="13" x2="40" y2="85" stroke="black" stroke-width="1.5"/>
  
  <!-- 桨叶 (Paddle) -->
  <rect x="20" y="85" width="40" height="10" fill="white" stroke="black" stroke-width="1.5"/>
  <line x1="20" y1="85" x2="60" y2="95" stroke="black" stroke-width="1"/>
  <line x1="20" y1="95" x2="60" y2="85" stroke="black" stroke-width="1"/>

  <!-- 4. 顶部连接桩 (Top Nozzles) -->
  <!-- 避开电机区域 (32-48)，向两侧分布 -->
  
  <!-- N1 (x=12) -->
  <line x1="12" y1="22" x2="12" y2="5" stroke-width="2"/>
  <line x1="9" y1="5" x2="15" y2="5" stroke-width="2"/> <!-- 法兰 -->

  <!-- N2 (x=24) - 距离电机有一定间隙 -->
  <line x1="24" y1="18" x2="24" y2="5" stroke-width="2"/>
  <line x1="21" y1="5" x2="27" y2="5" stroke-width="2"/>

  <!-- N3 (x=56) -->
  <line x1="56" y1="18" x2="56" y2="5" stroke-width="2"/>
  <line x1="53" y1="5" x2="59" y2="5" stroke-width="2"/>

  <!-- N4 (x=68) -->
  <line x1="68" y1="22" x2="68" y2="5" stroke-width="2"/>
  <line x1="65" y1="5" x2="71" y2="5" stroke-width="2"/>

  <!-- 5. 侧面工艺接口 -->
  
  <!-- 进料口 (Feed In) - 下移至 y=35 (连接在直筒体上) -->
  <line x1="0" y1="35" x2="10" y2="35" stroke-width="2"/>
  <!-- 纯直线，无法兰短线 -->

  <!-- 溢流口 (Overflow) - 右侧 y=35 (与进料口水平或略低，这里设为同高对称) -->
  <line x1="70" y1="35" x2="80" y2="35" stroke-width="2"/>
  
  <!-- 插底管 (Dip Pipe) -->
  <polyline points="70,35 62,35 62,95" fill="none" stroke="black" stroke-width="1" stroke-dasharray="3 2"/>

  <!-- 6. 底部出料口 -->
  <line x1="40" y1="110" x2="40" y2="120" stroke-width="2"/>
  <line x1="36" y1="120" x2="44" y2="120" stroke-width="2"/>

  <!-- 7. 内部挡板/套管 -->
  <line x1="65" y1="35" x2="65" y2="90" stroke="black" stroke-width="1"/>

</svg>
</file>

<file path="src/graph/cells/svgs/p-tappingpoint.svg">
<svg viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="black" stroke-width="2">
  <rect x="10" y="10" width="180" height="80" rx="20" ry="20" fill="white" />
  <line x1="10" y1="50" x2="190" y2="50" stroke="#1890ff" stroke-dasharray="4 2" />
</svg>
</file>

<file path="src/graph/cells/svgs/p-tee.svg">
<svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
  <!-- 20x20 画布，中心点在 10 -->
  <path d="M0 10 H20 M10 10 V20" stroke="black" stroke-width="2" stroke-linecap="butt" stroke-linejoin="round"/>
</svg>
</file>

<file path="src/graph/cells/svgs/p-trap.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 100" fill="none" stroke="black" stroke-width="2">
  <!-- 主罐体 -->
  <rect x="20" y="30" width="90" height="60" fill="white" />

  <!-- 内部挡板 -->
  <!-- 右侧挡板：从上往下 -->
  <line x1="75" y1="30" x2="75" y2="75" />
  <!-- 左侧挡板：从下往上 -->
  <line x1="50" y1="90" x2="50" y2="45" />

  <!-- N1: 入口连接桩 (右上) - 已移除文字，增加法兰盖 -->
  <line x1="85" y1="30" x2="85" y2="10" />
  <line x1="91" y1="30" x2="91" y2="10" />
  <!-- N1 法兰 -->
  <line x1="82" y1="10" x2="94" y2="10" />

  <!-- N2: 出口连接桩 (左上) - 已移除文字，增加法兰盖 -->
  <line x1="35" y1="30" x2="35" y2="10" />
  <line x1="41" y1="30" x2="41" y2="10" />
  <!-- N2 法兰 -->
  <line x1="32" y1="10" x2="44" y2="10" />

  <!-- M1: 侧口 (左侧) - 保持不变 -->
  <line x1="20" y1="50" x2="10" y2="50" />
  <line x1="20" y1="62" x2="10" y2="62" />
  <line x1="10" y1="46" x2="10" y2="66" />
  <text x="5" y="60" text-anchor="end" font-family="Arial" font-size="12" stroke="none" fill="black" font-weight="bold">M1</text>
</svg>
</file>

<file path="src/graph/cells/svgs/p-tvtrap.svg">
<svg width="250" height="100" viewBox="12.15 7.4 26 10.4" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
  <path style="fill:none;fill-opacity:1;stroke:#000;stroke-width:.15;stroke-dasharray:none;stroke-opacity:1;paint-order:markers fill stroke" d="M17.517 7.606h5.175M37.476 7.607h5.175" transform="translate(-4.948 4.884)"/>
  <g transform="matrix(.19762 0 0 .19762 20.262 7.575)" stroke="#000" pointer-events="all">
    <circle cx="25.25" cy="25.25" fill="#fff" r="25.248" style="fill:none"/>
    <path d="M43.12 7.37c9.88 9.87 9.88 25.88 0 35.75-9.87 9.88-25.88 9.88-35.75 0Z" stroke-miterlimit="10"/>
  </g>
</svg>
</file>

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="src/assets/react.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
</file>

<file path="src/components/DevTools/AttributeDesigner.tsx">
import React, { useState, useEffect } from 'react';
import { Layout, Form, Input, Select, InputNumber, Typography, Button, Card, Row, Col, Tabs, message, Divider } from 'antd';
import { CopyOutlined, CodeOutlined, SettingOutlined, ExperimentOutlined, ThunderboltOutlined, FilterOutlined } from '@ant-design/icons';

const { Content, Sider } = Layout;
const { Title, Paragraph } = Typography;
const { Option } = Select;
const { TabPane } = Tabs;
const { TextArea } = Input; // 确保这一行存在

// ============================================================================
// 1. 属性模式定义 (Schema Definition)
//    定义不同设备类型拥有的特有属性字段
// ============================================================================

const COMMON_FIELDS = [
  { name: 'tag', label: '位号 (Tag)', type: 'string', default: 'New-Tag' },
  { name: 'desc', label: '描述 (Description)', type: 'string', default: '' },
  { name: 'spec', label: '规格型号 (Spec)', type: 'string', default: '' },
];

const EQUIPMENT_SCHEMAS: Record<string, any> = {
  'Pump': {
    label: '泵类设备 (Pump)',
    icon: <ThunderboltOutlined />,
    fields: [
      { name: 'flow', label: '流量 (Flow)', unit: 'm³/h', type: 'number', default: 50 },
      { name: 'head', label: '扬程 (Head)', unit: 'm', type: 'number', default: 30 },
      { name: 'power', label: '电机功率 (Power)', unit: 'kW', type: 'string', default: '15kW' },
      { name: 'material', label: '泵体材质', type: 'select', options: ['CastIron', 'CS', 'SS304', 'SS316L', 'Duplex'] },
      { name: 'sealType', label: '密封形式', type: 'select', options: ['Mechanical', 'Packing', 'Magnetic'] },
    ]
  },
  'Trap': {
    label: '疏水阀 (Steam Trap)',
    icon: <FilterOutlined />,
    fields: [
      { name: 'trapType', label: '疏水阀类型', type: 'select', options: [
        { val: 'Thermodynamic', label: '热动力式 (圆盘)' },
        { val: 'BallFloat', label: '浮球式' },
        { val: 'InvertedBucket', label: '倒吊桶式' },
        { val: 'Thermostatic', label: '热静力式 (波纹管)' },
        { val: 'Bimetallic', label: '双金属片式' }
      ]},
      { name: 'size', label: '接口尺寸', type: 'select', options: ['DN15', 'DN20', 'DN25', 'DN32', 'DN40', 'DN50'] },
      { name: 'maxPressure', label: '最大允许压力 (PMA)', unit: 'MPa', type: 'number', default: 1.6 },
      { name: 'dischargeCapacity', label: '排水量', unit: 'kg/h', type: 'number', default: 500 },
      { name: 'connection', label: '连接方式', type: 'select', options: ['Flange', 'Thread', 'SocketWeld'] },
    ]
  },
  'Vessel': {
    label: '容器/储罐 (Vessel)',
    icon: <ExperimentOutlined />,
    fields: [
      { name: 'volume', label: '容积 (Volume)', unit: 'm³', type: 'number', default: 10 },
      { name: 'designPressure', label: '设计压力', unit: 'MPa', type: 'number', default: 0.6 },
      { name: 'designTemp', label: '设计温度', unit: '℃', type: 'number', default: 150 },
      { name: 'material', label: '主体材质', type: 'select', options: ['Q235B', 'Q345R', 'S30408', 'S31603', 'Ti'] },
      { name: 'insulation', label: '保温类型', type: 'select', options: ['None', 'RockWool', 'Perlite', 'PU'] },
    ]
  },
  'Exchanger': {
    label: '换热器 (Exchanger)',
    icon: <ExperimentOutlined />,
    fields: [
      { name: 'area', label: '换热面积', unit: '㎡', type: 'number', default: 50 },
      { name: 'type', label: '结构类型', type: 'select', options: ['FixedTubeSheet', 'U-Tube', 'FloatingHead', 'Plate'] },
      { name: 'shellPress', label: '壳程压力', unit: 'MPa', type: 'number', default: 1.6 },
      { name: 'tubePress', label: '管程压力', unit: 'MPa', type: 'number', default: 1.0 },
      { name: 'material', label: '材质(壳/管)', type: 'string', default: 'CS/SS304' },
    ]
  },
  'ControlValve': {
    label: '控制阀 (Control Valve)',
    icon: <SettingOutlined />,
    fields: [
      { name: 'size', label: '阀门尺寸', type: 'select', options: ['DN25', 'DN40', 'DN50', 'DN80', 'DN100', 'DN150'] },
      { name: 'cv', label: '流量系数 (Cv/Kv)', type: 'number', default: 60 },
      { name: 'failPos', label: '故障位置', type: 'select', options: [
        { val: 'FC', label: '气开 (FC/Fail Close)' },
        { val: 'FO', label: '气关 (FO/Fail Open)' },
        { val: 'FL', label: '保位 (FL/Fail Last)' }
      ]},
      { name: 'class', label: '压力等级', type: 'select', options: ['PN16', 'PN40', 'PN63', 'CL150', 'CL300', 'CL600'] },
      { name: 'actuator', label: '执行机构', type: 'select', options: ['Diaphragm', 'Piston', 'Electric'] },
    ]
  },
  'ManualValve': {
    label: '手动阀 (Manual Valve)',
    icon: <SettingOutlined />,
    fields: [
      { name: 'valveType', label: '阀门类型', type: 'select', options: ['Gate', 'Globe', 'Ball', 'Butterfly', 'Check'] },
      { name: 'size', label: '尺寸', type: 'select', options: ['DN15', 'DN25', 'DN50', 'DN80', 'DN100'] },
      { name: 'class', label: '压力等级', type: 'select', options: ['PN16', 'PN25', 'PN40', 'CL150'] },
      { name: 'material', label: '阀体材质', type: 'select', options: ['WCB', 'CF8', 'CF8M', 'CastIron'] },
    ]
  }
};

const AttributeDesigner: React.FC = () => {
  const [selectedType, setSelectedType] = useState('Pump');
  const [form] = Form.useForm();
  const [formData, setFormData] = useState<any>({});

  // 初始化表单默认值
  useEffect(() => {
    const schema = EQUIPMENT_SCHEMAS[selectedType];
    const initialValues: any = { type: selectedType };
    
    COMMON_FIELDS.forEach(f => initialValues[f.name] = f.default);
    schema.fields.forEach((f: any) => initialValues[f.name] = f.default);
    
    form.setFieldsValue(initialValues);
    setFormData(initialValues);
  }, [selectedType, form]);

  const handleValuesChange = (_: any, allValues: any) => {
    setFormData(allValues);
  };

  // 生成注册用的 data 对象代码
  const generateDataCode = () => {
    const jsonString = JSON.stringify(formData, null, 2);
    // 去掉 key 的引号，使其更像 JS 代码
    const jsObj = jsonString.replace(/"([^"]+)":/g, '$1:');
    
    return `// 在 src/graph/cells/registry.ts 中注册节点时使用：
Graph.registerNode('custom-${selectedType.toLowerCase()}', {
  // ... 其他配置 (inherit, width, height, ports 等)
  data: ${jsObj},
});`;
  };

  // 生成 Inspector 组件的渲染代码
  const generateInspectorCode = () => {
    const schema = EQUIPMENT_SCHEMAS[selectedType];
    
    const fieldRenders = schema.fields.map((f: any) => {
      let inputComponent = `<Input />`;
      if (f.type === 'number') inputComponent = `<InputNumber style={{ width: '100%' }} />`;
      if (f.type === 'select') {
        const options = f.options.map((opt: any) => {
          const val = typeof opt === 'string' ? opt : opt.val;
          const label = typeof opt === 'string' ? opt : opt.label;
          return `<Option value="${val}">${label}</Option>`;
        }).join('\n              ');
        inputComponent = `<Select>\n              ${options}\n            </Select>`;
      }

      return `          <Form.Item label="${f.label}" name="${f.name}">
            ${inputComponent}
          </Form.Item>`;
    }).join('\n');

    return `// 在 src/components/Editor/Inspector/index.tsx 中：
// 1. 在 renderSpecificFields 函数中添加 case：

if (type === '${selectedType}') {
  return (
    <>
      <Divider orientation="left">${schema.label}</Divider>
      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8 }}>
${fieldRenders}
      </div>
    </>
  );
}`;
  };

  return (
    <Layout style={{ height: '100vh', background: '#fff' }}>
      {/* 左侧：类型选择 */}
      <Sider width={250} style={{ background: '#f0f2f5', borderRight: '1px solid #eee', overflowY: 'auto' }}>
        <div style={{ padding: '16px', borderBottom: '1px solid #e8e8e8' }}>
          <Title level={5}>设备类型库</Title>
        </div>
        <div style={{ padding: 8 }}>
          {Object.keys(EQUIPMENT_SCHEMAS).map(key => (
            <Button 
              key={key}
              type={selectedType === key ? 'primary' : 'text'}
              block
              style={{ textAlign: 'left', marginBottom: 4, height: 'auto', padding: '8px 12px' }}
              icon={EQUIPMENT_SCHEMAS[key].icon}
              onClick={() => setSelectedType(key)}
            >
              {EQUIPMENT_SCHEMAS[key].label}
            </Button>
          ))}
        </div>
      </Sider>

      {/* 中间：属性配置表单 */}
      <Content style={{ padding: '24px', overflowY: 'auto', background: '#fff' }}>
        <Title level={4}>属性配置预览</Title>
        <Paragraph type="secondary">
          在此处配置 {EQUIPMENT_SCHEMAS[selectedType].label} 的默认属性值和字段结构。
        </Paragraph>
        
        <Card title="基础属性 (Common)" size="small" style={{ marginBottom: 16 }}>
          <Form layout="vertical" form={form} onValuesChange={handleValuesChange}>
            <Row gutter={16}>
              {COMMON_FIELDS.map(f => (
                <Col span={8} key={f.name}>
                  <Form.Item label={f.label} name={f.name}>
                    <Input />
                  </Form.Item>
                </Col>
              ))}
            </Row>
          </Form>
        </Card>

        <Card title="业务属性 (Specific)" size="small" headStyle={{ background: '#fafafa' }}>
          <Form layout="vertical" form={form} onValuesChange={handleValuesChange}>
            <Row gutter={16}>
              {EQUIPMENT_SCHEMAS[selectedType].fields.map((f: any) => (
                <Col span={12} key={f.name}>
                  <Form.Item label={f.label} name={f.name}>
                    {f.type === 'select' ? (
                      <Select>
                        {f.options.map((opt: any) => {
                          const val = typeof opt === 'string' ? opt : opt.val;
                          const label = typeof opt === 'string' ? opt : opt.label;
                          return <Option key={val} value={val}>{label}</Option>;
                        })}
                      </Select>
                    ) : f.type === 'number' ? (
                      <InputNumber style={{ width: '100%' }} addonAfter={f.unit} />
                    ) : (
                      <Input />
                    )}
                  </Form.Item>
                </Col>
              ))}
            </Row>
          </Form>
        </Card>
      </Content>

      {/* 右侧：代码生成 */}
      <Sider width={450} style={{ background: '#fff', borderLeft: '1px solid #eee', padding: '0' }}>
        <Tabs defaultActiveKey="1" tabBarStyle={{ paddingLeft: 16 }}>
          <TabPane tab={<span><CodeOutlined /> 注册数据 (Data)</span>} key="1">
            <div style={{ padding: 16, height: 'calc(100vh - 60px)', overflowY: 'auto' }}>
              <Paragraph type="secondary" style={{ fontSize: 12 }}>
                此代码用于 `src/graph/cells/registry.ts` 中的 `data` 字段。
              </Paragraph>
              <TextArea 
                value={generateDataCode()} 
                autoSize={{ minRows: 15 }} 
                style={{ fontFamily: 'monospace', fontSize: 12, background: '#f5f5f5', color: '#333' }} 
                readOnly
              />
              <Button type="primary" icon={<CopyOutlined />} block style={{ marginTop: 16 }} onClick={() => {
                navigator.clipboard.writeText(generateDataCode());
                message.success('Data 代码已复制');
              }}>
                复制 Data 代码
              </Button>
            </div>
          </TabPane>
          
          <TabPane tab={<span><SettingOutlined /> 属性面板 (Inspector)</span>} key="2">
            <div style={{ padding: 16, height: 'calc(100vh - 60px)', overflowY: 'auto' }}>
              <Paragraph type="secondary" style={{ fontSize: 12 }}>
                此代码用于 `src/components/Editor/Inspector/index.tsx`，用于在右侧面板渲染这些属性。
              </Paragraph>
              <TextArea 
                value={generateInspectorCode()} 
                autoSize={{ minRows: 20 }} 
                style={{ fontFamily: 'monospace', fontSize: 12, background: '#f5f5f5', color: '#333' }} 
                readOnly
              />
              <Button type="primary" icon={<CopyOutlined />} block style={{ marginTop: 16 }} onClick={() => {
                navigator.clipboard.writeText(generateInspectorCode());
                message.success('Inspector 代码已复制');
              }}>
                复制 Inspector 代码
              </Button>
            </div>
          </TabPane>
        </Tabs>
      </Sider>
    </Layout>
  );
};

export default AttributeDesigner;
</file>

<file path="src/components/Editor/ContextMenu/index.css">
.context-menu {
  position: fixed; /* 使用 fixed 避免被画布容器遮挡 */
  z-index: 9999;
  background: #fff;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  padding: 4px 0;
  border: 1px solid #eee;
  min-width: 120px;
  user-select: none;
}

.context-menu-item {
  padding: 6px 12px;
  cursor: pointer;
  font-size: 13px;
  color: #333;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: background 0.2s;
}

.context-menu-item:hover {
  background-color: #f5f5f5;
  color: #1890ff;
}

.context-menu-item.danger {
  color: #ff4d4f;
}

.context-menu-item.danger:hover {
  background-color: #fff1f0;
}

.context-menu-divider {
  height: 1px;
  background-color: #eee;
  margin: 4px 0;
}
</file>

<file path="src/components/Editor/Toolbar/index.css">
.toolbar-container {
  position: absolute;
  top: 20px;
  left: 260px; /* 躲开左侧 Stencil */
  z-index: 100;
  background: #fff;
  padding: 4px 12px;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  gap: 4px;
}
</file>

<file path="src/graph/cells/svgs/cv-electric.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 100" fill="none" stroke="black" stroke-width="2">
  <polygon points="5,75 30,85 5,95" fill="white" />
  <polygon points="55,75 30,85 55,95" fill="white" />
  <line x1="30" y1="85" x2="30" y2="40" />
  <circle cx="30" cy="25" r="15" fill="white" />
  <!-- 文字 M -->
  <text x="30" y="30" text-anchor="middle" font-family="Arial" font-size="16" fill="black">M</text>
</svg>
</file>

<file path="src/graph/cells/svgs/cv-manual.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 100" fill="none" stroke="black" stroke-width="2">
  <polygon points="5,75 30,85 5,95" fill="white" />
  <polygon points="55,75 30,85 55,95" fill="white" />
  <line x1="30" y1="85" x2="30" y2="40" />
  <circle cx="30" cy="25" r="15" fill="white" />
  <text x="30" y="30" text-anchor="middle" font-family="Arial" font-size="16" fill="black">H</text>
</svg>
</file>

<file path="src/graph/cells/svgs/cv-piston.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 100" fill="none" stroke="black" stroke-width="2">
  <!-- 阀体 (Bowtie) -->
  <polygon points="5,75 30,85 5,95" fill="white" />
  <polygon points="55,75 30,85 55,95" fill="white" />
  
  <!-- 阀杆 -->
  <line x1="30" y1="85" x2="30" y2="40" />
  
  <!-- 执行机构：两个大小相同的矩形 -->
  <!-- 下矩形 -->
  <rect x="15" y="25" width="30" height="15" fill="white" />
  <!-- 上矩形 -->
  <rect x="15" y="10" width="30" height="15" fill="white" />
</svg>
</file>

<file path="src/graph/cells/svgs/cv-pneumatic.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 100" fill="none" stroke="black" stroke-width="2">
  <!-- 阀体 (Bowtie) -->
  <polygon points="5,75 30,85 5,95" fill="white" />
  <polygon points="55,75 30,85 55,95" fill="white" />
  <!-- 阀杆 -->
  <line x1="30" y1="85" x2="30" y2="40" />
  <!-- 执行机构 (圆头) -->
  <circle cx="30" cy="25" r="15" fill="white" />
  <!-- 文字 P -->
  <text x="30" y="30" text-anchor="middle" font-family="Arial" font-size="16" fill="black">P</text>
</svg>
</file>

<file path="src/graph/cells/svgs/cv-positioner.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 100" fill="none" stroke="black" stroke-width="2">
  <!-- 阀体 (底部双三角) -->
  <polygon points="5,75 30,85 5,95" fill="white" />
  <polygon points="55,75 30,85 55,95" fill="white" />
  
  <!-- 阀杆 -->
  <line x1="30" y1="85" x2="30" y2="40" />
  
  <!-- 执行机构 (圆头) -->
  <!-- 圆心(30,25), 半径15 -> 顶端y=10 -->
  <circle cx="30" cy="25" r="15" fill="white" />
  
  <!-- 文字 P -->
  <text x="30" y="30" text-anchor="middle" font-family="Arial" font-size="16" fill="black">P</text>
  
  <!-- 定位器方块 (外接于圆顶) -->
  <!-- x居中: 30-7=23, y从0开始, 高度10 -> 底部y=10 (刚好接触圆顶) -->
  <rect x="23" y="0" width="14" height="10" fill="white" />
</svg>
</file>

<file path="src/graph/cells/svgs/cv-solenoid.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 90 100" fill="none" stroke="black" stroke-width="2">
  <!-- 阀体 (位于左侧，中心对齐圆 P) -->
  <!-- 左三角形 -->
  <polygon points="5,75 30,85 5,95" fill="white" />
  <!-- 右三角形 -->
  <polygon points="55,75 30,85 55,95" fill="white" />
  
  <!-- 阀杆 -->
  <line x1="30" y1="85" x2="30" y2="40" />

  <!-- 主气动头 P (圆心 x=30, r=15) -->
  <circle cx="30" cy="25" r="15" fill="white" />
  <text x="30" y="30" text-anchor="middle" font-family="Arial" font-size="16" fill="black">P</text>

  <!-- 电磁阀 S (圆心 x=60, r=15) -->
  <!-- 与 P 水平相接，直径相同 -->
  <circle cx="60" cy="25" r="15" fill="white" />
  <text x="60" y="30" text-anchor="middle" font-family="Arial" font-size="16" fill="black">S</text>
</svg>
</file>

<file path="src/graph/cells/svgs/exchanger-vertical.svg">
<svg viewBox="0 0 100 400" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="black" stroke-width="2">
  <!-- 1. 主体 (Body) - 保持不变 -->
  <path d="M10,40 A40,30 0 0,1 90,40" fill="white" />
  <rect x="10" y="40" width="80" height="320" fill="white" stroke="none" />
  <line x1="10" y1="40" x2="10" y2="360" />
  <line x1="90" y1="40" x2="90" y2="360" />
  <path d="M10,360 A40,30 0 0,0 90,360" fill="white" />

  <!-- 2. 内部管束 (Internal Tubes) - 保持不变 -->
  <line x1="10" y1="40" x2="90" y2="40" stroke-width="2" />
  <line x1="10" y1="360" x2="90" y2="360" stroke-width="2" />
  <g stroke-width="1">
    <line x1="18" y1="40" x2="18" y2="360" />
    <line x1="26" y1="40" x2="26" y2="360" />
    <line x1="34" y1="40" x2="34" y2="360" />
    <line x1="42" y1="40" x2="42" y2="360" />
    <line x1="50" y1="40" x2="50" y2="360" />
    <line x1="58" y1="40" x2="58" y2="360" />
    <line x1="66" y1="40" x2="66" y2="360" />
    <line x1="74" y1="40" x2="74" y2="360" />
    <line x1="82" y1="40" x2="82" y2="360" />
  </g>

  <!-- 3. 侧面接口 (Side Nozzles) -->
  
  <!-- 左上 -->
  <line x1="0" y1="80" x2="10" y2="80" stroke-width="3" />
  
  <!-- 左下 (修改处：改为普通接口) -->
  <!-- 原来是 rect，现在改为 line，位置 y=320 -->
  <line x1="0" y1="320" x2="10" y2="320" stroke-width="3" />

  <!-- 右上 -->
  <line x1="90" y1="60" x2="100" y2="60" stroke-width="3" />
  <!-- 右下 -->
  <line x1="90" y1="340" x2="100" y2="340" stroke-width="3" />

  <!-- 4. 封头接口 (Head Nozzles) - 保持不变 -->
  <line x1="30" y1="10" x2="30" y2="20" stroke-width="2" />
  <line x1="70" y1="10" x2="70" y2="20" stroke-width="2" />
  <line x1="30" y1="380" x2="30" y2="390" stroke-width="2" />
  <line x1="70" y1="380" x2="70" y2="390" stroke-width="2" />

</svg>
</file>

<file path="src/graph/cells/svgs/exchanger.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="-20 0 340 120" fill="none" stroke="black" stroke-width="2" style="background-color:transparent">
  <!-- 
     修正策略：调整绘制顺序 (Painter's Algorithm)
     1. 先画筒体 (白色背景)
     2. 再画内部管束 (叠在筒体上)
     3. 再画两端法兰和封头 (叠在最上层以遮挡多余线条)
  -->

  <!-- 1. 主筒体 (Shell) - 移到最前，作为底图 -->
  <rect x="50" y="20" width="230" height="80" fill="white" stroke-width="2" />

  <!-- 2. 内部管束 (Tubes) - 现在会显示在白色筒体之上 -->
  <g stroke="#333" stroke-width="1">
    <line x1="50" y1="30" x2="280" y2="30" />
    <line x1="50" y1="40" x2="280" y2="40" />
    <line x1="50" y1="50" x2="280" y2="50" />
    <line x1="50" y1="60" x2="280" y2="60" /> <!-- 中心线 -->
    <line x1="50" y1="70" x2="280" y2="70" />
    <line x1="50" y1="80" x2="280" y2="80" />
    <line x1="50" y1="90" x2="280" y2="90" />
  </g>

  <!-- 3. 左侧结构 (管箱 + 隔板) -->
  <!-- 左法兰 (直径90) -->
  <rect x="45" y="15" width="5" height="90" fill="white" />
  
  <!-- 左封头 (加长型) -->
  <path d="M45 20 C -5 20, -5 100, 45 100" fill="white" />
  
  <!-- 隔板 (虚线，画在封头之上) -->
  <line x1="45" y1="60" x2="5" y2="60" stroke-width="2" stroke-dasharray="4,2" />

  <!-- 4. 右侧结构 -->
  <!-- 右法兰 (直径90) -->
  <rect x="280" y="15" width="5" height="90" fill="white" />
  <!-- 右封头 -->
  <path d="M285 20 C 315 20, 315 100, 285 100" fill="white" />

  <!-- 5. 管口 (Nozzles) -->
  
  <!-- N1: 壳程入口 (上) -->
  <line x1="95" y1="20" x2="95" y2="5" stroke-width="2"/>
  <line x1="90" y1="5" x2="100" y2="5" stroke-width="2"/>

  <!-- N2: 壳程出口 (下) -->
  <line x1="235" y1="100" x2="235" y2="115" stroke-width="2"/>
  <line x1="230" y1="115" x2="240" y2="115" stroke-width="2"/>

  <!-- N4: 管程出口 (左上 - 位于隔板上方) -->
  <line x1="8" y1="35" x2="-15" y2="35" stroke-width="2"/>
  <line x1="-15" y1="30" x2="-15" y2="40" stroke-width="2"/>

  <!-- N3: 管程入口 (左下 - 位于隔板下方) -->
  <line x1="8" y1="85" x2="-15" y2="85" stroke-width="2"/>
  <line x1="-15" y1="80" x2="-15" y2="90" stroke-width="2"/>

  <!-- N5: 放空 (右上) -->
  <line x1="303" y1="23" x2="310" y2="15" stroke-width="2"/>
  <line x1="307" y1="12" x2="313" y2="18" stroke-width="2"/>

  <!-- N6: 排净 (右下) -->
  <line x1="303" y1="97" x2="310" y2="105" stroke-width="2"/>
  <line x1="307" y1="108" x2="313" y2="102" stroke-width="2"/>
</svg>
</file>

<file path="src/graph/cells/svgs/frame-a2.svg">
<svg xmlns="http://www.w3.org/2000/svg" width="2245" height="1587" viewBox="0 0 2245 1587">
  <!-- A2 Size @ 96DPI -->
  <defs>
    <style>
      .border { fill: none; stroke: #000; stroke-width: 2; }
      .inner { fill: none; stroke: #000; stroke-width: 4; }
      .text { font-family: sans-serif; font-size: 24px; fill: #666; }
    </style>
  </defs>
  
  <!-- 1. 纸张边缘 (已修改：fill="none" 实现透明) -->
  <rect width="100%" height="100%" fill="none" />
  
  <!-- 2. 外框 (纸张裁切线) -->
  <rect x="1" y="1" width="2243" height="1585" class="border" stroke-dasharray="10,10" stroke="#ccc"/>
  
  <!-- 3. 内框 (绘图区) -->
  <rect x="94" y="38" width="2113" height="1511" class="inner" />
  
  <!-- 4. 标题栏 -->
  <g transform="translate(1527, 1399)">
    <rect width="680" height="150" fill="none" stroke="#000" stroke-width="2"/>
    <line x1="0" y1="50" x2="680" y2="50" stroke="#000" />
    <line x1="0" y1="100" x2="680" y2="100" stroke="#000" />
    <line x1="200" y1="0" x2="200" y2="150" stroke="#000" />
    <text x="20" y="35" class="text">项目名称: 化工工艺流程图</text>
    <text x="20" y="85" class="text">图号: PID-001</text>
    <text x="20" y="135" class="text">设计阶段: 详细设计</text>
    <text x="220" y="85" class="text" font-size="32" font-weight="bold">智能 P&amp;ID 编辑器</text>
  </g>
  
  <text x="110" y="70" class="text" font-size="16">A2 (594x420mm)</text>
</svg>
</file>

<file path="src/graph/cells/svgs/gas-cooler.svg">
<svg viewBox="0 0 400 260" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="black" stroke-width="2">
  <!-- 1. 外框 (Frame) - 保持不变 -->
  <path d="M20,60 L380,60 L380,240 L60,240 L20,200 Z" fill="white" />

  <!-- 2. 左右连接桩 - 保持不变 -->
  <line x1="0" y1="150" x2="20" y2="150" stroke-width="3" />
  <line x1="380" y1="150" x2="400" y2="150" stroke-width="3" />

  <!-- 3. 顶部爆破片法兰 - 保持不变 -->
  <g>
    <rect x="25" y="50" width="20" height="10" fill="white" />
    <line x1="35" y1="50" x2="35" y2="60" />
  </g>
  <g>
    <rect x="355" y="50" width="20" height="10" fill="white" />
    <line x1="365" y1="50" x2="365" y2="60" />
  </g>

  <!-- 4. 换热管束 (7组) -->
  <!-- 修改说明：所有 translate 的 x 坐标增加 15 (半个管束宽) -->
  <!-- 原坐标: 55, 95, 135, 175, 215, 255, 295 -->
  <!-- 新坐标: 70, 110, 150, 190, 230, 270, 310 -->
  
  <g transform="translate(70, 40)"> <!-- 第1组 -->
    <rect x="0" y="0" width="30" height="200" rx="15" ry="15" fill="white" />
    <line x1="0" y1="20" x2="30" y2="20" /> <line x1="0" y1="180" x2="30" y2="180" />
    <path d="M6,25 V175 M12,25 V175 M18,25 V175 M24,25 V175" stroke-width="1"/>
  </g>

  <g transform="translate(110, 40)"> <!-- 第2组 -->
    <rect x="0" y="0" width="30" height="200" rx="15" ry="15" fill="white" />
    <line x1="0" y1="20" x2="30" y2="20" /> <line x1="0" y1="180" x2="30" y2="180" />
    <path d="M6,25 V175 M12,25 V175 M18,25 V175 M24,25 V175" stroke-width="1"/>
  </g>

  <g transform="translate(150, 40)"> <!-- 第3组 -->
    <rect x="0" y="0" width="30" height="200" rx="15" ry="15" fill="white" />
    <line x1="0" y1="20" x2="30" y2="20" /> <line x1="0" y1="180" x2="30" y2="180" />
    <path d="M6,25 V175 M12,25 V175 M18,25 V175 M24,25 V175" stroke-width="1"/>
  </g>

  <g transform="translate(190, 40)"> <!-- 第4组 -->
    <rect x="0" y="0" width="30" height="200" rx="15" ry="15" fill="white" />
    <line x1="0" y1="20" x2="30" y2="20" /> <line x1="0" y1="180" x2="30" y2="180" />
    <path d="M6,25 V175 M12,25 V175 M18,25 V175 M24,25 V175" stroke-width="1"/>
  </g>

  <g transform="translate(230, 40)"> <!-- 第5组 -->
    <rect x="0" y="0" width="30" height="200" rx="15" ry="15" fill="white" />
    <line x1="0" y1="20" x2="30" y2="20" /> <line x1="0" y1="180" x2="30" y2="180" />
    <path d="M6,25 V175 M12,25 V175 M18,25 V175 M24,25 V175" stroke-width="1"/>
  </g>

  <g transform="translate(270, 40)"> <!-- 第6组 -->
    <rect x="0" y="0" width="30" height="200" rx="15" ry="15" fill="white" />
    <line x1="0" y1="20" x2="30" y2="20" /> <line x1="0" y1="180" x2="30" y2="180" />
    <path d="M6,25 V175 M12,25 V175 M18,25 V175 M24,25 V175" stroke-width="1"/>
  </g>

  <g transform="translate(310, 40)"> <!-- 第7组 -->
    <rect x="0" y="0" width="30" height="200" rx="15" ry="15" fill="white" />
    <line x1="0" y1="20" x2="30" y2="20" /> <line x1="0" y1="180" x2="30" y2="180" />
    <path d="M6,25 V175 M12,25 V175 M18,25 V175 M24,25 V175" stroke-width="1"/>
  </g>

</svg>
</file>

<file path="src/graph/cells/svgs/pump-centrifugal.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <circle cx="50" cy="50" r="48" fill="white" />
  <path d="M 4 50 L 50 4 L 96 50" stroke-linejoin="round" />
  <!-- 中心垂直线 -->
  <line x1="50" y1="4" x2="50" y2="98" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-compressor.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <!-- 外圆 (白底遮挡网格) -->
  <circle cx="50" cy="50" r="48" fill="white" />
  
  <!-- 梯形结构 (修正版) -->
  <!-- 
       几何计算基于圆心(50,50) 半径48:
       - 底部两点 (y=85): x=17, x=83 (更宽，贴合下部圆弧)
       - 顶部两点 (y=5):  x=33, x=67 (较窄，贴合上部圆弧)
  -->
  <line x1="17" y1="85" x2="33" y2="5" stroke-linecap="round" />
  <line x1="83" y1="85" x2="67" y2="5" stroke-linecap="round" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-diaphragm.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <!-- 1. 外圆 (白底遮挡网格) -->
  <circle cx="50" cy="50" r="48" fill="white" />
  
  <!-- 2. 倒V型结构 (三角形的上半部分) -->
  <!-- 左端点: (4, 50), 顶点: (50, 4), 右端点: (96, 50) -->
  <path d="M 4 50 L 50 4 L 96 50" stroke-linejoin="round" />
  
  <!-- 3. 隔膜弧线 (修正版) -->
  <!-- 起点 (4, 50) -> 控制点 (50, 85) -> 终点 (96, 50) -->
  <!-- 这样弧线就精确连接了倒V型的两个端点 -->
  <path d="M 4 50 Q 50 85 96 50" stroke-linecap="round" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-fan.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <!-- 1. 外圆 (白底遮挡网格) -->
  <circle cx="50" cy="50" r="48" fill="white" />
  
  <!-- 2. 梯形外壳 (直线两端均内接于圆) -->
  <!-- 经过计算，确保线条内接于半径48的圆，且避开中心扇叶区域 -->
  <!-- 左线: 顶部(28, 7.5) -> 底部(10, 76.5) -->
  <line x1="28" y1="7.5" x2="10" y2="76.5" stroke-linecap="round" />
  <!-- 右线: 顶部(72, 7.5) -> 底部(90, 76.5) -->
  <line x1="72" y1="7.5" x2="90" y2="76.5" stroke-linecap="round" />

  <!-- 3. 三叶螺旋桨 (柳叶型，不与直线相交) -->
  <!-- 
       中心点: (50,50)
       叶片长度: 28 (小于直线到圆心的距离33，确保不相交)
       控制点: 宽度适中，形成柳叶状
  -->
  <g fill="black" stroke="none" transform="translate(50, 50)">
    <!-- 叶片1 (朝上 0度) -->
    <!-- M 0 0 (圆心) -> Q 8 -14 (右控) 0 -28 (叶尖) -> Q -8 -14 (左控) 0 0 (回圆心) -->
    <path d="M 0 0 Q 8 -14 0 -28 Q -8 -14 0 0" />
    
    <!-- 叶片2 (旋转120度) -->
    <path d="M 0 0 Q 8 -14 0 -28 Q -8 -14 0 0" transform="rotate(120)" />
    
    <!-- 叶片3 (旋转240度) -->
    <path d="M 0 0 Q 8 -14 0 -28 Q -8 -14 0 0" transform="rotate(240)" />
  </g>
  
  <!-- 中心轴点 (白色小圆点缀) -->
  <circle cx="50" cy="50" r="2" fill="white" stroke="none" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-gear.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <circle cx="50" cy="50" r="48" fill="white" />
  <path d="M 4 50 L 50 4 L 96 50" stroke-linejoin="round" />
  <!-- 两个齿轮 -->
  <circle cx="35" cy="65" r="14" />
  <circle cx="65" cy="65" r="14" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-general.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <!-- 外圆 -->
  <circle cx="50" cy="50" r="48" fill="white" />
  <!-- 倒 V (三角形) -->
  <path d="M14 70 L50 20 L86 70" fill="none" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-jet.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <!-- 1. 外圆 (白底遮挡网格) -->
  <circle cx="50" cy="50" r="48" fill="white" />
  
  <!-- 2. 上部三角形 (倒V型，同液体泵) -->
  <!-- 左端(4,50) -> 顶端(50,4) -> 右端(96,50) -->
  <path d="M 4 50 L 50 4 L 96 50" stroke-linejoin="round" />
  
  <!-- 3. 下部收缩弧线 (文丘里管结构) -->
  <!-- 左侧弧线: 起点在圆周(18,84) -> 向内收缩 -> 终点连接三角形左边(27,27) -->
  <path d="M 18 84 Q 45 65 27 27" stroke-linecap="round" />
  
  <!-- 右侧弧线: 起点在圆周(82,84) -> 向内收缩 -> 终点连接三角形右边(73,27) -->
  <path d="M 82 84 Q 55 65 73 27" stroke-linecap="round" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-liquid.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <!-- 外圆 (白底遮挡网格) -->
  <circle cx="50" cy="50" r="48" fill="white" />
  <!-- 倒V型结构 -->
  <path d="M 4 50 L 50 4 L 96 50" stroke-linejoin="round" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-piston.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <circle cx="50" cy="50" r="48" fill="white" />
  <path d="M 4 50 L 50 4 L 96 50" stroke-linejoin="round" />
  <!-- 活塞杆 -->
  <line x1="50" y1="4" x2="50" y2="75" />
  <!-- 活塞头 -->
  <line x1="30" y1="75" x2="70" y2="75" />
</svg>
</file>

<file path="src/graph/cells/svgs/reactor-fixed-bed.svg">
<svg viewBox="0 0 260 300" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="black" stroke-width="2">
  <!-- 1. 主体 (Body) - 保持加宽尺寸 -->
  <path d="M50,40 A80,30 0 0,1 210,40" fill="white" />
  <rect x="50" y="40" width="160" height="220" fill="white" stroke="none" />
  <line x1="50" y1="40" x2="50" y2="260" />
  <line x1="210" y1="40" x2="210" y2="260" />
  <path d="M50,260 A80,30 0 0,0 210,260" fill="white" />

  <!-- 2. 气体接口 (Gas Nozzles) -->
  <rect x="120" y="0" width="20" height="10" fill="white" />
  <line x1="125" y1="10" x2="125" y2="25" /> <line x1="135" y1="10" x2="135" y2="25" />
  <rect x="120" y="290" width="20" height="10" fill="white" />
  <line x1="125" y1="275" x2="125" y2="290" /> <line x1="135" y1="275" x2="135" y2="290" />

  <!-- 3. 盐环 (Salt Rings) -->
  <!-- 上盐道 -->
  <g id="upper-salt-ring">
    <rect x="34" y="60" width="192" height="25" rx="5" ry="5" fill="white" />
    <line x1="34" y1="72.5" x2="226" y2="72.5" stroke-width="1" stroke-dasharray="4 2" />
  </g>
  <!-- 下盐道 -->
  <g id="lower-salt-ring">
    <rect x="34" y="215" width="192" height="25" rx="5" ry="5" fill="white" />
    <line x1="34" y1="227.5" x2="226" y2="227.5" stroke-width="1" stroke-dasharray="4 2" />
  </g>

  <!-- 4. 内部管束示意 (10根) -->
  <g stroke="#999" stroke-width="1" stroke-dasharray="2 2">
    <line x1="64" y1="90" x2="64" y2="210" /> <line x1="78" y1="90" x2="78" y2="210" />
    <line x1="92" y1="90" x2="92" y2="210" /> <line x1="106" y1="90" x2="106" y2="210" />
    <line x1="120" y1="90" x2="120" y2="210" /> <line x1="140" y1="90" x2="140" y2="210" />
    <line x1="154" y1="90" x2="154" y2="210" /> <line x1="168" y1="90" x2="168" y2="210" />
    <line x1="182" y1="90" x2="182" y2="210" /> <line x1="196" y1="90" x2="196" y2="210" />
  </g>

  <!-- 5. 密集连接短管 (Stubs) -->
  
  <!-- === 上盐道接口 (Upper) === -->
  <!-- 左侧 3 个 (x=20~34) -->
  <line x1="20" y1="65" x2="34" y2="65" stroke-width="2" />   <!-- 上: G-14A -->
  <line x1="20" y1="72.5" x2="34" y2="72.5" stroke-width="2" /> <!-- 中: C-14 -->
  <line x1="20" y1="80" x2="34" y2="80" stroke-width="2" />     <!-- 下: E-15 -->
  
  <!-- 右侧 2 个 (x=226~240) -->
  <line x1="226" y1="68" x2="240" y2="68" stroke-width="2" />   <!-- 上: G-14B -->
  <line x1="226" y1="77" x2="240" y2="77" stroke-width="2" />   <!-- 下: E-14 -->

  <!-- === 下盐道接口 (Lower) === -->
  <!-- 左侧 3 个 -->
  <line x1="20" y1="220" x2="34" y2="220" stroke-width="2" />   <!-- 上: G-14A -->
  <line x1="20" y1="227.5" x2="34" y2="227.5" stroke-width="2" /> <!-- 中: C-14 -->
  <line x1="20" y1="235" x2="34" y2="235" stroke-width="2" />   <!-- 下: E-15 -->

  <!-- 右侧 2 个 -->
  <line x1="226" y1="223" x2="240" y2="223" stroke-width="2" />   <!-- 上: G-14B -->
  <line x1="226" y1="232" x2="240" y2="232" stroke-width="2" />   <!-- 下: E-14 -->

</svg>
</file>

<file path="src/graph/cells/svgs/tank-vertical.svg">
<svg viewBox="0 0 100 200" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="black" stroke-width="2">
  <!-- 1. 基础背景 (白色) -->
  <path d="M10,40 A40,20 0 0,1 90,40 L90,160 A40,20 0 0,1 10,160 Z" fill="white" stroke="none" />

  <!-- 2. 液相填充 (淡蓝色，下半部分) -->
  <!-- 路径说明: 从左中(10,100) -> 右中(90,100) -> 右下直线 -> 底部封头弧线 -> 闭合 -->
  <path d="M10,100 L90,100 L90,160 A40,20 0 0,1 10,160 Z" fill="#e6f7ff" stroke="none" />

  <!-- 3. 液面线 (蓝色虚线) -->
  <line x1="10" y1="100" x2="90" y2="100" stroke="#1890ff" stroke-width="1" stroke-dasharray="4 2" />

  <!-- 4. 外轮廓 (黑色) -->
  <path d="M10,40 A40,20 0 0,1 90,40 L90,160 A40,20 0 0,1 10,160 Z" fill="none" stroke="black" stroke-width="2" />
  
  <!-- 5. 支腿 (保持不变) -->
  <line x1="20" y1="175" x2="20" y2="195" />
  <line x1="10" y1="195" x2="30" y2="195" />
  <line x1="80" y1="175" x2="80" y2="195" />
  <line x1="70" y1="195" x2="90" y2="195" />
</svg>
</file>

<file path="src/graph/cells/svgs/tower-packing.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 200" fill="none" stroke="black" stroke-width="2">
  <!-- 1. 支腿 (Legs) -->
  <line x1="20" y1="180" x2="20" y2="200" stroke-width="2" />
  <line x1="80" y1="180" x2="80" y2="200" stroke-width="2" />
  <line x1="15" y1="200" x2="25" y2="200" stroke-width="2" />
  <line x1="75" y1="200" x2="85" y2="200" stroke-width="2" />

  <!-- 2. 主罐体 (Main Body) -->
  <!-- 筒体背景 -->
  <path d="M10,20 A40,15 0 0,1 90,20 L90,180 A40,15 0 0,1 10,180 Z" fill="white" stroke="none" />
  
  <!-- 顶部封头 -->
  <path d="M10,20 A40,15 0 0,1 90,20" fill="none" stroke="black" />
  <!-- 底部封头 -->
  <path d="M10,180 A40,15 0 0,0 90,180" fill="none" stroke="black" />
  <!-- 筒体侧壁 -->
  <line x1="10" y1="20" x2="10" y2="180" />
  <line x1="90" y1="20" x2="90" y2="180" />

  <!-- 3. 填料层 (Packing Section) - 鲍尔环示意 -->
  <!-- 填料层范围：Y=50 到 Y=110 -->
  
  <!-- 填料支撑板 (虚线) -->
  <line x1="10" y1="50" x2="90" y2="50" stroke-dasharray="4 2" stroke-width="1" />
  <line x1="10" y1="110" x2="90" y2="110" stroke-dasharray="4 2" stroke-width="1" />

  <!-- 填料纹理 (X形图案) -->
  <g stroke="#666" stroke-width="1" opacity="0.7">
    <!-- 第一排 -->
    <path d="M20,55 l10,10 m0,-10 l-10,10" />
    <path d="M40,55 l10,10 m0,-10 l-10,10" />
    <path d="M60,55 l10,10 m0,-10 l-10,10" />
    <!-- 第二排 (错位) -->
    <path d="M30,70 l10,10 m0,-10 l-10,10" />
    <path d="M50,70 l10,10 m0,-10 l-10,10" />
    <path d="M70,70 l10,10 m0,-10 l-10,10" />
    <!-- 第三排 -->
    <path d="M20,85 l10,10 m0,-10 l-10,10" />
    <path d="M40,85 l10,10 m0,-10 l-10,10" />
    <path d="M60,85 l10,10 m0,-10 l-10,10" />
    <!-- 第四排 (错位) -->
    <path d="M30,100 l10,10 m0,-10 l-10,10" />
    <path d="M50,100 l10,10 m0,-10 l-10,10" />
  </g>

  <!-- 4. 液体分布器示意 (填料上方) -->
  <line x1="20" y1="40" x2="80" y2="40" stroke-width="1" />
  <line x1="50" y1="30" x2="50" y2="40" stroke-width="1" />
</svg>
</file>

<file path="src/graph/cells/svgs/tv-Trap.svg">
<svg width="250" height="100" viewBox="12.15 7.4 26 10.4" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
  <path style="fill:none;fill-opacity:1;stroke:#000;stroke-width:.15;stroke-dasharray:none;stroke-opacity:1;paint-order:markers fill stroke" d="M17.517 7.606h5.175M37.476 7.607h5.175" transform="translate(-4.948 4.884)"/>
  <g transform="matrix(.19762 0 0 .19762 20.262 7.575)" stroke="#000" pointer-events="all">
    <circle cx="25.25" cy="25.25" fill="#fff" r="25.248" style="fill:none"/>
    <path d="M43.12 7.37c9.88 9.87 9.88 25.88 0 35.75-9.87 9.88-25.88 9.88-35.75 0Z" stroke-miterlimit="10"/>
  </g>
</svg>
</file>

<file path="src/App.css">

</file>

<file path="src/index.css">
html, body, #root {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  overflow: hidden; /* 禁止滚动条 */
}
</file>

<file path="src/main.tsx">
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.tsx'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
)
</file>

<file path=".env.example">
# Neo4j Configuration
# 请复制此文件为 .env 并填入你的真实配置
VITE_NEO4J_URI=bolt://localhost:7687
VITE_NEO4J_USER=neo4j
VITE_NEO4J_PASSWORD=your_password_here
</file>

<file path="eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])
</file>

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>chemical-graph-editor</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
</file>

<file path="LICENSE">
MIT License

Copyright (c) [year] [fullname]

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="tsconfig.app.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}
</file>

<file path="tsconfig.json">
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
</file>

<file path="tsconfig.node.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import fs from 'node:fs'
import path from 'node:path'

// 自定义中间件：处理文件保存请求
const saveFilePlugin = () => ({
  name: 'vite-plugin-save-shape',
  configureServer(server) {
    // 注册一个 API 路由 /_api/save-shape
    server.middlewares.use('/_api/save-shape', async (req, res, next) => {
      if (req.method === 'POST') {
        const chunks = []
        req.on('data', chunk => chunks.push(chunk))
        req.on('end', () => {
          try {
            const body = JSON.parse(Buffer.concat(chunks).toString())
            const { filename, svgContent, jsonContent } = body
            
            // 1. 确定保存路径 (基于项目根目录)
            // 注意：这里假设你的代码结构是 src/graph/cells/svgs 和 src/graph/cells/data
            const svgPath = path.resolve(__dirname, 'src/graph/cells/svgs', `${filename}.svg`)
            const jsonPath = path.resolve(__dirname, 'src/graph/cells/data', `${filename}.json`)

            // 2. 确保 data 目录存在 (svgs 目录通常已存在，但 data 目录可能是新的)
            const jsonDir = path.dirname(jsonPath)
            if (!fs.existsSync(jsonDir)) {
              fs.mkdirSync(jsonDir, { recursive: true })
            }

            // 3. 写入文件
            fs.writeFileSync(svgPath, svgContent, 'utf-8')
            fs.writeFileSync(jsonPath, JSON.stringify(jsonContent, null, 2), 'utf-8')

            console.log(`[Vite] Saved shape: ${filename}`)

            res.statusCode = 200
            res.setHeader('Content-Type', 'application/json')
            res.end(JSON.stringify({ success: true, message: 'Saved successfully' }))
          } catch (e) {
            console.error('[Vite] Save error:', e)
            res.statusCode = 500
            res.setHeader('Content-Type', 'application/json')
            res.end(JSON.stringify({ success: false, message: (e as Error).message }))
          }
        })
      } else {
        next()
      }
    })
  }
})

// https://vite.dev/config/
export default defineConfig({
  plugins: [
    react(), 
    saveFilePlugin() // 启用插件
  ],
})
</file>

<file path="src/components/Editor/Canvas/index.css">
/* =========================================
   1. 整体布局容器
   ========================================= */
.editor-container {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  overflow: hidden;
  background-color: #f0f2f5;
}

/* =========================================
   2. 左侧组件库 (Flex 布局改造)
   ========================================= */
.stencil-container {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  width: 240px;
  background-color: #fff;
  border-right: 1px solid #dfe3e8;
  z-index: 10;
  
  /* 关键：使用 Flex 布局垂直排列 */
  display: flex;
  flex-direction: column;
}

/* 强制 X6 Stencil 容器填满高度 */
.x6-widget-stencil {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  background-color: #fff;
  position: relative;
}

/* 搜索框：防止被压缩 */
.x6-widget-stencil-search {
  flex-shrink: 0;
  padding: 10px 12px !important;
  border-bottom: 1px solid #eee;
  background: #fff;
  position: sticky;
  top: 0;
  z-index: 2;
}

/* 搜索输入框美化 */
.x6-widget-stencil-search input {
  border-radius: 4px;
  border: 1px solid #d9d9d9;
  padding: 6px 8px;
  font-size: 13px;
}

/* 内容区域：核心滚动逻辑 */
.x6-widget-stencil-content {
  flex: 1;                 /* 自动占据剩余空间 */
  height: auto !important; /* 覆盖 X6 的行内高度 */
  overflow-y: auto !important; /* 强制开启纵向滚动 */
  overflow-x: hidden !important;
  position: relative !important;
}

/* 分组标题美化 */
.x6-widget-stencil-group-title {
  background-color: #f9fafb !important;
  color: #555 !important;
  font-weight: 600 !important;
  font-size: 13px !important;
  padding: 10px 12px !important;
  border-top: 1px solid #eee;
  border-bottom: 1px solid #eee;
}

/* 滚动条美化 */
.x6-widget-stencil-content::-webkit-scrollbar {
  width: 6px;
}
.x6-widget-stencil-content::-webkit-scrollbar-thumb {
  background: #d9d9d9;
  border-radius: 3px;
}
.x6-widget-stencil-content::-webkit-scrollbar-track {
  background: transparent;
}

/* =========================================
   3. 中间画布区域
   ========================================= */
.canvas-container {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 240px;
  right: 300px;
  background-color: #fff;
  z-index: 1;
  overflow: hidden;
}

/* =========================================
   4. 右侧属性面板
   ========================================= */
.inspector-container {
  position: absolute;
  top: 0;
  bottom: 0;
  right: 0;
  width: 300px;
  background-color: #fff;
  border-left: 1px solid #dfe3e8;
  z-index: 10;
  overflow-y: auto;
}

/* =========================================
   5. 顶部悬浮工具栏
   ========================================= */
.toolbar-container {
  position: absolute;
  top: 10px;
  left: 260px;
  right: 320px;
  height: 40px;
  background-color: #fff;
  border: 1px solid #dfe3e8;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  border-radius: 4px;
  z-index: 100;
  display: flex;
  align-items: center;
  padding: 0 12px;
  gap: 12px;
}

.toolbar-group {
  display: flex;
  align-items: center;
  gap: 4px;
  position: relative;
}

.toolbar-group:not(:last-child)::after {
  content: '';
  display: block;
  width: 1px;
  height: 16px;
  background-color: #e8e8e8;
  margin-left: 12px;
}

/* ... 之前的 CSS ... */

/* =========================================
   7. 修复侧边栏 UI 细节 (Overlap Fixes)
   ========================================= */

/* 修复分组标题：折叠图标与文字重叠的问题 */
.x6-widget-stencil-group-title {
  position: relative !important;
  display: flex !important;
  align-items: center !important;
  /* 给文字左侧留出空间，防止盖住图标 */
  padding-left: 32px !important; 
  height: 38px !important; /* 稍微增加高度，便于点击 */
  line-height: 38px !important;
}

/* 定位折叠图标 (那个圆圈加号) */
.x6-widget-stencil-group-icon {
  position: absolute !important;
  left: 10px !important; /* 固定在左侧 10px 处 */
  top: 50% !important;
  transform: translateY(-50%) !important; /* 垂直居中 */
  margin: 0 !important;
  width: 16px !important;
  height: 16px !important;
  font-size: 12px !important;
}

/* 可选：微调搜索框的下边距，让布局更紧凑 */
.x6-widget-stencil-search {
  border-bottom: 1px solid #e8e8e8;
  padding-bottom: 8px !important;
}

/* ... 之前的 CSS 保持不变，请只修改或追加文件末尾的以下内容 ... */

/* =========================================
   8. 终极空白修复 (The Void Fix)
   ========================================= */

/* 1. 压榨搜索框底部空间 */
.x6-widget-stencil-search {
  /* 确保搜索框底部没有多余的外边距 */
  margin-bottom: 0 !important;
  /* 仅保留必要的内边距 */
  padding-bottom: 10px !important;
  border-bottom: 1px solid #dfe3e8;
}

/* 2. 压榨内容区域顶部空间 */
.x6-widget-stencil-content {
  top: 0 !important; /* 强制对齐顶部 */
  margin-top: 0 !important;
  padding-top: 0 !important;
}

/* 3. 彻底消灭“幽灵”根画布 (关键！) */
/* 选中 content 下的第一个子元素，如果它不是分组标题，那就是那个讨厌的空白区域 */
.x6-widget-stencil-content > div:first-child:not(.x6-widget-stencil-group) {
  display: none !important;
  height: 0 !important;
  min-height: 0 !important;
  max-height: 0 !important;
  margin: 0 !important;
  padding: 0 !important;
  border: none !important;
  overflow: hidden !important;
}

/* 4. 双重保险：针对 X6 生成的特定 graph 容器 */
.x6-widget-stencil-content .x6-graph {
  /* 只隐藏不在分组内的 graph */
  display: none !important;
}
/* 恢复分组内的 graph 显示 (防止误伤) */
.x6-widget-stencil-group .x6-graph {
  display: block !important;
}
</file>

<file path="src/components/Editor/Toolbar/index.tsx">
import React, { useEffect, useState } from 'react';
import { Button, Tooltip } from 'antd';
import { 
  ZoomInOutlined, 
  ZoomOutOutlined, 
  UndoOutlined, 
  RedoOutlined, 
  ExpandOutlined, 
  CompressOutlined, 
  DeleteOutlined
} from '@ant-design/icons';
import { Graph } from '@antv/x6';

import './index.css';

interface ToolbarProps {
  graph: Graph | null;
}

const Toolbar: React.FC<ToolbarProps> = ({ graph }) => {
  const [canUndo, setCanUndo] = useState(false);
  const [canRedo, setCanRedo] = useState(false);
  const [designerVisible, setDesignerVisible] = useState(false);

  useEffect(() => {
    if (!graph) return;

    // [修复类型报错]
    // X6 的 Graph 类型定义中不包含 history 属性，需要断言为 any 才能访问插件实例
    const history = (graph as any).history;
    
    // 防御性检查：确保插件已加载
    if (!history) return;

    const updateState = () => {
      setCanUndo(history.canUndo());
      setCanRedo(history.canRedo());
    };

    history.on('change', updateState);
    history.on('undo', updateState);
    history.on('redo', updateState);
    
    // 初始化状态
    updateState();
    
    return () => {
      history.off('change', updateState);
      history.off('undo', updateState);
      history.off('redo', updateState);
    };
  }, [graph]);

  if (!graph) return null;

  // 辅助函数：安全调用 history
  const getHistory = () => (graph as any).history;

  return (
    <>
      <div className="toolbar-container">
        <Tooltip title="撤销 (Cmd+Z)">
          <Button 
            type="text" 
            icon={<UndoOutlined />} 
            disabled={!canUndo} 
            onClick={() => getHistory()?.undo()} 
          />
        </Tooltip>
        <Tooltip title="重做 (Cmd+Shift+Z)">
          <Button 
            type="text" 
            icon={<RedoOutlined />} 
            disabled={!canRedo} 
            onClick={() => getHistory()?.redo()} 
          />
        </Tooltip>
        
        <span style={{ width: 1, height: 16, background: '#eee', margin: '0 4px' }} />
        
        <Tooltip title="放大">
          <Button type="text" icon={<ZoomInOutlined />} onClick={() => graph.zoom(0.1)} />
        </Tooltip>
        <Tooltip title="缩小">
          <Button type="text" icon={<ZoomOutOutlined />} onClick={() => graph.zoom(-0.1)} />
        </Tooltip>
        <Tooltip title="适应画布">
          <Button type="text" icon={<CompressOutlined />} onClick={() => graph.zoomToFit({ padding: 20 })} />
        </Tooltip>
        <Tooltip title="1:1">
          <Button type="text" icon={<ExpandOutlined />} onClick={() => graph.zoomTo(1)} />
        </Tooltip>

        <span style={{ width: 1, height: 16, background: '#eee', margin: '0 4px' }} />

        <Tooltip title="删除选中 (Delete)">
          <Button 
            type="text" 
            danger
            icon={<DeleteOutlined />} 
            onClick={() => {
              const cells = graph.getSelectedCells();
              if(cells.length) graph.removeCells(cells);
            }} 
          />
        </Tooltip>

        
      </div>

     
    </>
  );
};

export default Toolbar;
</file>

<file path="src/config/rules.ts">
// src/config/rules.ts
// ============================================================================
// 全局业务规则配置
// ============================================================================

// 1. 当前图纸 ID (为多页系统做准备，目前暂定为 Draft_V1)
export const CURRENT_DRAWING_ID = 'Draft_V1';

// 2. 介质颜色定义
export const FLUID_COLORS: Record<string, string> = {
  Water: '#1890ff',       // 工艺水 - 蓝
  Steam: '#ff4d4f',       // 蒸汽 - 红
  Air: '#52c41a',         // 空气 - 绿
  N2: '#13c2c2',          // 氮气 - 青
  Oil: '#fa8c16',         // 导热油 - 橙
  Salt: '#722ed1',        // 熔盐 - 紫
  Naphthalene: '#8c8c8c', // 萘 - 深灰
  PA: '#eb2f96',          // 苯酐 - 洋红
  CrudePA: '#f759ab',     // 粗苯酐 - 浅洋红
  ProductGas: '#faad14',  // 产物气 - 金黄
  TailGas: '#bfbfbf',     // 尾气 - 浅灰
  Signal: '#888888',      // 信号线 - 灰
};

// 3. 在线元件列表
// 这些设备被视为"管线的一部分"，路由算法会忽略它们的体积，允许直线穿过
export const INLINE_TYPES = [
  'ControlValve', 
  'Valve', 
  'Fitting', 
  'TappingPoint'
];

// 4. 路由默认配置
export const DEFAULT_ROUTER = {
  name: 'manhattan',
  args: {
    padding: 10,
    excludeNodes: ['SHEET_FRAME_A2'], // 默认排除背景框
  },
};
</file>

<file path="src/graph/cells/svgs/inst-local.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" fill="none" stroke="black" stroke-width="2">
  <!-- 40x40 画布，圆心 20, 半径 18 -->
  <circle cx="20" cy="20" r="18" fill="white" />
</svg>
</file>

<file path="src/graph/cells/svgs/inst-panel.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" fill="none" stroke="black" stroke-width="2">
  <circle cx="20" cy="20" r="18" fill="white" />
  <!-- 中间双横线 (上下各偏移 2px) -->
  <line x1="2" y1="18" x2="38" y2="18" />
  <line x1="2" y1="22" x2="38" y2="22" />
</svg>
</file>

<file path="src/graph/cells/svgs/inst-remote.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" fill="none" stroke="black" stroke-width="2">
  <circle cx="20" cy="20" r="18" fill="white" />
  <!-- 中间单横线 y=20 -->
  <line x1="2" y1="20" x2="38" y2="20" />
</svg>
</file>

<file path="src/graph/cells/svgs/reactor.svg">
<svg viewBox="0 0 80 120" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="black" stroke-width="1.5">
  
  <!-- 1. 半管夹套 (Limpet Coil) -->
  <!-- 左侧半管组 -->
  <!-- 最上方半管 (入口) - 顶点在 x=6 -->
  <path d="M10,50 A4,4 0 0,0 10,58" fill="none"/> 
  <!-- 左侧入口连接线 (Jacket In) - 外接半圆顶点 -->
  <line x1="0" y1="54" x2="6" y2="54" stroke-width="2"/>
  
  <!-- 左侧其余半管 -->
  <path d="M10,62 A4,4 0 0,0 10,70" fill="none"/>
  <path d="M10,74 A4,4 0 0,0 10,82" fill="none"/>
  <path d="M10,86 A4,4 0 0,0 10,94" fill="none"/>

  <!-- 右侧半管组 -->
  <path d="M70,50 A4,4 0 0,1 70,58" fill="none"/>
  <path d="M70,62 A4,4 0 0,1 70,70" fill="none"/>
  <path d="M70,74 A4,4 0 0,1 70,82" fill="none"/>
  
  <!-- 最下方半管 (出口) - 顶点在 x=74 -->
  <path d="M70,86 A4,4 0 0,1 70,94" fill="none"/>
  <!-- 右侧出口连接线 (Jacket Out) - 外接半圆顶点 -->
  <line x1="74" y1="90" x2="80" y2="90" stroke-width="2"/>

  <!-- 2. 釜体 (Main Vessel) -->
  <path d="M10,30 Q40,10 70,30 L70,100 Q40,120 10,100 Z" fill="white" stroke="black" stroke-width="2"/>

  <!-- 3. 搅拌系统 (Agitator) -->
  <!-- 电机 (M) - 位于正中，半径8，占据 x=32~48 -->
  <circle cx="40" cy="5" r="8" fill="white" stroke="black" stroke-width="1.5"/>
  <text x="40" y="8" font-family="Arial" font-size="10" text-anchor="middle" fill="black" stroke="none">M</text>
  
  <!-- 搅拌轴 -->
  <line x1="40" y1="13" x2="40" y2="85" stroke="black" stroke-width="1.5"/>
  
  <!-- 桨叶 (Paddle) -->
  <rect x="20" y="85" width="40" height="10" fill="white" stroke="black" stroke-width="1.5"/>
  <line x1="20" y1="85" x2="60" y2="95" stroke="black" stroke-width="1"/>
  <line x1="20" y1="95" x2="60" y2="85" stroke="black" stroke-width="1"/>

  <!-- 4. 顶部连接桩 (Top Nozzles) -->
  <!-- 避开电机区域 (32-48)，向两侧分布 -->
  
  <!-- N1 (x=12) -->
  <line x1="12" y1="22" x2="12" y2="5" stroke-width="2"/>
  <line x1="9" y1="5" x2="15" y2="5" stroke-width="2"/> <!-- 法兰 -->

  <!-- N2 (x=24) - 距离电机有一定间隙 -->
  <line x1="24" y1="18" x2="24" y2="5" stroke-width="2"/>
  <line x1="21" y1="5" x2="27" y2="5" stroke-width="2"/>

  <!-- N3 (x=56) -->
  <line x1="56" y1="18" x2="56" y2="5" stroke-width="2"/>
  <line x1="53" y1="5" x2="59" y2="5" stroke-width="2"/>

  <!-- N4 (x=68) -->
  <line x1="68" y1="22" x2="68" y2="5" stroke-width="2"/>
  <line x1="65" y1="5" x2="71" y2="5" stroke-width="2"/>

  <!-- 5. 侧面工艺接口 -->
  
  <!-- 进料口 (Feed In) - 下移至 y=35 (连接在直筒体上) -->
  <line x1="0" y1="35" x2="10" y2="35" stroke-width="2"/>
  <!-- 纯直线，无法兰短线 -->

  <!-- 溢流口 (Overflow) - 右侧 y=35 (与进料口水平或略低，这里设为同高对称) -->
  <line x1="70" y1="35" x2="80" y2="35" stroke-width="2"/>
  
  <!-- 插底管 (Dip Pipe) -->
  <polyline points="70,35 62,35 62,95" fill="none" stroke="black" stroke-width="1" stroke-dasharray="3 2"/>

  <!-- 6. 底部出料口 -->
  <line x1="40" y1="110" x2="40" y2="120" stroke-width="2"/>
  <line x1="36" y1="120" x2="44" y2="120" stroke-width="2"/>

  <!-- 7. 内部挡板/套管 -->
  <line x1="65" y1="35" x2="65" y2="90" stroke="black" stroke-width="1"/>

</svg>
</file>

<file path="src/graph/cells/svgs/trap.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 100" fill="none" stroke="black" stroke-width="2">
  <!-- 主罐体 -->
  <rect x="20" y="30" width="90" height="60" fill="white" />

  <!-- 内部挡板 -->
  <!-- 右侧挡板：从上往下 -->
  <line x1="75" y1="30" x2="75" y2="75" />
  <!-- 左侧挡板：从下往上 -->
  <line x1="50" y1="90" x2="50" y2="45" />

  <!-- N1: 入口连接桩 (右上) - 已移除文字，增加法兰盖 -->
  <line x1="85" y1="30" x2="85" y2="10" />
  <line x1="91" y1="30" x2="91" y2="10" />
  <!-- N1 法兰 -->
  <line x1="82" y1="10" x2="94" y2="10" />

  <!-- N2: 出口连接桩 (左上) - 已移除文字，增加法兰盖 -->
  <line x1="35" y1="30" x2="35" y2="10" />
  <line x1="41" y1="30" x2="41" y2="10" />
  <!-- N2 法兰 -->
  <line x1="32" y1="10" x2="44" y2="10" />

  <!-- M1: 侧口 (左侧) - 保持不变 -->
  <line x1="20" y1="50" x2="10" y2="50" />
  <line x1="20" y1="62" x2="10" y2="62" />
  <line x1="10" y1="46" x2="10" y2="66" />
  <text x="5" y="60" text-anchor="end" font-family="Arial" font-size="12" stroke="none" fill="black" font-weight="bold">M1</text>
</svg>
</file>

<file path="src/graph/cells/icons.ts">
export const REACTOR_SVG = `
<svg viewBox="0 0 80 120" xmlns="http://www.w3.org/2000/svg">
  <path d="M10 30 V90 C10 110 70 110 70 90 V30 H10 Z" fill="#EFF4FF" stroke="#5F95FF" stroke-width="2"/>
  <path d="M10 30 C10 10 70 10 70 30" fill="none" stroke="#5F95FF" stroke-width="2"/>
  <rect x="35" y="0" width="10" height="20" fill="#fff" stroke="#5F95FF" stroke-width="2"/>
  <line x1="10" y1="45" x2="70" y2="45" stroke="#5F95FF" stroke-width="1" stroke-dasharray="3 3"/>
  <path d="M20 70 Q40 90 60 70" fill="none" stroke="#5F95FF" stroke-width="2"/>
</svg>
`;

export const PUMP_SVG = `
<svg viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
  <circle cx="30" cy="35" r="20" fill="#EFF4FF" stroke="#5F95FF" stroke-width="2"/>
  <path d="M30 15 V0 M50 35 H60" stroke="#5F95FF" stroke-width="2"/>
  <path d="M30 35 L45 25 L45 45 Z" fill="#5F95FF"/>
</svg>
`;

export const VALVE_SVG = `
<svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 10 L40 30 V10 L0 30 Z" fill="#EFF4FF" stroke="#5F95FF" stroke-width="2"/>
  <line x1="20" y1="20" x2="20" y2="0" stroke="#5F95FF" stroke-width="2"/>
  <line x1="10" y1="0" x2="30" y2="0" stroke="#5F95FF" stroke-width="2"/>
</svg>
`;

export const TEE_SVG = `
<svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 20 H40 M20 20 V40" stroke="#5F95FF" stroke-width="4" stroke-linecap="round"/>
</svg>
`;
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

# Environment variables (非常重要！绝对不能上传 .env)
.env
.env.local
.env.*.local
!.env.example
</file>

<file path="package.json">
{
  "name": "chemical-graph-editor",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@ant-design/icons": "^6.1.0",
    "@antv/x6": "^2.19.2",
    "@antv/x6-plugin-keyboard": "^2.2.3",
    "@antv/x6-plugin-selection": "^2.2.2",
    "@antv/x6-plugin-stencil": "^2.1.5",
    "@antv/x6-plugin-transform": "^2.1.8",
    "antd": "^6.0.0",
    "lodash": "^4.17.21",
    "neo4j-driver": "^6.0.1",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "sass": "^1.94.2",
    "uuid": "^13.0.0",
    "zustand": "^5.0.9"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/lodash": "^4.17.21",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@types/uuid": "^10.0.0",
    "@vitejs/plugin-react": "^5.1.1",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "npm:rolldown-vite@7.2.5"
  },
  "overrides": {
    "vite": "npm:rolldown-vite@7.2.5"
  }
}
</file>

<file path="src/components/DevTools/ShapeDesigner.tsx">
import React, { useState, useRef, useEffect } from 'react';
import { Layout, Input, Button, Form, Select, Row, Col, Typography, message, Divider, Collapse, Tooltip, Checkbox, Slider, Space, InputNumber } from 'antd';
import { 
  CopyOutlined, DeleteOutlined, QuestionCircleOutlined, InfoCircleOutlined, 
  ZoomInOutlined, ZoomOutOutlined, ReloadOutlined, FileAddOutlined, 
  ColumnHeightOutlined, AimOutlined,
  ImportOutlined, CloudUploadOutlined 
} from '@ant-design/icons';

// 1. 导入注册表和缓存
import { registerCustomCells, SHAPE_LIBRARY } from '../../graph/cells/registry';

const { Content, Sider } = Layout;
const { TextArea } = Input;
const { Title, Text } = Typography;
const { Option } = Select;
const { Panel } = Collapse;

// 默认 SVG 模板
const DEFAULT_SVG = `<svg viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="black" stroke-width="2">
  <rect x="10" y="10" width="180" height="80" rx="20" ry="20" fill="white" />
  <line x1="10" y1="50" x2="190" y2="50" stroke="#1890ff" stroke-dasharray="4 2" />
</svg>`;

interface PortConfig {
  id: string;
  group: string;
  x: number;
  y: number;
  desc: string;
  region: string;
  dir: 'in' | 'out' | 'bi';
}

interface ViewBox {
  x: number;
  y: number;
  w: number;
  h: number;
}

// [修改] 预置设备类型列表，增加疏水阀、手动阀等细分类型
const EQUIPMENT_TYPES = [
  { value: 'Reactor', label: '反应器 (Reactor)', prefix: 'R' },
  { value: 'Exchanger', label: '换热器 (Exchanger)', prefix: 'E' },
  { value: 'Evaporator', label: '蒸发器 (Evaporator)', prefix: 'E' },
  { value: 'Tank', label: '储罐 (Tank)', prefix: 'V' },
  { value: 'Pump', label: '泵 (Pump)', prefix: 'P' },
  { value: 'Compressor', label: '压缩机 (Compressor)', prefix: 'C' },
  { value: 'Fan', label: '风机 (Fan)', prefix: 'K' },
  
  // 阀门类细分
  { value: 'Valve', label: '通用阀门 (Valve)', prefix: 'V' },
  { value: 'ControlValve', label: '调节阀 (ControlValve)', prefix: 'FV' },
  { value: 'ManualValve', label: '手动阀 (ManualValve)', prefix: 'HV' },
  { value: 'Trap', label: '疏水阀 (Trap)', prefix: 'S' },
  
  { value: 'Instrument', label: '仪表 (Instrument)', prefix: 'PI' },
  { value: 'Fitting', label: '管件 (Fitting)', prefix: '' },
  { value: 'Other', label: '其他 (Other)', prefix: 'M' },
];

const ShapeDesigner: React.FC = () => {
  const [svgInput, setSvgInput] = useState(DEFAULT_SVG);
  const [ports, setPorts] = useState<PortConfig[]>([]);
  const [selectedPortId, setSelectedPortId] = useState<string | null>(null);
  
  const [nodeType, setNodeType] = useState('Reactor');
  const [nodeTag, setNodeTag] = useState('R-New');
  
  const [showGrid, setShowGrid] = useState(true);
  const [zoom, setZoom] = useState(1.0);

  // 画布显示的物理尺寸 (px)
  const [containerSize, setContainerSize] = useState({ w: 600, h: 300 });
  
  // 原始尺寸状态 (对应 SVG 的 width/height 属性)
  const [originalSize, setOriginalSize] = useState({ w: 100, h: 100 });

  // SVG 内部逻辑尺寸 (viewBox)
  const [svgViewBox, setSvgViewBox] = useState<ViewBox>({ x: 0, y: 0, w: 100, h: 100 });
  
  // 鼠标当前的 SVG 坐标
  const [mouseSvgPos, setMouseSvgPos] = useState<{x: number, y: number} | null>(null);

  // 网格捕捉设置
  const [enableSnap, setEnableSnap] = useState(true);
  const [gridSize, setGridSize] = useState(10); 

  const imgContainerRef = useRef<HTMLDivElement>(null);
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const [form] = Form.useForm();

  // 2. 新增 state：用于选择已有图元
  const [selectedLibraryShape, setSelectedLibraryShape] = useState<string | null>(null);
  
  // [新增] 用于强制刷新 UI 的状态
  const [libraryTick, setLibraryTick] = useState(0);

  // [新增] 封装刷新逻辑
  const refreshLibrary = () => {
    try {
      // 重新注册，确保 SHAPE_LIBRARY 被填充 (应对 HMR 重置的问题)
      registerCustomCells();
      // 强制触发 React 重渲染
      setLibraryTick(t => t + 1);
      console.log('Library refreshed, count:', Object.keys(SHAPE_LIBRARY).length);
    } catch (e) {
      console.warn('Registry load warning', e);
    }
  };

  // [修改] 初始化：使用 refreshLibrary
  useEffect(() => {
    refreshLibrary();
  }, []);

  // [新增] 核心逻辑：加载已有图元
  const handleLoadFromLibrary = (shapeId: string) => {
    const config = SHAPE_LIBRARY[shapeId];
    if (!config) {
      message.error('未找到该图元配置');
      return;
    }

    // 1. 恢复 SVG
    if (config.rawSvg) {
      setSvgInput(config.rawSvg);
    }

    // 2. 恢复尺寸
    const w = config.width || 100;
    const h = config.height || 100;
    setOriginalSize({ w, h });
    setContainerSize({ w, h });

    // 3. 恢复基础信息
    if (config.data) {
      setNodeType(config.data.type || 'Equipment');
      // 尝试从 shapeId 恢复 tag (例如 p-reactor -> Reactor)
      // 或者直接用 config.data.tag
      setNodeTag(config.data.tag || shapeId.replace('p-', '').toUpperCase());
    }

    // 4. 恢复端口
    if (config.ports && Array.isArray(config.ports.items)) {
      const restoredPorts: PortConfig[] = config.ports.items.map((item: any) => {
        // 解析 args: { x: '50%', y: '100%' } -> 50, 100
        let x = 0;
        let y = 0;
        
        if (item.args) {
          if (typeof item.args.x === 'string' && item.args.x.includes('%')) {
            x = parseFloat(item.args.x);
          } else {
            x = Number(item.args.x);
          }
          
          if (typeof item.args.y === 'string' && item.args.y.includes('%')) {
            y = parseFloat(item.args.y);
          } else {
            y = Number(item.args.y);
          }
        }

        return {
          id: item.id,
          group: item.group || 'default',
          x: isNaN(x) ? 0 : x,
          y: isNaN(y) ? 0 : y,
          desc: item.data?.desc || item.attrs?.circle?.title || '未命名端口',
          region: item.data?.region || 'ShellSide',
          dir: item.data?.dir || 'bi'
        };
      });
      
      setPorts(restoredPorts);
      message.success(`已加载图元: ${shapeId}`);
    } else {
      setPorts([]);
      message.info(`已加载图元: ${shapeId} (无端口)`);
    }
    
    setSelectedLibraryShape(shapeId);
  };

  // [新增] 保存到项目
  const handleSaveToProject = async () => {
    if (!nodeTag) {
      message.error('请输入 Tag 作为文件名');
      return;
    }

    // 1. 构造文件名 (使用 shapeName，例如 p-reactor)
    const cleanTag = nodeTag.replace(/[-_]/g, '').toLowerCase();
    const fileName = `p-${cleanTag}`; // 例如 p-r101

    // 2. 构造 JSON 配置内容
    const jsonContent = {
      width: originalSize.w,
      height: originalSize.h,
      ports: {
        groups: {
            // 收集所有用到的 group
            ...Array.from(new Set(ports.map(p => p.group))).reduce((acc, g) => ({
                ...acc,
                [g]: { position: 'absolute', attrs: { circle: { r: 3, magnet: true, stroke: '#FFFFFF', strokeWidth: 1, fill: '#e3dedeff' } } }
            }), {})
        },
        items: ports.map(p => ({
          id: p.id,
          group: p.group,
          args: { x: `${p.x}%`, y: `${p.y}%` },
          data: { desc: p.desc, region: p.region, dir: p.dir }
        }))
      },
      data: {
        type: nodeType,
        tag: nodeTag,
        spec: 'Spec...' 
      }
    };

    try {
      const response = await fetch('/_api/save-shape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          filename: fileName,
          svgContent: svgInput,
          jsonContent: jsonContent
        })
      });

      const res = await response.json();
      if (res.success) {
        message.success(`保存成功！文件已写入: src/graph/cells/data/${fileName}.json`);
        
        // [新增] 延迟自动刷新，等待 Vite HMR 完成
        message.loading({ content: '正在同步图元库...', key: 'sync_lib' });
        setTimeout(() => {
          refreshLibrary();
          message.success({ content: '图元库已同步', key: 'sync_lib' });
        }, 1500);

      } else {
        message.error('保存失败: ' + res.message);
      }
    } catch (e) {
      message.error('网络请求失败，请确保 Vite 插件已配置');
    }
  };

  // 解析 SVG viewBox 和 原始尺寸
  useEffect(() => {
    try {
      const parser = new DOMParser();
      const doc = parser.parseFromString(svgInput, 'image/svg+xml');
      const svg = doc.querySelector('svg');
      
      if (!svg) return;

      let vb = { x: 0, y: 0, w: 100, h: 100 };
      const viewBoxAttr = svg.getAttribute('viewBox');

      if (viewBoxAttr) {
        const parts = viewBoxAttr.split(/[\s,]+/).filter(Boolean).map(Number);
        if (parts.length === 4) { 
          vb = { x: parts[0], y: parts[1], w: parts[2], h: parts[3] };
        }
      } else {
        const attrW = parseFloat(svg.getAttribute('width') || '100');
        const attrH = parseFloat(svg.getAttribute('height') || '100');
        vb = { x: 0, y: 0, w: attrW, h: attrH };
      }
      setSvgViewBox(vb);

      // 优先读取 width/height 属性，如果没有则回退到 viewBox
      const rawW = parseFloat(svg.getAttribute('width') || String(vb.w));
      const rawH = parseFloat(svg.getAttribute('height') || String(vb.h));
      setOriginalSize({ w: rawW, h: rawH });

    } catch (e) {
      console.warn('SVG Parse Warning:', e);
    }
  }, [svgInput]);

  // 居中规整化
  const normalizeDimensions = () => {
    try {
      const parser = new DOMParser();
      const doc = parser.parseFromString(svgInput, 'image/svg+xml');
      const svg = doc.querySelector('svg');
      
      if (!svg) {
        message.error('无法解析 SVG');
        return;
      }

      let oldVb = { x: 0, y: 0, w: originalSize.w, h: originalSize.h };
      const currentVBAttr = svg.getAttribute('viewBox');
      if (currentVBAttr) {
        const parts = currentVBAttr.split(/[\s,]+/).filter(Boolean).map(Number);
        if (parts.length === 4) {
          oldVb = { x: parts[0], y: parts[1], w: parts[2], h: parts[3] };
        }
      }

      let newW = Math.round(oldVb.w / 10) * 10;
      let newH = Math.round(oldVb.h / 10) * 10;
      if (newW === 0) newW = 10;
      if (newH === 0) newH = 10;

      const diffW = newW - oldVb.w;
      const diffH = newH - oldVb.h;
      
      const newVbX = oldVb.x - (diffW / 2);
      const newVbY = oldVb.y - (diffH / 2);

      svg.setAttribute('width', String(newW));
      svg.setAttribute('height', String(newH));
      svg.setAttribute('viewBox', `${newVbX.toFixed(2)} ${newVbY.toFixed(2)} ${newW} ${newH}`);

      const serializer = new XMLSerializer();
      const newSvgStr = serializer.serializeToString(doc);

      setSvgInput(newSvgStr);
      setOriginalSize({ w: newW, h: newH });
      setContainerSize({ w: newW, h: newH }); 
      
      message.success(`SVG 已居中规整: ${oldVb.w.toFixed(1)}x${oldVb.h.toFixed(1)} -> ${newW}x${newH}`);

    } catch (e) {
      console.error(e);
      message.error('规整化失败，请检查 SVG 格式');
    }
  };

  // 一键匹配比例
  const fitAspectRatio = () => {
    const ratio = svgViewBox.h / svgViewBox.w;
    const newH = Math.round(containerSize.w * ratio);
    setContainerSize(prev => ({ ...prev, h: newH }));
    message.success(`画布比例已调整为 ${containerSize.w}x${newH}`);
  };

  // 处理滚轮缩放
  const handleWheel = (e: React.WheelEvent) => {
    if (e.ctrlKey || e.metaKey) {
      e.preventDefault();
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      const newZoom = Math.max(0.5, Math.min(5.0, zoom + delta));
      setZoom(parseFloat(newZoom.toFixed(1)));
    }
  };

  // 计算鼠标在 SVG 逻辑坐标系中的位置
  const getSvgCoordinates = (clientX: number, clientY: number) => {
    if (!imgContainerRef.current) return { x: 0, y: 0 };
    const rect = imgContainerRef.current.getBoundingClientRect();
    
    const relX = (clientX - rect.left) / rect.width;
    const relY = (clientY - rect.top) / rect.height;

    const svgX = svgViewBox.x + (relX * svgViewBox.w);
    const svgY = svgViewBox.y + (relY * svgViewBox.h);

    return { x: svgX, y: svgY };
  };

  const handleMouseMove = (e: React.MouseEvent) => {
    const coords = getSvgCoordinates(e.clientX, e.clientY);
    setMouseSvgPos({ 
      x: Math.round(coords.x * 10) / 10, 
      y: Math.round(coords.y * 10) / 10 
    });
  };

  // 智能百分比取整
  const smartRoundPercent = (val: number) => {
    if (val < 0.5) return 0;
    if (val > 99.5) return 100;
    const rounded = Math.round(val);
    if (Math.abs(val - rounded) < 0.5) return rounded;
    const halfRounded = Math.round(val * 2) / 2;
    if (Math.abs(val - halfRounded) < 0.25) return halfRounded;
    return Number(val.toFixed(2));
  };

  const handleCanvasClick = (e: React.MouseEvent) => {
    if (!imgContainerRef.current) return;
    if ((e.target as HTMLElement).closest('.port-dot')) return;

    let { x: svgX, y: svgY } = getSvgCoordinates(e.clientX, e.clientY);

    if (enableSnap) {
      const relativeX = svgX - svgViewBox.x;
      const relativeY = svgY - svgViewBox.y;

      const snappedRelX = Math.round(relativeX / gridSize) * gridSize;
      const snappedRelY = Math.round(relativeY / gridSize) * gridSize;

      svgX = svgViewBox.x + snappedRelX;
      svgY = svgViewBox.y + snappedRelY;
    }

    let pctX = ((svgX - svgViewBox.x) / svgViewBox.w) * 100;
    let pctY = ((svgY - svgViewBox.y) / svgViewBox.h) * 100;

    pctX = smartRoundPercent(pctX);
    pctY = smartRoundPercent(pctY);

    pctX = Math.max(0, Math.min(100, pctX));
    pctY = Math.max(0, Math.min(100, pctY));

    const newPort: PortConfig = {
      id: `p${ports.length + 1}`,
      group: 'all',
      x: pctX,
      y: pctY,
      desc: '新接口',
      region: 'ShellSide',
      dir: 'bi'
    };

    setPorts([...ports, newPort]);
    setSelectedPortId(newPort.id);
    form.setFieldsValue(newPort);
  };

  const handleFormChange = (_changedValues: any, allValues: any) => {
    if (!selectedPortId) return;
    setPorts(ports.map(p => p.id === selectedPortId ? { ...p, ...allValues } : p));
  };

  const handleDeletePort = (id: string) => {
    setPorts(ports.filter(p => p.id !== id));
    if (selectedPortId === id) setSelectedPortId(null);
  };

  const handleTypeChange = (value: string) => {
    setNodeType(value);
    const typeInfo = EQUIPMENT_TYPES.find(t => t.value === value);
    if (typeInfo && typeInfo.prefix) {
      setNodeTag(`${typeInfo.prefix}-New`);
    }
  };

  const generateCode = () => {
    const cleanTag = nodeTag.replace(/[-_]/g, '').toLowerCase();
    const varName = `${cleanTag}Svg`;
    const fileName = `${nodeTag}.svg`;
    const shapeName = `p-${nodeTag.toLowerCase()}`;

    const groups = Array.from(new Set(ports.map(p => p.group)));
    const groupsStr = groups.map(g => `        ${g}: { position: 'absolute', attrs: PORT_ATTRS }`).join(',\n');
    const itemsStr = ports.map(p => 
      `        { id: '${p.id}', group: '${p.group}', args: { x: '${p.x}%', y: '${p.y}%' }, data: { desc: '${p.desc}', region: '${p.region}', dir: '${p.dir}' } as PortData }`
    ).join(',\n');

    const neo4jLabels = nodeType === 'Instrument' 
      ? `['Instrument']` 
      : `['Equipment', '${nodeType}']`;

    return `/** 
 * ============================================================
 * 步骤 1: 创建 SVG 文件
 * 路径: src/graph/cells/svgs/${fileName}
 * 内容: (请复制左侧 SVG 源码)
 * ============================================================
 */

// ============================================================
// 步骤 2: 在 src/graph/cells/registry.ts 顶部添加导入
// ============================================================
import ${varName} from './svgs/${fileName}?raw';

// ============================================================
// 步骤 3: 在 registerCustomCells() 函数内部添加注册
// ============================================================
Graph.registerNode('${shapeName}', {
  inherit: 'image',
  width: ${originalSize.w}, 
  height: ${originalSize.h},
  imageUrl: svgToDataUrl(${varName}),
  ports: {
    groups: {
${groupsStr}
    },
    items: [
${itemsStr}
    ],
  },
  attrs: LABEL_ATTRS,
  data: { 
    type: '${nodeType}', 
    tag: '${nodeTag}', 
    spec: 'Spec...',
  },
});

// ============================================================
// 步骤 4: 在 src/services/neo4j.ts 的 TYPE_MAPPING 中添加映射
// ============================================================
// const TYPE_MAPPING: Record<string, string[]> = {
//   ...
  '${nodeType}': ${neo4jLabels},
//   ...
// };

// ============================================================
// 步骤 5: 在 src/services/neo4j.ts 的 loadGraphData switch 中添加
// ============================================================
// switch (props.type) {
//   ...
  case '${nodeType}': shapeName = '${shapeName}'; break;
//   ...
// }`;
  };

  return (
    <Layout style={{ height: '100vh', background: '#fff' }}>
      <Sider width={380} style={{ background: '#fff', borderRight: '1px solid #eee', padding: 16, overflowY: 'auto' }}>
        
        {/* [修改] 加载已有图元区域：增加刷新按钮 */}
        <div style={{ background: '#f0f5ff', padding: 12, borderRadius: 6, marginBottom: 16, border: '1px solid #adc6ff' }}>
          <div style={{ fontWeight: 'bold', marginBottom: 8, color: '#2f54eb', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <span><ImportOutlined /> 加载已有图元修改</span>
            <Tooltip title="刷新列表 (保存后如果列表为空请点击)">
              <Button type="text" size="small" icon={<ReloadOutlined />} onClick={() => { refreshLibrary(); message.success('列表已刷新'); }} />
            </Tooltip>
          </div>
          <Select
            showSearch
            style={{ width: '100%' }}
            placeholder="选择已注册的图元..."
            optionFilterProp="children"
            onChange={handleLoadFromLibrary}
            value={selectedLibraryShape}
            // [关键] 依赖 libraryTick 强制重新计算 options
            options={Object.keys(SHAPE_LIBRARY).map(key => ({
              value: key,
              label: `${key} (${SHAPE_LIBRARY[key].data?.type || 'Unknown'})`
            }))}
            filterOption={(input, option) =>
              (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
            }
          />
        </div>

        <Title level={4}>1. SVG 源码</Title>
        <TextArea 
          rows={4} 
          value={svgInput} 
          onChange={e => setSvgInput(e.target.value)} 
          placeholder="在此粘贴 SVG 代码..."
        />
        <div style={{ marginTop: 8, display: 'flex', flexDirection: 'column', gap: 4 }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: 12, color: '#666' }}>
            <span>
              原始尺寸: {Number(originalSize.w).toFixed(1)} x {Number(originalSize.h).toFixed(1)}
            </span>
            <Tooltip title="居中规整化：将尺寸调整为 10 的倍数，并保持内容居中不拉伸">
              <Button size="small" type="primary" ghost icon={<AimOutlined />} onClick={normalizeDimensions}>
                规整化
              </Button>
            </Tooltip>
          </div>
          <div style={{ fontSize: 12, color: '#999' }}>
            ViewBox: {svgViewBox.x}, {svgViewBox.y}, {svgViewBox.w}, {svgViewBox.h}
          </div>
          <Button 
            size="small" 
            icon={<FileAddOutlined />} 
            onClick={() => {
              navigator.clipboard.writeText(svgInput);
              message.success('SVG 源码已复制');
            }}
            block
            style={{ marginTop: 4 }}
          >
            复制 SVG 源码
          </Button>
        </div>
        
        <Divider />
        
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10 }}>
          <Title level={4} style={{ margin: 0 }}>3. 端口属性</Title>
          <Tooltip title="点击查看详细说明">
            <InfoCircleOutlined style={{ color: '#1890ff' }} />
          </Tooltip>
        </div>

        <Collapse ghost size="small" style={{ marginBottom: 16, background: '#f9f9f9', borderRadius: 4 }}>
          <Panel header="配置指南 (必读)" key="1">
            <Text type="secondary" style={{ fontSize: 12 }}>
              <ul style={{ paddingLeft: 16, margin: 0 }}>
                <li><b>Group</b>: 视觉分组 (如 top, left)，仅用于代码组织。</li>
                <li><b>Region</b>: <b>AI 语义核心</b>。
                  <ul style={{ marginTop: 4 }}>
                    <li><code>ShellSide</code>: 壳程/主容器</li>
                    <li><code>TubeSide</code>: 管程</li>
                    <li><code>Jacket</code>: 夹套</li>
                  </ul>
                </li>
                <li><b>Dir</b>: 流向。In 只能连 Out。</li>
              </ul>
            </Text>
          </Panel>
        </Collapse>

        {selectedPortId ? (
          <Form form={form} layout="vertical" onValuesChange={handleFormChange} initialValues={ports.find(p => p.id === selectedPortId)}>
            <Row gutter={8}>
              <Col span={12}>
                <Form.Item name="id" label="ID" tooltip="端口唯一标识，如 n1, n2"><Input /></Form.Item>
              </Col>
              <Col span={12}>
                <Form.Item name="group" label="Group" tooltip="视觉分组，如 top, left"><Input /></Form.Item>
              </Col>
            </Row>
            <Form.Item name="desc" label="描述 (语义)"><Input placeholder="例如：壳程入口" /></Form.Item>
            <Form.Item name="region" label="区域 (Region)" extra={<span style={{fontSize: 12, color: '#faad14'}}>AI 分析最重要的字段</span>}>
              <Select>
                <Option value="ShellSide">ShellSide (壳程/主容器)</Option>
                <Option value="ShellSide:Vapor">ShellSide:Vapor (气相区)</Option>
                <Option value="ShellSide:Liquid">ShellSide:Liquid (液相区)</Option>
                <Option value="TubeSide">TubeSide (管程/换热管)</Option>
                <Option value="Jacket">Jacket (夹套)</Option>
                <Option value="InnerVessel">InnerVessel (内胆)</Option>
              </Select>
            </Form.Item>
            <Form.Item name="dir" label="流向 (Direction)">
              <Select>
                <Option value="in">In (入口)</Option>
                <Option value="out">Out (出口)</Option>
                <Option value="bi">Bi (双向)</Option>
              </Select>
            </Form.Item>
            <Button danger icon={<DeleteOutlined />} onClick={() => handleDeletePort(selectedPortId)} block>删除此端口</Button>
          </Form>
        ) : (
          <div style={{ height: 200, display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', border: '1px dashed #d9d9d9', borderRadius: 4, background: '#fafafa' }}>
            <QuestionCircleOutlined style={{ fontSize: 24, color: '#ccc', marginBottom: 8 }} />
            <Text type="secondary">请在右侧图上点击红点选中</Text>
          </div>
        )}
      </Sider>

      <Content style={{ display: 'flex', flexDirection: 'column', background: '#f0f2f5', height: '100%', overflow: 'hidden' }}>
        {/* 工具栏 */}
        <div style={{ 
          padding: '8px 24px', background: '#fff', borderBottom: '1px solid #eee', 
          display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexShrink: 0, flexWrap: 'wrap', gap: 8
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
            <Title level={4} style={{ margin: 0 }}>2. 可视化打桩</Title>
            
            {/* 画布尺寸设置 */}
            <Space size="small" style={{ borderLeft: '1px solid #eee', paddingLeft: 16 }}>
              <Text type="secondary" style={{ fontSize: 12 }}>画布:</Text>
              <InputNumber 
                size="small" 
                value={containerSize.w} 
                onChange={v => setContainerSize(s => ({ ...s, w: v || 100 }))} 
                style={{ width: 60 }} 
              />
              <Text type="secondary">x</Text>
              <InputNumber 
                size="small" 
                value={containerSize.h} 
                onChange={v => setContainerSize(s => ({ ...s, h: v || 100 }))} 
                style={{ width: 60 }} 
              />
              <Tooltip title="调整画布高度以匹配 SVG 比例 (防止变形)">
                <Button size="small" icon={<ColumnHeightOutlined />} onClick={fitAspectRatio}>适应比例</Button>
              </Tooltip>
            </Space>

            {/* 网格捕捉设置 */}
            <Space size="small" style={{ borderLeft: '1px solid #eee', paddingLeft: 16 }}>
              <Checkbox checked={enableSnap} onChange={e => setEnableSnap(e.target.checked)}>
                SVG 坐标捕捉
              </Checkbox>
              <InputNumber 
                size="small" 
                value={gridSize} 
                onChange={v => setGridSize(v || 10)} 
                style={{ width: 50 }} 
                disabled={!enableSnap}
                min={0.1}
                step={1}
              />
              <Text type="secondary" style={{ fontSize: 12 }}>units</Text>
            </Space>
          </div>
          
          <Space>
            <Checkbox checked={showGrid} onChange={e => setShowGrid(e.target.checked)}>
              网格
            </Checkbox>
            <Space>
              <Button icon={<ZoomOutOutlined />} onClick={() => setZoom(z => Math.max(0.5, z - 0.1))} />
              <Slider 
                min={0.5} max={5.0} step={0.1} 
                value={zoom} 
                onChange={val => setZoom(val)} 
                style={{ width: 100 }} 
                tooltip={{ formatter: (val) => `${Math.round((val || 1) * 100)}%` }}
              />
              <Button icon={<ZoomInOutlined />} onClick={() => setZoom(z => Math.min(5.0, z + 0.1))} />
              <Button icon={<ReloadOutlined />} onClick={() => setZoom(1.0)}>1:1</Button>
            </Space>
          </Space>
        </div>

        {/* 滚动容器 (Outer Scroll View) */}
        <div 
          ref={scrollContainerRef}
          style={{ 
            flex: 1, 
            overflow: 'auto', 
            display: 'flex',  
            padding: 20,      
            background: '#e6e6e6' 
          }}
          onWheel={handleWheel}
        >
          {/* 画布本体 */}
          <div 
            style={{ 
              width: containerSize.w * zoom, 
              height: containerSize.h * zoom, 
              border: '1px solid #999', 
              position: 'relative',
              backgroundColor: '#fff',
              cursor: 'crosshair',
              boxShadow: '0 8px 24px rgba(0,0,0,0.15)',
              transition: 'width 0.1s, height 0.1s',
              flexShrink: 0, 
              margin: 'auto' 
            }}
            ref={imgContainerRef}
            onClick={handleCanvasClick}
            onMouseMove={handleMouseMove}
            onMouseLeave={() => setMouseSvgPos(null)}
          >
            <img 
              src={`data:image/svg+xml;utf8,${encodeURIComponent(svgInput)}`}
              style={{
                width: '100%',
                height: '100%',
                display: 'block',
                pointerEvents: 'none',
                userSelect: 'none',
                objectFit: 'fill' 
              }}
              draggable={false}
              alt="SVG Preview"
            />

            {showGrid && (
              <div style={{
                position: 'absolute', top: 0, left: 0, right: 0, bottom: 0,
                pointerEvents: 'none', zIndex: 1,
                backgroundImage: `
                  linear-gradient(to right, rgba(0,0,0,0.1) 1px, transparent 1px),
                  linear-gradient(to bottom, rgba(0,0,0,0.1) 1px, transparent 1px)
                `,
                backgroundSize: `${(containerSize.w / originalSize.w) * gridSize * zoom}px ${(containerSize.h / originalSize.h) * gridSize * zoom}px`
              }} />
            )}

            {ports.map(port => (
              <div
                key={port.id}
                className="port-dot"
                onClick={(e) => {
                  e.stopPropagation();
                  setSelectedPortId(port.id);
                  form.setFieldsValue(port);
                }}
                style={{
                  position: 'absolute',
                  left: `${port.x}%`,
                  top: `${port.y}%`,
                  width: 12,
                  height: 12,
                  borderRadius: '50%',
                  background: selectedPortId === port.id ? '#1890ff' : 'red',
                  border: '2px solid white',
                  transform: 'translate(-50%, -50%)',
                  cursor: 'pointer',
                  boxShadow: '0 2px 4px rgba(0,0,0,0.2)',
                  zIndex: 10
                }}
                title={`${port.id}: ${port.desc}`}
              >
                <div style={{ position: 'absolute', top: -20, left: '50%', transform: 'translateX(-50%)', fontSize: 10, background: 'rgba(0,0,0,0.7)', color: '#fff', padding: '0 4px', borderRadius: 2, whiteSpace: 'nowrap' }}>
                  {port.id}
                </div>
              </div>
            ))}
          </div>
        </div>
        
        <div style={{ padding: '4px 24px', background: '#fff', borderTop: '1px solid #eee', fontSize: 12, color: '#666', display: 'flex', justifyContent: 'space-between' }}>
          <span>
            {mouseSvgPos && `SVG 坐标: X=${mouseSvgPos.x}, Y=${mouseSvgPos.y}`}
          </span>
          <span>
            当前设计尺寸: {containerSize.w}x{containerSize.h}px (显示比例: {(zoom * 100).toFixed(0)}%)
          </span>
        </div>
      </Content>

      <Sider width={400} style={{ background: '#fff', borderLeft: '1px solid #eee', padding: 16 }}>
        <Title level={4}>4. 生成代码</Title>
        <div style={{ marginBottom: 16 }}>
          <div style={{ marginBottom: 8, display: 'flex', alignItems: 'center' }}>
            <span style={{ width: 60, display: 'inline-block', color: 'rgba(0, 0, 0, 0.88)' }}>Type:</span>
            <Select 
              value={nodeType} 
              onChange={handleTypeChange} 
              style={{ flex: 1 }}
              showSearch
              optionFilterProp="label"
            >
              {EQUIPMENT_TYPES.map(t => (
                <Option key={t.value} value={t.value} label={t.label}>
                  {t.label}
                </Option>
              ))}
            </Select>
          </div>
          <Input addonBefore="Tag" value={nodeTag} onChange={e => setNodeTag(e.target.value)} placeholder="如 R-101" />
        </div>
        <TextArea 
          value={generateCode()} 
          autoSize={{ minRows: 20, maxRows: 30 }} 
          style={{ fontFamily: 'monospace', fontSize: 12, background: '#f5f5f5' }} 
        />
        
        {/* [新增] 保存到项目按钮 */}
        <div style={{ marginTop: 16, display: 'flex', gap: 8 }}>
          <Button type="primary" icon={<CopyOutlined />} onClick={() => {
            navigator.clipboard.writeText(generateCode());
            message.success('完整注册代码已复制');
          }} style={{ flex: 1 }}>
            复制完整代码
          </Button>
          <Button type="primary" danger icon={<CloudUploadOutlined />} onClick={handleSaveToProject} style={{ flex: 1 }}>
            保存到项目
          </Button>
        </div>
        <div style={{ marginTop: 8, fontSize: 12, color: '#999' }}>
          * 保存到项目将直接写入 src/graph/cells 下的 svgs 和 data 目录，刷新页面即可生效。
        </div>
      </Sider>
    </Layout>
  );
};

export default ShapeDesigner;
</file>

<file path="src/components/Editor/ContextMenu/index.tsx">
import React from 'react';
import { 
  DeleteOutlined, 
  CopyOutlined, 
  SnippetsOutlined, 
  InfoCircleOutlined, 
  ClearOutlined,
  RotateRightOutlined 
} from '@ant-design/icons';
import './index.css';

export interface MenuState {
  visible: boolean;
  x: number;
  y: number;
  type: 'node' | 'edge' | 'blank' | null;
  cellId?: string;
}

interface ContextMenuProps {
  visible: boolean;
  x: number;
  y: number;
  type: 'node' | 'edge' | 'blank' | null;
  onClose: () => void;
  onAction: (action: string) => void;
}

const ContextMenu: React.FC<ContextMenuProps> = ({ visible, x, y, type, onClose, onAction }) => {
  if (!visible) return null;

  const handleItemClick = (action: string) => {
    // 使用 try-catch 包裹 action 执行，防止报错阻止菜单关闭
    try {
      onAction(action);
    } catch (e) {
      console.error('Menu action failed:', e);
    } finally {
      // 无论成功失败，都延迟关闭菜单
      setTimeout(() => {
        onClose();
      }, 100);
    }
  };

  return (
    <>
      <div 
        style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, zIndex: 9998 }} 
        onClick={(e) => { e.stopPropagation(); onClose(); }} 
        onContextMenu={(e) => { e.preventDefault(); onClose(); }}
      />
      
      <div 
        className="context-menu" 
        style={{ left: x, top: y }}
        onClick={(e) => e.stopPropagation()}
      >
        {/* --- 选中节点/连线 --- */}
        {(type === 'node' || type === 'edge') && (
          <>
            <div className="context-menu-item" onClick={() => handleItemClick('copy')}>
              <CopyOutlined /> 复制
            </div>

            {/* 仅节点显示粘贴和旋转 */}
            {type === 'node' && (
              <>
                <div className="context-menu-item" onClick={() => handleItemClick('paste')}>
                  <SnippetsOutlined /> 粘贴
                </div>
                <div className="context-menu-item" onClick={() => handleItemClick('rotate')}>
                  <RotateRightOutlined /> 旋转 90°
                </div>
              </>
            )}
            
            <div className="context-menu-divider" />
            
            <div className="context-menu-item" onClick={() => handleItemClick('property')}>
              <InfoCircleOutlined /> 属性详情
            </div>
            <div className="context-menu-item danger" onClick={() => handleItemClick('delete')}>
              <DeleteOutlined /> 删除
            </div>
          </>
        )}

        {/* --- 空白处 --- */}
        {type === 'blank' && (
          <>
            <div className="context-menu-item" onClick={() => handleItemClick('paste')}>
              <SnippetsOutlined /> 粘贴
            </div>
            <div className="context-menu-divider" />
            <div className="context-menu-item" onClick={() => handleItemClick('fit')}>
              <InfoCircleOutlined /> 适应画布
            </div>
            <div className="context-menu-item danger" onClick={() => handleItemClick('clear')}>
              <ClearOutlined /> 清空所有
            </div>
          </>
        )}
      </div>
    </>
  );
};

export default ContextMenu;
</file>

<file path="src/graph/cells/svgs/E-13.svg">
<svg xmlns="http://www.w3.org/2000/svg" width="1000" height="450" viewBox="0 0 1000 450" fill="none" stroke="black" stroke-width="2">
  <defs>
    <!-- 定义主罐体轮廓路径 (左侧封头已镜像为向外凸) -->
    <path id="vessel-body" d="M100,25 L700,25 A50,200 0 0,1 700,425 L100,425 A50,200 0 0,1 100,25 Z" />
    
    <!-- 定义液位剪切蒙版 -->
    <clipPath id="liquid-clip">
      <use href="#vessel-body" />
    </clipPath>
  </defs>

  <g>
    <!-- 1. 右侧加热器 (Heater) - 底层 -->
    <rect x="500" y="250" width="310" height="150" fill="white" stroke="#000000" stroke-width="2"/>
    <line x1="810" y1="245" x2="810" y2="405" stroke-width="4" />
    <rect x="810" y="250" width="40" height="150" fill="white" stroke="#000000" stroke-width="2"/>
    <path d="M850,250 A40,75 0 0,1 850,400" fill="white" stroke="#000000" stroke-width="2"/>
    <line x1="810" y1="325" x2="890" y2="325" stroke-width="2" />
    
    <g stroke="#000000" stroke-width="1" opacity="0.6">
      <line x1="510" y1="270" x2="810" y2="270" />
      <line x1="510" y1="290" x2="810" y2="290" />
      <line x1="510" y1="310" x2="810" y2="310" />
      <line x1="510" y1="330" x2="810" y2="330" />
      <line x1="510" y1="350" x2="810" y2="350" />
      <line x1="510" y1="370" x2="810" y2="370" />
    </g>

    <!-- 2. 主罐体 (Main Vessel) - 顶层覆盖 -->
    
    <!-- 2.1 罐体背景 -->
    <use href="#vessel-body" fill="white" stroke="none" />
    
    <!-- 2.2 液相示意 (淡蓝色填充) -->
    <!-- 修改：y=225 (即 50% 高度) -->
    <rect x="0" y="225" width="800" height="300" fill="#e6f7ff" stroke="none" clip-path="url(#liquid-clip)" />
    
    <!-- 2.3 液面线 -->
    <!-- 修改：y1=225, y2=225 -->
    <line x1="50" y1="225" x2="750" y2="225" stroke="#1890ff" stroke-width="1" stroke-dasharray="4 2" clip-path="url(#liquid-clip)" />

    <!-- 2.4 罐体轮廓描边 -->
    <use href="#vessel-body" fill="none" stroke="black" stroke-width="2" />
  </g>
</svg>
</file>

<file path="src/graph/cells/svgs/tank-horizontal.svg">
<svg viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="black" stroke-width="2">
  <!-- 1. 基础背景 (白色) -->
  <path d="M20,10 L180,10 A20,40 0 0,1 180,90 L20,90 A20,40 0 0,1 20,10 Z" fill="white" stroke="none" />
  
  <!-- 2. 液相填充 (修正版：覆盖封头) -->
  <!-- 路径: 左顶点(0,50) -> 右顶点(200,50) -> 右下弧线 -> 底部直线 -> 左下弧线 -> 闭合 -->
  <path d="M0,50 L200,50 A20,40 0 0,1 180,90 L20,90 A20,40 0 0,1 0,50 Z" fill="#e6f7ff" stroke="none" />
  
  <!-- 3. 液面线 (贯穿整个宽度) -->
  <line x1="0" y1="50" x2="200" y2="50" stroke="#1890ff" stroke-width="1" stroke-dasharray="4 2" />

  <!-- 4. 外轮廓 -->
  <path d="M20,10 L180,10 A20,40 0 0,1 180,90 L20,90 A20,40 0 0,1 20,10 Z" fill="none" stroke="black" stroke-width="2" />
</svg>
</file>

<file path="src/graph/cells/svgs/tee.svg">
<svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
  <!-- 20x20 画布，中心点在 10 -->
  <path d="M0 10 H20 M10 10 V20" stroke="black" stroke-width="2" stroke-linecap="butt" stroke-linejoin="round"/>
</svg>
</file>

<file path="README.md">
# Chemical P&ID Graph Editor 🏭⚛️

<div align="center">

**连接传统工业图纸与 AI 大模型的桥梁**  
**A Bridge Between Traditional P&ID and Industrial AI Models**

[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
![Tech](https://img.shields.io/badge/Tech-React%20%7C%20AntV%20X6%20%7C%20Neo4j-green)
![AI-Ready](https://img.shields.io/badge/AI-Physics%20Aware%20Graph-orange)

[English](#-english) | [中文](#-中文)

</div>

---

<a name="-english"></a>
## 🇬🇧 English

### 📖 The Story
**This is an open-source project built entirely by a Chemical Industry Expert (with 0 coding background) paired with Google Gemini 3.**

In the digital transformation of the process industry, general LLMs often struggle to understand the complex physical semantics within P&ID drawings (images). For instance, AI finds it difficult to distinguish whether a pipeline connects to the "Shell Side" or "Tube Side" of a heat exchanger, or whether the medium is in a "Vapor" or "Liquid" phase.

This project is not just a drawing tool, but an **Industrial Knowledge Graph Generator**. By utilizing high-fidelity semantic modeling, it converts graphics into structured data containing **Physical Topology** and **Process Logic**, serving as a high-quality data foundation for Industrial RAG (Retrieval-Augmented Generation) and intelligent diagnostics.

### ✨ Core Features

#### 1. 🎨 Professional Visual Editor
*   **Powered by AntV X6**: Delivers a Web-based drag-and-drop experience similar to AutoCAD/Visio.
*   **Smart Routing**: Manhattan orthogonal routing algorithm supporting automatic obstacle avoidance and non-overlapping crossings.
*   **Smart Interaction**: Auto-split pipelines when dragging valves; auto-generate Tapping Points for instruments.

#### 2. 🧠 AI-Native Semantics `NEW`
The graph data generated is designed specifically for AI reasoning, embedding deep physical semantics:
*   **Internal Structure Definition**:
    *   Explicitly distinguishes internal spaces, e.g., **ShellSide** vs. **TubeSide**, **InnerVessel** vs. **Jacket**.
    *   *AI Scenario*: Analyzing heat exchange efficiency or mixing logic.
*   **Phase Awareness**:
    *   Ports carry phase information, e.g., **ShellSide:Vapor** vs. **ShellSide:Liquid**.
    *   *AI Scenario*: Detecting "Dry Run" risks (e.g., ensuring heaters are submerged in liquid) or validating venting/draining logic.
*   **Strict Taxonomy**:
    *   Strictly distinguishes between **Equipment** and **Instrument** in the graph database.
    *   *AI Scenario*: Rapid control loop extraction or asset statistics.

#### 3. 🔗 Graph Database Sync
One-click synchronization to Neo4j, generating an industrial-standard Knowledge Graph:
*   **Node Labels**: `:Thing`, `:Equipment`, `:Instrument`
*   **Relationship Props**: Includes `fromRegion`, `toRegion`, `fluid`, `material`, etc.

### 🧠 AI Reasoning Examples
Once data is stored in Neo4j, you can use Cypher or LLMs to answer complex engineering questions:

1.  **Material Balance Analysis**:
    > "Query E-13 Evaporator: which pipelines are connected to the Liquid Phase area, and which to the Vapor Phase area?"
2.  **Safety Logic Verification**:
    > "Check all heater connections to verify if their corresponding shell-side region is Liquid Phase (to prevent dry heating)."
3.  **Control Loop Extraction**:
    > "Find all temperature control instruments on R-101 Reactor and their associated control valves."

### 🚀 Quick Start

1.  **Prerequisites**: Node.js (v16+) and Neo4j Desktop.
2.  **Clone Repo**:
    ```bash
    git clone https://github.com/ssnchenfeng-ai/chemical-graph-editor.git
    cd chemical-graph-editor
    ```
3.  **Install Dependencies**:
    ```bash
    npm install
    ```
4.  **Configuration**:
    Copy the example env file:
    ```bash
    # Mac/Linux
    cp .env.example .env

    # Windows (CMD)
    copy .env.example .env
    ```
    Edit `.env` and fill in your Neo4j credentials.
5.  **Run**:
    ```bash
    npm run dev
    ```

---

<a name="-中文"></a>
## 🇨🇳 中文

### 📖 项目背景
**这是一个由化工行业资深从业者（0 编程基础），在 Google Gemini 3 全程辅助下完成的开源项目。**

在工业智能化转型中，通用的 AI 大模型（LLM）往往难以理解 P&ID 图纸中复杂的物理含义。例如，AI 很难区分一条管线是连接到了换热器的“壳程”还是“管程”，也无法判断介质是“气相”还是“液相”。

本项目不仅仅是一个绘图工具，更是一个**工业知识图谱生成器**。它通过高保真的语义建模，将图形转化为包含**物理拓扑**和**工艺逻辑**的结构化数据，为工业 RAG（检索增强生成）和智能诊断提供高质量的数据底座。

### ✨ 核心功能

#### 1. 🎨 专业级可视化绘图
*   **基于 AntV X6**: 实现了类似 AutoCAD/Visio 的 Web 端拖拽体验。
*   **智能路由**: Manhattan 正交路由算法，支持管线自动避让、跨越不穿模。
*   **智能交互**: 拖拽阀门自动打断管线、拖拽仪表自动生成测点（Tapping Point）。

#### 2. 🧠 AI 语义增强 (AI-Native Semantics) `NEW`
本项目生成的图谱数据专为 AI 推理设计，包含深度的物理语义：
*   **精细化腔室定义 (Internal Structure)**:
    *   明确区分设备的内部空间，如 **壳程 (ShellSide)** vs **管程 (TubeSide)**，**釜内 (InnerVessel)** vs **夹套 (Jacket)**。
    *   *AI 应用场景*: 分析热交换效率、判断物料是否混合。
*   **相态感知 (Phase Awareness)**:
    *   端口携带相态信息，如 **气相区 (ShellSide:Vapor)** vs **液相区 (ShellSide:Liquid)**。
    *   *AI 应用场景*: 自动检测“干烧”风险（如加热器未浸没在液相中）、验证排污/放空逻辑。
*   **严格的分类体系 (Strict Taxonomy)**:
    *   在图数据库中严格区分 **设备 (Equipment)** 与 **仪表 (Instrument)**。
    *   *AI 应用场景*: 快速提取控制回路，或进行全厂设备资产统计。

#### 3. 🔗 图数据库同步 (Graph Sync)
一键将画布内容同步至 Neo4j，生成符合工业标准的知识图谱：
*   **节点标签**: `:Thing`, `:Equipment`, `:Instrument`
*   **关系属性**: 包含 `fromRegion` (来源腔室), `toRegion` (目标腔室), `fluid` (介质), `material` (材质) 等。

### 🧠 AI 推理示例
当数据存入 Neo4j 后，您可以使用 Cypher 或让 AI 模型回答以下复杂问题：

1.  **物料平衡分析**:
    > "查询 E-13 蒸发器中，哪些管线连接到了液相区 (ShellSide:Liquid)，哪些连接到了气相区 (ShellSide:Vapor)？"
2.  **安全逻辑验证**:
    > "检查所有加热器接口，确认其对应的壳程区域是否为液相？(防止干烧)"
3.  **控制回路提取**:
    > "找出 R-101 反应釜上所有的温度控制仪表及其关联的调节阀。"

### 🚀 快速开始

1.  **环境准备**: 确保已安装 Node.js (v16+) 和 Neo4j Desktop。
2.  **克隆项目**:
    ```bash
    git clone https://github.com/ssnchenfeng-ai/chemical-graph-editor.git
    cd chemical-graph-editor
    ```
3.  **安装依赖**:
    ```bash
    npm install
    ```
4.  **配置数据库**:
    复制环境变量模板文件：
    ```bash
    # Mac/Linux
    cp .env.example .env

    # Windows (CMD)
    copy .env.example .env
    ```
    打开 `.env` 文件，填入你的 Neo4j 数据库连接信息：
    ```ini
    VITE_NEO4J_URI=bolt://localhost:7687
    VITE_NEO4J_USER=neo4j
    VITE_NEO4J_PASSWORD=你的数据库密码
    ```
5.  **启动项目**:
    ```bash
    npm run dev
    ```
    浏览器访问 `http://localhost:5173` 即可开始使用。

### 📸 演示截图 (Screenshots)

<div align="center">
    <!-- GitHub 读取图片的路径规则：相对路径指向 public 文件夹 -->
    <img src="public/demo-editor.png" alt="Web Editor Interface" width="800"/>
    <p><i>Web Editor Interface / 编辑器界面</i></p>
    <br/>
    <img src="public/demo-graph.png" alt="Neo4j Knowledge Graph" width="800"/>
    <p><i>Generated Neo4j Graph / 生成的 Neo4j 知识图谱</i></p>
</div>

---

## 🤝 Contribution / 贡献

As a project initiated by a non-programmer, the code structure might not be perfect. Pull Requests and suggestions are warmly welcome!
作为一个非程序员发起的项目，代码结构可能不够完美。非常欢迎专业的开发者提出建议或提交 PR！

Special thanks to **AntV X6** team and **Google Gemini**.

## 📄 License

MIT License
</file>

<file path="src/App.tsx">
import { useRef, useState } from 'react';
import { Button, Layout, message, Radio } from 'antd';
import { 
  SaveOutlined, 
  DatabaseOutlined, 
  ToolOutlined, 
  ArrowLeftOutlined,
  FormOutlined 
} from '@ant-design/icons';

import GraphCanvas from './components/Editor/Canvas';
import type { GraphCanvasRef } from './components/Editor/Canvas';
import ShapeDesigner from './components/DevTools/ShapeDesigner';
import AttributeDesigner from './components/DevTools/AttributeDesigner';

const { Header, Content } = Layout;

function App() {
  const [saving, setSaving] = useState(false);
  // mode 增加 'attributes' 状态
  const [mode, setMode] = useState<'editor' | 'designer' | 'attributes'>('editor');
  const graphRef = useRef<GraphCanvasRef>(null);

  const handleSaveClick = async () => {
    if (graphRef.current) {
      setSaving(true);
      try {
        await graphRef.current.handleSave();
      } catch (e) {
        console.error(e);
        message.error('保存操作异常');
      } finally {
        setSaving(false);
      }
    } else {
        console.warn("GraphRef is null");
    }
  };

  // --- 渲染开发者模式 (包含 图元设计 和 属性设计) ---
  if (mode === 'designer' || mode === 'attributes') {
    return (
      <Layout style={{ height: '100vh' }}>
        <Header style={{ 
          display: 'flex', alignItems: 'center', color: 'white', 
          height: '50px', padding: '0 20px', flexShrink: 0,
          justifyContent: 'space-between', background: '#001529'
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 20 }}>
            <div style={{ fontSize: '1.2rem', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: 10 }}>
              <ToolOutlined /> 开发者工具箱
            </div>
            
            {/* 顶部切换 Tab */}
            <Radio.Group 
              value={mode} 
              onChange={e => setMode(e.target.value)} 
              buttonStyle="solid"
              size="small"
            >
              <Radio.Button value="designer"><ToolOutlined /> 图形设计 (Shape)</Radio.Button>
              <Radio.Button value="attributes"><FormOutlined /> 属性定义 (Attribute)</Radio.Button>
            </Radio.Group>
          </div>

          <Button 
            type="primary" 
            ghost 
            icon={<ArrowLeftOutlined />} 
            onClick={() => setMode('editor')}
          >
            返回编辑器
          </Button>
        </Header>
        <Content style={{ height: 'calc(100vh - 50px)', overflow: 'hidden' }}>
          {mode === 'designer' ? <ShapeDesigner /> : <AttributeDesigner />}
        </Content>
      </Layout>
    );
  }

  // --- 渲染主编辑器 ---
  return (
    <Layout style={{ height: '100vh', display: 'flex', flexDirection: 'column' }}>
      <Header style={{ 
        display: 'flex', alignItems: 'center', color: 'white', 
        height: '50px', padding: '0 20px', flexShrink: 0,
        justifyContent: 'space-between' 
      }}>
        <div style={{ fontSize: '1.2rem', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: 10 }}>
          <DatabaseOutlined />
          🧪 化工 P&ID 编辑器
        </div>
        <div style={{ display: 'flex', gap: 10 }}>
          <Button 
              type="dashed" 
              ghost 
              icon={<ToolOutlined />} 
              onClick={() => setMode('designer')} // 默认进入图形设计
            >
              DevTools
            </Button>
          <Button 
            type="primary" 
            icon={<SaveOutlined />} 
            loading={saving}
            onClick={handleSaveClick}
          >
            保存图纸到 Neo4j
          </Button>
        </div>
      </Header>
      
      <Content style={{ position: 'relative', flex: 1, overflow: 'hidden', display: 'flex' }}>
        <GraphCanvas ref={graphRef} />
      </Content>
    </Layout>
  );
}

export default App;
</file>

<file path="src/components/Editor/Inspector/index.tsx">
// src/components/Editor/Inspector/index.tsx
import React, { useEffect, useState } from 'react';
import { Form, Input, Card, Empty, Select, Divider, Collapse } from 'antd';
import { Cell } from '@antv/x6';
import { 
  InfoCircleOutlined, SettingOutlined, DashboardOutlined, ExperimentOutlined 
} from '@ant-design/icons';
import { FLUID_COLORS } from '../../../config/rules';

interface InspectorProps { cell: Cell | null; }

const { Option } = Select;
const { Panel } = Collapse;

const Inspector: React.FC<InspectorProps> = ({ cell }) => {
  const [form] = Form.useForm();
  const [, setTick] = useState(0);

  // 1. 监听选中 cell 变化及数据变更
  useEffect(() => {
    if (!cell) return;

    const updateForm = () => {
      const data = cell.getData() || {};
      const attrs = cell.getAttrs();
      
      const formData: any = {
        type: data.type || 'Unknown',
        tag: data.tag || attrs?.label?.text || '', 
        desc: data.desc || '',
      };

      if (cell.isNode()) {
        Object.assign(formData, {
          designPressure: data.designPressure,
          designTemp: data.designTemp,
          material: data.material,
          volume: data.volume,
          area: data.area,
          flow: data.flow,
          head: data.head,
          power: data.power,
          size: data.size,
          valveClass: data.valveClass,
          failPosition: data.failPosition,
          tagId: data.tagId,
          loopNum: data.loopNum,
          range: data.range,
          unit: data.unit,
        });
      } else if (cell.isEdge()) {
        const labelObj = cell.getLabelAt(0);
        const labelText = typeof labelObj === 'string' ? labelObj : (labelObj?.attrs?.label?.text || '');
        Object.assign(formData, {
          tag: labelText,
          fluid: data.fluid || 'Water',
          material: data.material || 'CS',
          dn: data.dn || 'DN50',
          pn: data.pn || 'PN16',
          insulation: data.insulation || 'None',
        });
      }
      form.setFieldsValue(formData);
      setTick(t => t + 1);
    };

    updateForm();

    cell.on('change:data', updateForm);
    cell.on('change:attrs', updateForm);

    return () => {
      cell.off('change:data', updateForm);
      cell.off('change:attrs', updateForm);
    };
  }, [cell, form]);

  // 2. 表单变更处理
  const handleValuesChange = (changedValues: any, allValues: any) => {
    if (!cell) return;

    const currentData = cell.getData() || {};
    cell.setData({ ...currentData, ...allValues });

    if (cell.isNode()) {
      if (currentData.type === 'Instrument') {
        if (changedValues.tagId !== undefined) cell.attr('topLabel/text', changedValues.tagId);
        if (changedValues.loopNum !== undefined) cell.attr('bottomLabel/text', changedValues.loopNum);
      } else {
        if (changedValues.tag !== undefined) {
          cell.setAttrs({ label: { text: changedValues.tag } });
        }
      }
    } else if (cell.isEdge()) {
      if (changedValues.tag !== undefined) {
        cell.setLabelAt(0, { attrs: { label: { text: changedValues.tag } }, position: { distance: 0.5 } });
      }
      if (changedValues.fluid !== undefined || changedValues.insulation !== undefined) {
        const fluid = allValues.fluid;
        const insulation = allValues.insulation;
        const color = FLUID_COLORS[fluid] || '#5F95FF';

        if (insulation && insulation.startsWith('Jacket')) {
          cell.setAttrs({ line: { strokeWidth: 4, stroke: '#fa8c16', strokeDasharray: null } });
        } else if (['ST', 'ET', 'OT'].includes(insulation)) {
          cell.setAttrs({ line: { strokeWidth: 2, stroke: color, strokeDasharray: '5 5' } });
        } else {
          cell.setAttrs({ line: { strokeWidth: 2, stroke: color, strokeDasharray: null } });
        }
      }
    }
  };

  if (!cell) return <Empty description="请选择对象" style={{ marginTop: 100 }} />;

  const data = cell.getData() || {};
  const type = data.type;
  const isNode = cell.isNode();
  const isEdge = cell.isEdge();
  const isSignal = isEdge && type === 'Signal';

  const renderSpecificFields = () => {
    if (!isNode) return null;
    
    if (['LiquidPump', 'CentrifugalPump', 'DiaphragmPump', 'PistonPump', 'GearPump', 'Compressor', 'Fan', 'JetPump'].includes(type)) {
      return (
        <>
          <Divider orientation={"left" as any}><DashboardOutlined /> 性能参数</Divider>
          <div style={{ display: 'flex', gap: 8 }}>
            <Form.Item label="流量 (m³/h)" name="flow" style={{ flex: 1 }}><Input placeholder="50" /></Form.Item>
            <Form.Item label="扬程 (m)" name="head" style={{ flex: 1 }}><Input placeholder="30" /></Form.Item>
          </div>
          <Form.Item label="电机功率 (kW)" name="power"><Input placeholder="15 kW" /></Form.Item>
          <Form.Item label="材质" name="material">
            <Select>
              <Option value="CS">铸钢 (CS)</Option>
              <Option value="SS304">不锈钢 (304)</Option>
              <Option value="SS316L">不锈钢 (316L)</Option>
              <Option value="CastIron">铸铁</Option>
            </Select>
          </Form.Item>
        </>
      );
    }
    if (['Reactor', 'Tank', 'Evaporator'].includes(type)) {
      return (
        <>
          <Divider orientation={"left" as any}><ExperimentOutlined /> 设备参数</Divider>
          <div style={{ display: 'flex', gap: 8 }}>
            <Form.Item label="容积 (m³)" name="volume" style={{ flex: 1 }}><Input placeholder="2000" /></Form.Item>
            <Form.Item label="材质" name="material" style={{ flex: 1 }}>
              <Select>
                <Option value="SS304">S30408</Option>
                <Option value="SS316L">S31603</Option>
                <Option value="GL">搪玻璃</Option>
                <Option value="Ti">钛材</Option>
              </Select>
            </Form.Item>
          </div>
          <div style={{ display: 'flex', gap: 8 }}>
            <Form.Item label="设计压力(MPa)" name="designPressure" style={{ flex: 1 }}><Input placeholder="0.6" /></Form.Item>
            <Form.Item label="设计温度(℃)" name="designTemp" style={{ flex: 1 }}><Input placeholder="150" /></Form.Item>
          </div>
        </>
      );
    }
    if (['Exchanger'].includes(type)) {
      return (
        <>
          <Divider orientation={"left" as any}><ExperimentOutlined /> 换热参数</Divider>
          <Form.Item label="换热面积 (㎡)" name="area"><Input placeholder="10" /></Form.Item>
          <div style={{ display: 'flex', gap: 8 }}>
            <Form.Item label="壳程压力" name="designPressure" style={{ flex: 1 }}><Input placeholder="1.6" /></Form.Item>
            <Form.Item label="管程压力" name="tubePressure" style={{ flex: 1 }}><Input placeholder="1.0" /></Form.Item>
          </div>
          <Form.Item label="材质 (壳/管)" name="material"><Input placeholder="CS / SS304" /></Form.Item>
        </>
      );
    }
    if (['ControlValve', 'Valve'].includes(type)) {
      return (
        <>
          <Divider orientation={"left" as any}><SettingOutlined /> 阀门规格</Divider>
          <div style={{ display: 'flex', gap: 8 }}>
            <Form.Item label="尺寸" name="size" style={{ flex: 1 }}>
              <Select>
                <Option value="DN25">DN25</Option>
                <Option value="DN50">DN50</Option>
                <Option value="DN80">DN80</Option>
                <Option value="DN100">DN100</Option>
              </Select>
            </Form.Item>
            <Form.Item label="压力等级" name="valveClass" style={{ flex: 1 }}>
              <Select>
                <Option value="PN16">PN16</Option>
                <Option value="PN40">PN40</Option>
                <Option value="CL150">CL150</Option>
                <Option value="CL300">CL300</Option>
              </Select>
            </Form.Item>
          </div>
          {type === 'ControlValve' && (
            <Form.Item label="故障位置 (FC/FO)" name="failPosition">
              <Select>
                <Option value="FC">气开 (FC)</Option>
                <Option value="FO">气关 (FO)</Option>
                <Option value="FL">保位 (FL)</Option>
              </Select>
            </Form.Item>
          )}
        </>
      );
    }
    if (['Instrument'].includes(type)) {
      return (
        <>
          <Divider orientation={"left" as any}><DashboardOutlined /> 仪表定义</Divider>
          <div style={{ display: 'flex', gap: 8 }}>
            <Form.Item label="功能 (Tag)" name="tagId" style={{ flex: 1 }} help="如: PI, TT"><Input /></Form.Item>
            <Form.Item label="回路 (Loop)" name="loopNum" style={{ flex: 1 }} help="如: 101"><Input /></Form.Item>
          </div>
          <div style={{ display: 'flex', gap: 8 }}>
            <Form.Item label="量程" name="range" style={{ flex: 2 }}><Input placeholder="0-1.6" /></Form.Item>
            <Form.Item label="单位" name="unit" style={{ flex: 1 }}><Input placeholder="MPa" /></Form.Item>
          </div>
        </>
      );
    }
    return <Empty description="无特定参数" image={Empty.PRESENTED_IMAGE_SIMPLE} />;
  };

  return (
    <Card 
      title={
        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
          {isNode ? <SettingOutlined /> : <InfoCircleOutlined />}
          <span>
            {isNode ? (data.type === 'Instrument' ? '仪表属性' : '设备属性') : (isSignal ? '信号线属性' : '管线属性')}
          </span>
        </div>
      } 
      bordered={false} 
      style={{ height: '100%', overflowY: 'auto' }}
      bodyStyle={{ padding: '12px 16px' }}
    >
      <Form form={form} layout="vertical" onValuesChange={handleValuesChange} size="small">
        <Collapse defaultActiveKey={['1']} ghost>
          <Panel header="基础信息" key="1">
            {type !== 'Instrument' && !isSignal && (
              <Form.Item label={isNode ? "位号 (Tag No.)" : "管段号 (Line No.)"} name="tag">
                <Input placeholder={isNode ? "R-101" : "PL-1001-50-CS"} />
              </Form.Item>
            )}
            <Form.Item label="描述" name="desc">
              <Input.TextArea rows={2} placeholder="设备或管线的功能描述" />
            </Form.Item>
          </Panel>
        </Collapse>

        {isNode && renderSpecificFields()}

        {isEdge && !isSignal && (
          <>
            <Divider orientation={"left" as any}>管道规格</Divider>
            <div style={{ display: 'flex', gap: 8 }}>
              <Form.Item label="介质" name="fluid" style={{ flex: 1 }}>
                <Select showSearch optionFilterProp="children">
                  {Object.keys(FLUID_COLORS).map(key => (
                    <Option key={key} value={key}>{key}</Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item label="材质" name="material" style={{ flex: 1 }}>
                <Select>
                  <Option value="CS">碳钢</Option>
                  <Option value="SS304">SS304</Option>
                  <Option value="SS316L">SS316L</Option>
                </Select>
              </Form.Item>
            </div>
            <div style={{ display: 'flex', gap: 8 }}>
              <Form.Item label="管径" name="dn" style={{ flex: 1 }}>
                <Select showSearch>
                  {[
                    'DN15', 'DN20', 'DN25', 'DN32', 'DN40', 'DN50', 'DN65', 'DN80', 
                    'DN100', 'DN125', 'DN150', 'DN200', 'DN250', 'DN300', 'DN350', 
                    'DN400', 'DN450', 'DN500', 'DN600'
                  ].map(d => <Option key={d} value={d}>{d}</Option>)}
                </Select>
              </Form.Item>
              <Form.Item label="等级" name="pn" style={{ flex: 1 }}>
                <Select showSearch>
                  <Option value="PN6">PN6</Option>
                  <Option value="PN10">PN10</Option>
                  <Option value="PN16">PN16</Option>
                  <Option value="PN25">PN25</Option>
                  <Option value="PN40">PN40</Option>
                  <Option value="PN63">PN63</Option>
                  <Option value="PN100">PN100</Option>
                  <Option value="CL150">CL150</Option>
                  <Option value="CL300">CL300</Option>
                  <Option value="CL600">CL600</Option>
                  <Option value="CL900">CL900</Option>
                  <Option value="CL1500">CL1500</Option>
                </Select>
              </Form.Item>
            </div>
            <Form.Item label="保温/伴热" name="insulation">
              <Select>
                <Option value="None">无</Option>
                <Option value="H">保温 (H)</Option>
                <Option value="C">保冷 (C)</Option>
                <Option value="ST">蒸汽伴热</Option>
                <Option value="ET">电伴热</Option>
                <Option value="Jacket-Steam">蒸汽夹套</Option>
              </Select>
            </Form.Item>
          </>
        )}

        {isSignal && (
           <div style={{ color: '#999', padding: '20px 0', textAlign: 'center' }}>
             <InfoCircleOutlined /> 信号连接 (Signal) <br/> 无需配置工艺参数
           </div>
        )}

        <div style={{ marginTop: 20, fontSize: 12, color: '#999', textAlign: 'center' }}>
          ID: {cell.id.slice(0, 8)}...
        </div>
      </Form>
    </Card>
  );
};

export default Inspector;
</file>

<file path="src/components/Editor/Canvas/index.tsx">
import { useEffect, useRef, useState, useImperativeHandle, forwardRef } from 'react';
import { Graph, Cell, Edge, Node } from '@antv/x6';
import { Stencil } from '@antv/x6-plugin-stencil';
import { Keyboard } from '@antv/x6-plugin-keyboard';
import { Selection } from '@antv/x6-plugin-selection';
import { History } from '@antv/x6-plugin-history';
import { Transform } from '@antv/x6-plugin-transform';
import '@antv/x6-plugin-transform/dist/index.css';
import { Button, Tooltip, message, Modal } from 'antd';
import { 
  ZoomInOutlined, ZoomOutOutlined, OneToOneOutlined, CompressOutlined, 
  UndoOutlined, RedoOutlined, ClearOutlined 
} from '@ant-design/icons';

import Inspector from '../Inspector';
import ContextMenu, { type MenuState } from '../ContextMenu';
import './index.css';
//import { registerCustomCells } from '../../../graph/cells/registry';
import { saveGraphData, loadGraphData } from '../../../services/neo4j';
import { FLUID_COLORS, INLINE_TYPES } from '../../../config/rules';
import { registerCustomCells, SHAPE_LIBRARY } from '../../../graph/cells/registry';

// 确保注册自定义图形
try { registerCustomCells(); } catch (e) { console.warn(e); }

export interface GraphCanvasRef {
  handleSave: () => Promise<void>;
}

const pick = (obj: any, keys: string[]) => {
  const ret: any = {};
  keys.forEach(key => {
    if (obj[key] !== undefined && obj[key] !== null && obj[key] !== '') {
      ret[key] = obj[key];
    }
  });
  return ret;
};

const GraphCanvas = forwardRef<GraphCanvasRef, {}>((_, ref) => {
  const containerRef = useRef<HTMLDivElement>(null);
  const stencilRef = useRef<HTMLDivElement>(null);
  const graphRef = useRef<Graph | null>(null);
  const historyRef = useRef<History | null>(null);
  const clipboardRef = useRef<any>(null);

  const [selectedCell, setSelectedCell] = useState<Cell | null>(null);
  const [canUndo, setCanUndo] = useState(false);
  const [canRedo, setCanRedo] = useState(false);
  
  const [menu, setMenu] = useState<MenuState>({ visible: false, x: 0, y: 0, type: null });

  // --- 辅助函数：判断是否为在线元件 ---
  const isInlineComponent = (cellId: string) => {
    if (!graphRef.current) return false;
    const cell = graphRef.current.getCellById(cellId);
    if (!cell || !cell.isNode()) return false;
    return INLINE_TYPES.includes(cell.getData()?.type);
  };

  // --- 辅助函数：刷新所有管线的路由策略 ---
  const refreshRouting = () => {
    const graph = graphRef.current;
    if (!graph) return;
    
    graph.getEdges().forEach(edge => {
      if (edge.getData()?.type === 'Pipe') {
        const sourceId = edge.getSourceCellId();
        const targetId = edge.getTargetCellId();
        
        const excludeNodes = ['SHEET_FRAME_A2'];
        if (isInlineComponent(sourceId)) excludeNodes.push(sourceId);
        if (isInlineComponent(targetId)) excludeNodes.push(targetId);

        edge.setRouter('manhattan', {
          padding: 10,
          excludeNodes: excludeNodes
        });
      }
    });
  };

  // --- 保存功能 ---
  useImperativeHandle(ref, () => ({
    handleSave: async () => {
      if (!graphRef.current) return;
      const graph = graphRef.current;
      
      // 1. 处理节点
      const nodes = graph.getNodes()
        .filter(node => !node.getData()?.isBackground)
        .map(node => {
          const data = node.getData() || {};
          const pos = node.getPosition();
          const size = node.getSize();
          const angle = node.getAngle(); // 获取角度
          const type = data.type || 'Unknown';

          // Tag 处理逻辑
          let Tag = data.tag || node.getAttrs()?.label?.text || '';
          if (type === 'Instrument') {
            const func = data.tagId || '';
            const loop = data.loopNum || '';
            if (func || loop) Tag = `${func}${loop ? '-' + loop : ''}`;
          }

          // [核心修改] 将 x, y, w, h, a 打包成 layout JSON 字符串
          // 使用 Math.round 取整，减少存储体积
          const layoutData = {
            x: Math.round(pos.x),
            y: Math.round(pos.y),
            w: Math.round(size.width),
            h: Math.round(size.height),
            a: Math.round(angle) 
          };

          const baseProps = {
            x6Id: node.id,
            type: type, 
            Tag: Tag,
            desc: data.desc || '',
            // [新增] 存入 layout 字段
            layout: JSON.stringify(layoutData)
            // [移除] x, y, width, height, angle 不再直接作为顶层属性
          };

          // 业务属性提取逻辑 (保持不变)
          let specificProps = {};
          if (['LiquidPump', 'CentrifugalPump', 'DiaphragmPump', 'PistonPump', 'GearPump', 'Compressor', 'Fan', 'JetPump'].includes(type)) {
             specificProps = pick(data, ['spec', 'flow', 'head', 'power', 'material']);
          } else if (['Reactor', 'Tank', 'Evaporator'].includes(type)) {
             specificProps = pick(data, ['spec', 'volume', 'material', 'designPressure', 'designTemp']);
          } else if (type === 'Exchanger') {
             specificProps = pick(data, ['spec', 'area', 'material', 'designPressure', 'tubePressure']);
          } else if (['ControlValve', 'Valve'].includes(type)) {
             specificProps = pick(data, ['spec', 'size', 'valveClass', 'failPosition']);
          } else if (type === 'Instrument') {
             specificProps = pick(data, ['spec', 'range', 'unit', 'tagId', 'loopNum']);
          } else {
             specificProps = pick(data, ['spec', 'material']);
          }

          return { ...baseProps, ...specificProps };
        });

      // 2. 处理连线
      const edges = graph.getEdges().map(edge => {
        const data = edge.getData() || {};
        const sourceNode = edge.getSourceNode();
        const targetNode = edge.getTargetNode();
        const vertices = edge.getVertices(); 
        
        // [核心修改] 提取端口元数据逻辑
        const getPortMeta = (node: Cell | null, portId: string | undefined) => {
          if (!node || !node.isNode() || !portId) return { group: 'default', desc: 'unknown' };
          
          const port = node.getPort(portId);
          if (!port) return { group: 'default', desc: 'unknown' };

          // 优先级逻辑：
          // 1. 优先使用语义化的 region (如 "ShellSide:Liquid", "TubeSide")
          // 2. 其次使用 section (如 "HighTemp")
          // 3. 最后降级使用视觉 group (如 "top", "left")
          let region = port.data?.region || port.group || 'default';
          
          // 如果有 section (如气体冷却器的高温段)，可以拼接到 region 中，或者单独存储
          // 这里为了简化，如果存在 section，我们将其追加到 region 描述中，例如 "TubeSide:HighTemp"
          if (port.data?.region && port.data?.section) {
            region = `${port.data.region}:${port.data.section}`;
          }

          return {
            group: region, // 这里将语义 region 赋值给 group 字段，后续会存入 Neo4j 的 fromRegion/toRegion
            desc: port.data?.desc || port.attrs?.circle?.title || port.id
          };
        };

        const srcMeta = getPortMeta(sourceNode, edge.getSourcePortId());
        const tgtMeta = getPortMeta(targetNode, edge.getTargetPortId());

        return {
          source: edge.getSourceCell()?.id,
          target: edge.getTargetCell()?.id,
          sourcePort: edge.getSourcePortId(),
          targetPort: edge.getTargetPortId(),
          
          // 这里 srcMeta.group 现在携带的是 "ShellSide:Liquid" 等高价值语义
          sourceRegion: srcMeta.group, 
          sourceDesc: srcMeta.desc,
          targetRegion: tgtMeta.group, 
          targetDesc: tgtMeta.desc,
          
          type: data.type || 'Pipe', 
          material: data.material || 'CS',
          fluid: data.fluid || 'Water',
          dn: data.dn || 'DN50',
          pn: data.pn || 'PN16',
          insulation: data.insulation || 'None',
          label: edge.getLabelAt(0)?.attrs?.label?.text || '',
          vertices: JSON.stringify(vertices) 
        };
      });

      try {
        await saveGraphData(nodes, edges);
        message.success(`保存成功！节点: ${nodes.length}, 连线: ${edges.length}`);
      } catch (error) {
        console.error(error);
        message.error('保存失败，请检查数据库连接');
      }
    }
  }));

  const updateNodeLabel = (node: Node) => {
    const angle = node.getAngle();
    if (angle === 0) {
      node.setAttrs({
        label: {
          refX: 0.5, refY: '100%', refY2: 10, refX2: 0,
          textAnchor: 'middle', textVerticalAnchor: 'top',
          transform: null 
        }
      });
      return;
    }
    const size = node.getSize();
    const rad = (angle * Math.PI) / 180;
    const visualHeight = size.width * Math.abs(Math.sin(rad)) + size.height * Math.abs(Math.cos(rad));
    const distance = visualHeight / 2 + 15;
    const offsetX = distance * Math.sin(rad);
    const offsetY = distance * Math.cos(rad);
    node.setAttrs({
      label: {
        refX: 0.5, refY: 0.5,
        refX2: offsetX, refY2: offsetY,
        textAnchor: 'middle', textVerticalAnchor: 'middle',
        transform: `rotate(${-angle})`,
      }
    });
  };

  // ============================================================
  // [修复] 复制粘贴逻辑 (手动序列化，解决管线报错问题)
  // ============================================================
  const performCopy = (targetCell?: Cell) => {
    const graph = graphRef.current;
    if (!graph) return;
    
    try {
      let cells = graph.getSelectedCells();
      
      // 如果当前没有选中任何东西，但传入了目标对象（右键菜单触发），则使用目标对象
      if (cells.length === 0 && targetCell) {
        cells = [targetCell];
        graph.select(targetCell);
      }

      if (cells.length === 0) {
        message.info('请先选中要复制的对象');
        return;
      }

      // [核心修改] 过滤掉背景图框 AND 过滤掉管线 (只复制设备节点)
      const cellsToCopy = cells.filter(cell => 
        !cell.getData()?.isBackground && cell.isNode()
      );

      if (cellsToCopy.length === 0) {
        message.warning('没有可复制的设备对象 (管线已忽略)');
        return;
      }

      // 手动序列化
      const jsonList = cellsToCopy.map(cell => {
        try {
          // 尝试深拷贝 data，防止引用问题
          const safeData = cell.getData() ? JSON.parse(JSON.stringify(cell.getData())) : {};
          
          // 只处理 Node，因为上面已经 filter 过了
          if (cell.isNode()) {
            return {
              id: cell.id,
              shape: cell.shape,
              position: cell.getPosition(),
              size: cell.getSize(),
              angle: cell.getAngle(),
              zIndex: cell.getZIndex(),
              attrs: cell.getAttrs(),
              data: safeData,
              ports: cell.getPorts(), // 必须保留端口信息
            };
          }
          return null;
        } catch (err) {
          console.error(`Failed to serialize cell ${cell.id}:`, err);
          return null;
        }
      }).filter(item => item !== null);

      if (jsonList.length > 0) {
        clipboardRef.current = jsonList;
        message.destroy();
        message.success(`已复制 ${jsonList.length} 个设备`);
      } else {
        message.error('复制失败：无法提取对象数据');
      }
    } catch (e) {
      console.error('Copy critical error:', e);
      message.error('复制操作失败');
    }
  };

  // ============================================================
  // [修复] 粘贴逻辑 (增加数据清洗，防止 History 报错)
  // ============================================================
  const performPaste = (offsetPoint?: { x: number, y: number }) => {
    const graph = graphRef.current;
    if (!graph || !clipboardRef.current || clipboardRef.current.length === 0) return;

    try {
      const cellsJSON = clipboardRef.current;
      console.log('Paste Start. Clipboard items:', cellsJSON.length);

      let dx = 20;
      let dy = 20;

      if (offsetPoint) {
        const nodesOnly = cellsJSON.filter((c: any) => c.position && typeof c.position.x === 'number');
        if (nodesOnly.length > 0) {
          const minX = Math.min(...nodesOnly.map((c: any) => c.position.x));
          const minY = Math.min(...nodesOnly.map((c: any) => c.position.y));
          dx = offsetPoint.x - minX;
          dy = offsetPoint.y - minY;
        }
      }

      graph.cleanSelection();
      const newCells: Cell[] = [];
      const idMap: Record<string, string> = {};

      // 辅助函数：深度清洗对象，移除 undefined/null
      const cleanData = (obj: any): any => {
        if (obj === null || obj === undefined) return {};
        if (typeof obj !== 'object') return obj;
        if (Array.isArray(obj)) return obj.map(cleanData);
        
        const res: any = {};
        for (const key in obj) {
          if (obj[key] !== undefined && obj[key] !== null) {
            res[key] = cleanData(obj[key]);
          }
        }
        return res;
      };

      // 1. 粘贴节点
      cellsJSON.forEach((cellData: any) => {
        if (!cellData.position) return;
        
        try {
          const oldId = cellData.id;
          const { id, zIndex, ...otherData } = cellData;
          
          // 确保 data 和 attrs 是纯净对象
          const safeData = cleanData(otherData.data || {});
          const safeAttrs = cleanData(otherData.attrs || {});
          
          const newNode = graph.createNode({
            ...otherData,
            data: safeData,
            attrs: safeAttrs,
            x: (otherData.position.x) + dx,
            y: (otherData.position.y) + dy,
            zIndex: (zIndex || 2) + 1
          });
          
          idMap[oldId] = newNode.id;
          newCells.push(newNode);
        } catch (nodeErr) {
          console.error('Failed to create node:', nodeErr);
        }
      });

      // (已移除连线粘贴逻辑，因为复制时已经过滤掉了)

      if (newCells.length > 0) {
        graph.addCell(newCells);
        graph.select(newCells);
        message.success(`已粘贴 ${newCells.length} 个设备`);
      }

      if (!offsetPoint) {
         clipboardRef.current = cellsJSON.map((c: any) => {
           if (c.position) {
             return { ...c, position: { x: c.position.x + 20, y: c.position.y + 20 } };
           }
           return c;
         });
      }
    } catch (e) {
      console.error('Paste critical error:', e);
      message.error('粘贴操作异常');
    }
  };

  const onUndo = () => historyRef.current?.undo();
  const onRedo = () => historyRef.current?.redo();
  const onZoom = (f: number) => graphRef.current?.zoom(f);
  const onZoomToFit = () => graphRef.current?.zoomToFit({ padding: 10 });
  const onZoomReset = () => graphRef.current?.zoomTo(1);
  const onClear = () => {
    Modal.confirm({
      title: '清空画布', content: '确定要清空吗？图框将被保留。', okType: 'danger',
      onOk: () => {
        if (!graphRef.current) return;
        const cellsToRemove = graphRef.current.getCells().filter(cell => !cell.getData()?.isBackground);
        graphRef.current.removeCells(cellsToRemove);
        setSelectedCell(null);
      },
    });
  };

  const handleMenuAction = (action: string) => {
    const { cellId } = menu;
    const graph = graphRef.current;
    if (!graph) return;
    
    const cell = cellId ? graph.getCellById(cellId) : null;
    
    switch (action) {
      case 'copy': 
        if (cell && !graph.isSelected(cell)) {
          graph.resetSelection(cell); 
        }
        performCopy(cell || undefined); 
        break;
      case 'paste': 
        const point = graph.clientToLocal({ x: menu.x, y: menu.y }); 
        performPaste(point); 
        break;
      case 'property': message.success('已定位到属性面板'); break;
      case 'clear': onClear(); break;
      case 'fit': onZoomToFit(); break;
      case 'delete': 
        const selected = graph.getSelectedCells();
        if (selected.length > 0) {
          graph.removeCells(selected);
        } else if (cell) {
          graph.removeCell(cell);
        }
        break;
      case 'rotate': 
        if (cell && cell.isNode() && !cell.getData()?.isBackground) { cell.rotate(90); } break;
    }
  };

  // --- 初始化 ---
  useEffect(() => {
    if (!containerRef.current || !stencilRef.current) return;
    stencilRef.current.innerHTML = '';

    const graph = new Graph({
      container: containerRef.current,
      autoResize: true,
      grid: { size: 10, visible: true, type: 'doubleMesh', args: [{ color: '#eee' }, { color: '#ddd', factor: 4 }] },
      panning: { enabled: true, eventTypes: ['rightMouseDown'] },
      mousewheel: { enabled: true, zoomAtMousePosition: true, modifiers: null, factor: 1.1, maxScale: 3, minScale: 0.1 },
      interacting: {
        nodeMovable: (view) => !view.cell.getData()?.isBackground,
        magnetConnectable: (view) => !view.cell.getData()?.isBackground,
      },
      connecting: {
        router: { name: 'manhattan', args: { padding: 10, excludeNodes: ['SHEET_FRAME_A2'] } },
        connector: { name: 'rounded', args: { radius: 8 } },
        anchor: 'center', connectionPoint: 'anchor', snap: true, allowBlank: false, allowEdge: true, highlight: true,
        validateConnection: ({ sourceView, targetView, sourceMagnet, targetMagnet }) => {
          if (!sourceView || !targetView || !sourceMagnet) return false;
          if (sourceView === targetView) return false;
          if (targetView.isEdgeElement()) {
            const sourceNode = sourceView.cell as Node;
            if (sourceNode.getData()?.type === 'Instrument') return true;
            return false;
          }
          if (!targetMagnet) return false;
          const sourcePortId = sourceMagnet.getAttribute('port');
          const targetPortId = targetMagnet.getAttribute('port');
          if (!sourcePortId || !targetPortId) return false;
          const sourceNode = sourceView.cell as Node;
          const targetNode = targetView.cell as Node;
          const sourcePort = sourceNode.getPort(sourcePortId);
          const targetPort = targetNode.getPort(targetPortId);
          const sDir = sourcePort?.data?.dir || 'bi';
          const tDir = targetPort?.data?.dir || 'bi';
          return sDir !== 'in' && tDir !== 'out';
        },
        createEdge(args) {
          let data = { type: 'Pipe', material: 'CS', fluid: 'Water', dn: 'DN50', pn: 'PN16', insulation: 'None' };
          if (args.sourceCell) {
            const cell = args.sourceCell;
            const connectedEdges = this.getConnectedEdges(cell);
            const pipes = connectedEdges.filter(e => e.getData()?.type === 'Pipe');
            if (pipes.length > 0) {
              const lastPipe = pipes[pipes.length - 1];
              const lastData = lastPipe.getData() || {};
              data = { ...data, material: lastData.material || data.material, fluid: lastData.fluid || data.fluid, dn: lastData.dn || data.dn, pn: lastData.pn || data.pn, insulation: lastData.insulation || data.insulation };
            }
          }
          const color = FLUID_COLORS[data.fluid] || '#5F95FF';
          return this.createEdge({
            shape: 'edge',
            attrs: { line: { stroke: color, strokeWidth: 2, targetMarker: { name: 'classic', width: 8, height: 6 } } },
            labels: [], data: data
          });
        },
      },
    });
    graphRef.current = graph;

    graph.on('node:change:angle', ({ node }) => updateNodeLabel(node as Node));

    // ============================================================
    // [修复] 阀门打断逻辑 (增强容错)
    // ============================================================
    const handlePipeSplit = (node: Node) => {
      const nodeType = node.getData()?.type;
      if (!INLINE_TYPES.includes(nodeType)) return; 
      
      const connectedEdges = graph.getConnectedEdges(node);
      if (connectedEdges.length > 0) return; 

      const nodeBBox = node.getBBox();
      const center = nodeBBox.center;
      const allEdges = graph.getEdges();

      const targetEdge = allEdges.find(edge => {
        if (edge.getData()?.type === 'Signal') return false;
        return edge.getBBox().intersectsWithRect(nodeBBox);
      });

      if (targetEdge) {
        const targetView = graph.findViewByCell(targetEdge);
        if (!targetView) return;

        // @ts-ignore
        const closestPoint = targetView.getClosestPoint(center);
        // @ts-ignore
        const routePoints = targetView.routePoints || [];
        
        const points = [targetEdge.getSourcePoint(), ...routePoints, targetEdge.getTargetPoint()];
        
        let isPipeHorizontal = true; 
        let foundSegment = false;

        for (let i = 0; i < points.length - 1; i++) {
          const p1 = points[i];
          const p2 = points[i + 1];
          
          const minX = Math.min(p1.x, p2.x) - 5;
          const maxX = Math.max(p1.x, p2.x) + 5;
          const minY = Math.min(p1.y, p2.y) - 5;
          const maxY = Math.max(p1.y, p2.y) + 5;

          if (closestPoint.x >= minX && closestPoint.x <= maxX &&
              closestPoint.y >= minY && closestPoint.y <= maxY) {
            
            if (Math.abs(p1.y - p2.y) < 5) { 
              isPipeHorizontal = true; 
            } else {
              isPipeHorizontal = false; 
            }
            foundSegment = true;
            break; 
          }
        }

        if (!foundSegment) {
           const src = targetEdge.getSourcePoint();
           const tgt = targetEdge.getTargetPoint();
           isPipeHorizontal = Math.abs(src.x - tgt.x) > Math.abs(src.y - tgt.y);
        }

        const angle = node.getAngle();
        const normalizedAngle = (angle % 360 + 360) % 360;
        const isValveHorizontal = (normalizedAngle < 10 || normalizedAngle > 350) || (normalizedAngle > 170 && normalizedAngle < 190);

        if (isValveHorizontal !== isPipeHorizontal) return; 

        const OFFSET = 20; 
        let newX = nodeBBox.x;
        let newY = nodeBBox.y;

        if (isPipeHorizontal) {
          const pipeY = closestPoint.y;
          newY = Math.round((pipeY - OFFSET) / 10) * 10; 
          newX = Math.round(nodeBBox.x / 10) * 10; 
        } else {
          const pipeX = closestPoint.x;
          newX = Math.round((pipeX + OFFSET) / 10) * 10;
          newY = Math.round(nodeBBox.y / 10) * 10; 
        }
        
        node.setPosition(newX, newY);

        const srcPoint = targetEdge.getSourcePoint();
        const tgtPoint = targetEdge.getTargetPoint();
        let portForSource = 'in';  
        let portForTarget = 'out'; 

        if (isPipeHorizontal) {
          if (srcPoint.x < tgtPoint.x) { portForSource = 'in'; portForTarget = 'out'; } 
          else { portForSource = 'out'; portForTarget = 'in'; }
        } else {
          if (srcPoint.y < tgtPoint.y) { portForSource = 'in'; portForTarget = 'out'; } 
          else { portForSource = 'out'; portForTarget = 'in'; }
        }

        const source = targetEdge.getSource();
        const target = targetEdge.getTarget();
        const edgeData = targetEdge.getData();
        const edgeAttrs = targetEdge.getAttrs(); 
        const sourceCellId = (source as any).cell;
        const targetCellId = (target as any).cell;

        graph.removeCell(targetEdge);

        const exclude1 = ['SHEET_FRAME_A2', node.id];
        if (isInlineComponent(sourceCellId)) exclude1.push(sourceCellId);

        const exclude2 = ['SHEET_FRAME_A2', node.id];
        if (isInlineComponent(targetCellId)) exclude2.push(targetCellId);

        const router1 = { name: 'manhattan', args: { padding: 10, excludeNodes: exclude1 } };
        const router2 = { name: 'manhattan', args: { padding: 10, excludeNodes: exclude2 } };

        const edge1 = graph.createEdge({
          shape: 'edge', source: source, target: { cell: node.id, port: portForSource }, 
          data: { ...edgeData }, attrs: edgeAttrs, labels: [], router: router1 
        });

        const edge2 = graph.createEdge({
          shape: 'edge', source: { cell: node.id, port: portForTarget }, target: target,
          data: { ...edgeData }, attrs: edgeAttrs, labels: [], router: router2 
        });

        graph.addCell([edge1, edge2]);
        message.success('阀门已接入');
      }
    };

    // ============================================================
    // [修复] 智能测点 (Z-Index 修复)
    // ============================================================
    const handleSignalDrop = (args: any) => {
      const { e, edge } = args;
      const sourceNode = edge.getSourceNode();
      if (sourceNode?.getData()?.type !== 'Instrument') return;
      const sourcePortId = edge.getSourcePortId(); 

      let hitPipe: Edge | null = null;
      const point = graph.clientToLocal(e.clientX, e.clientY);
      const targetCell = edge.getTargetCell();
      
      if (targetCell && targetCell.isEdge()) {
        hitPipe = targetCell as Edge;
      } else {
        if (edge.getTargetNode()) return; 
        const views = graph.findViewsFromPoint(point);
        const pipeView = views.find(v => v.isEdgeElement() && v.cell.id !== edge.id && v.cell.getData()?.type !== 'Signal');
        if (pipeView) hitPipe = pipeView.cell as Edge;
      }

      if (hitPipe) {
        const src = hitPipe.getSourcePoint();
        const tgt = hitPipe.getTargetPoint();
        let tapX = point.x;
        let tapY = point.y;
        const isHorizontal = Math.abs(src.y - tgt.y) < 5; 
        const isVertical = Math.abs(src.x - tgt.x) < 5;

        if (isHorizontal) { tapY = src.y; tapX = Math.round(point.x / 10) * 10; } 
        else if (isVertical) { tapX = src.x; tapY = Math.round(point.y / 10) * 10; } 
        else { tapX = Math.round(point.x / 10) * 10; tapY = Math.round(point.y / 10) * 10; }

        const tappingPoint = graph.createNode({
          shape: 'tapping-point', x: tapX - 6, y: tapY - 6, data: { type: 'TappingPoint' },
          zIndex: 10 
        });
        
        graph.removeCell(edge); 
        const signalEdge = graph.createEdge({
          shape: 'signal-edge', source: { cell: tappingPoint.id },  target: { cell: sourceNode.id, port: sourcePortId },
          data: { 
            type: 'Signal', 
            relationType: 'MEASURES',
            fluid: 'Signal',
            // 显式清除工艺属性
            material: undefined, dn: undefined, pn: undefined, insulation: undefined
          }
        });

        const source = hitPipe.getSource();
        const target = hitPipe.getTarget();
        const pipeData = hitPipe.getData();
        const pipeAttrs = hitPipe.getAttrs(); 
        graph.removeCell(hitPipe);

        const pipe1 = graph.createEdge({
          shape: 'edge', source: source, target: { cell: tappingPoint.id },
          data: pipeData, attrs: pipeAttrs, labels: []
        });
        const pipe2 = graph.createEdge({
          shape: 'edge', source: { cell: tappingPoint.id }, target: target,
          data: pipeData, attrs: pipeAttrs, labels: []
        });
        
        graph.addCell([tappingPoint, pipe1, pipe2, signalEdge]);
        setTimeout(refreshRouting, 50);
        message.success('已生成测点');
      } else {
        if (!edge.getTargetCell()) graph.removeCell(edge);
      }
    };

    graph.on('node:added', ({ node }) => setTimeout(() => handlePipeSplit(node as Node), 50));
    graph.on('node:mouseup', ({ node }) => handlePipeSplit(node as Node));
    graph.on('edge:mouseup', handleSignalDrop); 

    graph.on('edge:connected', ({ edge }) => {
      const sourceNode = edge.getSourceNode();
      const targetPortId = edge.getTargetPortId();
      const isSourceInstrument = sourceNode?.getData()?.type === 'Instrument';
      const isTargetActuator = targetPortId === 'actuator';

      if (isSourceInstrument || isTargetActuator) {
        edge.setAttrs({
          line: { stroke: '#888', strokeWidth: 1, strokeDasharray: '4 4', targetMarker: { name: 'classic', size: 3 } } 
        });
        edge.setData({ type: 'Signal', fluid: 'Signal', relationType: isTargetActuator ? 'CONTROLS' : 'MEASURES' });
        if (isTargetActuator) edge.setRouter('manhattan', { padding: 10 });
      } else {
        refreshRouting();
      }
    });

    graph.use(new Selection({ enabled: true, multiple: true, rubberband: true, movable: true, showNodeSelectionBox: true, filter: (cell) => !cell.getData()?.isBackground }));
    graph.use(new Keyboard({ enabled: true }));
    graph.use(new Transform({ resizing: { enabled: true }, rotating: { enabled: true, grid: 15 } }));
    const history = new History({ enabled: true });
    graph.use(history);
    historyRef.current = history;
    graph.on('history:change', () => { setCanUndo(history.canUndo()); setCanRedo(history.canRedo()); });

    graph.bindKey(['meta+c', 'ctrl+c'], () => { performCopy(); return false; });
    graph.bindKey(['meta+v', 'ctrl+v'], () => { performPaste(); return false; });
    graph.bindKey(['backspace', 'delete'], () => { const cells = graph.getSelectedCells().filter(c => !c.getData()?.isBackground); if (cells.length) graph.removeCells(cells); });

    graph.on('cell:click', ({ cell }) => {
      if (cell.getData()?.isBackground) { setSelectedCell(null); graph.getEdges().forEach(edge => edge.removeTools()); return; }
      setSelectedCell(cell);
      if (cell.isEdge()) { cell.attr('line/strokeWidth', 3); }
      graph.getEdges().forEach(edge => { if (edge.id !== cell.id) { edge.attr('line/strokeWidth', 2); edge.removeTools(); } });
      if (cell.isEdge() && cell.getData()?.type === 'Pipe') {
        cell.addTools([{ name: 'vertices', args: { attrs: { fill: '#666' } } }, { name: 'segments', args: { snapRadius: 20, attrs: { fill: '#444' } } }]);
      }
    });
    
    graph.on('blank:click', () => { setSelectedCell(null); graph.getEdges().forEach(edge => { edge.attr('line/strokeWidth', 2); edge.removeTools(); }); });
    graph.on('cell:contextmenu', ({ e, cell }) => { if (cell.getData()?.isBackground) return; setMenu({ visible: true, x: e.clientX, y: e.clientY, type: cell.isNode() ? 'node' : 'edge', cellId: cell.id }); });
    graph.on('blank:contextmenu', ({ e }) => { setMenu({ visible: true, x: e.clientX, y: e.clientY, type: 'blank' }); });

    // --- Stencil (动态加载逻辑) ---
    const stencil = new Stencil({
      title: '组件库', 
      target: graph, 
      stencilGraphWidth: 240, 
      stencilGraphHeight: 0, 
      collapsable: true,
      search: { visible: true, placeholder: '搜索设备...' },
      groups: [
        { title: '主工艺设备', name: 'main_equip', layoutOptions: { columns: 1, columnWidth: 220, rowHeight: 160 } },
        { title: '泵类设备', name: 'pumps', layoutOptions: { columns: 2, columnWidth: 100, rowHeight: 100 } },
        { title: '仪表控制', name: 'instruments', layoutOptions: { columns: 3, columnWidth: 60, rowHeight: 70 } },
        { title: '管路附件', name: 'parts', layoutOptions: { columns: 2, columnWidth: 100, rowHeight: 120 } }
      ],
    });
    stencilRef.current.appendChild(stencil.container);

    // ============================================================
    // 动态分拣算法：根据 Type 自动归类
    // ============================================================
    
    // 1. 定义类型到分组的映射表
    const TYPE_TO_GROUP: Record<string, string> = {
      // 主设备
      'Reactor': 'main_equip',
      'FixedBedReactor': 'main_equip',
      'Exchanger': 'main_equip',
      'VerticalExchanger': 'main_equip',
      'Evaporator': 'main_equip',
      'Tank': 'main_equip',
      'GasCooler': 'main_equip',
      'Trap': 'main_equip', // 捕集器/疏水阀如果是大型的放这里，小型的放 parts
      
      // 泵类
      'Pump': 'pumps',
      'LiquidPump': 'pumps',
      'CentrifugalPump': 'pumps',
      'DiaphragmPump': 'pumps',
      'PistonPump': 'pumps',
      'GearPump': 'pumps',
      'Compressor': 'pumps',
      'Fan': 'pumps',
      'JetPump': 'pumps',
      
      // 仪表
      'Instrument': 'instruments',
      
      // 附件
      'Valve': 'parts',
      'ControlValve': 'parts',
      'Fitting': 'parts',
      'TappingPoint': 'ignore', // 忽略
      'Frame': 'ignore'         // 忽略
    };

    // 2. 初始化分组容器
    const stencilNodes: Record<string, Node[]> = {
      main_equip: [],
      pumps: [],
      instruments: [],
      parts: []
    };

    // 3. 遍历注册表，自动创建节点实例
    Object.keys(SHAPE_LIBRARY).forEach(shapeId => {
      const config = SHAPE_LIBRARY[shapeId];
      const type = config.data?.type || 'Unknown';
      
      // 获取目标分组，默认为 'parts'
      let groupName = TYPE_TO_GROUP[type];
      
      // 特殊处理：如果映射表中没写，但 type 包含 Pump 字样，自动归入泵类
      if (!groupName) {
        if (type.includes('Pump')) groupName = 'pumps';
        else if (type.includes('Valve')) groupName = 'parts';
        else groupName = 'parts'; // 兜底
      }

      if (groupName === 'ignore') return;

      // 创建用于 Stencil 显示的节点
      // 注意：这里我们只取必要的展示属性
      const node = graph.createNode({
        shape: shapeId,
        // 优先显示 spec (规格)，其次 tag (位号)，最后是 shapeId
        label: config.data?.spec || config.data?.tag || shapeId, 
        data: { ...config.data } // 复制完整数据
      });

      if (stencilNodes[groupName]) {
        stencilNodes[groupName].push(node);
      }
    });

    // 4. 一次性加载所有分组
    stencil.load(stencilNodes.main_equip, 'main_equip');
    stencil.load(stencilNodes.pumps, 'pumps');
    stencil.load(stencilNodes.instruments, 'instruments');
    stencil.load(stencilNodes.parts, 'parts');

    const setupBackgroundFrame = () => {
      if (graph.getNodes().some(n => n.getData()?.isBackground)) return;
      graph.addNode({ shape: 'drawing-frame-a2', id: 'SHEET_FRAME_A2', x: 0, y: 0, zIndex: -1, movable: false, selectable: false, data: { type: 'Frame', isBackground: true } });
    };

    const initCanvasData = async () => {
      setupBackgroundFrame();
      try {
        const data = await loadGraphData();
        if (data && data.nodes.length > 0) {
          graph.fromJSON(data as any);
          
          graph.batchUpdate(() => {
            const nodes = graph.getNodes();
            const edges = graph.getEdges();
            nodes.forEach(node => {
              if (!node.getData()?.isBackground) {
                updateNodeLabel(node); 
                node.setZIndex(node.getData()?.type === 'TappingPoint' ? 10 : 2);     
              }
            });
            edges.forEach(edge => edge.setZIndex(1));
            refreshRouting();
          });

          setupBackgroundFrame();
          graph.centerContent();
          message.success('数据已恢复');
        }
      } catch (error) {
        console.error('Data Load Error:', error);
        message.error('数据加载失败，已重置');
      }
    };
    setTimeout(initCanvasData, 100);

    return () => { graph.dispose(); if (stencilRef.current) stencilRef.current.innerHTML = ''; };
  }, []);

  return (
    <div className="editor-container">
      <div ref={stencilRef} className="stencil-container" />
      <div className="toolbar-container">
         <Tooltip title="撤销"><Button type="text" icon={<UndoOutlined />} disabled={!canUndo} onClick={onUndo} /></Tooltip>
         <Tooltip title="重做"><Button type="text" icon={<RedoOutlined />} disabled={!canRedo} onClick={onRedo} /></Tooltip>
         <div className="toolbar-sep"></div>
         <Tooltip title="放大"><Button type="text" icon={<ZoomInOutlined />} onClick={() => onZoom(0.1)} /></Tooltip>
         <Tooltip title="缩小"><Button type="text" icon={<ZoomOutOutlined />} onClick={() => onZoom(-0.1)} /></Tooltip>
         <Tooltip title="适应"><Button type="text" icon={<CompressOutlined />} onClick={onZoomToFit} /></Tooltip>
         <Tooltip title="1:1"><Button type="text" icon={<OneToOneOutlined />} onClick={onZoomReset} /></Tooltip>
         <div className="toolbar-sep"></div>
         <Tooltip title="清空"><Button type="text" danger icon={<ClearOutlined />} onClick={onClear} /></Tooltip>
      </div>
      <div ref={containerRef} className="canvas-container" />
      <div className="inspector-container"><Inspector cell={selectedCell} /></div>
      <ContextMenu visible={menu.visible} x={menu.x} y={menu.y} type={menu.type} onClose={() => setMenu({ ...menu, visible: false })} onAction={handleMenuAction} />
    </div>
  );
});

export default GraphCanvas;
</file>

<file path="src/graph/cells/registry.ts">
import { Graph } from '@antv/x6';

// --- SVG Imports (保留用于手动注册的 SVG) ---
import frameA2Svg from './svgs/frame-a2.svg?raw';
import reactorSvg from './svgs/reactor.svg?raw';
import exchangerSvg from './svgs/exchanger.svg?raw';
import e13Svg from './svgs/E-13.svg?raw';

import pumpLiquidSvg from './svgs/pump-liquid.svg?raw';
import pumpCentrifugalSvg from './svgs/pump-centrifugal.svg?raw';
import pumpDiaphragmSvg from './svgs/pump-diaphragm.svg?raw';
import pumpPistonSvg from './svgs/pump-piston.svg?raw';
import pumpCompressorSvg from './svgs/pump-compressor.svg?raw';
import pumpGearSvg from './svgs/pump-gear.svg?raw';
import pumpFanSvg from './svgs/pump-fan.svg?raw';
import pumpJetSvg from './svgs/pump-jet.svg?raw';

import cvPneumaticSvg from './svgs/cv-pneumatic.svg?raw';
import cvPositionerSvg from './svgs/cv-positioner.svg?raw';
import cvElectricSvg from './svgs/cv-electric.svg?raw';
import cvSolenoidSvg from './svgs/cv-solenoid.svg?raw';
import cvManualSvg from './svgs/cv-manual.svg?raw';
import cvPistonSvg from './svgs/cv-piston.svg?raw';

import instLocalSvg from './svgs/inst-local.svg?raw';
import instRemoteSvg from './svgs/inst-remote.svg?raw';
import instPanelSvg from './svgs/inst-panel.svg?raw';

// 注意：teeSvg 和 trapSvg 的导入可以保留，也可以删除，因为它们将通过自动加载读取
import teeSvg from './svgs/tee.svg?raw'; 
import trapSvg from './svgs/trap.svg?raw';

import tankHorizontalSvg from './svgs/tank-horizontal.svg?raw';
import tankVerticalSvg from './svgs/tank-vertical.svg?raw';
import gasCoolerSvg from './svgs/gas-cooler.svg?raw';
import reactorFixedBedSvg from './svgs/reactor-fixed-bed.svg?raw';
import exchangerVerticalSvg from './svgs/exchanger-vertical.svg?raw';
import tvtrapSvg from './svgs/tv-Trap.svg?raw';

// --- 全局变量与类型定义 ---

export const SHAPE_LIBRARY: Record<string, any> = {};

export type PortDir = 'in' | 'out' | 'bi';
export interface PortData {
  dir?: PortDir;
  [key: string]: any;
}

// JSON 配置文件结构接口
interface ShapeConfig {
  width: number;
  height: number;
  ports: any;
  attrs?: any;
  data: any;
}

// --- 工具函数 ---

// 确保使用 utf-8 编码
const svgToDataUrl = (svgStr: string) => `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgStr)}`;

// 内部注册函数：同时写入 X6 引擎和 SHAPE_LIBRARY 缓存
const registerNodeWithCache = (id: string, config: any) => {
  // 1. 注册到 X6
  Graph.registerNode(id, config);

  // 2. 存入缓存供设计器读取
  let rawSvg = '';
  // 尝试还原 SVG 源码供设计器回显
  if (config.imageUrl && typeof config.imageUrl === 'string') {
    try {
      const base64Data = config.imageUrl.split(',')[1];
      if (base64Data) {
        rawSvg = decodeURIComponent(base64Data);
      }
    } catch (e) {
      console.warn('Failed to decode SVG for designer:', id);
    }
  }

  SHAPE_LIBRARY[id] = {
    ...config,
    rawSvg, 
  };
};

// --- 通用样式常量 ---

const PORT_ATTRS = {
  circle: { r: 3, magnet: true, stroke: '#FFFFFF', strokeWidth: 1, fill: '#e3dedeff' },
};

const LABEL_ATTRS = {
  label: { refY: '100%', refY2: 8, textAnchor: 'middle', textVerticalAnchor: 'top', fontSize: 12, fill: '#333' }
};

// ============================================================
// 1. 自动化注册逻辑 (Auto Loader)
// ============================================================

const autoRegisterShapes = () => {
  // 1.1 自动导入 svgs 目录下所有的 .svg 文件
  const svgModules = import.meta.glob('./svgs/*.svg', { eager: true, query: '?raw', import: 'default' });
  
  // 1.2 自动导入 data 目录下所有的 .json 文件
  const jsonModules = import.meta.glob('./data/*.json', { eager: true, import: 'default' });

  console.log(`[Registry] Found ${Object.keys(jsonModules).length} custom shapes in /data folder.`);

  // 1.3 遍历 JSON 配置进行注册
  for (const path in jsonModules) {
    try {
      const config = jsonModules[path] as ShapeConfig;
      
      // 从文件名推导 ID: ./data/p-reactor.json -> p-reactor
      const fileName = path.split('/').pop()?.replace('.json', '');
      const shapeId = fileName || 'unknown';

      // 查找对应的 SVG
      const svgPath = `./svgs/${shapeId}.svg`;
      const svgContent = svgModules[svgPath] as string;

      if (!svgContent) {
        console.warn(`[Registry] Missing SVG for ${shapeId} (expected at ${svgPath})`);
        continue;
      }

      // 注册
      registerNodeWithCache(shapeId, {
        inherit: 'image',
        width: config.width,
        height: config.height,
        imageUrl: svgToDataUrl(svgContent),
        ports: config.ports,
        attrs: config.attrs || LABEL_ATTRS,
        data: config.data
      });
      
    } catch (e) {
      console.error(`[Registry] Failed to register shape from ${path}`, e);
    }
  }
};

// ============================================================
// 2. 手动端口定义 (保留给尚未迁移的复杂图元)
// ============================================================

// E-13 端口定义
const E13_PORTS = {
  groups: { 
    top: { position: 'absolute', attrs: PORT_ATTRS }, 
    bottom: { position: 'absolute', attrs: PORT_ATTRS }, 
    left: { position: 'absolute', attrs: PORT_ATTRS }, 
    heater: { position: 'absolute', attrs: PORT_ATTRS } 
  },
  items: [
    { id: 't1', group: 'top', args: { x: '22%', y: '1.1%' }, data: { desc: '顶部接口-1', region: 'ShellSide:Vapor', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 't2', group: 'top', args: { x: '34%', y: '1.1%' }, data: { desc: '顶部接口-2', region: 'ShellSide:Vapor', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 't3', group: 'top', args: { x: '46%', y: '1.1%' }, data: { desc: '顶部接口-3', region: 'ShellSide:Vapor', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 't4', group: 'top', args: { x: '58%', y: '1.1%' }, data: { desc: '顶部接口-4', region: 'ShellSide:Vapor', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 'l1', group: 'left', args: { x: '3%', y: '17.7%' }, data: { desc: '左侧接口-1(上)', region: 'ShellSide:Vapor', phase: 'Gas', dir: 'in' } as PortData },
    { id: 'l2', group: 'left', args: { x: '3%', y: '31.1%' }, data: { desc: '左侧接口-2(上)', region: 'ShellSide:Vapor', phase: 'Gas', dir: 'in' } as PortData },
    { id: 'l3', group: 'left', args: { x: '3%', y: '44.4%' }, data: { desc: '左侧接口-3(中上)', region: 'ShellSide:Vapor', phase: 'Gas', dir: 'in' } as PortData },
    { id: 'b1', group: 'bottom', args: { x: '22%', y: '98.9%' }, data: { desc: '底部接口-1', region: 'ShellSide:Liquid', phase: 'Liquid', dir: 'bi' } as PortData },
    { id: 'b2', group: 'bottom', args: { x: '34%', y: '98.9%' }, data: { desc: '底部接口-2', region: 'ShellSide:Liquid', phase: 'Liquid', dir: 'bi' } as PortData },
    { id: 'b3', group: 'bottom', args: { x: '46%', y: '98.9%' }, data: { desc: '底部接口-3', region: 'ShellSide:Liquid', phase: 'Liquid', dir: 'bi' } as PortData },
    { id: 'b4', group: 'bottom', args: { x: '58%', y: '98.9%' }, data: { desc: '底部接口-4', region: 'ShellSide:Liquid', phase: 'Liquid', dir: 'bi' } as PortData },
    { id: 'l4', group: 'left', args: { x: '3%', y: '57.7%' }, data: { desc: '左侧接口-4(中下)', region: 'ShellSide:Liquid', phase: 'Liquid', dir: 'in' } as PortData },
    { id: 'l5', group: 'left', args: { x: '3%', y: '71.1%' }, data: { desc: '左侧接口-5(下)', region: 'ShellSide:Liquid', phase: 'Liquid', dir: 'in' } as PortData },
    { id: 'l6', group: 'left', args: { x: '3%', y: '84.4%' }, data: { desc: '左侧接口-6(下)', region: 'ShellSide:Liquid', phase: 'Liquid', dir: 'in' } as PortData },
    { id: 'h_in', group: 'heater', args: { x: '83%', y: '51.1%' }, data: { desc: '蒸汽入口', region: 'TubeSide', phase: 'Gas', dir: 'in' } as PortData },
    { id: 'h_out', group: 'heater', args: { x: '83%', y: '93.3%' }, data: { desc: '冷凝水出口', region: 'TubeSide', phase: 'Liquid', dir: 'out' } as PortData },
  ],
};

const REACTOR_PORTS = {
  groups: { 
    top: { position: 'absolute', attrs: PORT_ATTRS }, 
    left_side: { position: 'absolute', attrs: PORT_ATTRS }, 
    right_side: { position: 'absolute', attrs: PORT_ATTRS }, 
    jacket: { position: 'absolute', attrs: PORT_ATTRS },
    bottom: { position: 'absolute', attrs: PORT_ATTRS } 
  },
  items: [
    { id: 'n1', group: 'top', args: { x: '15%', y: '0%' }, data: { desc: '釜顶接口N1', region: 'InnerVessel', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 'n2', group: 'top', args: { x: '30%', y: '0%' }, data: { desc: '釜顶接口N2', region: 'InnerVessel', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 'n3', group: 'top', args: { x: '70%', y: '0%' }, data: { desc: '釜顶接口N3', region: 'InnerVessel', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 'n4', group: 'top', args: { x: '85%', y: '0%' }, data: { desc: '釜顶接口N4', region: 'InnerVessel', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 'feed_in', group: 'left_side', args: { x: '0%', y: '30%' }, data: { desc: '进料口', region: 'InnerVessel', phase: 'Gas', dir: 'in' } as PortData },
    { id: 'overflow', group: 'right_side', args: { x: '100%', y: '30%' }, data: { desc: '溢流口', region: 'InnerVessel', phase: 'Liquid', dir: 'out' } as PortData },
    { id: 'j_in', group: 'jacket', args: { x: '0%', y: '45%' }, data: { desc: '半管夹套入口', region: 'Jacket', dir: 'in' } as PortData },
    { id: 'j_out', group: 'jacket', args: { x: '100%', y: '75%' }, data: { desc: '半管夹套出口', region: 'Jacket', dir: 'out' } as PortData },
    { id: 'discharge', group: 'bottom', args: { x: '50%', y: '100%' }, data: { desc: '釜底出料口', region: 'InnerVessel', phase: 'Liquid', dir: 'out' } as PortData },
    { id: 'temp_point', group: 'bottom', args: { x: '25%', y: '92%' }, attrs: { circle: { r: 3, fill: '#faad14', stroke: '#333' } }, data: { desc: '釜底温度口', region: 'InnerVessel', phase: 'Liquid', type: 'Instrument' } as PortData },
  ],
};

const COMMON_PUMP_PORTS = {
  groups: { in: { position: 'absolute', attrs: PORT_ATTRS }, out: { position: 'absolute', attrs: PORT_ATTRS } },
  items: [
    { id: 'in', group: 'in', args: { x: '50%', y: '100%' }, attrs: { circle: { title: '入口', cursor: 'help' } }, data: { desc: '泵入口', dir: 'in' } as PortData },
    { id: 'out', group: 'out', args: { x: '50%', y: '0%' }, attrs: { circle: { title: '出口', cursor: 'help' } }, data: { desc: '泵出口', dir: 'out' } as PortData },
  ],
};

const VALVE_PORTS = {
  groups: { left: { position: 'absolute', attrs: PORT_ATTRS }, right: { position: 'absolute', attrs: PORT_ATTRS }, actuator: { position: 'absolute', attrs: PORT_ATTRS } },
  items: [
    { id: 'in', group: 'left', args: { x: '0%', y: '83.33%' }, data: { desc: '阀门入口', dir: 'bi' } as PortData },
    { id: 'out', group: 'right', args: { x: '100%', y: '83.33%' }, data: { desc: '阀门出口', dir: 'bi' } as PortData },
    { id: 'actuator', group: 'actuator', args: { x: '50%', y: '0%' }, attrs: { circle: { r: 4, magnet: true, stroke: '#fa8c16', strokeWidth: 1, fill: '#fff' } }, data: { desc: '执行机构', dir: 'in', type: 'signal' } as PortData },
  ],
};

const TANK_HORIZONTAL_PORTS = {
  groups: { 
    top: { position: 'absolute', attrs: PORT_ATTRS }, 
    bottom: { position: 'absolute', attrs: PORT_ATTRS }, 
    left: { position: 'absolute', attrs: PORT_ATTRS }, 
    right: { position: 'absolute', attrs: PORT_ATTRS } 
  },
  items: [
    { id: 'n1', group: 'top', args: { x: '20%', y: '0%' }, data: { desc: '顶部口N1', region: 'InnerVessel', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 'n2', group: 'top', args: { x: '35%', y: '0%' }, data: { desc: '顶部口N2', region: 'InnerVessel', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 'n3', group: 'top', args: { x: '50%', y: '0%' }, data: { desc: '顶部口N3', region: 'InnerVessel', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 'n4', group: 'top', args: { x: '65%', y: '0%' }, data: { desc: '顶部口N4', region: 'InnerVessel', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 'n5', group: 'top', args: { x: '80%', y: '0%' }, data: { desc: '顶部口N5', region: 'InnerVessel', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 'n6', group: 'bottom', args: { x: '20%', y: '100%' }, data: { desc: '底部口N6', region: 'InnerVessel', phase: 'Liquid', dir: 'out' } as PortData },
    { id: 'n7', group: 'bottom', args: { x: '35%', y: '100%' }, data: { desc: '底部口N7', region: 'InnerVessel', phase: 'Liquid', dir: 'out' } as PortData },
    { id: 'n8', group: 'bottom', args: { x: '50%', y: '100%' }, data: { desc: '底部口N8', region: 'InnerVessel', phase: 'Liquid', dir: 'out' } as PortData },
    { id: 'n9', group: 'bottom', args: { x: '65%', y: '100%' }, data: { desc: '底部口N9', region: 'InnerVessel', phase: 'Liquid', dir: 'out' } as PortData },
    { id: 'n10', group: 'bottom', args: { x: '80%', y: '100%' }, data: { desc: '底部口N10', region: 'InnerVessel', phase: 'Liquid', dir: 'out' } as PortData },
    { id: 'n11', group: 'left', args: { x: '0%', y: '50%' }, data: { desc: '左侧口N11', region: 'InnerVessel', phase: 'Liquid', dir: 'bi' } as PortData },
    { id: 'n14', group: 'right', args: { x: '100%', y: '50%' }, data: { desc: '右侧口N14', region: 'InnerVessel', phase: 'Liquid', dir: 'bi' } as PortData },
  ],
};

const TANK_VERTICAL_PORTS = {
  groups: { 
    top: { position: 'absolute', attrs: PORT_ATTRS }, 
    bottom: { position: 'absolute', attrs: PORT_ATTRS }, 
    left_upper: { position: 'absolute', attrs: PORT_ATTRS }, 
    left_lower: { position: 'absolute', attrs: PORT_ATTRS },
    right_upper: { position: 'absolute', attrs: PORT_ATTRS },
    right_lower: { position: 'absolute', attrs: PORT_ATTRS }
  },
  items: [
    { id: 't1', group: 'top', args: { x: '50%', y: '10%' }, data: { desc: '顶部放空', region: 'InnerVessel', phase: 'Gas', dir: 'out' } as PortData },
    { id: 'b1', group: 'bottom', args: { x: '50%', y: '90%' }, data: { desc: '底部出料', region: 'InnerVessel', phase: 'Liquid', dir: 'out' } as PortData },
    { id: 'l_up', group: 'left_upper', args: { x: '10%', y: '30%' }, data: { desc: '上部侧口(左)', region: 'InnerVessel', phase: 'Gas', dir: 'in' } as PortData },
    { id: 'r_up', group: 'right_upper', args: { x: '90%', y: '30%' }, data: { desc: '上部侧口(右)', region: 'InnerVessel', phase: 'Gas', dir: 'in' } as PortData },
    { id: 'l_low', group: 'left_lower', args: { x: '10%', y: '70%' }, data: { desc: '下部侧口(左)', region: 'InnerVessel', phase: 'Liquid', dir: 'in' } as PortData },
    { id: 'r_low', group: 'right_lower', args: { x: '90%', y: '70%' }, data: { desc: '下部侧口(右)', region: 'InnerVessel', phase: 'Liquid', dir: 'in' } as PortData },
  ],
};

const GAS_COOLER_PORTS = {
  groups: { 
    main: { position: 'absolute', attrs: PORT_ATTRS }, 
    burst: { position: 'absolute', attrs: PORT_ATTRS }, 
    top_in: { position: 'absolute', attrs: PORT_ATTRS }, 
    top_out: { position: 'absolute', attrs: PORT_ATTRS }, 
    bottom_in: { position: 'absolute', attrs: PORT_ATTRS }, 
    bottom_out: { position: 'absolute', attrs: PORT_ATTRS } 
  },
  items: [
    { id: 'shell_in', group: 'main', args: { x: '0%', y: '58%' }, data: { desc: '壳程入口(产物气)', region: 'ShellSide', phase: 'Gas', dir: 'in' } as PortData },
    { id: 'shell_out', group: 'main', args: { x: '100%', y: '58%' }, data: { desc: '壳程出口(产物气)', region: 'ShellSide', phase: 'Gas', dir: 'out' } as PortData },
    { id: 'burst_left', group: 'burst', args: { x: '8.75%', y: '19%' }, data: { desc: '爆破片接口(左)', region: 'TubeSide', dir: 'out' } as PortData },
    { id: 'burst_right', group: 'burst', args: { x: '91.25%', y: '19%' }, data: { desc: '爆破片接口(右)', region: 'TubeSide', dir: 'out' } as PortData },
    { id: 'tube_top_in_1', group: 'top_in', args: { x: '21.25%', y: '15%' }, data: { desc: '高温段水入口', region: 'TubeSide', section: 'HighTemp', phase: 'Liquid', dir: 'in' } as PortData },
    { id: 'tube_top_out_1', group: 'top_out', args: { x: '31.25%', y: '15%' }, data: { desc: '高温段水出口', region: 'TubeSide', section: 'HighTemp', phase: 'Liquid', dir: 'out' } as PortData },
    { id: 'tube_top_out_2', group: 'top_out', args: { x: '41.25%', y: '15%' }, data: { desc: '低温段水出口', region: 'TubeSide', section: 'LowTemp', phase: 'Liquid', dir: 'out' } as PortData },
    { id: 'tube_top_in_2', group: 'top_in', args: { x: '81.25%', y: '15%' }, data: { desc: '低温段水入口', region: 'TubeSide', section: 'LowTemp', phase: 'Liquid', dir: 'in' } as PortData },
    { id: 'tube_bot_in_1', group: 'bottom_in', args: { x: '21.25%', y: '92%' }, data: { desc: '高温段水入口(下)', region: 'TubeSide', section: 'HighTemp', phase: 'Liquid', dir: 'in' } as PortData },
    { id: 'tube_bot_out_1', group: 'bottom_out', args: { x: '31.25%', y: '92%' }, data: { desc: '高温段水出口(下)', region: 'TubeSide', section: 'HighTemp', phase: 'Liquid', dir: 'out' } as PortData },
    { id: 'tube_bot_out_2', group: 'bottom_out', args: { x: '41.25%', y: '92%' }, data: { desc: '低温段水出口(下)', region: 'TubeSide', section: 'LowTemp', phase: 'Liquid', dir: 'out' } as PortData },
    { id: 'tube_bot_in_2', group: 'bottom_in', args: { x: '81.25%', y: '92%' }, data: { desc: '低温段水入口(下)', region: 'TubeSide', section: 'LowTemp', phase: 'Liquid', dir: 'in' } as PortData },
  ],
};

const INSTRUMENT_PORTS = {
  groups: { all: { position: 'absolute', attrs: PORT_ATTRS } },
  items: [
    { id: 'top', group: 'all', args: { x: '50%', y: '0%' } },
    { id: 'bottom', group: 'all', args: { x: '50%', y: '100%' } },
    { id: 'left', group: 'all', args: { x: '0%', y: '50%' } },
    { id: 'right', group: 'all', args: { x: '100%', y: '50%' } },
  ],
};

const FIXED_BED_REACTOR_PORTS = {
  groups: { gas: { position: 'absolute', attrs: PORT_ATTRS }, upper_salt: { position: 'absolute', attrs: PORT_ATTRS }, lower_salt: { position: 'absolute', attrs: PORT_ATTRS } },
  items: [
    { id: 'gas_in', group: 'gas', args: { x: '50%', y: '0%' }, data: { desc: '工艺气入口', region: 'TubeSide', dir: 'in' } as PortData },
    { id: 'gas_out', group: 'gas', args: { x: '50%', y: '100%' }, data: { desc: '气体出口', region: 'TubeSide', dir: 'out' } as PortData },
    { id: 'upper_L1', group: 'upper_salt', args: { x: '7.7%', y: '21.6%' }, data: { desc: '上盐道接口-L1', region: 'UpperSaltChannel', dir: 'in' } as PortData },
    { id: 'upper_L2', group: 'upper_salt', args: { x: '7.7%', y: '24.1%' }, data: { desc: '上盐道接口-L2', region: 'UpperSaltChannel', dir: 'in' } as PortData },
    { id: 'upper_L3', group: 'upper_salt', args: { x: '7.7%', y: '26.6%' }, data: { desc: '上盐道接口-L3', region: 'UpperSaltChannel', dir: 'out' } as PortData },
    { id: 'upper_R1', group: 'upper_salt', args: { x: '92.3%', y: '22.6%' }, data: { desc: '上盐道接口-R1', region: 'UpperSaltChannel', dir: 'in' } as PortData },
    { id: 'upper_R2', group: 'upper_salt', args: { x: '92.3%', y: '25.6%' }, data: { desc: '上盐道接口-R2', region: 'UpperSaltChannel', dir: 'out' } as PortData },
    { id: 'lower_L1', group: 'lower_salt', args: { x: '7.7%', y: '73.3%' }, data: { desc: '下盐道接口-L1', region: 'LowerSaltChannel', dir: 'in' } as PortData },
    { id: 'lower_L2', group: 'lower_salt', args: { x: '7.7%', y: '75.8%' }, data: { desc: '下盐道接口-L2', region: 'LowerSaltChannel', dir: 'out' } as PortData },
    { id: 'lower_L3', group: 'lower_salt', args: { x: '7.7%', y: '78.3%' }, data: { desc: '下盐道接口-L3', region: 'LowerSaltChannel', dir: 'out' } as PortData },
    { id: 'lower_R1', group: 'lower_salt', args: { x: '92.3%', y: '74.3%' }, data: { desc: '下盐道接口-R1', region: 'LowerSaltChannel', dir: 'in' } as PortData },
    { id: 'lower_R2', group: 'lower_salt', args: { x: '92.3%', y: '77.3%' }, data: { desc: '下盐道接口-R2', region: 'LowerSaltChannel', dir: 'out' } as PortData },
  ],
};

const VERTICAL_EXCHANGER_PORTS = {
  groups: { 
    side: { position: 'absolute', attrs: PORT_ATTRS }, 
    head: { position: 'absolute', attrs: PORT_ATTRS } 
  },
  items: [
    { id: 'side_left_top', group: 'side', args: { x: '0%', y: '20%' }, data: { desc: '壳程接口(左上)', region: 'ShellSide', dir: 'bi' } as PortData },
    { id: 'side_left_bottom', group: 'side', args: { x: '0%', y: '80%' }, data: { desc: '壳程接口(左下)', region: 'ShellSide', dir: 'bi' } as PortData },
    { id: 'side_right_top', group: 'side', args: { x: '100%', y: '15%' }, data: { desc: '壳程接口(右上)', region: 'ShellSide', dir: 'bi' } as PortData },
    { id: 'side_right_bottom', group: 'side', args: { x: '100%', y: '85%' }, data: { desc: '壳程接口(右下)', region: 'ShellSide', dir: 'bi' } as PortData },
    { id: 'head_top_left', group: 'head', args: { x: '30%', y: '2.5%' }, data: { desc: '管程接口(上左)', region: 'TubeSide', dir: 'bi' } as PortData },
    { id: 'head_top_right', group: 'head', args: { x: '70%', y: '2.5%' }, data: { desc: '管程接口(上右)', region: 'TubeSide', dir: 'bi' } as PortData },
    { id: 'head_bottom_left', group: 'head', args: { x: '30%', y: '97.5%' }, data: { desc: '管程接口(下左)', region: 'TubeSide', dir: 'bi' } as PortData },
    { id: 'head_bottom_right', group: 'head', args: { x: '70%', y: '97.5%' }, data: { desc: '管程接口(下右)', region: 'TubeSide', dir: 'bi' } as PortData },
  ],
};

// ============================================================
// 3. 主注册函数
// ============================================================

export const registerCustomCells = () => {
  // 1. 优先执行自动化注册 (加载 data/*.json)
  autoRegisterShapes();

  // 2. 注册基础元素
  Graph.registerEdge('signal-edge', {
    inherit: 'edge',
    attrs: { line: { stroke: '#888', strokeWidth: 1, strokeDasharray: '4 4', targetMarker: { name: 'classic', size: 3 } } },
    data: { type: 'Signal', fluid: 'Signal' },
  });

  registerNodeWithCache('tapping-point', {
    width: 12, height: 12,
    markup: [{ tagName: 'circle', selector: 'hitArea' }, { tagName: 'circle', selector: 'body' }],
    attrs: {
      hitArea: { r: 10, fill: 'transparent', stroke: 'none', magnet: false, cursor: 'move', pointerEvents: 'all' },
      body: { r: 3, fill: '#333', stroke: 'none', pointerEvents: 'none' },
    },
    ports: { items: [] },
    data: { type: 'TappingPoint', desc: '测量点' },
  });

  registerNodeWithCache('drawing-frame-a2', {
    inherit: 'image', width: 2245, height: 1587,
    imageUrl: `data:image/svg+xml;charset=utf-8,${encodeURIComponent(frameA2Svg)}`,
    ports: { items: [] }, attrs: { image: { style: { pointerEvents: 'none' } } },
    data: { type: 'Frame', isBackground: true }
  });

  // 3. 手动注册复杂图元 (尚未迁移到 JSON 的部分)
  
  registerNodeWithCache('p-reactor', {
    inherit: 'image',
    width: 80,
    height: 120,
    imageUrl: svgToDataUrl(reactorSvg),
    ports: REACTOR_PORTS,
    attrs: LABEL_ATTRS,
    data: {
      type: 'Reactor',
      tag: 'R-101',
      spec: 'HalfPipe-2000L',
      volume: '2.0',
      material: 'SS304',
      designPressure: '0.6',
      designTemp: '150'
    },
  });

  registerNodeWithCache('p-exchanger', {
    inherit: 'image',
    width: 200,
    height: 80,
    imageUrl: svgToDataUrl(exchangerSvg),
    ports: {
      groups: {
        shell: { position: 'absolute', attrs: PORT_ATTRS },
        tube_left: { position: 'absolute', attrs: PORT_ATTRS },
        tube_right: { position: 'absolute', attrs: PORT_ATTRS }
      },
      items: [
        { id: 'n1', group: 'shell', args: { x: '35%', y: '0%' }, attrs: { circle: { title: 'N1 (壳程入口)', cursor: 'help' } }, data: { desc: '壳程入口(N1)', region: 'ShellSide', dir: 'in' } as PortData },
        { id: 'n2', group: 'shell', args: { x: '75%', y: '100%' }, attrs: { circle: { title: 'N2 (壳程出口)', cursor: 'help' } }, data: { desc: '壳程出口(N2)', region: 'ShellSide', dir: 'out' } as PortData },
        { id: 'n3', group: 'tube_left', args: { x: '0%', y: '67.5%' }, attrs: { circle: { title: 'N3 (管程入口)', cursor: 'help' } }, data: { desc: '管程入口(N3)', region: 'TubeSide', dir: 'in' } as PortData },
        { id: 'n4', group: 'tube_left', args: { x: '0%', y: '32.5%' }, attrs: { circle: { title: 'N4 (管程出口)', cursor: 'help' } }, data: { desc: '管程出口(N4)', region: 'TubeSide', dir: 'out' } as PortData },
        { id: 'n5', group: 'tube_right', args: { x: '98%', y: '12%' }, data: { desc: '放空(N5)', region: 'ShellSide', type: 'Vent', dir: 'out' } as PortData },
        { id: 'n6', group: 'tube_right', args: { x: '98%', y: '88%' }, data: { desc: '排净(N6)', region: 'ShellSide', type: 'Drain', dir: 'out' } as PortData },
      ],
    },
    attrs: LABEL_ATTRS, 
    data: { 
      type: 'Exchanger', 
      tag: 'E-101', 
      spec: 'BES-50', 
      area: '50', 
      material: 'CS/SS304', 
      designPressure: '1.6' 
    },
  });

  registerNodeWithCache('p-naphthalene-evaporator', {
    inherit: 'image',
    width: 200,
    height: 90,
    imageUrl: svgToDataUrl(e13Svg),
    ports: E13_PORTS,
    attrs: LABEL_ATTRS,
    data: { type: 'Evaporator', spec: '蒸发器', tag: 'E-13' },
  });

  const pumps = [
    { key: 'p-pump-liquid', name: '液体泵', svg: pumpLiquidSvg, type: 'LiquidPump' },
    { key: 'p-pump-centrifugal', name: '离心泵', svg: pumpCentrifugalSvg, type: 'CentrifugalPump' },
    { key: 'p-pump-diaphragm', name: '隔膜泵', svg: pumpDiaphragmSvg, type: 'DiaphragmPump' },
    { key: 'p-pump-piston', name: '活塞泵', svg: pumpPistonSvg, type: 'PistonPump' },
    { key: 'p-pump-compressor', name: '压缩机', svg: pumpCompressorSvg, type: 'Compressor' },
    { key: 'p-pump-gear', name: '齿轮泵', svg: pumpGearSvg, type: 'GearPump' },
    { key: 'p-pump-fan', name: '风扇', svg: pumpFanSvg, type: 'Fan' },
    { key: 'p-pump-jet', name: '喷射泵', svg: pumpJetSvg, type: 'JetPump' },
  ];

  pumps.forEach(item => {
    registerNodeWithCache(item.key, {
      inherit: 'image', width: 60, height: 60, imageUrl: svgToDataUrl(item.svg),
      ports: COMMON_PUMP_PORTS, attrs: LABEL_ATTRS,
      data: { type: item.type, tag: 'P-101', spec: 'IH50-32-160', flow: '25', head: '30', power: '7.5', material: 'SS304' },
    });
  });

  const controlValves = [
    { key: 'p-cv-pneumatic', name: '气动调节阀', svg: cvPneumaticSvg, type: 'ControlValve' },
    { key: 'p-cv-positioner', name: '带定位器阀', svg: cvPositionerSvg, type: 'ControlValve' },
    { key: 'p-cv-electric', name: '电动调节阀', svg: cvElectricSvg, type: 'ControlValve' },
    { key: 'p-cv-solenoid', name: '带电磁阀', svg: cvSolenoidSvg, type: 'ControlValve' },
    { key: 'p-cv-manual', name: '手动调节阀', svg: cvManualSvg, type: 'ControlValve' },
    { key: 'p-cv-piston', name: '气缸调节阀', svg: cvPistonSvg, type: 'ControlValve' },
  ];

  controlValves.forEach(v => {
    registerNodeWithCache(v.key, {
      inherit: 'image', width: 40, height: 60, imageUrl: svgToDataUrl(v.svg),
      ports: VALVE_PORTS, attrs: LABEL_ATTRS,
      data: { type: v.type || 'ControlValve', tag: 'FV-101', size: 'DN50', valveClass: 'PN16', failPosition: 'FC' },
    });
  });

  const instruments = [
    { key: 'p-inst-local', name: '就地仪表', svg: instLocalSvg, type: 'Instrument' },
    { key: 'p-inst-remote', name: '远传仪表', svg: instRemoteSvg, type: 'Instrument' },
    { key: 'p-inst-panel', name: '就地盘仪表', svg: instPanelSvg, type: 'Instrument' },
  ];

  instruments.forEach(inst => {
    registerNodeWithCache(inst.key, {
      width: 40, height: 40,
      markup: [{ tagName: 'image', selector: 'body' }, { tagName: 'text', selector: 'topLabel' }, { tagName: 'text', selector: 'bottomLabel' }],
      attrs: {
        body: { refWidth: '100%', refHeight: '100%', xlinkHref: svgToDataUrl(inst.svg) },
        topLabel: { refX: 0.5, refY: 0.35, textAnchor: 'middle', textVerticalAnchor: 'middle', fontSize: 9, fontWeight: 'bold', fill: '#000', text: 'PI' },
        bottomLabel: { refX: 0.5, refY: 0.65, textAnchor: 'middle', textVerticalAnchor: 'middle', fontSize: 9, fontWeight: 'bold', fill: '#000', text: '101' },
      },
      ports: INSTRUMENT_PORTS, data: { type: inst.type, tagId: 'PI', loopNum: '101', range: '0-1.6', unit: 'MPa' },
    });
  });

  // [迁移说明] p-tee (三通) 已移除手动注册，请确保 src/graph/cells/data/p-tee.json 存在
  // [迁移说明] p-trap (捕集器) 已移除手动注册，请确保 src/graph/cells/data/p-trap.json 存在

  registerNodeWithCache('p-tank-horizontal', {
    inherit: 'image', width: 160, height: 80, imageUrl: svgToDataUrl(tankHorizontalSvg),
    ports: TANK_HORIZONTAL_PORTS, attrs: { label: { text: 'V-100', refY: '100%', refY2: 10 } },
    data: { type: 'Tank', spec: 'Horizontal', volume: '5.0' },
  });

  registerNodeWithCache('p-tank-vertical', {
    inherit: 'image', 
    width: 80, 
    height: 160, 
    imageUrl: svgToDataUrl(tankVerticalSvg), 
    ports: TANK_VERTICAL_PORTS,
    attrs: { label: { text: 'V-101', refY: '100%', refY2: 10 } },
    data: { type: 'Tank', spec: 'Vertical', volume: '10.0' },
  });

  registerNodeWithCache('p-gas-cooler', {
    inherit: 'image', width: 200, height: 130, imageUrl: svgToDataUrl(gasCoolerSvg),
    ports: GAS_COOLER_PORTS, attrs: { label: { text: 'E-201', refY: '100%', refY2: 10 } },
    data: { type: 'GasCooler', spec: 'AirCooled', area: '200' },
  });

  registerNodeWithCache('p-fixed-bed-reactor', {
    inherit: 'image', width: 130, height: 150, imageUrl: svgToDataUrl(reactorFixedBedSvg),
    ports: FIXED_BED_REACTOR_PORTS, attrs: { label: { text: 'D-14', refY: '100%', refY2: 10 } },
    data: { type: 'FixedBedReactor', spec: '20000 Tubes', catalyst: 'V2O5' },
  });

  registerNodeWithCache('p-exchanger-vertical', {
    inherit: 'image', width: 60, height: 200, imageUrl: svgToDataUrl(exchangerVerticalSvg),
    ports: VERTICAL_EXCHANGER_PORTS, attrs: { label: { text: 'E-102', refY: '100%', refY2: 10 } },
    data: { type: 'VerticalExchanger', spec: 'Vertical', area: '100' },
  });

  // 疏水阀 (复杂版) 暂时保留手动注册
  registerNodeWithCache('p-tv-trap', {
    inherit: 'image',
    width: 250, 
    height: 100,
    imageUrl: svgToDataUrl(tvtrapSvg),
    ports: {
      groups: {
          all: { position: 'absolute', attrs: PORT_ATTRS }
      },
      items: [
          { id: 'i', group: 'all', args: { x: '0%', y: '49%' }, data: { desc: '新接口', region: 'ShellSide', dir: 'bi' } as PortData },
          { id: 'o', group: 'all', args: { x: '100%', y: '49%' }, data: { desc: '新接口', region: 'ShellSide', dir: 'bi' } as PortData }
      ],
    },
    attrs: LABEL_ATTRS,
    data: { 
      type: 'Trap', 
      tag: 'tv-Trap', 
      spec: 'Spec...',
    },
  });
};
</file>

<file path="src/services/neo4j.ts">
// src/services/neo4j.ts
import neo4j from 'neo4j-driver';
import { FLUID_COLORS, CURRENT_DRAWING_ID } from '../config/rules';

const uri = import.meta.env.VITE_NEO4J_URI || 'bolt://localhost:7687';
const user = import.meta.env.VITE_NEO4J_USER || 'neo4j';
const password = import.meta.env.VITE_NEO4J_PASSWORD || '';

// 创建驱动实例
const driver = neo4j.driver(
  uri,
  neo4j.auth.basic(user, password)
);

export default driver;

// [新增] 类型映射表：定义 X6 type 到 Neo4j Labels 的映射关系
// 所有的节点都会自动带上 :Asset 标签
const TYPE_MAPPING: Record<string, string[]> = {
  // 反应器类
  'Reactor':           ['Equipment', 'Reactor'],
  'FixedBedReactor':   ['Equipment', 'Reactor'],
  
  // 换热器类
  'Exchanger':         ['Equipment', 'Exchanger'],
  'VerticalExchanger': ['Equipment', 'Exchanger'],
  'Evaporator':        ['Equipment', 'Exchanger'],
  'GasCooler':         ['Equipment', 'Exchanger'],
  
  // 泵/压缩机类
  'Pump':              ['Equipment', 'Pump'],
  'LiquidPump':        ['Equipment', 'Pump'],
  'CentrifugalPump':   ['Equipment', 'Pump'],
  'DiaphragmPump':     ['Equipment', 'Pump'],
  'PistonPump':        ['Equipment', 'Pump'],
  'GearPump':          ['Equipment', 'Pump'],
  'JetPump':           ['Equipment', 'Pump'],
  'Compressor':        ['Equipment', 'Pump', 'Compressor'], // 压缩机也是流体输送设备，但也可是独立分类
  'Fan':               ['Equipment', 'Pump', 'Fan'],
  
  // 阀门类 (包括手动阀和调节阀)
  'Valve':             ['Equipment', 'Valve'],
  'ControlValve':      ['Equipment', 'Valve', 'ControlValve'], // 调节阀既是阀门，也是控制元件
  'Trap':              ['Equipment', 'Trap'],
  
  // 容器类
  'Tank':              ['Equipment', 'Vessel'],
  'Trap':              ['Equipment', 'Vessel'],
  
  // 管件
  'Fitting':           ['Equipment', 'Fitting'],
  
  // 仪表类
  'Instrument':        ['Instrument'],
  'TappingPoint':      ['Instrument', 'Connection'], // 测点
  
  // 默认
  'default':           ['Equipment', 'Other']
};

export const saveGraphData = async (nodes: any[], edges: any[]) => {
  const session = driver.session();
  const tx = session.beginTransaction();
  try {
    // 1. [修改] 删除当前图纸的所有资产 (使用基类标签 :Asset)
    await tx.run(
      `MATCH (n:Asset {drawingId: $drawingId}) DETACH DELETE n`,
      { drawingId: CURRENT_DRAWING_ID }
    );

    // 2. [重构] 保存节点 - 根据类型进行分组批量插入
    if (nodes.length) {
      // 2.1 在内存中对节点进行分组
      const groups: Record<string, any[]> = {};
      
      nodes.forEach(node => {
        const type = node.type || 'Unknown';
        // 获取对应的标签列表，例如 ['Equipment', 'Pump']
        const labels = TYPE_MAPPING[type] || TYPE_MAPPING['default'];
        // 生成唯一的 Group Key，例如 "Equipment_Pump"
        const groupKey = labels.join(':');
        
        if (!groups[groupKey]) groups[groupKey] = [];
        groups[groupKey].push(node);
      });

      // 2.2 针对每一组生成特定的 Cypher 语句
      for (const [labelString, batch] of Object.entries(groups)) {
        // labelString 是 "Equipment:Pump"，我们需要把它拼接到 Cypher 中
        // 注意：Cypher 不支持参数化 Label，所以这里必须使用字符串拼接
        // 但由于 labelString 来自我们内部定义的 TYPE_MAPPING，所以是安全的
        const labels = `:Asset:${labelString}`; 
        
        await tx.run(
          `UNWIND $batch AS n 
           CREATE (e${labels} {x6Id: n.x6Id, drawingId: $drawingId}) 
           SET e += n`, 
          { batch, drawingId: CURRENT_DRAWING_ID }
        );
      }
    }

    // 3. 保存连线 (匹配 :Asset)
    if (edges.length) {
      const pipes = edges.filter(e => e.type !== 'Signal');
      const signals = edges.filter(e => e.type === 'Signal');

      // 3.1 保存工艺管线
      if (pipes.length) {
        await tx.run(
          `UNWIND $pipes AS r 
           MATCH (s:Asset {x6Id: r.source}), (t:Asset {x6Id: r.target}) 
           CREATE (s)-[:PIPE {
             fromPort:   r.sourcePort, 
             toPort:     r.targetPort,
             tag:        r.label,
             material:   r.material,
             fluid:      r.fluid,
             dn:         r.dn,
             pn:         r.pn,
             insulation: r.insulation,
             fromRegion: r.sourceRegion, 
             fromDesc:   r.sourceDesc,
             toRegion:   r.targetRegion,
             toDesc:     r.targetDesc,
             vertices:   r.vertices
           }]->(t)`, 
          { pipes }
        );
      }

      // 3.2 保存信号线
      if (signals.length) {
        const controlSignals = signals.filter((s: any) => s.targetPort === 'actuator' || s.relationType === 'CONTROLS');
        const measureSignals = signals.filter((s: any) => s.targetPort !== 'actuator' && s.relationType !== 'CONTROLS');

        if (controlSignals.length) {
          await tx.run(
            `UNWIND $batch AS r 
             MATCH (s:Asset {x6Id: r.source}), (t:Asset {x6Id: r.target}) 
             CREATE (s)-[:CONTROLS {
               fromPort:   r.sourcePort, 
               toPort:     r.targetPort,
               fluid:      'Signal',
               vertices:   r.vertices 
             }]->(t)`, 
            { batch: controlSignals }
          );
        }

        if (measureSignals.length) {
          await tx.run(
            `UNWIND $batch AS r 
             MATCH (inst:Asset {x6Id: r.target}), (tp:Asset {x6Id: r.source}) 
             CREATE (inst)-[:MEASURES {
               fromPort:   r.targetPort,
               toPort:     r.sourcePort,
               fluid:      'Signal',
               vertices:   r.vertices
             }]->(tp)`, 
            { batch: measureSignals }
          );
        }
      }
    }

    await tx.commit();
  } catch (e) {
    await tx.rollback();
    throw e;
  } finally {
    await session.close();
  }
};


  export const loadGraphData = async () => {
  const session = driver.session();
  try {
    // 1. 加载节点
    const nodesResult = await session.run(
      `MATCH (n:Asset {drawingId: $drawingId}) RETURN n`,
      { drawingId: CURRENT_DRAWING_ID }
    );
    
    const nodes = nodesResult.records.map(record => {
      const props = record.get('n').properties;
      
      // 1. 解析 layout JSON
      let layout: any = { x: 0, y: 0, w: 40, h: 40, a: 0 };
      if (props.layout) {
        try {
          layout = JSON.parse(props.layout);
        } catch (e) {
          console.warn('Layout parse failed for node:', props.x6Id);
        }
      } else {
        // 兼容旧数据
        layout = {
          x: props.x || 0,
          y: props.y || 0,
          w: props.width || 40,
          h: props.height || 40,
          a: props.angle || 0
        };
      }

      // ... (Tag 处理逻辑保持不变) ...
      if (props.Tag) { props.tag = props.Tag; }
      const isTee = props.type === 'Fitting';
      if (isTee) { props.tag = 'TEE'; props.Tag = 'TEE'; }

      // ... (Shape 映射逻辑保持不变) ...
      let shapeName = 'p-valve'; 
      switch (props.type) {
          
          case 'Reactor':      shapeName = 'p-reactor'; break;
          case 'Exchanger':    shapeName = 'p-exchanger'; break;
          case 'Pump':         shapeName = 'p-pump'; break;
          case 'LiquidPump':   shapeName = 'p-pump-liquid'; break;
          case 'CentrifugalPump': shapeName = 'p-pump-centrifugal'; break;
          case 'DiaphragmPump': shapeName = 'p-pump-diaphragm'; break;
          case 'PistonPump':   shapeName = 'p-pump-piston'; break;
          case 'Compressor':   shapeName = 'p-pump-compressor'; break;
          case 'GearPump':     shapeName = 'p-pump-gear'; break;
          case 'Fan':          shapeName = 'p-pump-fan'; break;
          case 'JetPump':      shapeName = 'p-pump-jet'; break;
          case 'ControlValve': shapeName = 'p-cv-pneumatic'; break;
          case 'Valve':        shapeName = 'p-cv-manual'; break;
          case 'Fitting':      shapeName = 'p-tee'; break; 
          case 'Tank':         if (props.spec === 'Vertical') {shapeName = 'p-tank-vertical';} else {shapeName = 'p-tank-horizontal';} break;
          case 'GasCooler':    shapeName = 'p-gas-cooler'; break;
          case 'Trap':         shapeName = 'p-trap'; break;
          case 'Trap':         shapeName = 'p-tv-trap'; break;
          case 'FixedBedReactor': shapeName = 'p-fixed-bed-reactor'; break;
          case 'VerticalExchanger': shapeName = 'p-exchanger-vertical'; break;
          case 'Evaporator':   shapeName = 'p-naphthalene-evaporator'; break;
          case 'Instrument':   
            if(props.spec === 'Local') shapeName = 'p-inst-local';
            else if(props.spec === 'Panel') shapeName = 'p-inst-panel';
            else shapeName = 'p-inst-remote';
            break;
          case 'TappingPoint': shapeName = 'tapping-point'; break;
          default: break;
      }

      // [核心修正 1] 清理 props，分离出纯业务数据
      // 我们不希望 data 里包含 layout 字符串，也不希望包含旧的 x,y
      const { layout: _layoutStr, x, y, width, height, angle, ...businessData } = props;

      return {
        id: props.x6Id,
        shape: shapeName, 
        
        // [核心修正 2] 使用解析后的 layout 变量
        // 注意：保存时用的键是 w, h, a，这里要对应上
        x: layout.x,
        y: layout.y,
        width: layout.w, 
        height: layout.h,
        angle: layout.a, 
        
        // [核心修正 3] data 只放入清洗后的业务数据
        data: { ...businessData }, 
        
        attrs: { 
          label: { 
            text: isTee ? '' : (props.Tag || props.tag || props.label),
            display: isTee ? 'none' : undefined
          },
          topLabel: props.tagId ? { text: props.tagId } : undefined,
          bottomLabel: props.loopNum ? { text: props.loopNum } : undefined,
        }
      };
    });

    // 2. [修改] 加载连线 (匹配 :Asset)
    const edgesResult = await session.run(`
      MATCH (s:Asset {drawingId: $drawingId})-[r:PIPE|MEASURES|CONTROLS]->(t:Asset {drawingId: $drawingId}) 
      RETURN s.x6Id as sourceId, t.x6Id as targetId, r, type(r) as relType
    `, { drawingId: CURRENT_DRAWING_ID });
    
    // ... (edges map 逻辑保持不变) ...
    const edges = edgesResult.records.map(record => {
        // ... 保持原样 ...
        const rel = record.get('r').properties;
        const relType = record.get('relType'); 
        const sourceId = record.get('sourceId');
        const targetId = record.get('targetId');
        
        let strokeWidth = 2;
        let strokeColor = FLUID_COLORS[rel.fluid] || '#5F95FF';
        let dashArray = null;
        let targetMarker: any = null; 
        let edgeType = 'Pipe'; 
        let labels: any[] = [];
        let vertices = [];
        
        if (rel.vertices) {
            try { vertices = JSON.parse(rel.vertices); } catch (e) { console.warn('Vertices parse error', e); }
        }

        if (relType === 'MEASURES' || relType === 'CONTROLS') {
            strokeWidth = 1;
            strokeColor = FLUID_COLORS.Signal; 
            dashArray = '4 4';    
            targetMarker = { name: 'classic', width: 10, height: 6 }; 
            edgeType = 'Signal';
        } else {
            targetMarker = { name: 'classic', width: 8, height: 6 }; 
            if (rel.insulation && rel.insulation.startsWith('Jacket')) {
            strokeWidth = 4;
            strokeColor = FLUID_COLORS.Oil; 
            } else if (['ST', 'ET', 'OT'].includes(rel.insulation)) {
            dashArray = '5 5'; 
            }
        }

        if (relType === 'PIPE' && rel.tag) {
            labels.push({
            attrs: { label: { text: rel.tag }, body: { fill: '#fff', stroke: '#333' } },
            position: { distance: 0.5, args: { y: -15 } } 
            });
        }

        let finalSourceId = sourceId;
        let finalTargetId = targetId;
        let finalSourcePort = rel.fromPort;
        let finalTargetPort = rel.toPort;

        if (relType === 'MEASURES') {
            finalSourceId = targetId; 
            finalTargetId = sourceId; 
            finalSourcePort = rel.toPort;   
            finalTargetPort = rel.fromPort; 
        }

        return {
            shape: edgeType === 'Signal' ? 'signal-edge' : 'edge',
            source: { cell: finalSourceId, port: finalSourcePort || undefined },
            target: { cell: finalTargetId, port: finalTargetPort || undefined },
            vertices: vertices, 
            attrs: { 
            line: { 
                stroke: strokeColor,
                strokeWidth: strokeWidth,
                strokeDasharray: dashArray,
                targetMarker: targetMarker
            } 
            },
            labels: labels,
            data: { 
            type: edgeType, 
            relationType: relType, 
            material: rel.material, 
            fluid: rel.fluid,
            dn: rel.dn,
            pn: rel.pn,
            insulation: rel.insulation
            }
        };
    });

    return { nodes, edges };
  } finally {
    await session.close();
  }
};
</file>

</files>
