This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
public/
  vite.svg
src/
  assets/
    react.svg
  components/
    Editor/
      Canvas/
        index.css
        index.tsx
      ContextMenu/
        index.css
        index.tsx
      Inspector/
        index.tsx
      Toolbar/
        index.css
        index.tsx
  config/
    rules.ts
  graph/
    cells/
      svgs/
        cv-electric.svg
        cv-manual.svg
        cv-piston.svg
        cv-pneumatic.svg
        cv-positioner.svg
        cv-solenoid.svg
        E-13.svg
        exchanger-vertical.svg
        exchanger.svg
        frame-a2.svg
        gas-cooler.svg
        inst-local.svg
        inst-panel.svg
        inst-remote.svg
        pump-centrifugal.svg
        pump-compressor.svg
        pump-diaphragm.svg
        pump-fan.svg
        pump-gear.svg
        pump-general.svg
        pump-jet.svg
        pump-liquid.svg
        pump-piston.svg
        reactor-fixed-bed.svg
        reactor.svg
        tank-horizontal.svg
        tee.svg
        trap.svg
      icons.ts
      registry.ts
  services/
    neo4j.ts
  App.css
  App.tsx
  index.css
  main.tsx
.gitignore
eslint.config.js
index.html
package.json
README.md
tsconfig.app.json
tsconfig.json
tsconfig.node.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="src/assets/react.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
</file>

<file path="src/components/Editor/ContextMenu/index.css">
.context-menu {
  position: fixed; /* ä½¿ç”¨ fixed é¿å…è¢«ç”»å¸ƒå®¹å™¨é®æŒ¡ */
  z-index: 9999;
  background: #fff;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  padding: 4px 0;
  border: 1px solid #eee;
  min-width: 120px;
  user-select: none;
}

.context-menu-item {
  padding: 6px 12px;
  cursor: pointer;
  font-size: 13px;
  color: #333;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: background 0.2s;
}

.context-menu-item:hover {
  background-color: #f5f5f5;
  color: #1890ff;
}

.context-menu-item.danger {
  color: #ff4d4f;
}

.context-menu-item.danger:hover {
  background-color: #fff1f0;
}

.context-menu-divider {
  height: 1px;
  background-color: #eee;
  margin: 4px 0;
}
</file>

<file path="src/components/Editor/Toolbar/index.css">
.toolbar-container {
  position: absolute;
  top: 20px;
  left: 260px; /* èº²å¼€å·¦ä¾§ Stencil */
  z-index: 100;
  background: #fff;
  padding: 4px 12px;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  gap: 4px;
}
</file>

<file path="src/components/Editor/Toolbar/index.tsx">
import React, { useEffect, useState } from 'react';
import { Button, Tooltip, Divider } from 'antd';
import { 
  ZoomInOutlined, 
  ZoomOutOutlined, 
  UndoOutlined, 
  RedoOutlined, 
  ExpandOutlined, 
  CompressOutlined, 
  DeleteOutlined 
} from '@ant-design/icons';
import { Graph } from '@antv/x6';
import './index.css';

interface ToolbarProps {
  graph: Graph | null;
}

const Toolbar: React.FC<ToolbarProps> = ({ graph }) => {
  const [canUndo, setCanUndo] = useState(false);
  const [canRedo, setCanRedo] = useState(false);

  useEffect(() => {
    // 1. åŸºç¡€æ£€æŸ¥
    if (!graph) return;

    // 2. é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿ history æ’ä»¶å·²åŠ è½½
    // å¦‚æœ graph.history æ˜¯ undefinedï¼Œè¯´æ˜æ’ä»¶è¿˜æ²¡åˆå§‹åŒ–å¥½ï¼Œç›´æ¥è¿”å›ï¼Œé¿å…å´©æºƒ
    const { history } = graph;
    if (!history) {
      return;
    }

    const updateState = () => {
      setCanUndo(history.canUndo());
      setCanRedo(history.canRedo());
    };

    // 3. å®‰å…¨è®¢é˜…äº‹ä»¶
    history.on('change', updateState);
    history.on('undo', updateState);
    history.on('redo', updateState);
        // åˆå§‹åŒ–æ—¶å…ˆæ‰§è¡Œä¸€æ¬¡
    updateState();
    
    return () => {
      history.off('change', updateState);
      history.off('undo', updateState);
      history.off('redo', updateState);
    };
  }, [graph]);

  if (!graph) return null;

  return (
    <div className="toolbar-container">
      <Tooltip title="æ’¤é”€ (Cmd+Z)">
        <Button type="text" icon={<UndoOutlined />} disabled={!canUndo} onClick={() => graph?.history?.undo()} />
      </Tooltip>
      <Tooltip title="é‡åš (Cmd+Shift+Z)">
        <Button type="text" icon={<RedoOutlined />} disabled={!canRedo} onClick={() => graph?.history?.redo()} />
      </Tooltip>
      
      {/* ä¿®å¤ Antd Divider è­¦å‘Šï¼Œå»æ‰ type="vertical"ï¼Œä½¿ç”¨ CSS æˆ–é»˜è®¤å³å¯ï¼Œè¿™é‡Œç”¨ style æ¨¡æ‹Ÿ */}
      <span style={{ width: 1, height: 16, background: '#eee', margin: '0 4px' }} />
      
      <Tooltip title="æ”¾å¤§">
        <Button type="text" icon={<ZoomInOutlined />} onClick={() => graph.zoom(0.1)} />
      </Tooltip>
      <Tooltip title="ç¼©å°">
        <Button type="text" icon={<ZoomOutOutlined />} onClick={() => graph.zoom(-0.1)} />
      </Tooltip>
      <Tooltip title="é€‚åº”ç”»å¸ƒ">
        <Button type="text" icon={<CompressOutlined />} onClick={() => graph.zoomToFit({ padding: 20 })} />
      </Tooltip>
      <Tooltip title="1:1">
        <Button type="text" icon={<ExpandOutlined />} onClick={() => graph.zoomTo(1)} />
      </Tooltip>

      <span style={{ width: 1, height: 16, background: '#eee', margin: '0 4px' }} />

      <Tooltip title="åˆ é™¤é€‰ä¸­ (Delete)">
        <Button 
          type="text" 
          danger
          icon={<DeleteOutlined />} 
          onClick={() => {
            const cells = graph.getSelectedCells();
            if(cells.length) graph.removeCells(cells);
          }} 
        />
      </Tooltip>
    </div>
  );
};

export default Toolbar;
</file>

<file path="src/config/rules.ts">
// src/config/rules.ts
// ============================================================================
// å…¨å±€ä¸šåŠ¡è§„åˆ™é…ç½®
// ============================================================================

// 1. å½“å‰å›¾çº¸ ID (ä¸ºå¤šé¡µç³»ç»Ÿåšå‡†å¤‡ï¼Œç›®å‰æš‚å®šä¸º Draft_V1)
export const CURRENT_DRAWING_ID = 'Draft_V1';

// 2. ä»‹è´¨é¢œè‰²å®šä¹‰
export const FLUID_COLORS: Record<string, string> = {
  Water: '#1890ff',       // å·¥è‰ºæ°´ - è“
  Steam: '#ff4d4f',       // è’¸æ±½ - çº¢
  Air: '#52c41a',         // ç©ºæ°” - ç»¿
  N2: '#13c2c2',          // æ°®æ°” - é’
  Oil: '#fa8c16',         // å¯¼çƒ­æ²¹ - æ©™
  Salt: '#722ed1',        // ç†”ç› - ç´«
  Naphthalene: '#8c8c8c', // è˜ - æ·±ç°
  PA: '#eb2f96',          // è‹¯é… - æ´‹çº¢
  CrudePA: '#f759ab',     // ç²—è‹¯é… - æµ…æ´‹çº¢
  ProductGas: '#faad14',  // äº§ç‰©æ°” - é‡‘é»„
  TailGas: '#bfbfbf',     // å°¾æ°” - æµ…ç°
  Signal: '#888888',      // ä¿¡å·çº¿ - ç°
};

// 3. åœ¨çº¿å…ƒä»¶åˆ—è¡¨
// è¿™äº›è®¾å¤‡è¢«è§†ä¸º"ç®¡çº¿çš„ä¸€éƒ¨åˆ†"ï¼Œè·¯ç”±ç®—æ³•ä¼šå¿½ç•¥å®ƒä»¬çš„ä½“ç§¯ï¼Œå…è®¸ç›´çº¿ç©¿è¿‡
export const INLINE_TYPES = [
  'ControlValve', 
  'Valve', 
  'Fitting', 
  'TappingPoint'
];

// 4. è·¯ç”±é»˜è®¤é…ç½®
export const DEFAULT_ROUTER = {
  name: 'manhattan',
  args: {
    padding: 20,
    excludeNodes: ['SHEET_FRAME_A2'], // é»˜è®¤æ’é™¤èƒŒæ™¯æ¡†
  },
};
</file>

<file path="src/graph/cells/svgs/cv-electric.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 100" fill="none" stroke="black" stroke-width="2">
  <polygon points="5,75 30,85 5,95" fill="white" />
  <polygon points="55,75 30,85 55,95" fill="white" />
  <line x1="30" y1="85" x2="30" y2="40" />
  <circle cx="30" cy="25" r="15" fill="white" />
  <!-- æ–‡å­— M -->
  <text x="30" y="30" text-anchor="middle" font-family="Arial" font-size="16" fill="black">M</text>
</svg>
</file>

<file path="src/graph/cells/svgs/cv-manual.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 100" fill="none" stroke="black" stroke-width="2">
  <polygon points="5,75 30,85 5,95" fill="white" />
  <polygon points="55,75 30,85 55,95" fill="white" />
  <line x1="30" y1="85" x2="30" y2="40" />
  <circle cx="30" cy="25" r="15" fill="white" />
  <text x="30" y="30" text-anchor="middle" font-family="Arial" font-size="16" fill="black">H</text>
</svg>
</file>

<file path="src/graph/cells/svgs/cv-piston.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 100" fill="none" stroke="black" stroke-width="2">
  <!-- é˜€ä½“ (Bowtie) -->
  <polygon points="5,75 30,85 5,95" fill="white" />
  <polygon points="55,75 30,85 55,95" fill="white" />
  
  <!-- é˜€æ† -->
  <line x1="30" y1="85" x2="30" y2="40" />
  
  <!-- æ‰§è¡Œæœºæ„ï¼šä¸¤ä¸ªå¤§å°ç›¸åŒçš„çŸ©å½¢ -->
  <!-- ä¸‹çŸ©å½¢ -->
  <rect x="15" y="25" width="30" height="15" fill="white" />
  <!-- ä¸ŠçŸ©å½¢ -->
  <rect x="15" y="10" width="30" height="15" fill="white" />
</svg>
</file>

<file path="src/graph/cells/svgs/cv-pneumatic.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 100" fill="none" stroke="black" stroke-width="2">
  <!-- é˜€ä½“ (Bowtie) -->
  <polygon points="5,75 30,85 5,95" fill="white" />
  <polygon points="55,75 30,85 55,95" fill="white" />
  <!-- é˜€æ† -->
  <line x1="30" y1="85" x2="30" y2="40" />
  <!-- æ‰§è¡Œæœºæ„ (åœ†å¤´) -->
  <circle cx="30" cy="25" r="15" fill="white" />
  <!-- æ–‡å­— P -->
  <text x="30" y="30" text-anchor="middle" font-family="Arial" font-size="16" fill="black">P</text>
</svg>
</file>

<file path="src/graph/cells/svgs/cv-positioner.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 100" fill="none" stroke="black" stroke-width="2">
  <!-- é˜€ä½“ (åº•éƒ¨åŒä¸‰è§’) -->
  <polygon points="5,75 30,85 5,95" fill="white" />
  <polygon points="55,75 30,85 55,95" fill="white" />
  
  <!-- é˜€æ† -->
  <line x1="30" y1="85" x2="30" y2="40" />
  
  <!-- æ‰§è¡Œæœºæ„ (åœ†å¤´) -->
  <!-- åœ†å¿ƒ(30,25), åŠå¾„15 -> é¡¶ç«¯y=10 -->
  <circle cx="30" cy="25" r="15" fill="white" />
  
  <!-- æ–‡å­— P -->
  <text x="30" y="30" text-anchor="middle" font-family="Arial" font-size="16" fill="black">P</text>
  
  <!-- å®šä½å™¨æ–¹å— (å¤–æ¥äºåœ†é¡¶) -->
  <!-- xå±…ä¸­: 30-7=23, yä»0å¼€å§‹, é«˜åº¦10 -> åº•éƒ¨y=10 (åˆšå¥½æ¥è§¦åœ†é¡¶) -->
  <rect x="23" y="0" width="14" height="10" fill="white" />
</svg>
</file>

<file path="src/graph/cells/svgs/cv-solenoid.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 90 100" fill="none" stroke="black" stroke-width="2">
  <!-- é˜€ä½“ (ä½äºå·¦ä¾§ï¼Œä¸­å¿ƒå¯¹é½åœ† P) -->
  <!-- å·¦ä¸‰è§’å½¢ -->
  <polygon points="5,75 30,85 5,95" fill="white" />
  <!-- å³ä¸‰è§’å½¢ -->
  <polygon points="55,75 30,85 55,95" fill="white" />
  
  <!-- é˜€æ† -->
  <line x1="30" y1="85" x2="30" y2="40" />

  <!-- ä¸»æ°”åŠ¨å¤´ P (åœ†å¿ƒ x=30, r=15) -->
  <circle cx="30" cy="25" r="15" fill="white" />
  <text x="30" y="30" text-anchor="middle" font-family="Arial" font-size="16" fill="black">P</text>

  <!-- ç”µç£é˜€ S (åœ†å¿ƒ x=60, r=15) -->
  <!-- ä¸ P æ°´å¹³ç›¸æ¥ï¼Œç›´å¾„ç›¸åŒ -->
  <circle cx="60" cy="25" r="15" fill="white" />
  <text x="60" y="30" text-anchor="middle" font-family="Arial" font-size="16" fill="black">S</text>
</svg>
</file>

<file path="src/graph/cells/svgs/E-13.svg">
<svg xmlns="http://www.w3.org/2000/svg" width="1000" height="450" viewBox="0 0 1000 450" fill="none" stroke="black" stroke-width="2">
  <g>
    <!-- 1. å³ä¾§åŠ çƒ­å™¨ (Heater) - åº•å±‚ -->
    
    <!-- å†…éƒ¨ç®¡æŸä¸»ä½“ (Internal Tubes) -->
    <!-- x=500 åˆ° x=810 -->
    <rect x="500" y="250" width="310" height="150" fill="white" stroke="#000000" stroke-width="2"/>
    
    <!-- è¿æ¥æ³•å…° (Flange) -->
    <!-- x=810 -->
    <line x1="810" y1="245" x2="810" y2="405" stroke-width="4" />

    <!-- [æ–°å¢] åŠ çƒ­å™¨å¤–ä¼¸ç­’ä½“ (Extension Cylinder) -->
    <!-- å®½åº¦=40 (ç­‰äºå°å¤´æ·±åº¦), x=810 åˆ° 850 -->
    <rect x="810" y="250" width="40" height="150" fill="white" stroke="#000000" stroke-width="2"/>

    <!-- å¤–éƒ¨å°å¤´ (Head) -->
    <!-- èµ·ç‚¹å³ç§»è‡³ x=850 -->
    <path d="M850,250 A40,75 0 0,1 850,400" fill="white" stroke="#000000" stroke-width="2"/>
    
    <!-- å°å¤´éš”æ¿ (Separator) -->
    <!-- ä»æ³•å…° x=810 å»¶ä¼¸è‡³å°å¤´é¡¶ç«¯ x=890 (850+40) -->
    <line x1="810" y1="325" x2="890" y2="325" stroke-width="2" />
    
    <!-- ç®¡æŸç¤ºæ„çº¿ (Tubes) -->
    <!-- é¡¶åˆ°æ³•å…°ä¸ºæ­¢ x2=810 -->
    <g stroke="#000000" stroke-width="1" opacity="0.6">
      <line x1="510" y1="270" x2="810" y2="270" />
      <line x1="510" y1="290" x2="810" y2="290" />
      <line x1="510" y1="310" x2="810" y2="310" />
      <line x1="510" y1="330" x2="810" y2="330" />
      <line x1="510" y1="350" x2="810" y2="350" />
      <line x1="510" y1="370" x2="810" y2="370" />
    </g>

    <!-- 2. ä¸»ç½ä½“ (Main Vessel) - é¡¶å±‚è¦†ç›– -->
    <rect x="100" y="25" width="600" height="400" fill="white" stroke="#000000" stroke-width="2"/>
    <path d="M100,25 A50,200 0 0,0 100,425" fill="white" stroke="#000000" stroke-width="2"/>
    <path d="M700,25 A50,200 0 0,1 700,425" fill="white" stroke="#000000" stroke-width="2"/>
  </g>
</svg>
</file>

<file path="src/graph/cells/svgs/exchanger-vertical.svg">
<svg viewBox="0 0 100 400" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="black" stroke-width="2">
  <!-- 1. ä¸»ä½“ (Body) - ä¿æŒä¸å˜ -->
  <path d="M10,40 A40,30 0 0,1 90,40" fill="white" />
  <rect x="10" y="40" width="80" height="320" fill="white" stroke="none" />
  <line x1="10" y1="40" x2="10" y2="360" />
  <line x1="90" y1="40" x2="90" y2="360" />
  <path d="M10,360 A40,30 0 0,0 90,360" fill="white" />

  <!-- 2. å†…éƒ¨ç®¡æŸ (Internal Tubes) - ä¿æŒä¸å˜ -->
  <line x1="10" y1="40" x2="90" y2="40" stroke-width="2" />
  <line x1="10" y1="360" x2="90" y2="360" stroke-width="2" />
  <g stroke-width="1">
    <line x1="18" y1="40" x2="18" y2="360" />
    <line x1="26" y1="40" x2="26" y2="360" />
    <line x1="34" y1="40" x2="34" y2="360" />
    <line x1="42" y1="40" x2="42" y2="360" />
    <line x1="50" y1="40" x2="50" y2="360" />
    <line x1="58" y1="40" x2="58" y2="360" />
    <line x1="66" y1="40" x2="66" y2="360" />
    <line x1="74" y1="40" x2="74" y2="360" />
    <line x1="82" y1="40" x2="82" y2="360" />
  </g>

  <!-- 3. ä¾§é¢æ¥å£ (Side Nozzles) -->
  
  <!-- å·¦ä¸Š -->
  <line x1="0" y1="80" x2="10" y2="80" stroke-width="3" />
  
  <!-- å·¦ä¸‹ (ä¿®æ”¹å¤„ï¼šæ”¹ä¸ºæ™®é€šæ¥å£) -->
  <!-- åŸæ¥æ˜¯ rectï¼Œç°åœ¨æ”¹ä¸º lineï¼Œä½ç½® y=320 -->
  <line x1="0" y1="320" x2="10" y2="320" stroke-width="3" />

  <!-- å³ä¸Š -->
  <line x1="90" y1="60" x2="100" y2="60" stroke-width="3" />
  <!-- å³ä¸‹ -->
  <line x1="90" y1="340" x2="100" y2="340" stroke-width="3" />

  <!-- 4. å°å¤´æ¥å£ (Head Nozzles) - ä¿æŒä¸å˜ -->
  <line x1="30" y1="10" x2="30" y2="20" stroke-width="2" />
  <line x1="70" y1="10" x2="70" y2="20" stroke-width="2" />
  <line x1="30" y1="380" x2="30" y2="390" stroke-width="2" />
  <line x1="70" y1="380" x2="70" y2="390" stroke-width="2" />

</svg>
</file>

<file path="src/graph/cells/svgs/exchanger.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="-20 0 340 120" fill="none" stroke="black" stroke-width="2" style="background-color:transparent">
  <!-- 
     ä¿®æ­£ç­–ç•¥ï¼šè°ƒæ•´ç»˜åˆ¶é¡ºåº (Painter's Algorithm)
     1. å…ˆç”»ç­’ä½“ (ç™½è‰²èƒŒæ™¯)
     2. å†ç”»å†…éƒ¨ç®¡æŸ (å åœ¨ç­’ä½“ä¸Š)
     3. å†ç”»ä¸¤ç«¯æ³•å…°å’Œå°å¤´ (å åœ¨æœ€ä¸Šå±‚ä»¥é®æŒ¡å¤šä½™çº¿æ¡)
  -->

  <!-- 1. ä¸»ç­’ä½“ (Shell) - ç§»åˆ°æœ€å‰ï¼Œä½œä¸ºåº•å›¾ -->
  <rect x="50" y="20" width="230" height="80" fill="white" stroke-width="2" />

  <!-- 2. å†…éƒ¨ç®¡æŸ (Tubes) - ç°åœ¨ä¼šæ˜¾ç¤ºåœ¨ç™½è‰²ç­’ä½“ä¹‹ä¸Š -->
  <g stroke="#333" stroke-width="1">
    <line x1="50" y1="30" x2="280" y2="30" />
    <line x1="50" y1="40" x2="280" y2="40" />
    <line x1="50" y1="50" x2="280" y2="50" />
    <line x1="50" y1="60" x2="280" y2="60" /> <!-- ä¸­å¿ƒçº¿ -->
    <line x1="50" y1="70" x2="280" y2="70" />
    <line x1="50" y1="80" x2="280" y2="80" />
    <line x1="50" y1="90" x2="280" y2="90" />
  </g>

  <!-- 3. å·¦ä¾§ç»“æ„ (ç®¡ç®± + éš”æ¿) -->
  <!-- å·¦æ³•å…° (ç›´å¾„90) -->
  <rect x="45" y="15" width="5" height="90" fill="white" />
  
  <!-- å·¦å°å¤´ (åŠ é•¿å‹) -->
  <path d="M45 20 C -5 20, -5 100, 45 100" fill="white" />
  
  <!-- éš”æ¿ (è™šçº¿ï¼Œç”»åœ¨å°å¤´ä¹‹ä¸Š) -->
  <line x1="45" y1="60" x2="5" y2="60" stroke-width="2" stroke-dasharray="4,2" />

  <!-- 4. å³ä¾§ç»“æ„ -->
  <!-- å³æ³•å…° (ç›´å¾„90) -->
  <rect x="280" y="15" width="5" height="90" fill="white" />
  <!-- å³å°å¤´ -->
  <path d="M285 20 C 315 20, 315 100, 285 100" fill="white" />

  <!-- 5. ç®¡å£ (Nozzles) -->
  
  <!-- N1: å£³ç¨‹å…¥å£ (ä¸Š) -->
  <line x1="95" y1="20" x2="95" y2="5" stroke-width="2"/>
  <line x1="90" y1="5" x2="100" y2="5" stroke-width="2"/>

  <!-- N2: å£³ç¨‹å‡ºå£ (ä¸‹) -->
  <line x1="235" y1="100" x2="235" y2="115" stroke-width="2"/>
  <line x1="230" y1="115" x2="240" y2="115" stroke-width="2"/>

  <!-- N4: ç®¡ç¨‹å‡ºå£ (å·¦ä¸Š - ä½äºéš”æ¿ä¸Šæ–¹) -->
  <line x1="8" y1="35" x2="-15" y2="35" stroke-width="2"/>
  <line x1="-15" y1="30" x2="-15" y2="40" stroke-width="2"/>

  <!-- N3: ç®¡ç¨‹å…¥å£ (å·¦ä¸‹ - ä½äºéš”æ¿ä¸‹æ–¹) -->
  <line x1="8" y1="85" x2="-15" y2="85" stroke-width="2"/>
  <line x1="-15" y1="80" x2="-15" y2="90" stroke-width="2"/>

  <!-- N5: æ”¾ç©º (å³ä¸Š) -->
  <line x1="303" y1="23" x2="310" y2="15" stroke-width="2"/>
  <line x1="307" y1="12" x2="313" y2="18" stroke-width="2"/>

  <!-- N6: æ’å‡€ (å³ä¸‹) -->
  <line x1="303" y1="97" x2="310" y2="105" stroke-width="2"/>
  <line x1="307" y1="108" x2="313" y2="102" stroke-width="2"/>
</svg>
</file>

<file path="src/graph/cells/svgs/frame-a2.svg">
<svg xmlns="http://www.w3.org/2000/svg" width="2245" height="1587" viewBox="0 0 2245 1587">
  <!-- A2 Size @ 96DPI -->
  <defs>
    <style>
      .border { fill: none; stroke: #000; stroke-width: 2; }
      .inner { fill: none; stroke: #000; stroke-width: 4; }
      .text { font-family: sans-serif; font-size: 24px; fill: #666; }
    </style>
  </defs>
  
  <!-- 1. çº¸å¼ è¾¹ç¼˜ (å·²ä¿®æ”¹ï¼šfill="none" å®ç°é€æ˜) -->
  <rect width="100%" height="100%" fill="none" />
  
  <!-- 2. å¤–æ¡† (çº¸å¼ è£åˆ‡çº¿) -->
  <rect x="1" y="1" width="2243" height="1585" class="border" stroke-dasharray="10,10" stroke="#ccc"/>
  
  <!-- 3. å†…æ¡† (ç»˜å›¾åŒº) -->
  <rect x="94" y="38" width="2113" height="1511" class="inner" />
  
  <!-- 4. æ ‡é¢˜æ  -->
  <g transform="translate(1527, 1399)">
    <rect width="680" height="150" fill="none" stroke="#000" stroke-width="2"/>
    <line x1="0" y1="50" x2="680" y2="50" stroke="#000" />
    <line x1="0" y1="100" x2="680" y2="100" stroke="#000" />
    <line x1="200" y1="0" x2="200" y2="150" stroke="#000" />
    <text x="20" y="35" class="text">é¡¹ç›®åç§°: åŒ–å·¥å·¥è‰ºæµç¨‹å›¾</text>
    <text x="20" y="85" class="text">å›¾å·: PID-001</text>
    <text x="20" y="135" class="text">è®¾è®¡é˜¶æ®µ: è¯¦ç»†è®¾è®¡</text>
    <text x="220" y="85" class="text" font-size="32" font-weight="bold">æ™ºèƒ½ P&amp;ID ç¼–è¾‘å™¨</text>
  </g>
  
  <text x="110" y="70" class="text" font-size="16">A2 (594x420mm)</text>
</svg>
</file>

<file path="src/graph/cells/svgs/gas-cooler.svg">
<svg viewBox="0 0 400 260" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="black" stroke-width="2">
  <!-- 1. å¤–æ¡† (Frame) - ä¿æŒä¸å˜ -->
  <path d="M20,60 L380,60 L380,240 L60,240 L20,200 Z" fill="white" />

  <!-- 2. å·¦å³è¿æ¥æ¡© - ä¿æŒä¸å˜ -->
  <line x1="0" y1="150" x2="20" y2="150" stroke-width="3" />
  <line x1="380" y1="150" x2="400" y2="150" stroke-width="3" />

  <!-- 3. é¡¶éƒ¨çˆ†ç ´ç‰‡æ³•å…° - ä¿æŒä¸å˜ -->
  <g>
    <rect x="25" y="50" width="20" height="10" fill="white" />
    <line x1="35" y1="50" x2="35" y2="60" />
  </g>
  <g>
    <rect x="355" y="50" width="20" height="10" fill="white" />
    <line x1="365" y1="50" x2="365" y2="60" />
  </g>

  <!-- 4. æ¢çƒ­ç®¡æŸ (7ç»„) -->
  <!-- ä¿®æ”¹è¯´æ˜ï¼šæ‰€æœ‰ translate çš„ x åæ ‡å¢åŠ  15 (åŠä¸ªç®¡æŸå®½) -->
  <!-- åŸåæ ‡: 55, 95, 135, 175, 215, 255, 295 -->
  <!-- æ–°åæ ‡: 70, 110, 150, 190, 230, 270, 310 -->
  
  <g transform="translate(70, 40)"> <!-- ç¬¬1ç»„ -->
    <rect x="0" y="0" width="30" height="200" rx="15" ry="15" fill="white" />
    <line x1="0" y1="20" x2="30" y2="20" /> <line x1="0" y1="180" x2="30" y2="180" />
    <path d="M6,25 V175 M12,25 V175 M18,25 V175 M24,25 V175" stroke-width="1"/>
  </g>

  <g transform="translate(110, 40)"> <!-- ç¬¬2ç»„ -->
    <rect x="0" y="0" width="30" height="200" rx="15" ry="15" fill="white" />
    <line x1="0" y1="20" x2="30" y2="20" /> <line x1="0" y1="180" x2="30" y2="180" />
    <path d="M6,25 V175 M12,25 V175 M18,25 V175 M24,25 V175" stroke-width="1"/>
  </g>

  <g transform="translate(150, 40)"> <!-- ç¬¬3ç»„ -->
    <rect x="0" y="0" width="30" height="200" rx="15" ry="15" fill="white" />
    <line x1="0" y1="20" x2="30" y2="20" /> <line x1="0" y1="180" x2="30" y2="180" />
    <path d="M6,25 V175 M12,25 V175 M18,25 V175 M24,25 V175" stroke-width="1"/>
  </g>

  <g transform="translate(190, 40)"> <!-- ç¬¬4ç»„ -->
    <rect x="0" y="0" width="30" height="200" rx="15" ry="15" fill="white" />
    <line x1="0" y1="20" x2="30" y2="20" /> <line x1="0" y1="180" x2="30" y2="180" />
    <path d="M6,25 V175 M12,25 V175 M18,25 V175 M24,25 V175" stroke-width="1"/>
  </g>

  <g transform="translate(230, 40)"> <!-- ç¬¬5ç»„ -->
    <rect x="0" y="0" width="30" height="200" rx="15" ry="15" fill="white" />
    <line x1="0" y1="20" x2="30" y2="20" /> <line x1="0" y1="180" x2="30" y2="180" />
    <path d="M6,25 V175 M12,25 V175 M18,25 V175 M24,25 V175" stroke-width="1"/>
  </g>

  <g transform="translate(270, 40)"> <!-- ç¬¬6ç»„ -->
    <rect x="0" y="0" width="30" height="200" rx="15" ry="15" fill="white" />
    <line x1="0" y1="20" x2="30" y2="20" /> <line x1="0" y1="180" x2="30" y2="180" />
    <path d="M6,25 V175 M12,25 V175 M18,25 V175 M24,25 V175" stroke-width="1"/>
  </g>

  <g transform="translate(310, 40)"> <!-- ç¬¬7ç»„ -->
    <rect x="0" y="0" width="30" height="200" rx="15" ry="15" fill="white" />
    <line x1="0" y1="20" x2="30" y2="20" /> <line x1="0" y1="180" x2="30" y2="180" />
    <path d="M6,25 V175 M12,25 V175 M18,25 V175 M24,25 V175" stroke-width="1"/>
  </g>

</svg>
</file>

<file path="src/graph/cells/svgs/pump-centrifugal.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <circle cx="50" cy="50" r="48" fill="white" />
  <path d="M 4 50 L 50 4 L 96 50" stroke-linejoin="round" />
  <!-- ä¸­å¿ƒå‚ç›´çº¿ -->
  <line x1="50" y1="4" x2="50" y2="98" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-compressor.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <!-- å¤–åœ† (ç™½åº•é®æŒ¡ç½‘æ ¼) -->
  <circle cx="50" cy="50" r="48" fill="white" />
  
  <!-- æ¢¯å½¢ç»“æ„ (ä¿®æ­£ç‰ˆ) -->
  <!-- 
       å‡ ä½•è®¡ç®—åŸºäºåœ†å¿ƒ(50,50) åŠå¾„48:
       - åº•éƒ¨ä¸¤ç‚¹ (y=85): x=17, x=83 (æ›´å®½ï¼Œè´´åˆä¸‹éƒ¨åœ†å¼§)
       - é¡¶éƒ¨ä¸¤ç‚¹ (y=5):  x=33, x=67 (è¾ƒçª„ï¼Œè´´åˆä¸Šéƒ¨åœ†å¼§)
  -->
  <line x1="17" y1="85" x2="33" y2="5" stroke-linecap="round" />
  <line x1="83" y1="85" x2="67" y2="5" stroke-linecap="round" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-diaphragm.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <!-- 1. å¤–åœ† (ç™½åº•é®æŒ¡ç½‘æ ¼) -->
  <circle cx="50" cy="50" r="48" fill="white" />
  
  <!-- 2. å€’Vå‹ç»“æ„ (ä¸‰è§’å½¢çš„ä¸ŠåŠéƒ¨åˆ†) -->
  <!-- å·¦ç«¯ç‚¹: (4, 50), é¡¶ç‚¹: (50, 4), å³ç«¯ç‚¹: (96, 50) -->
  <path d="M 4 50 L 50 4 L 96 50" stroke-linejoin="round" />
  
  <!-- 3. éš”è†œå¼§çº¿ (ä¿®æ­£ç‰ˆ) -->
  <!-- èµ·ç‚¹ (4, 50) -> æ§åˆ¶ç‚¹ (50, 85) -> ç»ˆç‚¹ (96, 50) -->
  <!-- è¿™æ ·å¼§çº¿å°±ç²¾ç¡®è¿æ¥äº†å€’Vå‹çš„ä¸¤ä¸ªç«¯ç‚¹ -->
  <path d="M 4 50 Q 50 85 96 50" stroke-linecap="round" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-fan.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <!-- 1. å¤–åœ† (ç™½åº•é®æŒ¡ç½‘æ ¼) -->
  <circle cx="50" cy="50" r="48" fill="white" />
  
  <!-- 2. æ¢¯å½¢å¤–å£³ (ç›´çº¿ä¸¤ç«¯å‡å†…æ¥äºåœ†) -->
  <!-- ç»è¿‡è®¡ç®—ï¼Œç¡®ä¿çº¿æ¡å†…æ¥äºåŠå¾„48çš„åœ†ï¼Œä¸”é¿å¼€ä¸­å¿ƒæ‰‡å¶åŒºåŸŸ -->
  <!-- å·¦çº¿: é¡¶éƒ¨(28, 7.5) -> åº•éƒ¨(10, 76.5) -->
  <line x1="28" y1="7.5" x2="10" y2="76.5" stroke-linecap="round" />
  <!-- å³çº¿: é¡¶éƒ¨(72, 7.5) -> åº•éƒ¨(90, 76.5) -->
  <line x1="72" y1="7.5" x2="90" y2="76.5" stroke-linecap="round" />

  <!-- 3. ä¸‰å¶èºæ—‹æ¡¨ (æŸ³å¶å‹ï¼Œä¸ä¸ç›´çº¿ç›¸äº¤) -->
  <!-- 
       ä¸­å¿ƒç‚¹: (50,50)
       å¶ç‰‡é•¿åº¦: 28 (å°äºç›´çº¿åˆ°åœ†å¿ƒçš„è·ç¦»33ï¼Œç¡®ä¿ä¸ç›¸äº¤)
       æ§åˆ¶ç‚¹: å®½åº¦é€‚ä¸­ï¼Œå½¢æˆæŸ³å¶çŠ¶
  -->
  <g fill="black" stroke="none" transform="translate(50, 50)">
    <!-- å¶ç‰‡1 (æœä¸Š 0åº¦) -->
    <!-- M 0 0 (åœ†å¿ƒ) -> Q 8 -14 (å³æ§) 0 -28 (å¶å°–) -> Q -8 -14 (å·¦æ§) 0 0 (å›åœ†å¿ƒ) -->
    <path d="M 0 0 Q 8 -14 0 -28 Q -8 -14 0 0" />
    
    <!-- å¶ç‰‡2 (æ—‹è½¬120åº¦) -->
    <path d="M 0 0 Q 8 -14 0 -28 Q -8 -14 0 0" transform="rotate(120)" />
    
    <!-- å¶ç‰‡3 (æ—‹è½¬240åº¦) -->
    <path d="M 0 0 Q 8 -14 0 -28 Q -8 -14 0 0" transform="rotate(240)" />
  </g>
  
  <!-- ä¸­å¿ƒè½´ç‚¹ (ç™½è‰²å°åœ†ç‚¹ç¼€) -->
  <circle cx="50" cy="50" r="2" fill="white" stroke="none" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-gear.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <circle cx="50" cy="50" r="48" fill="white" />
  <path d="M 4 50 L 50 4 L 96 50" stroke-linejoin="round" />
  <!-- ä¸¤ä¸ªé½¿è½® -->
  <circle cx="35" cy="65" r="14" />
  <circle cx="65" cy="65" r="14" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-general.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <!-- å¤–åœ† -->
  <circle cx="50" cy="50" r="48" fill="white" />
  <!-- å€’ V (ä¸‰è§’å½¢) -->
  <path d="M14 70 L50 20 L86 70" fill="none" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-jet.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <!-- 1. å¤–åœ† (ç™½åº•é®æŒ¡ç½‘æ ¼) -->
  <circle cx="50" cy="50" r="48" fill="white" />
  
  <!-- 2. ä¸Šéƒ¨ä¸‰è§’å½¢ (å€’Vå‹ï¼ŒåŒæ¶²ä½“æ³µ) -->
  <!-- å·¦ç«¯(4,50) -> é¡¶ç«¯(50,4) -> å³ç«¯(96,50) -->
  <path d="M 4 50 L 50 4 L 96 50" stroke-linejoin="round" />
  
  <!-- 3. ä¸‹éƒ¨æ”¶ç¼©å¼§çº¿ (æ–‡ä¸˜é‡Œç®¡ç»“æ„) -->
  <!-- å·¦ä¾§å¼§çº¿: èµ·ç‚¹åœ¨åœ†å‘¨(18,84) -> å‘å†…æ”¶ç¼© -> ç»ˆç‚¹è¿æ¥ä¸‰è§’å½¢å·¦è¾¹(27,27) -->
  <path d="M 18 84 Q 45 65 27 27" stroke-linecap="round" />
  
  <!-- å³ä¾§å¼§çº¿: èµ·ç‚¹åœ¨åœ†å‘¨(82,84) -> å‘å†…æ”¶ç¼© -> ç»ˆç‚¹è¿æ¥ä¸‰è§’å½¢å³è¾¹(73,27) -->
  <path d="M 82 84 Q 55 65 73 27" stroke-linecap="round" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-liquid.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <!-- å¤–åœ† (ç™½åº•é®æŒ¡ç½‘æ ¼) -->
  <circle cx="50" cy="50" r="48" fill="white" />
  <!-- å€’Vå‹ç»“æ„ -->
  <path d="M 4 50 L 50 4 L 96 50" stroke-linejoin="round" />
</svg>
</file>

<file path="src/graph/cells/svgs/pump-piston.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none" stroke="black" stroke-width="2">
  <circle cx="50" cy="50" r="48" fill="white" />
  <path d="M 4 50 L 50 4 L 96 50" stroke-linejoin="round" />
  <!-- æ´»å¡æ† -->
  <line x1="50" y1="4" x2="50" y2="75" />
  <!-- æ´»å¡å¤´ -->
  <line x1="30" y1="75" x2="70" y2="75" />
</svg>
</file>

<file path="src/graph/cells/svgs/reactor-fixed-bed.svg">
<svg viewBox="0 0 260 300" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="black" stroke-width="2">
  <!-- 1. ä¸»ä½“ (Body) - ä¿æŒåŠ å®½å°ºå¯¸ -->
  <path d="M50,40 A80,30 0 0,1 210,40" fill="white" />
  <rect x="50" y="40" width="160" height="220" fill="white" stroke="none" />
  <line x1="50" y1="40" x2="50" y2="260" />
  <line x1="210" y1="40" x2="210" y2="260" />
  <path d="M50,260 A80,30 0 0,0 210,260" fill="white" />

  <!-- 2. æ°”ä½“æ¥å£ (Gas Nozzles) -->
  <rect x="120" y="0" width="20" height="10" fill="white" />
  <line x1="125" y1="10" x2="125" y2="25" /> <line x1="135" y1="10" x2="135" y2="25" />
  <rect x="120" y="290" width="20" height="10" fill="white" />
  <line x1="125" y1="275" x2="125" y2="290" /> <line x1="135" y1="275" x2="135" y2="290" />

  <!-- 3. ç›ç¯ (Salt Rings) -->
  <!-- ä¸Šç›é“ -->
  <g id="upper-salt-ring">
    <rect x="34" y="60" width="192" height="25" rx="5" ry="5" fill="white" />
    <line x1="34" y1="72.5" x2="226" y2="72.5" stroke-width="1" stroke-dasharray="4 2" />
  </g>
  <!-- ä¸‹ç›é“ -->
  <g id="lower-salt-ring">
    <rect x="34" y="215" width="192" height="25" rx="5" ry="5" fill="white" />
    <line x1="34" y1="227.5" x2="226" y2="227.5" stroke-width="1" stroke-dasharray="4 2" />
  </g>

  <!-- 4. å†…éƒ¨ç®¡æŸç¤ºæ„ (10æ ¹) -->
  <g stroke="#999" stroke-width="1" stroke-dasharray="2 2">
    <line x1="64" y1="90" x2="64" y2="210" /> <line x1="78" y1="90" x2="78" y2="210" />
    <line x1="92" y1="90" x2="92" y2="210" /> <line x1="106" y1="90" x2="106" y2="210" />
    <line x1="120" y1="90" x2="120" y2="210" /> <line x1="140" y1="90" x2="140" y2="210" />
    <line x1="154" y1="90" x2="154" y2="210" /> <line x1="168" y1="90" x2="168" y2="210" />
    <line x1="182" y1="90" x2="182" y2="210" /> <line x1="196" y1="90" x2="196" y2="210" />
  </g>

  <!-- 5. å¯†é›†è¿æ¥çŸ­ç®¡ (Stubs) -->
  
  <!-- === ä¸Šç›é“æ¥å£ (Upper) === -->
  <!-- å·¦ä¾§ 3 ä¸ª (x=20~34) -->
  <line x1="20" y1="65" x2="34" y2="65" stroke-width="2" />   <!-- ä¸Š: G-14A -->
  <line x1="20" y1="72.5" x2="34" y2="72.5" stroke-width="2" /> <!-- ä¸­: C-14 -->
  <line x1="20" y1="80" x2="34" y2="80" stroke-width="2" />     <!-- ä¸‹: E-15 -->
  
  <!-- å³ä¾§ 2 ä¸ª (x=226~240) -->
  <line x1="226" y1="68" x2="240" y2="68" stroke-width="2" />   <!-- ä¸Š: G-14B -->
  <line x1="226" y1="77" x2="240" y2="77" stroke-width="2" />   <!-- ä¸‹: E-14 -->

  <!-- === ä¸‹ç›é“æ¥å£ (Lower) === -->
  <!-- å·¦ä¾§ 3 ä¸ª -->
  <line x1="20" y1="220" x2="34" y2="220" stroke-width="2" />   <!-- ä¸Š: G-14A -->
  <line x1="20" y1="227.5" x2="34" y2="227.5" stroke-width="2" /> <!-- ä¸­: C-14 -->
  <line x1="20" y1="235" x2="34" y2="235" stroke-width="2" />   <!-- ä¸‹: E-15 -->

  <!-- å³ä¾§ 2 ä¸ª -->
  <line x1="226" y1="223" x2="240" y2="223" stroke-width="2" />   <!-- ä¸Š: G-14B -->
  <line x1="226" y1="232" x2="240" y2="232" stroke-width="2" />   <!-- ä¸‹: E-14 -->

</svg>
</file>

<file path="src/graph/cells/svgs/reactor.svg">
<svg viewBox="0 0 80 120" xmlns="http://www.w3.org/2000/svg">
  <!-- å¤¹å¥— (ç°è‰²èƒŒæ™¯) -->
  <path d="M10,30 H70 V90 Q70,110 40,110 Q10,110 10,90 Z" fill="#f0f0f0" stroke="#666" stroke-width="2"/>
  <!-- é‡œä½“ (è“è‰²ä¸»ä½“) -->
  <path d="M15,30 H65 V90 Q65,105 40,105 Q15,105 15,90 Z" fill="#e6f7ff" stroke="#1890ff" stroke-width="2"/>
  <!-- é¡¶ç›– -->
  <path d="M15,30 Q40,10 65,30 Z" fill="#e6f7ff" stroke="#1890ff" stroke-width="2"/>
  <!-- æ…æ‹Œç”µæœº -->
  <rect x="35" y="0" width="10" height="15" fill="#666"/>
  <line x1="40" y1="15" x2="40" y2="80" stroke="#666" stroke-width="2" stroke-dasharray="4 2"/>
  <!-- æ…æ‹Œæ¡¨ -->
  <path d="M25,80 L55,80" stroke="#666" stroke-width="3"/>
  <!-- ç«¯å£è§†è§‰æ ‡è®° (ä»…ä¾›å‚è€ƒï¼Œä¸å‚ä¸é€»è¾‘) -->
  <circle cx="25" cy="22" r="2" fill="#1890ff"/> <!-- è¿›æ–™å£1 -->
  <circle cx="55" cy="22" r="2" fill="#1890ff"/> <!-- è¿›æ–™å£2 -->
  <circle cx="40" cy="110" r="2" fill="#1890ff"/> <!-- å‡ºæ–™å£ -->
  <circle cx="10" cy="50" r="2" fill="#666"/> <!-- å¤¹å¥—è¿› -->
  <circle cx="70" cy="80" r="2" fill="#666"/> <!-- å¤¹å¥—å‡º -->
</svg>
</file>

<file path="src/index.css">
html, body, #root {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  overflow: hidden; /* ç¦æ­¢æ»šåŠ¨æ¡ */
}
</file>

<file path="src/main.tsx">
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.tsx'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
)
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])
</file>

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>chemical-graph-editor</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
</file>

<file path="README.md">
# Chemical P&ID Graph Editor ğŸ­âš›ï¸

> **è¿æ¥ä¼ ç»Ÿå·¥ä¸šå›¾çº¸ä¸ AI å¤§æ¨¡å‹çš„æ¡¥æ¢**
> 
> *A Bridge Between Traditional P&ID and Industrial AI Models*

![License](https://img.shields.io/badge/license-MIT-blue.svg)
![Tech](https://img.shields.io/badge/Tech-React%20%7C%20AntV%20X6%20%7C%20Neo4j-green)
![AI-Generated](https://img.shields.io/badge/AI-100%25%20Generated%20Code-purple)

## ğŸ“– é¡¹ç›®èƒŒæ™¯ (The Story)

**è¿™æ˜¯ä¸€ä¸ªç”±åŒ–å·¥è¡Œä¸šèµ„æ·±ä»ä¸šè€…ï¼ˆ0 ç¼–ç¨‹åŸºç¡€ï¼‰ï¼Œåœ¨ Google Gemini 3 å…¨ç¨‹è¾…åŠ©ä¸‹å®Œæˆçš„å¼€æºé¡¹ç›®ã€‚**

åœ¨å·¥ä¸šæ™ºèƒ½åŒ–è½¬å‹ä¸­ï¼Œæˆ‘ä»¬é¢ä¸´ä¸€ä¸ªæ ¸å¿ƒç—›ç‚¹ï¼š**é€šç”¨çš„ AI å¤§æ¨¡å‹ï¼ˆLLMï¼‰æ— æ³•ç†è§£å›¾ç‰‡æ ¼å¼çš„ P&IDï¼ˆç®¡é“åŠä»ªè¡¨æµç¨‹å›¾ï¼‰**ã€‚ä¸ºäº†è®© DeepSeekã€Llama ç­‰æ¨¡å‹èƒ½å¤Ÿåˆ†æå·¥è‰ºæµç¨‹ï¼Œæˆ‘ä»¬éœ€è¦å°†å›¾çº¸è½¬åŒ–ä¸ºæœºå™¨å¯è¯»çš„**ç»“æ„åŒ–çŸ¥è¯†å›¾è°±**ã€‚

æœ¬é¡¹ç›®æä¾›äº†ä¸€ä¸ªå¯è§†åŒ–çš„ Web ç¼–è¾‘å™¨ï¼Œå…è®¸å·¥ç¨‹å¸ˆå¿«é€Ÿç»˜åˆ¶æˆ–é‡æ„ P&IDï¼Œå¹¶è‡ªåŠ¨ç”Ÿæˆç¬¦åˆè¯­ä¹‰è§„èŒƒçš„ Neo4j å›¾æ•°æ®ï¼Œä¸ºå·¥ä¸š RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰åº”ç”¨æä¾›é«˜è´¨é‡çš„æ•°æ®åº•åº§ã€‚

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

*   **å¯è§†åŒ–ç»˜å›¾**: åŸºäº AntV X6 çš„æ‹–æ‹½å¼ç¼–è¾‘å™¨ï¼Œå†…ç½®åŒ–å·¥å¸¸ç”¨å›¾ä¾‹ï¼ˆååº”é‡œã€æ¢çƒ­å™¨ã€é˜€é—¨ç­‰ï¼‰ã€‚
*   **æ™ºèƒ½ç®¡çº¿ç®¡ç†**: æ”¯æŒæ™ºèƒ½é¿è®©ã€è‡ªåŠ¨å¸é™„ï¼Œæ¨¡æ‹ŸçœŸå® CAD ç»˜å›¾ä½“éªŒã€‚
*   **è¯­ä¹‰åŒ–æ•°æ®ç”Ÿæˆ**:
    *   **èŠ‚ç‚¹ (Node)**: è®¾å¤‡ã€ä»ªè¡¨ã€ç®¡ä»¶æºå¸¦å®Œæ•´çš„ä½å·ï¼ˆTagï¼‰å’Œå±æ€§ã€‚
    *   **å…³ç³» (Relationship)**: è‡ªåŠ¨ç”Ÿæˆ `(è®¾å¤‡A)-[PIPING_CONNECT]->(é˜€é—¨)-[PIPING_CONNECT]->(è®¾å¤‡B)` çš„æµå‘å…³ç³»ã€‚
*   **å›¾æ•°æ®åº“åŒæ­¥**: ä¸€é”®å°†å½“å‰ç”»å¸ƒå†…å®¹åŒæ­¥è‡³æœ¬åœ° Neo4j æ•°æ®åº“ã€‚

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

*   **å‰ç«¯æ¡†æ¶**: React 18 + TypeScript + Vite
*   **å›¾å½¢å¼•æ“**: AntV X6 (2.0+)
*   **UI ç»„ä»¶åº“**: Ant Design
*   **å›¾æ•°æ®åº“**: Neo4j (via neo4j-driver)
*   **AI è¾…åŠ©**: Google Gemini 3 (æ‹…ä»»æ¶æ„å¸ˆä¸ç¨‹åºå‘˜)

## ğŸš€ å¿«é€Ÿå¼€å§‹ (Quick Start)

### 1. ç¯å¢ƒå‡†å¤‡
ç¡®ä¿ä½ å·²å®‰è£… [Node.js](https://nodejs.org/) (v16+) å’Œ [Neo4j Desktop](https://neo4j.com/download/)ã€‚

### 2. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/YOUR_USERNAME/chemical-pid-graph-editor.git
cd chemical-pid-graph-editor

### 3. å®‰è£…ä¾èµ–
```bash
npm install
```

### 4. é…ç½®æ•°æ®åº“
å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿æ–‡ä»¶ï¼š
```bash
cp .env.example .env
```
æ‰“å¼€ `.env` æ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„ Neo4j æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼š
```ini
VITE_NEO4J_URI=bolt://localhost:7687
VITE_NEO4J_USER=neo4j
VITE_NEO4J_PASSWORD=ä½ çš„æ•°æ®åº“å¯†ç 
```

### 5. å¯åŠ¨é¡¹ç›®
```bash
npm run dev
```
æµè§ˆå™¨è®¿é—® `http://localhost:5173` å³å¯å¼€å§‹ä½¿ç”¨ã€‚

## ğŸ“¸ æ¼”ç¤ºæˆªå›¾

*(æ­¤å¤„è¯·ä¸Šä¼  1-2 å¼ æˆªå›¾ï¼Œä¾‹å¦‚ï¼šç¼–è¾‘å™¨ç•Œé¢ã€Neo4j Browser ä¸­ç”Ÿæˆçš„å›¾è°±æ•ˆæœ)*

> æç¤ºï¼šå›¾è°±ç”Ÿæˆåï¼Œå¯ä¾›æœ¬åœ°éƒ¨ç½²çš„ DeepSeek/Llama æ¨¡å‹é€šè¿‡ Cypher è¯­å¥è¿›è¡ŒæŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼šâ€œæŸ¥è¯¢ V-101 å‚¨ç½ä¸‹æ¸¸çš„æ‰€æœ‰åˆ‡æ–­é˜€â€ã€‚

## ğŸ¤ è´¡çŒ®ä¸åé¦ˆ

ä½œä¸ºä¸€ä¸ªéç¨‹åºå‘˜å‘èµ·çš„é¡¹ç›®ï¼Œä»£ç ç»“æ„å¯èƒ½ä¸å¤Ÿå®Œç¾ã€‚éå¸¸æ¬¢è¿ä¸“ä¸šçš„å¼€å‘è€…æå‡ºå»ºè®®æˆ–æäº¤ PRï¼

ç‰¹åˆ«æ„Ÿè°¢ **AntV X6** å›¢é˜Ÿæä¾›ä¼˜ç§€çš„å›¾å½¢å¼•æ“ï¼Œä»¥åŠ **Google Gemini** è®©é›¶åŸºç¡€å¼€å‘æˆä¸ºå¯èƒ½ã€‚

## ğŸ“„ å¼€æºåè®®

MIT License
```
</file>

<file path="tsconfig.app.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}
</file>

<file path="tsconfig.json">
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
</file>

<file path="tsconfig.node.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})
</file>

<file path="src/components/Editor/Canvas/index.css">
/* =========================================
   1. æ•´ä½“å¸ƒå±€å®¹å™¨
   ========================================= */
.editor-container {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  overflow: hidden;
  background-color: #f0f2f5;
}

/* =========================================
   2. å·¦ä¾§ç»„ä»¶åº“ (Flex å¸ƒå±€æ”¹é€ )
   ========================================= */
.stencil-container {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  width: 240px;
  background-color: #fff;
  border-right: 1px solid #dfe3e8;
  z-index: 10;
  
  /* å…³é”®ï¼šä½¿ç”¨ Flex å¸ƒå±€å‚ç›´æ’åˆ— */
  display: flex;
  flex-direction: column;
}

/* å¼ºåˆ¶ X6 Stencil å®¹å™¨å¡«æ»¡é«˜åº¦ */
.x6-widget-stencil {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  background-color: #fff;
  position: relative;
}

/* æœç´¢æ¡†ï¼šé˜²æ­¢è¢«å‹ç¼© */
.x6-widget-stencil-search {
  flex-shrink: 0;
  padding: 10px 12px !important;
  border-bottom: 1px solid #eee;
  background: #fff;
  position: sticky;
  top: 0;
  z-index: 2;
}

/* æœç´¢è¾“å…¥æ¡†ç¾åŒ– */
.x6-widget-stencil-search input {
  border-radius: 4px;
  border: 1px solid #d9d9d9;
  padding: 6px 8px;
  font-size: 13px;
}

/* å†…å®¹åŒºåŸŸï¼šæ ¸å¿ƒæ»šåŠ¨é€»è¾‘ */
.x6-widget-stencil-content {
  flex: 1;                 /* è‡ªåŠ¨å æ®å‰©ä½™ç©ºé—´ */
  height: auto !important; /* è¦†ç›– X6 çš„è¡Œå†…é«˜åº¦ */
  overflow-y: auto !important; /* å¼ºåˆ¶å¼€å¯çºµå‘æ»šåŠ¨ */
  overflow-x: hidden !important;
  position: relative !important;
}

/* åˆ†ç»„æ ‡é¢˜ç¾åŒ– */
.x6-widget-stencil-group-title {
  background-color: #f9fafb !important;
  color: #555 !important;
  font-weight: 600 !important;
  font-size: 13px !important;
  padding: 10px 12px !important;
  border-top: 1px solid #eee;
  border-bottom: 1px solid #eee;
}

/* æ»šåŠ¨æ¡ç¾åŒ– */
.x6-widget-stencil-content::-webkit-scrollbar {
  width: 6px;
}
.x6-widget-stencil-content::-webkit-scrollbar-thumb {
  background: #d9d9d9;
  border-radius: 3px;
}
.x6-widget-stencil-content::-webkit-scrollbar-track {
  background: transparent;
}

/* =========================================
   3. ä¸­é—´ç”»å¸ƒåŒºåŸŸ
   ========================================= */
.canvas-container {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 240px;
  right: 300px;
  background-color: #fff;
  z-index: 1;
  overflow: hidden;
}

/* =========================================
   4. å³ä¾§å±æ€§é¢æ¿
   ========================================= */
.inspector-container {
  position: absolute;
  top: 0;
  bottom: 0;
  right: 0;
  width: 300px;
  background-color: #fff;
  border-left: 1px solid #dfe3e8;
  z-index: 10;
  overflow-y: auto;
}

/* =========================================
   5. é¡¶éƒ¨æ‚¬æµ®å·¥å…·æ 
   ========================================= */
.toolbar-container {
  position: absolute;
  top: 10px;
  left: 260px;
  right: 320px;
  height: 40px;
  background-color: #fff;
  border: 1px solid #dfe3e8;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  border-radius: 4px;
  z-index: 100;
  display: flex;
  align-items: center;
  padding: 0 12px;
  gap: 12px;
}

.toolbar-group {
  display: flex;
  align-items: center;
  gap: 4px;
  position: relative;
}

.toolbar-group:not(:last-child)::after {
  content: '';
  display: block;
  width: 1px;
  height: 16px;
  background-color: #e8e8e8;
  margin-left: 12px;
}

/* ... ä¹‹å‰çš„ CSS ... */

/* =========================================
   7. ä¿®å¤ä¾§è¾¹æ  UI ç»†èŠ‚ (Overlap Fixes)
   ========================================= */

/* ä¿®å¤åˆ†ç»„æ ‡é¢˜ï¼šæŠ˜å å›¾æ ‡ä¸æ–‡å­—é‡å çš„é—®é¢˜ */
.x6-widget-stencil-group-title {
  position: relative !important;
  display: flex !important;
  align-items: center !important;
  /* ç»™æ–‡å­—å·¦ä¾§ç•™å‡ºç©ºé—´ï¼Œé˜²æ­¢ç›–ä½å›¾æ ‡ */
  padding-left: 32px !important; 
  height: 38px !important; /* ç¨å¾®å¢åŠ é«˜åº¦ï¼Œä¾¿äºç‚¹å‡» */
  line-height: 38px !important;
}

/* å®šä½æŠ˜å å›¾æ ‡ (é‚£ä¸ªåœ†åœˆåŠ å·) */
.x6-widget-stencil-group-icon {
  position: absolute !important;
  left: 10px !important; /* å›ºå®šåœ¨å·¦ä¾§ 10px å¤„ */
  top: 50% !important;
  transform: translateY(-50%) !important; /* å‚ç›´å±…ä¸­ */
  margin: 0 !important;
  width: 16px !important;
  height: 16px !important;
  font-size: 12px !important;
}

/* å¯é€‰ï¼šå¾®è°ƒæœç´¢æ¡†çš„ä¸‹è¾¹è·ï¼Œè®©å¸ƒå±€æ›´ç´§å‡‘ */
.x6-widget-stencil-search {
  border-bottom: 1px solid #e8e8e8;
  padding-bottom: 8px !important;
}

/* ... ä¹‹å‰çš„ CSS ä¿æŒä¸å˜ï¼Œè¯·åªä¿®æ”¹æˆ–è¿½åŠ æ–‡ä»¶æœ«å°¾çš„ä»¥ä¸‹å†…å®¹ ... */

/* =========================================
   8. ç»ˆæç©ºç™½ä¿®å¤ (The Void Fix)
   ========================================= */

/* 1. å‹æ¦¨æœç´¢æ¡†åº•éƒ¨ç©ºé—´ */
.x6-widget-stencil-search {
  /* ç¡®ä¿æœç´¢æ¡†åº•éƒ¨æ²¡æœ‰å¤šä½™çš„å¤–è¾¹è· */
  margin-bottom: 0 !important;
  /* ä»…ä¿ç•™å¿…è¦çš„å†…è¾¹è· */
  padding-bottom: 10px !important;
  border-bottom: 1px solid #dfe3e8;
}

/* 2. å‹æ¦¨å†…å®¹åŒºåŸŸé¡¶éƒ¨ç©ºé—´ */
.x6-widget-stencil-content {
  top: 0 !important; /* å¼ºåˆ¶å¯¹é½é¡¶éƒ¨ */
  margin-top: 0 !important;
  padding-top: 0 !important;
}

/* 3. å½»åº•æ¶ˆç­â€œå¹½çµâ€æ ¹ç”»å¸ƒ (å…³é”®ï¼) */
/* é€‰ä¸­ content ä¸‹çš„ç¬¬ä¸€ä¸ªå­å…ƒç´ ï¼Œå¦‚æœå®ƒä¸æ˜¯åˆ†ç»„æ ‡é¢˜ï¼Œé‚£å°±æ˜¯é‚£ä¸ªè®¨åŒçš„ç©ºç™½åŒºåŸŸ */
.x6-widget-stencil-content > div:first-child:not(.x6-widget-stencil-group) {
  display: none !important;
  height: 0 !important;
  min-height: 0 !important;
  max-height: 0 !important;
  margin: 0 !important;
  padding: 0 !important;
  border: none !important;
  overflow: hidden !important;
}

/* 4. åŒé‡ä¿é™©ï¼šé’ˆå¯¹ X6 ç”Ÿæˆçš„ç‰¹å®š graph å®¹å™¨ */
.x6-widget-stencil-content .x6-graph {
  /* åªéšè—ä¸åœ¨åˆ†ç»„å†…çš„ graph */
  display: none !important;
}
/* æ¢å¤åˆ†ç»„å†…çš„ graph æ˜¾ç¤º (é˜²æ­¢è¯¯ä¼¤) */
.x6-widget-stencil-group .x6-graph {
  display: block !important;
}
</file>

<file path="src/graph/cells/svgs/inst-local.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" fill="none" stroke="black" stroke-width="2">
  <!-- 40x40 ç”»å¸ƒï¼Œåœ†å¿ƒ 20, åŠå¾„ 18 -->
  <circle cx="20" cy="20" r="18" fill="white" />
</svg>
</file>

<file path="src/graph/cells/svgs/inst-panel.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" fill="none" stroke="black" stroke-width="2">
  <circle cx="20" cy="20" r="18" fill="white" />
  <!-- ä¸­é—´åŒæ¨ªçº¿ (ä¸Šä¸‹å„åç§» 2px) -->
  <line x1="2" y1="18" x2="38" y2="18" />
  <line x1="2" y1="22" x2="38" y2="22" />
</svg>
</file>

<file path="src/graph/cells/svgs/inst-remote.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" fill="none" stroke="black" stroke-width="2">
  <circle cx="20" cy="20" r="18" fill="white" />
  <!-- ä¸­é—´å•æ¨ªçº¿ y=20 -->
  <line x1="2" y1="20" x2="38" y2="20" />
</svg>
</file>

<file path="src/graph/cells/svgs/tank-horizontal.svg">
<svg viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="black" stroke-width="2">
  <!-- 1. ç½ä½“ -->
  <!-- ç­’ä½“ç›´çº¿æ®µ: x=20 åˆ° x=180 -->
  <!-- å·¦å³å°å¤´: å®½åº¦20çš„æ¤­åœ†å¼§ (Rx=20, Ry=40) -->
  <!-- è¿™æ ·æ€»å®½åº¦æ­£å¥½æ˜¯ 0(20-20) åˆ° 200(180+20)ï¼Œä¸ä¼šè¢«è£å‰ª -->
  <path d="M20,10 L180,10 A20,40 0 0,1 180,90 L20,90 A20,40 0 0,1 20,10 Z" fill="white" />
  
  
</svg>
</file>

<file path="src/graph/cells/svgs/trap.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 100" fill="none" stroke="black" stroke-width="2">
  <!-- ä¸»ç½ä½“ -->
  <rect x="20" y="30" width="90" height="60" fill="white" />

  <!-- å†…éƒ¨æŒ¡æ¿ -->
  <!-- å³ä¾§æŒ¡æ¿ï¼šä»ä¸Šå¾€ä¸‹ -->
  <line x1="75" y1="30" x2="75" y2="75" />
  <!-- å·¦ä¾§æŒ¡æ¿ï¼šä»ä¸‹å¾€ä¸Š -->
  <line x1="50" y1="90" x2="50" y2="45" />

  <!-- N1: å…¥å£è¿æ¥æ¡© (å³ä¸Š) - å·²ç§»é™¤æ–‡å­—ï¼Œå¢åŠ æ³•å…°ç›– -->
  <line x1="85" y1="30" x2="85" y2="10" />
  <line x1="91" y1="30" x2="91" y2="10" />
  <!-- N1 æ³•å…° -->
  <line x1="82" y1="10" x2="94" y2="10" />

  <!-- N2: å‡ºå£è¿æ¥æ¡© (å·¦ä¸Š) - å·²ç§»é™¤æ–‡å­—ï¼Œå¢åŠ æ³•å…°ç›– -->
  <line x1="35" y1="30" x2="35" y2="10" />
  <line x1="41" y1="30" x2="41" y2="10" />
  <!-- N2 æ³•å…° -->
  <line x1="32" y1="10" x2="44" y2="10" />

  <!-- M1: ä¾§å£ (å·¦ä¾§) - ä¿æŒä¸å˜ -->
  <line x1="20" y1="50" x2="10" y2="50" />
  <line x1="20" y1="62" x2="10" y2="62" />
  <line x1="10" y1="46" x2="10" y2="66" />
  <text x="5" y="60" text-anchor="end" font-family="Arial" font-size="12" stroke="none" fill="black" font-weight="bold">M1</text>
</svg>
</file>

<file path="src/graph/cells/icons.ts">
export const REACTOR_SVG = `
<svg viewBox="0 0 80 120" xmlns="http://www.w3.org/2000/svg">
  <path d="M10 30 V90 C10 110 70 110 70 90 V30 H10 Z" fill="#EFF4FF" stroke="#5F95FF" stroke-width="2"/>
  <path d="M10 30 C10 10 70 10 70 30" fill="none" stroke="#5F95FF" stroke-width="2"/>
  <rect x="35" y="0" width="10" height="20" fill="#fff" stroke="#5F95FF" stroke-width="2"/>
  <line x1="10" y1="45" x2="70" y2="45" stroke="#5F95FF" stroke-width="1" stroke-dasharray="3 3"/>
  <path d="M20 70 Q40 90 60 70" fill="none" stroke="#5F95FF" stroke-width="2"/>
</svg>
`;

export const PUMP_SVG = `
<svg viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
  <circle cx="30" cy="35" r="20" fill="#EFF4FF" stroke="#5F95FF" stroke-width="2"/>
  <path d="M30 15 V0 M50 35 H60" stroke="#5F95FF" stroke-width="2"/>
  <path d="M30 35 L45 25 L45 45 Z" fill="#5F95FF"/>
</svg>
`;

export const VALVE_SVG = `
<svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 10 L40 30 V10 L0 30 Z" fill="#EFF4FF" stroke="#5F95FF" stroke-width="2"/>
  <line x1="20" y1="20" x2="20" y2="0" stroke="#5F95FF" stroke-width="2"/>
  <line x1="10" y1="0" x2="30" y2="0" stroke="#5F95FF" stroke-width="2"/>
</svg>
`;

export const TEE_SVG = `
<svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 20 H40 M20 20 V40" stroke="#5F95FF" stroke-width="4" stroke-linecap="round"/>
</svg>
`;
</file>

<file path="src/App.tsx">
import { useRef, useState } from 'react';
import { Button, Layout, message } from 'antd';
// 1. ç¡®ä¿å›¾æ ‡åº“å·²å®‰è£…ã€‚å¦‚æœæ­¤å¤„æŠ¥é”™ï¼Œè¯·è¿è¡Œ npm install @ant-design/icons
import { SaveOutlined, DatabaseOutlined } from '@ant-design/icons';

// 2. åˆ†å¼€å¯¼å…¥ç»„ä»¶å’Œç±»å‹ï¼ˆè¿™æ˜¯ä¿®å¤ç™½å±çš„å…³é”®ï¼‰
import GraphCanvas from './components/Editor/Canvas';
import type { GraphCanvasRef } from './components/Editor/Canvas';

const { Header, Content } = Layout;

function App() {
  const [saving, setSaving] = useState(false);
  const graphRef = useRef<GraphCanvasRef>(null);

  const handleSaveClick = async () => {
    if (graphRef.current) {
      setSaving(true);
      try {
        await graphRef.current.handleSave();
      } catch (e) {
        console.error(e);
        message.error('ä¿å­˜æ“ä½œå¼‚å¸¸');
      } finally {
        setSaving(false);
      }
    } else {
        console.warn("GraphRef is null");
    }
  };

  return (
    <Layout style={{ height: '100vh', display: 'flex', flexDirection: 'column' }}>
      <Header style={{ 
        display: 'flex', alignItems: 'center', color: 'white', 
        height: '50px', padding: '0 20px', flexShrink: 0,
        justifyContent: 'space-between' 
      }}>
        <div style={{ fontSize: '1.2rem', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: 10 }}>
          <DatabaseOutlined />
          ğŸ§ª åŒ–å·¥ P&ID ç¼–è¾‘å™¨
        </div>
        
        <Button 
          type="primary" 
          icon={<SaveOutlined />} 
          loading={saving}
          onClick={handleSaveClick}
        >
          ä¿å­˜å›¾çº¸åˆ° Neo4j
        </Button>
      </Header>
      
      <Content style={{ position: 'relative', flex: 1, overflow: 'hidden', display: 'flex' }}>
        {/* ç¡®ä¿è¿™é‡Œæ²¡æœ‰å¤šä½™çš„ props å¯¼è‡´ç±»å‹å†²çª */}
        <GraphCanvas ref={graphRef} />
      </Content>
    </Layout>
  );
}

export default App;
</file>

<file path="package.json">
{
  "name": "chemical-graph-editor",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@ant-design/icons": "^6.1.0",
    "@antv/x6": "^2.19.2",
    "@antv/x6-plugin-keyboard": "^2.2.3",
    "@antv/x6-plugin-selection": "^2.2.2",
    "@antv/x6-plugin-stencil": "^2.1.5",
    "@antv/x6-plugin-transform": "^2.1.8",
    "antd": "^6.0.0",
    "lodash": "^4.17.21",
    "neo4j-driver": "^6.0.1",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "sass": "^1.94.2",
    "uuid": "^13.0.0",
    "zustand": "^5.0.9"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/lodash": "^4.17.21",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@types/uuid": "^10.0.0",
    "@vitejs/plugin-react": "^5.1.1",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "npm:rolldown-vite@7.2.5"
  },
  "overrides": {
    "vite": "npm:rolldown-vite@7.2.5"
  }
}
</file>

<file path="src/components/Editor/ContextMenu/index.tsx">
import React from 'react';
import { 
  DeleteOutlined, 
  CopyOutlined, 
  SnippetsOutlined, 
  InfoCircleOutlined, 
  ClearOutlined,
  RotateRightOutlined 
} from '@ant-design/icons';
import './index.css';

export interface MenuState {
  visible: boolean;
  x: number;
  y: number;
  type: 'node' | 'edge' | 'blank' | null;
  cellId?: string;
}

interface ContextMenuProps {
  visible: boolean;
  x: number;
  y: number;
  type: 'node' | 'edge' | 'blank' | null;
  onClose: () => void;
  onAction: (action: string) => void;
}

const ContextMenu: React.FC<ContextMenuProps> = ({ visible, x, y, type, onClose, onAction }) => {
  if (!visible) return null;

  const handleItemClick = (action: string) => {
    // ä½¿ç”¨ try-catch åŒ…è£¹ action æ‰§è¡Œï¼Œé˜²æ­¢æŠ¥é”™é˜»æ­¢èœå•å…³é—­
    try {
      onAction(action);
    } catch (e) {
      console.error('Menu action failed:', e);
    } finally {
      // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½å»¶è¿Ÿå…³é—­èœå•
      setTimeout(() => {
        onClose();
      }, 100);
    }
  };

  return (
    <>
      <div 
        style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, zIndex: 9998 }} 
        onClick={(e) => { e.stopPropagation(); onClose(); }} 
        onContextMenu={(e) => { e.preventDefault(); onClose(); }}
      />
      
      <div 
        className="context-menu" 
        style={{ left: x, top: y }}
        onClick={(e) => e.stopPropagation()}
      >
        {/* --- é€‰ä¸­èŠ‚ç‚¹/è¿çº¿ --- */}
        {(type === 'node' || type === 'edge') && (
          <>
            <div className="context-menu-item" onClick={() => handleItemClick('copy')}>
              <CopyOutlined /> å¤åˆ¶
            </div>

            {/* ä»…èŠ‚ç‚¹æ˜¾ç¤ºç²˜è´´å’Œæ—‹è½¬ */}
            {type === 'node' && (
              <>
                <div className="context-menu-item" onClick={() => handleItemClick('paste')}>
                  <SnippetsOutlined /> ç²˜è´´
                </div>
                <div className="context-menu-item" onClick={() => handleItemClick('rotate')}>
                  <RotateRightOutlined /> æ—‹è½¬ 90Â°
                </div>
              </>
            )}
            
            <div className="context-menu-divider" />
            
            <div className="context-menu-item" onClick={() => handleItemClick('property')}>
              <InfoCircleOutlined /> å±æ€§è¯¦æƒ…
            </div>
            <div className="context-menu-item danger" onClick={() => handleItemClick('delete')}>
              <DeleteOutlined /> åˆ é™¤
            </div>
          </>
        )}

        {/* --- ç©ºç™½å¤„ --- */}
        {type === 'blank' && (
          <>
            <div className="context-menu-item" onClick={() => handleItemClick('paste')}>
              <SnippetsOutlined /> ç²˜è´´
            </div>
            <div className="context-menu-divider" />
            <div className="context-menu-item" onClick={() => handleItemClick('fit')}>
              <InfoCircleOutlined /> é€‚åº”ç”»å¸ƒ
            </div>
            <div className="context-menu-item danger" onClick={() => handleItemClick('clear')}>
              <ClearOutlined /> æ¸…ç©ºæ‰€æœ‰
            </div>
          </>
        )}
      </div>
    </>
  );
};

export default ContextMenu;
</file>

<file path="src/graph/cells/svgs/tee.svg">
<svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
  <!-- 20x20 ç”»å¸ƒï¼Œä¸­å¿ƒç‚¹åœ¨ 10 -->
  <path d="M0 10 H20 M10 10 V20" stroke="black" stroke-width="2" stroke-linecap="butt" stroke-linejoin="round"/>
</svg>
</file>

<file path="src/components/Editor/Inspector/index.tsx">
// src/components/Editor/Inspector/index.tsx
import React, { useEffect, useState } from 'react';
import { Form, Input, Card, Empty, Select, Divider, Collapse } from 'antd';
import { Cell } from '@antv/x6';
import { 
  InfoCircleOutlined, SettingOutlined, DashboardOutlined, ExperimentOutlined 
} from '@ant-design/icons';
import { FLUID_COLORS } from '../../../config/rules'; // [å¼•å…¥é…ç½®]

interface InspectorProps { cell: Cell | null; }

const { Option } = Select;
const { Panel } = Collapse;

const Inspector: React.FC<InspectorProps> = ({ cell }) => {
  const [form] = Form.useForm();
  // å¢åŠ ä¸€ä¸ª tick çŠ¶æ€ï¼Œç”¨äºå¼ºåˆ¶åˆ·æ–°
  const [, setTick] = useState(0);

  // 1. ç›‘å¬é€‰ä¸­ cell å˜åŒ–åŠæ•°æ®å˜æ›´
  useEffect(() => {
    if (!cell) return;

    const updateForm = () => {
      const data = cell.getData() || {};
      const attrs = cell.getAttrs();
      
      const formData: any = {
        type: data.type || 'Unknown',
        tag: data.tag || attrs?.label?.text || '', 
        desc: data.desc || '',
      };

      if (cell.isNode()) {
        Object.assign(formData, {
          designPressure: data.designPressure,
          designTemp: data.designTemp,
          material: data.material,
          volume: data.volume,
          area: data.area,
          flow: data.flow,
          head: data.head,
          power: data.power,
          size: data.size,
          valveClass: data.valveClass,
          failPosition: data.failPosition,
          tagId: data.tagId,
          loopNum: data.loopNum,
          range: data.range,
          unit: data.unit,
        });
      } else if (cell.isEdge()) {
        const labelObj = cell.getLabelAt(0);
        const labelText = typeof labelObj === 'string' ? labelObj : (labelObj?.attrs?.label?.text || '');
        Object.assign(formData, {
          tag: labelText,
          fluid: data.fluid || 'Water',
          material: data.material || 'CS',
          dn: data.dn || 'DN50',
          pn: data.pn || 'PN16',
          insulation: data.insulation || 'None',
        });
      }
      form.setFieldsValue(formData);
      setTick(t => t + 1); // è§¦å‘é‡æ¸²æŸ“
    };

    // åˆå§‹åŒ–å›å¡«
    updateForm();

    // [ä¿®å¤] ç›‘å¬æ•°æ®å˜åŒ– (æ”¯æŒ Undo/Redo åçš„åˆ·æ–°)
    cell.on('change:data', updateForm);
    cell.on('change:attrs', updateForm);

    return () => {
      cell.off('change:data', updateForm);
      cell.off('change:attrs', updateForm);
    };
  }, [cell, form]);

  // 2. è¡¨å•å˜æ›´å¤„ç†
  const handleValuesChange = (changedValues: any, allValues: any) => {
    if (!cell) return;

    const currentData = cell.getData() || {};
    cell.setData({ ...currentData, ...allValues });

    if (cell.isNode()) {
      if (currentData.type === 'Instrument') {
        if (changedValues.tagId !== undefined) cell.attr('topLabel/text', changedValues.tagId);
        if (changedValues.loopNum !== undefined) cell.attr('bottomLabel/text', changedValues.loopNum);
      } else {
        if (changedValues.tag !== undefined) {
          cell.setAttrs({ label: { text: changedValues.tag } });
        }
      }
    } else if (cell.isEdge()) {
      if (changedValues.tag !== undefined) {
        cell.setLabelAt(0, { attrs: { label: { text: changedValues.tag } }, position: { distance: 0.5 } });
      }
      if (changedValues.fluid !== undefined || changedValues.insulation !== undefined) {
        const fluid = allValues.fluid;
        const insulation = allValues.insulation;
        const color = FLUID_COLORS[fluid] || '#5F95FF';

        if (insulation && insulation.startsWith('Jacket')) {
          cell.setAttrs({ line: { strokeWidth: 4, stroke: '#fa8c16', strokeDasharray: null } });
        } else if (['ST', 'ET', 'OT'].includes(insulation)) {
          cell.setAttrs({ line: { strokeWidth: 2, stroke: color, strokeDasharray: '5 5' } });
        } else {
          cell.setAttrs({ line: { strokeWidth: 2, stroke: color, strokeDasharray: null } });
        }
      }
    }
  };

  if (!cell) return <Empty description="è¯·é€‰æ‹©å¯¹è±¡" style={{ marginTop: 100 }} />;

  const data = cell.getData() || {};
  const type = data.type;
  const isNode = cell.isNode();
  const isEdge = cell.isEdge();

  const renderSpecificFields = () => {
    if (!isNode) return null;
    // [ä¿®å¤] ä½¿ç”¨ orientation="left" æ ‡å‡†å±æ€§
    if (['LiquidPump', 'CentrifugalPump', 'DiaphragmPump', 'PistonPump', 'GearPump', 'Compressor', 'Fan', 'JetPump'].includes(type)) {
      return (
        <>
          <Divider orientation="left"><DashboardOutlined /> æ€§èƒ½å‚æ•°</Divider>
          <div style={{ display: 'flex', gap: 8 }}>
            <Form.Item label="æµé‡ (mÂ³/h)" name="flow" style={{ flex: 1 }}><Input placeholder="50" /></Form.Item>
            <Form.Item label="æ‰¬ç¨‹ (m)" name="head" style={{ flex: 1 }}><Input placeholder="30" /></Form.Item>
          </div>
          <Form.Item label="ç”µæœºåŠŸç‡ (kW)" name="power"><Input placeholder="15 kW" /></Form.Item>
          <Form.Item label="æè´¨" name="material">
            <Select>
              <Option value="CS">é“¸é’¢ (CS)</Option>
              <Option value="SS304">ä¸é”ˆé’¢ (304)</Option>
              <Option value="SS316L">ä¸é”ˆé’¢ (316L)</Option>
              <Option value="CastIron">é“¸é“</Option>
            </Select>
          </Form.Item>
        </>
      );
    }
    if (['Reactor', 'Tank', 'Evaporator'].includes(type)) {
      return (
        <>
          <Divider orientation="left"><ExperimentOutlined /> è®¾å¤‡å‚æ•°</Divider>
          <div style={{ display: 'flex', gap: 8 }}>
            <Form.Item label="å®¹ç§¯ (mÂ³)" name="volume" style={{ flex: 1 }}><Input placeholder="2000" /></Form.Item>
            <Form.Item label="æè´¨" name="material" style={{ flex: 1 }}>
              <Select>
                <Option value="SS304">S30408</Option>
                <Option value="SS316L">S31603</Option>
                <Option value="GL">æªç»ç’ƒ</Option>
                <Option value="Ti">é’›æ</Option>
              </Select>
            </Form.Item>
          </div>
          <div style={{ display: 'flex', gap: 8 }}>
            <Form.Item label="è®¾è®¡å‹åŠ›(MPa)" name="designPressure" style={{ flex: 1 }}><Input placeholder="0.6" /></Form.Item>
            <Form.Item label="è®¾è®¡æ¸©åº¦(â„ƒ)" name="designTemp" style={{ flex: 1 }}><Input placeholder="150" /></Form.Item>
          </div>
        </>
      );
    }
    if (['Exchanger'].includes(type)) {
      return (
        <>
          <Divider orientation="left"><ExperimentOutlined /> æ¢çƒ­å‚æ•°</Divider>
          <Form.Item label="æ¢çƒ­é¢ç§¯ (ã¡)" name="area"><Input placeholder="10" /></Form.Item>
          <div style={{ display: 'flex', gap: 8 }}>
            <Form.Item label="å£³ç¨‹å‹åŠ›" name="designPressure" style={{ flex: 1 }}><Input placeholder="1.6" /></Form.Item>
            <Form.Item label="ç®¡ç¨‹å‹åŠ›" name="tubePressure" style={{ flex: 1 }}><Input placeholder="1.0" /></Form.Item>
          </div>
          <Form.Item label="æè´¨ (å£³/ç®¡)" name="material"><Input placeholder="CS / SS304" /></Form.Item>
        </>
      );
    }
    if (['ControlValve', 'Valve'].includes(type)) {
      return (
        <>
          <Divider orientation="left"><SettingOutlined /> é˜€é—¨è§„æ ¼</Divider>
          <div style={{ display: 'flex', gap: 8 }}>
            <Form.Item label="å°ºå¯¸" name="size" style={{ flex: 1 }}>
              <Select>
                <Option value="DN25">DN25</Option>
                <Option value="DN50">DN50</Option>
                <Option value="DN80">DN80</Option>
                <Option value="DN100">DN100</Option>
              </Select>
            </Form.Item>
            <Form.Item label="å‹åŠ›ç­‰çº§" name="valveClass" style={{ flex: 1 }}>
              <Select>
                <Option value="PN16">PN16</Option>
                <Option value="PN40">PN40</Option>
                <Option value="CL150">CL150</Option>
                <Option value="CL300">CL300</Option>
              </Select>
            </Form.Item>
          </div>
          {type === 'ControlValve' && (
            <Form.Item label="æ•…éšœä½ç½® (FC/FO)" name="failPosition">
              <Select>
                <Option value="FC">æ°”å¼€ (FC)</Option>
                <Option value="FO">æ°”å…³ (FO)</Option>
                <Option value="FL">ä¿ä½ (FL)</Option>
              </Select>
            </Form.Item>
          )}
        </>
      );
    }
    if (['Instrument'].includes(type)) {
      return (
        <>
          <Divider orientation="left"><DashboardOutlined /> ä»ªè¡¨å®šä¹‰</Divider>
          <div style={{ display: 'flex', gap: 8 }}>
            <Form.Item label="åŠŸèƒ½ (Tag)" name="tagId" style={{ flex: 1 }} help="å¦‚: PI, TT"><Input /></Form.Item>
            <Form.Item label="å›è·¯ (Loop)" name="loopNum" style={{ flex: 1 }} help="å¦‚: 101"><Input /></Form.Item>
          </div>
          <div style={{ display: 'flex', gap: 8 }}>
            <Form.Item label="é‡ç¨‹" name="range" style={{ flex: 2 }}><Input placeholder="0-1.6" /></Form.Item>
            <Form.Item label="å•ä½" name="unit" style={{ flex: 1 }}><Input placeholder="MPa" /></Form.Item>
          </div>
        </>
      );
    }
    return <Empty description="æ— ç‰¹å®šå‚æ•°" image={Empty.PRESENTED_IMAGE_SIMPLE} />;
  };

  return (
    <Card 
      title={
        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
          {isNode ? <SettingOutlined /> : <InfoCircleOutlined />}
          <span>{isNode ? (data.type === 'Instrument' ? 'ä»ªè¡¨å±æ€§' : 'è®¾å¤‡å±æ€§') : 'ç®¡çº¿å±æ€§'}</span>
        </div>
      } 
      bordered={false} 
      style={{ height: '100%', overflowY: 'auto' }}
      bodyStyle={{ padding: '12px 16px' }}
    >
      <Form form={form} layout="vertical" onValuesChange={handleValuesChange} size="small">
        <Collapse defaultActiveKey={['1']} ghost>
          <Panel header="åŸºç¡€ä¿¡æ¯" key="1">
            {type !== 'Instrument' && (
              <Form.Item label={isNode ? "ä½å· (Tag No.)" : "ç®¡æ®µå· (Line No.)"} name="tag">
                <Input placeholder={isNode ? "R-101" : "PL-1001-50-CS"} />
              </Form.Item>
            )}
            <Form.Item label="æè¿°" name="desc">
              <Input.TextArea rows={2} placeholder="è®¾å¤‡æˆ–ç®¡çº¿çš„åŠŸèƒ½æè¿°" />
            </Form.Item>
          </Panel>
        </Collapse>

        {isNode && renderSpecificFields()}

        {isEdge && (
          <>
            <Divider orientation="left">ç®¡é“è§„æ ¼</Divider>
            <div style={{ display: 'flex', gap: 8 }}>
              <Form.Item label="ä»‹è´¨" name="fluid" style={{ flex: 1 }}>
                <Select showSearch optionFilterProp="children">
                  {Object.keys(FLUID_COLORS).map(key => (
                    <Option key={key} value={key}>{key}</Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item label="æè´¨" name="material" style={{ flex: 1 }}>
                <Select>
                  <Option value="CS">ç¢³é’¢</Option>
                  <Option value="SS304">SS304</Option>
                  <Option value="SS316L">SS316L</Option>
                </Select>
              </Form.Item>
            </div>
            <div style={{ display: 'flex', gap: 8 }}>
              <Form.Item label="ç®¡å¾„" name="dn" style={{ flex: 1 }}>
                <Select showSearch>
                  {['DN15','DN25','DN50','DN80','DN100','DN150','DN200'].map(d => <Option key={d} value={d}>{d}</Option>)}
                </Select>
              </Form.Item>
              <Form.Item label="ç­‰çº§" name="pn" style={{ flex: 1 }}>
                <Select>
                  <Option value="PN10">PN10</Option>
                  <Option value="PN16">PN16</Option>
                  <Option value="CL150">CL150</Option>
                </Select>
              </Form.Item>
            </div>
            <Form.Item label="ä¿æ¸©/ä¼´çƒ­" name="insulation">
              <Select>
                <Option value="None">æ— </Option>
                <Option value="H">ä¿æ¸© (H)</Option>
                <Option value="C">ä¿å†· (C)</Option>
                <Option value="ST">è’¸æ±½ä¼´çƒ­</Option>
                <Option value="ET">ç”µä¼´çƒ­</Option>
                <Option value="Jacket-Steam">è’¸æ±½å¤¹å¥—</Option>
              </Select>
            </Form.Item>
          </>
        )}

        <div style={{ marginTop: 20, fontSize: 12, color: '#999', textAlign: 'center' }}>
          ID: {cell.id.slice(0, 8)}...
        </div>
      </Form>
    </Card>
  );
};

export default Inspector;
</file>

<file path="src/components/Editor/Canvas/index.tsx">
import { useEffect, useRef, useState, useImperativeHandle, forwardRef } from 'react';
import { Graph, Cell, Edge, Node } from '@antv/x6';
import { Stencil } from '@antv/x6-plugin-stencil';
import { Keyboard } from '@antv/x6-plugin-keyboard';
import { Selection } from '@antv/x6-plugin-selection';
import { History } from '@antv/x6-plugin-history';
import { Transform } from '@antv/x6-plugin-transform';
import '@antv/x6-plugin-transform/dist/index.css';
import { Button, Tooltip, message, Modal } from 'antd';
import { 
  ZoomInOutlined, ZoomOutOutlined, OneToOneOutlined, CompressOutlined, 
  UndoOutlined, RedoOutlined, ClearOutlined 
} from '@ant-design/icons';

import Inspector from '../Inspector';
import ContextMenu, { type MenuState } from '../ContextMenu';
import './index.css';
import { registerCustomCells } from '../../../graph/cells/registry';
import { saveGraphData, loadGraphData } from '../../../services/neo4j';
import { FLUID_COLORS, INLINE_TYPES } from '../../../config/rules';

// ç¡®ä¿æ³¨å†Œè‡ªå®šä¹‰å›¾å½¢
try { registerCustomCells(); } catch (e) { console.warn(e); }

export interface GraphCanvasRef {
  handleSave: () => Promise<void>;
}

const pick = (obj: any, keys: string[]) => {
  const ret: any = {};
  keys.forEach(key => {
    if (obj[key] !== undefined && obj[key] !== null && obj[key] !== '') {
      ret[key] = obj[key];
    }
  });
  return ret;
};

const GraphCanvas = forwardRef<GraphCanvasRef, {}>((_, ref) => {
  const containerRef = useRef<HTMLDivElement>(null);
  const stencilRef = useRef<HTMLDivElement>(null);
  const graphRef = useRef<Graph | null>(null);
  const historyRef = useRef<History | null>(null);
  const clipboardRef = useRef<any>(null);

  const [selectedCell, setSelectedCell] = useState<Cell | null>(null);
  const [canUndo, setCanUndo] = useState(false);
  const [canRedo, setCanRedo] = useState(false);
  
  const [menu, setMenu] = useState<MenuState>({ visible: false, x: 0, y: 0, type: null });

  // --- è¾…åŠ©å‡½æ•°ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºåœ¨çº¿å…ƒä»¶ ---
  const isInlineComponent = (cellId: string) => {
    if (!graphRef.current) return false;
    const cell = graphRef.current.getCellById(cellId);
    if (!cell || !cell.isNode()) return false;
    return INLINE_TYPES.includes(cell.getData()?.type);
  };

  // --- è¾…åŠ©å‡½æ•°ï¼šåˆ·æ–°æ‰€æœ‰ç®¡çº¿çš„è·¯ç”±ç­–ç•¥ ---
  const refreshRouting = () => {
    const graph = graphRef.current;
    if (!graph) return;
    
    graph.getEdges().forEach(edge => {
      if (edge.getData()?.type === 'Pipe') {
        const sourceId = edge.getSourceCellId();
        const targetId = edge.getTargetCellId();
        
        const excludeNodes = ['SHEET_FRAME_A2'];
        if (isInlineComponent(sourceId)) excludeNodes.push(sourceId);
        if (isInlineComponent(targetId)) excludeNodes.push(targetId);

        edge.setRouter('manhattan', {
          padding: 20,
          excludeNodes: excludeNodes
        });
      }
    });
  };

  // --- ä¿å­˜åŠŸèƒ½ ---
  useImperativeHandle(ref, () => ({
    handleSave: async () => {
      if (!graphRef.current) return;
      const graph = graphRef.current;
      
      // 1. å¤„ç†èŠ‚ç‚¹
      const nodes = graph.getNodes()
        .filter(node => !node.getData()?.isBackground)
        .map(node => {
          const data = node.getData() || {};
          const pos = node.getPosition();
          const size = node.getSize();
          const type = data.type || 'Unknown';
          const isInstrument = ['Instrument', 'ControlValve'].includes(type);
          const category = isInstrument ? 'Instrument' : 'Equipment';

          let Tag = data.tag || node.getAttrs()?.label?.text || '';
          if (type === 'Instrument') {
            const func = data.tagId || '';
            const loop = data.loopNum || '';
            if (func || loop) Tag = `${func}${loop ? '-' + loop : ''}`;
          }

          const baseProps = {
            x6Id: node.id,
            type: type, 
            Tag: Tag,
            category: category, // [æ–°å¢] å°†åˆ†ç±»ä¼ é€’ç»™åç«¯
            x: pos.x, y: pos.y, width: size.width, height: size.height, angle: node.getAngle(),
            desc: data.desc || ''
          };

          let specificProps = {};
          if (['LiquidPump', 'CentrifugalPump', 'DiaphragmPump', 'PistonPump', 'GearPump', 'Compressor', 'Fan', 'JetPump'].includes(type)) {
             specificProps = pick(data, ['spec', 'flow', 'head', 'power', 'material']);
          } else if (['Reactor', 'Tank', 'Evaporator'].includes(type)) {
             specificProps = pick(data, ['spec', 'volume', 'material', 'designPressure', 'designTemp']);
          } else if (type === 'Exchanger') {
             specificProps = pick(data, ['spec', 'area', 'material', 'designPressure', 'tubePressure']);
          } else if (['ControlValve', 'Valve'].includes(type)) {
             specificProps = pick(data, ['spec', 'size', 'valveClass', 'failPosition']);
          } else if (type === 'Instrument') {
             specificProps = pick(data, ['spec', 'range', 'unit', 'tagId', 'loopNum']);
          } else {
             specificProps = pick(data, ['spec', 'material']);
          }

          return { ...baseProps, ...specificProps };
        });

      // 2. å¤„ç†è¿çº¿
      const edges = graph.getEdges().map(edge => {
        const data = edge.getData() || {};
        const sourceNode = edge.getSourceNode();
        const targetNode = edge.getTargetNode();
        const vertices = edge.getVertices(); 
        
        // [æ ¸å¿ƒä¿®æ”¹] æå–ç«¯å£å…ƒæ•°æ®é€»è¾‘
        const getPortMeta = (node: Cell | null, portId: string | undefined) => {
          if (!node || !node.isNode() || !portId) return { group: 'default', desc: 'unknown' };
          
          const port = node.getPort(portId);
          if (!port) return { group: 'default', desc: 'unknown' };

          // ä¼˜å…ˆçº§é€»è¾‘ï¼š
          // 1. ä¼˜å…ˆä½¿ç”¨è¯­ä¹‰åŒ–çš„ region (å¦‚ "ShellSide:Liquid", "TubeSide")
          // 2. å…¶æ¬¡ä½¿ç”¨ section (å¦‚ "HighTemp")
          // 3. æœ€åé™çº§ä½¿ç”¨è§†è§‰ group (å¦‚ "top", "left")
          let region = port.data?.region || port.group || 'default';
          
          // å¦‚æœæœ‰ section (å¦‚æ°”ä½“å†·å´å™¨çš„é«˜æ¸©æ®µ)ï¼Œå¯ä»¥æ‹¼æ¥åˆ° region ä¸­ï¼Œæˆ–è€…å•ç‹¬å­˜å‚¨
          // è¿™é‡Œä¸ºäº†ç®€åŒ–ï¼Œå¦‚æœå­˜åœ¨ sectionï¼Œæˆ‘ä»¬å°†å…¶è¿½åŠ åˆ° region æè¿°ä¸­ï¼Œä¾‹å¦‚ "TubeSide:HighTemp"
          if (port.data?.region && port.data?.section) {
            region = `${port.data.region}:${port.data.section}`;
          }

          return {
            group: region, // è¿™é‡Œå°†è¯­ä¹‰ region èµ‹å€¼ç»™ group å­—æ®µï¼Œåç»­ä¼šå­˜å…¥ Neo4j çš„ fromRegion/toRegion
            desc: port.data?.desc || port.attrs?.circle?.title || port.id
          };
        };

        const srcMeta = getPortMeta(sourceNode, edge.getSourcePortId());
        const tgtMeta = getPortMeta(targetNode, edge.getTargetPortId());

        return {
          source: edge.getSourceCell()?.id,
          target: edge.getTargetCell()?.id,
          sourcePort: edge.getSourcePortId(),
          targetPort: edge.getTargetPortId(),
          
          // è¿™é‡Œ srcMeta.group ç°åœ¨æºå¸¦çš„æ˜¯ "ShellSide:Liquid" ç­‰é«˜ä»·å€¼è¯­ä¹‰
          sourceRegion: srcMeta.group, 
          sourceDesc: srcMeta.desc,
          targetRegion: tgtMeta.group, 
          targetDesc: tgtMeta.desc,
          
          type: data.type || 'Pipe', 
          material: data.material || 'CS',
          fluid: data.fluid || 'Water',
          dn: data.dn || 'DN50',
          pn: data.pn || 'PN16',
          insulation: data.insulation || 'None',
          label: edge.getLabelAt(0)?.attrs?.label?.text || '',
          vertices: JSON.stringify(vertices) 
        };
      });

      try {
        await saveGraphData(nodes, edges);
        message.success(`ä¿å­˜æˆåŠŸï¼èŠ‚ç‚¹: ${nodes.length}, è¿çº¿: ${edges.length}`);
      } catch (error) {
        console.error(error);
        message.error('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“è¿æ¥');
      }
    }
  }));

  const updateNodeLabel = (node: Node) => {
    const angle = node.getAngle();
    if (angle === 0) {
      node.setAttrs({
        label: {
          refX: 0.5, refY: '100%', refY2: 10, refX2: 0,
          textAnchor: 'middle', textVerticalAnchor: 'top',
          transform: null 
        }
      });
      return;
    }
    const size = node.getSize();
    const rad = (angle * Math.PI) / 180;
    const visualHeight = size.width * Math.abs(Math.sin(rad)) + size.height * Math.abs(Math.cos(rad));
    const distance = visualHeight / 2 + 15;
    const offsetX = distance * Math.sin(rad);
    const offsetY = distance * Math.cos(rad);
    node.setAttrs({
      label: {
        refX: 0.5, refY: 0.5,
        refX2: offsetX, refY2: offsetY,
        textAnchor: 'middle', textVerticalAnchor: 'middle',
        transform: `rotate(${-angle})`,
      }
    });
  };

  // ============================================================
  // [ä¿®å¤] å¤åˆ¶ç²˜è´´é€»è¾‘ (æ‰‹åŠ¨åºåˆ—åŒ–ï¼Œè§£å†³ç®¡çº¿æŠ¥é”™é—®é¢˜)
  // ============================================================
  const performCopy = (targetCell?: Cell) => {
    const graph = graphRef.current;
    if (!graph) return;
    
    try {
      let cells = graph.getSelectedCells();
      
      // å¦‚æœå½“å‰æ²¡æœ‰é€‰ä¸­ä»»ä½•ä¸œè¥¿ï¼Œä½†ä¼ å…¥äº†ç›®æ ‡å¯¹è±¡ï¼ˆå³é”®èœå•è§¦å‘ï¼‰ï¼Œåˆ™ä½¿ç”¨ç›®æ ‡å¯¹è±¡
      if (cells.length === 0 && targetCell) {
        cells = [targetCell];
        graph.select(targetCell);
      }

      if (cells.length === 0) {
        message.info('è¯·å…ˆé€‰ä¸­è¦å¤åˆ¶çš„å¯¹è±¡');
        return;
      }

      // [æ ¸å¿ƒä¿®æ”¹] è¿‡æ»¤æ‰èƒŒæ™¯å›¾æ¡† AND è¿‡æ»¤æ‰ç®¡çº¿ (åªå¤åˆ¶è®¾å¤‡èŠ‚ç‚¹)
      const cellsToCopy = cells.filter(cell => 
        !cell.getData()?.isBackground && cell.isNode()
      );

      if (cellsToCopy.length === 0) {
        message.warning('æ²¡æœ‰å¯å¤åˆ¶çš„è®¾å¤‡å¯¹è±¡ (ç®¡çº¿å·²å¿½ç•¥)');
        return;
      }

      // æ‰‹åŠ¨åºåˆ—åŒ–
      const jsonList = cellsToCopy.map(cell => {
        try {
          // å°è¯•æ·±æ‹·è´ dataï¼Œé˜²æ­¢å¼•ç”¨é—®é¢˜
          const safeData = cell.getData() ? JSON.parse(JSON.stringify(cell.getData())) : {};
          
          // åªå¤„ç† Nodeï¼Œå› ä¸ºä¸Šé¢å·²ç» filter è¿‡äº†
          if (cell.isNode()) {
            return {
              id: cell.id,
              shape: cell.shape,
              position: cell.getPosition(),
              size: cell.getSize(),
              angle: cell.getAngle(),
              zIndex: cell.getZIndex(),
              attrs: cell.getAttrs(),
              data: safeData,
              ports: cell.getPorts(), // å¿…é¡»ä¿ç•™ç«¯å£ä¿¡æ¯
            };
          }
          return null;
        } catch (err) {
          console.error(`Failed to serialize cell ${cell.id}:`, err);
          return null;
        }
      }).filter(item => item !== null);

      if (jsonList.length > 0) {
        clipboardRef.current = jsonList;
        message.destroy();
        message.success(`å·²å¤åˆ¶ ${jsonList.length} ä¸ªè®¾å¤‡`);
      } else {
        message.error('å¤åˆ¶å¤±è´¥ï¼šæ— æ³•æå–å¯¹è±¡æ•°æ®');
      }
    } catch (e) {
      console.error('Copy critical error:', e);
      message.error('å¤åˆ¶æ“ä½œå¤±è´¥');
    }
  };

  // ============================================================
  // [ä¿®å¤] ç²˜è´´é€»è¾‘ (å¢åŠ æ•°æ®æ¸…æ´—ï¼Œé˜²æ­¢ History æŠ¥é”™)
  // ============================================================
  const performPaste = (offsetPoint?: { x: number, y: number }) => {
    const graph = graphRef.current;
    if (!graph || !clipboardRef.current || clipboardRef.current.length === 0) return;

    try {
      const cellsJSON = clipboardRef.current;
      console.log('Paste Start. Clipboard items:', cellsJSON.length);

      let dx = 20;
      let dy = 20;

      if (offsetPoint) {
        const nodesOnly = cellsJSON.filter((c: any) => c.position && typeof c.position.x === 'number');
        if (nodesOnly.length > 0) {
          const minX = Math.min(...nodesOnly.map((c: any) => c.position.x));
          const minY = Math.min(...nodesOnly.map((c: any) => c.position.y));
          dx = offsetPoint.x - minX;
          dy = offsetPoint.y - minY;
        }
      }

      graph.cleanSelection();
      const newCells: Cell[] = [];
      const idMap: Record<string, string> = {};

      // è¾…åŠ©å‡½æ•°ï¼šæ·±åº¦æ¸…æ´—å¯¹è±¡ï¼Œç§»é™¤ undefined/null
      const cleanData = (obj: any): any => {
        if (obj === null || obj === undefined) return {};
        if (typeof obj !== 'object') return obj;
        if (Array.isArray(obj)) return obj.map(cleanData);
        
        const res: any = {};
        for (const key in obj) {
          if (obj[key] !== undefined && obj[key] !== null) {
            res[key] = cleanData(obj[key]);
          }
        }
        return res;
      };

      // 1. ç²˜è´´èŠ‚ç‚¹
      cellsJSON.forEach((cellData: any) => {
        if (!cellData.position) return;
        
        try {
          const oldId = cellData.id;
          const { id, zIndex, ...otherData } = cellData;
          
          // ç¡®ä¿ data å’Œ attrs æ˜¯çº¯å‡€å¯¹è±¡
          const safeData = cleanData(otherData.data || {});
          const safeAttrs = cleanData(otherData.attrs || {});
          
          const newNode = graph.createNode({
            ...otherData,
            data: safeData,
            attrs: safeAttrs,
            x: (otherData.position.x) + dx,
            y: (otherData.position.y) + dy,
            zIndex: (zIndex || 2) + 1
          });
          
          idMap[oldId] = newNode.id;
          newCells.push(newNode);
        } catch (nodeErr) {
          console.error('Failed to create node:', nodeErr);
        }
      });

      // (å·²ç§»é™¤è¿çº¿ç²˜è´´é€»è¾‘ï¼Œå› ä¸ºå¤åˆ¶æ—¶å·²ç»è¿‡æ»¤æ‰äº†)

      if (newCells.length > 0) {
        graph.addCell(newCells);
        graph.select(newCells);
        message.success(`å·²ç²˜è´´ ${newCells.length} ä¸ªè®¾å¤‡`);
      }

      if (!offsetPoint) {
         clipboardRef.current = cellsJSON.map((c: any) => {
           if (c.position) {
             return { ...c, position: { x: c.position.x + 20, y: c.position.y + 20 } };
           }
           return c;
         });
      }
    } catch (e) {
      console.error('Paste critical error:', e);
      message.error('ç²˜è´´æ“ä½œå¼‚å¸¸');
    }
  };

  const onUndo = () => historyRef.current?.undo();
  const onRedo = () => historyRef.current?.redo();
  const onZoom = (f: number) => graphRef.current?.zoom(f);
  const onZoomToFit = () => graphRef.current?.zoomToFit({ padding: 20 });
  const onZoomReset = () => graphRef.current?.zoomTo(1);
  const onClear = () => {
    Modal.confirm({
      title: 'æ¸…ç©ºç”»å¸ƒ', content: 'ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿå›¾æ¡†å°†è¢«ä¿ç•™ã€‚', okType: 'danger',
      onOk: () => {
        if (!graphRef.current) return;
        const cellsToRemove = graphRef.current.getCells().filter(cell => !cell.getData()?.isBackground);
        graphRef.current.removeCells(cellsToRemove);
        setSelectedCell(null);
      },
    });
  };

  const handleMenuAction = (action: string) => {
    const { cellId } = menu;
    const graph = graphRef.current;
    if (!graph) return;
    
    const cell = cellId ? graph.getCellById(cellId) : null;
    
    switch (action) {
      case 'copy': 
        if (cell && !graph.isSelected(cell)) {
          graph.resetSelection(cell); 
        }
        performCopy(cell || undefined); 
        break;
      case 'paste': 
        const point = graph.clientToLocal({ x: menu.x, y: menu.y }); 
        performPaste(point); 
        break;
      case 'property': message.success('å·²å®šä½åˆ°å±æ€§é¢æ¿'); break;
      case 'clear': onClear(); break;
      case 'fit': onZoomToFit(); break;
      case 'delete': 
        const selected = graph.getSelectedCells();
        if (selected.length > 0) {
          graph.removeCells(selected);
        } else if (cell) {
          graph.removeCell(cell);
        }
        break;
      case 'rotate': 
        if (cell && cell.isNode() && !cell.getData()?.isBackground) { cell.rotate(90); } break;
    }
  };

  // --- åˆå§‹åŒ– ---
  useEffect(() => {
    if (!containerRef.current || !stencilRef.current) return;
    stencilRef.current.innerHTML = '';

    const graph = new Graph({
      container: containerRef.current,
      autoResize: true,
      grid: { size: 10, visible: true, type: 'doubleMesh', args: [{ color: '#eee' }, { color: '#ddd', factor: 4 }] },
      panning: { enabled: true, eventTypes: ['rightMouseDown'] },
      mousewheel: { enabled: true, zoomAtMousePosition: true, modifiers: null, factor: 1.1, maxScale: 3, minScale: 0.1 },
      interacting: {
        nodeMovable: (view) => !view.cell.getData()?.isBackground,
        magnetConnectable: (view) => !view.cell.getData()?.isBackground,
      },
      connecting: {
        router: { name: 'manhattan', args: { padding: 20, excludeNodes: ['SHEET_FRAME_A2'] } },
        connector: { name: 'rounded', args: { radius: 8 } },
        anchor: 'center', connectionPoint: 'anchor', snap: true, allowBlank: false, allowEdge: true, highlight: true,
        validateConnection: ({ sourceView, targetView, sourceMagnet, targetMagnet }) => {
          if (!sourceView || !targetView || !sourceMagnet) return false;
          if (sourceView === targetView) return false;
          if (targetView.isEdgeElement()) {
            const sourceNode = sourceView.cell as Node;
            if (sourceNode.getData()?.type === 'Instrument') return true;
            return false;
          }
          if (!targetMagnet) return false;
          const sourcePortId = sourceMagnet.getAttribute('port');
          const targetPortId = targetMagnet.getAttribute('port');
          if (!sourcePortId || !targetPortId) return false;
          const sourceNode = sourceView.cell as Node;
          const targetNode = targetView.cell as Node;
          const sourcePort = sourceNode.getPort(sourcePortId);
          const targetPort = targetNode.getPort(targetPortId);
          const sDir = sourcePort?.data?.dir || 'bi';
          const tDir = targetPort?.data?.dir || 'bi';
          return sDir !== 'in' && tDir !== 'out';
        },
        createEdge(args) {
          let data = { type: 'Pipe', material: 'CS', fluid: 'Water', dn: 'DN50', pn: 'PN16', insulation: 'None' };
          if (args.sourceCell) {
            const cell = args.sourceCell;
            const connectedEdges = this.getConnectedEdges(cell);
            const pipes = connectedEdges.filter(e => e.getData()?.type === 'Pipe');
            if (pipes.length > 0) {
              const lastPipe = pipes[pipes.length - 1];
              const lastData = lastPipe.getData() || {};
              data = { ...data, material: lastData.material || data.material, fluid: lastData.fluid || data.fluid, dn: lastData.dn || data.dn, pn: lastData.pn || data.pn, insulation: lastData.insulation || data.insulation };
            }
          }
          const color = FLUID_COLORS[data.fluid] || '#5F95FF';
          return this.createEdge({
            shape: 'edge',
            attrs: { line: { stroke: color, strokeWidth: 2, targetMarker: { name: 'classic', width: 8, height: 6 } } },
            labels: [], data: data
          });
        },
      },
    });
    graphRef.current = graph;

    graph.on('node:change:angle', ({ node }) => updateNodeLabel(node as Node));

    // ============================================================
    // [ä¿®å¤] é˜€é—¨æ‰“æ–­é€»è¾‘ (å¢å¼ºå®¹é”™)
    // ============================================================
    const handlePipeSplit = (node: Node) => {
      const nodeType = node.getData()?.type;
      if (!INLINE_TYPES.includes(nodeType)) return; 
      
      const connectedEdges = graph.getConnectedEdges(node);
      if (connectedEdges.length > 0) return; 

      const nodeBBox = node.getBBox();
      const center = nodeBBox.center;
      const allEdges = graph.getEdges();

      const targetEdge = allEdges.find(edge => {
        if (edge.getData()?.type === 'Signal') return false;
        return edge.getBBox().intersectsWithRect(nodeBBox);
      });

      if (targetEdge) {
        const targetView = graph.findViewByCell(targetEdge);
        if (!targetView) return;

        // @ts-ignore
        const closestPoint = targetView.getClosestPoint(center);
        // @ts-ignore
        const routePoints = targetView.routePoints || [];
        
        const points = [targetEdge.getSourcePoint(), ...routePoints, targetEdge.getTargetPoint()];
        
        let isPipeHorizontal = true; 
        let foundSegment = false;

        for (let i = 0; i < points.length - 1; i++) {
          const p1 = points[i];
          const p2 = points[i + 1];
          
          const minX = Math.min(p1.x, p2.x) - 5;
          const maxX = Math.max(p1.x, p2.x) + 5;
          const minY = Math.min(p1.y, p2.y) - 5;
          const maxY = Math.max(p1.y, p2.y) + 5;

          if (closestPoint.x >= minX && closestPoint.x <= maxX &&
              closestPoint.y >= minY && closestPoint.y <= maxY) {
            
            if (Math.abs(p1.y - p2.y) < 5) { 
              isPipeHorizontal = true; 
            } else {
              isPipeHorizontal = false; 
            }
            foundSegment = true;
            break; 
          }
        }

        if (!foundSegment) {
           const src = targetEdge.getSourcePoint();
           const tgt = targetEdge.getTargetPoint();
           isPipeHorizontal = Math.abs(src.x - tgt.x) > Math.abs(src.y - tgt.y);
        }

        const angle = node.getAngle();
        const normalizedAngle = (angle % 360 + 360) % 360;
        const isValveHorizontal = (normalizedAngle < 10 || normalizedAngle > 350) || (normalizedAngle > 170 && normalizedAngle < 190);

        if (isValveHorizontal !== isPipeHorizontal) return; 

        const OFFSET = 20; 
        let newX = nodeBBox.x;
        let newY = nodeBBox.y;

        if (isPipeHorizontal) {
          const pipeY = closestPoint.y;
          newY = Math.round((pipeY - OFFSET) / 10) * 10; 
          newX = Math.round(nodeBBox.x / 10) * 10; 
        } else {
          const pipeX = closestPoint.x;
          newX = Math.round((pipeX + OFFSET) / 10) * 10;
          newY = Math.round(nodeBBox.y / 10) * 10; 
        }
        
        node.setPosition(newX, newY);

        const srcPoint = targetEdge.getSourcePoint();
        const tgtPoint = targetEdge.getTargetPoint();
        let portForSource = 'in';  
        let portForTarget = 'out'; 

        if (isPipeHorizontal) {
          if (srcPoint.x < tgtPoint.x) { portForSource = 'in'; portForTarget = 'out'; } 
          else { portForSource = 'out'; portForTarget = 'in'; }
        } else {
          if (srcPoint.y < tgtPoint.y) { portForSource = 'in'; portForTarget = 'out'; } 
          else { portForSource = 'out'; portForTarget = 'in'; }
        }

        const source = targetEdge.getSource();
        const target = targetEdge.getTarget();
        const edgeData = targetEdge.getData();
        const edgeAttrs = targetEdge.getAttrs(); 
        const sourceCellId = (source as any).cell;
        const targetCellId = (target as any).cell;

        graph.removeCell(targetEdge);

        const exclude1 = ['SHEET_FRAME_A2', node.id];
        if (isInlineComponent(sourceCellId)) exclude1.push(sourceCellId);

        const exclude2 = ['SHEET_FRAME_A2', node.id];
        if (isInlineComponent(targetCellId)) exclude2.push(targetCellId);

        const router1 = { name: 'manhattan', args: { padding: 30, excludeNodes: exclude1 } };
        const router2 = { name: 'manhattan', args: { padding: 30, excludeNodes: exclude2 } };

        const edge1 = graph.createEdge({
          shape: 'edge', source: source, target: { cell: node.id, port: portForSource }, 
          data: { ...edgeData }, attrs: edgeAttrs, labels: [], router: router1 
        });

        const edge2 = graph.createEdge({
          shape: 'edge', source: { cell: node.id, port: portForTarget }, target: target,
          data: { ...edgeData }, attrs: edgeAttrs, labels: [], router: router2 
        });

        graph.addCell([edge1, edge2]);
        message.success('é˜€é—¨å·²æ¥å…¥');
      }
    };

    // ============================================================
    // [ä¿®å¤] æ™ºèƒ½æµ‹ç‚¹ (Z-Index ä¿®å¤)
    // ============================================================
    const handleSignalDrop = (args: any) => {
      const { e, edge } = args;
      const sourceNode = edge.getSourceNode();
      if (sourceNode?.getData()?.type !== 'Instrument') return;

      let hitPipe: Edge | null = null;
      const point = graph.clientToLocal(e.clientX, e.clientY);
      const targetCell = edge.getTargetCell();
      
      if (targetCell && targetCell.isEdge()) {
        hitPipe = targetCell as Edge;
      } else {
        if (edge.getTargetNode()) return; 
        const views = graph.findViewsFromPoint(point);
        const pipeView = views.find(v => v.isEdgeElement() && v.cell.id !== edge.id && v.cell.getData()?.type !== 'Signal');
        if (pipeView) hitPipe = pipeView.cell as Edge;
      }

      if (hitPipe) {
        const src = hitPipe.getSourcePoint();
        const tgt = hitPipe.getTargetPoint();
        let tapX = point.x;
        let tapY = point.y;
        const isHorizontal = Math.abs(src.y - tgt.y) < 5; 
        const isVertical = Math.abs(src.x - tgt.x) < 5;

        if (isHorizontal) { tapY = src.y; tapX = Math.round(point.x / 10) * 10; } 
        else if (isVertical) { tapX = src.x; tapY = Math.round(point.y / 10) * 10; } 
        else { tapX = Math.round(point.x / 10) * 10; tapY = Math.round(point.y / 10) * 10; }

        const tappingPoint = graph.createNode({
          shape: 'tapping-point', x: tapX - 6, y: tapY - 6, data: { type: 'TappingPoint' },
          zIndex: 10 
        });
        
        graph.removeCell(edge); 
        const signalEdge = graph.createEdge({
          shape: 'signal-edge', source: { cell: tappingPoint.id }, target: { cell: sourceNode.id },
          data: { type: 'Signal', relationType: 'MEASURES' }
        });

        const source = hitPipe.getSource();
        const target = hitPipe.getTarget();
        const pipeData = hitPipe.getData();
        const pipeAttrs = hitPipe.getAttrs(); 
        graph.removeCell(hitPipe);

        const pipe1 = graph.createEdge({
          shape: 'edge', source: source, target: { cell: tappingPoint.id },
          data: pipeData, attrs: pipeAttrs, labels: []
        });
        const pipe2 = graph.createEdge({
          shape: 'edge', source: { cell: tappingPoint.id }, target: target,
          data: pipeData, attrs: pipeAttrs, labels: []
        });
        
        graph.addCell([tappingPoint, pipe1, pipe2, signalEdge]);
        setTimeout(refreshRouting, 50);
        message.success('å·²ç”Ÿæˆæµ‹ç‚¹');
      } else {
        if (!edge.getTargetCell()) graph.removeCell(edge);
      }
    };

    graph.on('node:added', ({ node }) => setTimeout(() => handlePipeSplit(node as Node), 50));
    graph.on('node:mouseup', ({ node }) => handlePipeSplit(node as Node));
    graph.on('edge:mouseup', handleSignalDrop); 

    graph.on('edge:connected', ({ edge }) => {
      const sourceNode = edge.getSourceNode();
      const targetPortId = edge.getTargetPortId();
      const isSourceInstrument = sourceNode?.getData()?.type === 'Instrument';
      const isTargetActuator = targetPortId === 'actuator';

      if (isSourceInstrument || isTargetActuator) {
        edge.setAttrs({
          line: { stroke: '#888', strokeWidth: 1, strokeDasharray: '4 4', targetMarker: { name: 'classic', size: 3 } } 
        });
        edge.setData({ type: 'Signal', fluid: 'Signal', relationType: isTargetActuator ? 'CONTROLS' : 'MEASURES' });
        if (isTargetActuator) edge.setRouter('manhattan', { padding: 10 });
      } else {
        refreshRouting();
      }
    });

    graph.use(new Selection({ enabled: true, multiple: true, rubberband: true, movable: true, showNodeSelectionBox: true, filter: (cell) => !cell.getData()?.isBackground }));
    graph.use(new Keyboard({ enabled: true }));
    graph.use(new Transform({ resizing: { enabled: true }, rotating: { enabled: true, grid: 15 } }));
    const history = new History({ enabled: true });
    graph.use(history);
    historyRef.current = history;
    graph.on('history:change', () => { setCanUndo(history.canUndo()); setCanRedo(history.canRedo()); });

    graph.bindKey(['meta+c', 'ctrl+c'], () => { performCopy(); return false; });
    graph.bindKey(['meta+v', 'ctrl+v'], () => { performPaste(); return false; });
    graph.bindKey(['backspace', 'delete'], () => { const cells = graph.getSelectedCells().filter(c => !c.getData()?.isBackground); if (cells.length) graph.removeCells(cells); });

    graph.on('cell:click', ({ cell }) => {
      if (cell.getData()?.isBackground) { setSelectedCell(null); graph.getEdges().forEach(edge => edge.removeTools()); return; }
      setSelectedCell(cell);
      if (cell.isEdge()) { cell.attr('line/strokeWidth', 3); }
      graph.getEdges().forEach(edge => { if (edge.id !== cell.id) { edge.attr('line/strokeWidth', 2); edge.removeTools(); } });
      if (cell.isEdge() && cell.getData()?.type === 'Pipe') {
        cell.addTools([{ name: 'vertices', args: { attrs: { fill: '#666' } } }, { name: 'segments', args: { snapRadius: 20, attrs: { fill: '#444' } } }]);
      }
    });
    
    graph.on('blank:click', () => { setSelectedCell(null); graph.getEdges().forEach(edge => { edge.attr('line/strokeWidth', 2); edge.removeTools(); }); });
    graph.on('cell:contextmenu', ({ e, cell }) => { if (cell.getData()?.isBackground) return; setMenu({ visible: true, x: e.clientX, y: e.clientY, type: cell.isNode() ? 'node' : 'edge', cellId: cell.id }); });
    graph.on('blank:contextmenu', ({ e }) => { setMenu({ visible: true, x: e.clientX, y: e.clientY, type: 'blank' }); });

    // --- Stencil (å®Œæ•´åŠ è½½é€»è¾‘) ---
    const stencil = new Stencil({
      title: 'ç»„ä»¶åº“', target: graph, stencilGraphWidth: 240, stencilGraphHeight: 0, collapsable: true,
      search: { visible: true, placeholder: 'æœç´¢è®¾å¤‡...' },
      groups: [
        { title: 'ä¸»å·¥è‰ºè®¾å¤‡', name: 'main_equip', layoutOptions: { columns: 1, columnWidth: 220, rowHeight: 160 } },
        { title: 'æ³µç±»è®¾å¤‡', name: 'pumps', layoutOptions: { columns: 2, columnWidth: 100, rowHeight: 100 } },
        { title: 'ä»ªè¡¨æ§åˆ¶', name: 'instruments', layoutOptions: { columns: 3, columnWidth: 60, rowHeight: 70 } },
        { title: 'ç®¡è·¯é™„ä»¶', name: 'parts', layoutOptions: { columns: 2, columnWidth: 100, rowHeight: 120 } }
      ],
    });
    stencilRef.current.appendChild(stencil.container);

    // 1. åˆ›å»ºä¸»è®¾å¤‡
    const reactor = graph.createNode({ shape: 'p-reactor', label: 'ååº”é‡œ', data: { type: 'Reactor' } });
    const exchanger = graph.createNode({ shape: 'p-exchanger', label: 'æ¢çƒ­å™¨', data: { type: 'Exchanger' } });
    const e13 = graph.createNode({ shape: 'p-naphthalene-evaporator', label: 'è˜è’¸å‘å™¨', data: { type: 'Evaporator' } });
    const tankH = graph.createNode({ shape: 'p-tank-horizontal', label: 'å§å¼å‚¨ç½', data: { type: 'Tank' } });
    const gasCooler = graph.createNode({ shape: 'p-gas-cooler', label: 'æ°”ä½“å†·å´å™¨', data: { type: 'GasCooler' } });
    const d14 = graph.createNode({ shape: 'p-fixed-bed-reactor', label: 'å›ºå®šåºŠååº”å™¨', data: { type: 'FixedBedReactor' } });
    const vExchanger = graph.createNode({ shape: 'p-exchanger-vertical', label: 'ç«‹å¼æ¢çƒ­å™¨', data: { type: 'VerticalExchanger' } });
    const trapNode = graph.createNode({ shape: 'p-trap', label: 'æ•é›†å™¨', data: { type: 'Trap' } });

    // 2. åˆ›å»ºæ³µç±»
    const pumpList = [
      graph.createNode({ shape: 'p-pump-liquid', label: 'æ¶²ä½“æ³µ' }),
      graph.createNode({ shape: 'p-pump-centrifugal', label: 'ç¦»å¿ƒæ³µ' }),
      graph.createNode({ shape: 'p-pump-diaphragm', label: 'éš”è†œæ³µ' }),
      graph.createNode({ shape: 'p-pump-piston', label: 'æ´»å¡æ³µ' }),
      graph.createNode({ shape: 'p-pump-compressor', label: 'å‹ç¼©æœº' }),
      graph.createNode({ shape: 'p-pump-gear', label: 'é½¿è½®æ³µ' }),
      graph.createNode({ shape: 'p-pump-fan', label: 'é£æ‰‡' }),
      graph.createNode({ shape: 'p-pump-jet', label: 'å–·å°„æ³µ' }),
    ];

    // 3. åˆ›å»ºé˜€é—¨ä¸é™„ä»¶
    const valveList = [
      graph.createNode({ shape: 'p-cv-pneumatic', label: 'æ°”åŠ¨é˜€' }),
      graph.createNode({ shape: 'p-cv-positioner', label: 'å®šä½å™¨' }),
      graph.createNode({ shape: 'p-cv-electric', label: 'ç”µåŠ¨é˜€' }),
      graph.createNode({ shape: 'p-cv-solenoid', label: 'ç”µç£é˜€' }),
      graph.createNode({ shape: 'p-cv-manual', label: 'æ‰‹åŠ¨é˜€' }),
      graph.createNode({ shape: 'p-cv-piston', label: 'æ°”ç¼¸é˜€' }),
    ];
    const teeNode = graph.createNode({ shape: 'p-tee' });

    // 4. åˆ›å»ºä»ªè¡¨
    const instList = [
      graph.createNode({ shape: 'p-inst-local', label: 'å°±åœ°' }),
      graph.createNode({ shape: 'p-inst-remote', label: 'è¿œä¼ ' }),
      graph.createNode({ shape: 'p-inst-panel', label: 'ç›˜è£…' }),
    ];

    // 5. åŠ è½½åˆ° Stencil
    stencil.load([reactor, exchanger, vExchanger, e13, tankH, gasCooler, d14, trapNode], 'main_equip');
    stencil.load(pumpList, 'pumps');
    stencil.load(instList, 'instruments');
    stencil.load([...valveList, teeNode], 'parts');

    const setupBackgroundFrame = () => {
      if (graph.getNodes().some(n => n.getData()?.isBackground)) return;
      graph.addNode({ shape: 'drawing-frame-a2', id: 'SHEET_FRAME_A2', x: 0, y: 0, zIndex: -1, movable: false, selectable: false, data: { type: 'Frame', isBackground: true } });
    };

    const initCanvasData = async () => {
      setupBackgroundFrame();
      try {
        const data = await loadGraphData();
        if (data && data.nodes.length > 0) {
          graph.fromJSON(data as any);
          
          graph.batchUpdate(() => {
            const nodes = graph.getNodes();
            const edges = graph.getEdges();
            nodes.forEach(node => {
              if (!node.getData()?.isBackground) {
                updateNodeLabel(node); 
                node.setZIndex(node.getData()?.type === 'TappingPoint' ? 10 : 2);     
              }
            });
            edges.forEach(edge => edge.setZIndex(1));
            refreshRouting();
          });

          setupBackgroundFrame();
          graph.centerContent();
          message.success('æ•°æ®å·²æ¢å¤');
        }
      } catch (error) {
        console.error('Data Load Error:', error);
        message.error('æ•°æ®åŠ è½½å¤±è´¥ï¼Œå·²é‡ç½®');
      }
    };
    setTimeout(initCanvasData, 100);

    return () => { graph.dispose(); if (stencilRef.current) stencilRef.current.innerHTML = ''; };
  }, []);

  return (
    <div className="editor-container">
      <div ref={stencilRef} className="stencil-container" />
      <div className="toolbar-container">
         <Tooltip title="æ’¤é”€"><Button type="text" icon={<UndoOutlined />} disabled={!canUndo} onClick={onUndo} /></Tooltip>
         <Tooltip title="é‡åš"><Button type="text" icon={<RedoOutlined />} disabled={!canRedo} onClick={onRedo} /></Tooltip>
         <div className="toolbar-sep"></div>
         <Tooltip title="æ”¾å¤§"><Button type="text" icon={<ZoomInOutlined />} onClick={() => onZoom(0.1)} /></Tooltip>
         <Tooltip title="ç¼©å°"><Button type="text" icon={<ZoomOutOutlined />} onClick={() => onZoom(-0.1)} /></Tooltip>
         <Tooltip title="é€‚åº”"><Button type="text" icon={<CompressOutlined />} onClick={onZoomToFit} /></Tooltip>
         <Tooltip title="1:1"><Button type="text" icon={<OneToOneOutlined />} onClick={onZoomReset} /></Tooltip>
         <div className="toolbar-sep"></div>
         <Tooltip title="æ¸…ç©º"><Button type="text" danger icon={<ClearOutlined />} onClick={onClear} /></Tooltip>
      </div>
      <div ref={containerRef} className="canvas-container" />
      <div className="inspector-container"><Inspector cell={selectedCell} /></div>
      <ContextMenu visible={menu.visible} x={menu.x} y={menu.y} type={menu.type} onClose={() => setMenu({ ...menu, visible: false })} onAction={handleMenuAction} />
    </div>
  );
});

export default GraphCanvas;
</file>

<file path="src/services/neo4j.ts">
// src/services/neo4j.ts
import neo4j from 'neo4j-driver';
import { FLUID_COLORS, CURRENT_DRAWING_ID } from '../config/rules';

const driver = neo4j.driver(
  'bolt://localhost:7687', 
  neo4j.auth.basic('neo4j', 'CGrx2526'), 
  { encrypted: 'ENCRYPTION_OFF', disableLosslessIntegers: true }
);

export const saveGraphData = async (nodes: any[], edges: any[]) => {
  const session = driver.session();
  const tx = session.beginTransaction();
  try {
    // 1. [ä¿®æ”¹] åˆ é™¤å½“å‰å›¾çº¸çš„æ‰€æœ‰èŠ‚ç‚¹ (ä½¿ç”¨åŸºç±»æ ‡ç­¾ :Thing)
    await tx.run(
      `MATCH (n:Thing {drawingId: $drawingId}) DETACH DELETE n`,
      { drawingId: CURRENT_DRAWING_ID }
    );

    // 2. ä¿å­˜èŠ‚ç‚¹ (æ ¹æ® category åˆ†æµ)
    if (nodes.length) {
      // 2.1 ä¿å­˜è®¾å¤‡ (Equipment)
      // æ ‡ç­¾: :Thing (åŸºç±») + :Equipment (å…·ä½“ç±»)
      await tx.run(
        `UNWIND $nodes AS n 
         WITH n WHERE n.category = 'Equipment'
         CREATE (e:Thing:Equipment {x6Id: n.x6Id, drawingId: $drawingId}) 
         SET e += n`, 
        { nodes, drawingId: CURRENT_DRAWING_ID }
      );

      // 2.2 ä¿å­˜ä»ªè¡¨ (Instrument)
      // æ ‡ç­¾: :Thing (åŸºç±») + :Instrument (å…·ä½“ç±»)
      await tx.run(
        `UNWIND $nodes AS n 
         WITH n WHERE n.category = 'Instrument'
         CREATE (e:Thing:Instrument {x6Id: n.x6Id, drawingId: $drawingId}) 
         SET e += n`, 
        { nodes, drawingId: CURRENT_DRAWING_ID }
      );
    }

    // 3. ä¿å­˜è¿çº¿
    if (edges.length) {
      const pipes = edges.filter(e => e.type !== 'Signal');
      const signals = edges.filter(e => e.type === 'Signal');

      // 3.1 ä¿å­˜å·¥è‰ºç®¡çº¿ (åŒ¹é… :Thing)
      if (pipes.length) {
        await tx.run(
          `UNWIND $pipes AS r 
           MATCH (s:Thing {x6Id: r.source}), (t:Thing {x6Id: r.target}) 
           CREATE (s)-[:PIPE {
             fromPort:   r.sourcePort, 
             toPort:     r.targetPort,
             tag:        r.label,
             material:   r.material,
             fluid:      r.fluid,
             dn:         r.dn,
             pn:         r.pn,
             insulation: r.insulation,
             fromRegion: r.sourceRegion, 
             fromDesc:   r.sourceDesc,
             toRegion:   r.targetRegion,
             toDesc:     r.targetDesc,
             vertices:   r.vertices
           }]->(t)`, 
          { pipes }
        );
      }

      // 3.2 ä¿å­˜ä¿¡å·çº¿ (åŒ¹é… :Thing)
      if (signals.length) {
        const controlSignals = signals.filter((s: any) => s.targetPort === 'actuator' || s.relationType === 'CONTROLS');
        const measureSignals = signals.filter((s: any) => s.targetPort !== 'actuator' && s.relationType !== 'CONTROLS');

        if (controlSignals.length) {
          await tx.run(
            `UNWIND $batch AS r 
             MATCH (s:Thing {x6Id: r.source}), (t:Thing {x6Id: r.target}) 
             CREATE (s)-[:CONTROLS {
               fromPort:   r.sourcePort, 
               toPort:     r.targetPort,
               fluid:      'Signal',
               vertices:   r.vertices 
             }]->(t)`, 
            { batch: controlSignals }
          );
        }

        if (measureSignals.length) {
          await tx.run(
            `UNWIND $batch AS r 
             MATCH (inst:Thing {x6Id: r.target}), (tp:Thing {x6Id: r.source}) 
             CREATE (inst)-[:MEASURES {
               fromPort:   r.targetPort,
               toPort:     r.sourcePort,
               fluid:      'Signal',
               vertices:   r.vertices
             }]->(tp)`, 
            { batch: measureSignals }
          );
        }
      }
    }

    await tx.commit();
  } catch (e) {
    await tx.rollback();
    throw e;
  } finally {
    await session.close();
  }
};

export const loadGraphData = async () => {
  const session = driver.session();
  try {
    // 1. [ä¿®æ”¹] åŠ è½½èŠ‚ç‚¹ (åŒ¹é… :Thing ä»¥åŠ è½½æ‰€æœ‰ç±»å‹)
    const nodesResult = await session.run(
      `MATCH (n:Thing {drawingId: $drawingId}) RETURN n`,
      { drawingId: CURRENT_DRAWING_ID }
    );
    
    // ... (nodes map é€»è¾‘ä¿æŒä¸å˜) ...
    const nodes = nodesResult.records.map(record => {
        // ... åŸæœ‰ä»£ç  ...
        // æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦æ”¹åŠ¨ï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¯è¯»å–å±æ€§
        const props = record.get('n').properties;
        // ...
        // ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œæ­¤å¤„çœç•¥ä¸­é—´çš„ shape æ˜ å°„ä»£ç ï¼Œä¿æŒåŸæ ·å³å¯
        // ...
        // è¡¥å…¨ return ç»“æ„
        const safeNumber = (val: any) => {
            if (typeof val === 'number') return val;
            if (val && val.low !== undefined) return val.low; 
            if (val && !isNaN(Number(val))) return Number(val); 
            return undefined; 
        };
        // é‡æ–°æ„å»º shapeName æ˜ å°„é€»è¾‘ (å¿…é¡»ä¿ç•™ï¼Œå¦åˆ™æ— æ³•åŠ è½½)
        let shapeName = 'p-valve'; 
        switch (props.type) {
            case 'Reactor':      shapeName = 'p-reactor'; break;
            case 'Exchanger':    shapeName = 'p-exchanger'; break;
            case 'Pump':         shapeName = 'p-pump'; break;
            case 'LiquidPump':   shapeName = 'p-pump-liquid'; break;
            case 'CentrifugalPump': shapeName = 'p-pump-centrifugal'; break;
            case 'DiaphragmPump': shapeName = 'p-pump-diaphragm'; break;
            case 'PistonPump':   shapeName = 'p-pump-piston'; break;
            case 'Compressor':   shapeName = 'p-pump-compressor'; break;
            case 'GearPump':     shapeName = 'p-pump-gear'; break;
            case 'Fan':          shapeName = 'p-pump-fan'; break;
            case 'JetPump':      shapeName = 'p-pump-jet'; break;
            case 'ControlValve': shapeName = 'p-cv-pneumatic'; break;
            case 'Valve':        shapeName = 'p-cv-manual'; break;
            case 'Fitting':      shapeName = 'p-tee'; break; 
            case 'Tank':         shapeName = 'p-tank-horizontal'; break;
            case 'GasCooler':    shapeName = 'p-gas-cooler'; break;
            case 'Trap':         shapeName = 'p-trap'; break;
            case 'FixedBedReactor': shapeName = 'p-fixed-bed-reactor'; break;
            case 'VerticalExchanger': shapeName = 'p-exchanger-vertical'; break;
            case 'Evaporator':   shapeName = 'p-naphthalene-evaporator'; break;
            case 'Instrument':   
            if(props.spec === 'Local') shapeName = 'p-inst-local';
            else if(props.spec === 'Panel') shapeName = 'p-inst-panel';
            else shapeName = 'p-inst-remote';
            break;
            case 'TappingPoint': shapeName = 'tapping-point'; break;
            default: break;
        }
        
        const isTee = props.type === 'Fitting';

        return {
            id: props.x6Id,
            shape: shapeName, 
            x: props.x,
            y: props.y,
            width: safeNumber(props.width), 
            height: safeNumber(props.height),
            angle: safeNumber(props.angle) || 0,
            data: { ...props },
            attrs: { 
                label: { 
                    text: isTee ? '' : (props.Tag || props.tag || props.label),
                    display: isTee ? 'none' : undefined
                },
                topLabel: props.tagId ? { text: props.tagId } : undefined,
                bottomLabel: props.loopNum ? { text: props.loopNum } : undefined,
            }
        };
    });

    // 2. [ä¿®æ”¹] åŠ è½½è¿çº¿ (åŒ¹é… :Thing)
    const edgesResult = await session.run(`
      MATCH (s:Thing {drawingId: $drawingId})-[r:PIPE|MEASURES|CONTROLS]->(t:Thing {drawingId: $drawingId}) 
      RETURN s.x6Id as sourceId, t.x6Id as targetId, r, type(r) as relType
    `, { drawingId: CURRENT_DRAWING_ID });
    
    // ... (edges map é€»è¾‘ä¿æŒä¸å˜) ...
    const edges = edgesResult.records.map(record => {
        // ... ä¿æŒåŸæ · ...
        const rel = record.get('r').properties;
        const relType = record.get('relType'); 
        const sourceId = record.get('sourceId');
        const targetId = record.get('targetId');
        
        let strokeWidth = 2;
        let strokeColor = FLUID_COLORS[rel.fluid] || '#5F95FF';
        let dashArray = null;
        let targetMarker: any = null; 
        let edgeType = 'Pipe'; 
        let labels: any[] = [];
        let vertices = [];
        
        if (rel.vertices) {
            try { vertices = JSON.parse(rel.vertices); } catch (e) { console.warn('Vertices parse error', e); }
        }

        if (relType === 'MEASURES' || relType === 'CONTROLS') {
            strokeWidth = 1;
            strokeColor = FLUID_COLORS.Signal; 
            dashArray = '4 4';    
            targetMarker = { name: 'classic', width: 10, height: 6 }; 
            edgeType = 'Signal';
        } else {
            targetMarker = { name: 'classic', width: 8, height: 6 }; 
            if (rel.insulation && rel.insulation.startsWith('Jacket')) {
            strokeWidth = 4;
            strokeColor = FLUID_COLORS.Oil; 
            } else if (['ST', 'ET', 'OT'].includes(rel.insulation)) {
            dashArray = '5 5'; 
            }
        }

        if (relType === 'PIPE' && rel.tag) {
            labels.push({
            attrs: { label: { text: rel.tag }, body: { fill: '#fff', stroke: '#333' } },
            position: { distance: 0.5, args: { y: -15 } } 
            });
        }

        let finalSourceId = sourceId;
        let finalTargetId = targetId;
        let finalSourcePort = rel.fromPort;
        let finalTargetPort = rel.toPort;

        if (relType === 'MEASURES') {
            finalSourceId = targetId; 
            finalTargetId = sourceId; 
            finalSourcePort = rel.toPort;   
            finalTargetPort = rel.fromPort; 
        }

        return {
            shape: edgeType === 'Signal' ? 'signal-edge' : 'edge',
            source: { cell: finalSourceId, port: finalSourcePort || undefined },
            target: { cell: finalTargetId, port: finalTargetPort || undefined },
            vertices: vertices, 
            attrs: { 
            line: { 
                stroke: strokeColor,
                strokeWidth: strokeWidth,
                strokeDasharray: dashArray,
                targetMarker: targetMarker
            } 
            },
            labels: labels,
            data: { 
            type: edgeType, 
            relationType: relType, 
            material: rel.material, 
            fluid: rel.fluid,
            dn: rel.dn,
            pn: rel.pn,
            insulation: rel.insulation
            }
        };
    });

    return { nodes, edges };
  } finally {
    await session.close();
  }
};
</file>

<file path="src/graph/cells/registry.ts">
import { Graph } from '@antv/x6';
import frameA2Svg from './svgs/frame-a2.svg?raw';
import reactorSvg from './svgs/reactor.svg?raw';
import exchangerSvg from './svgs/exchanger.svg?raw';
import e13Svg from './svgs/E-13.svg?raw';

import pumpLiquidSvg from './svgs/pump-liquid.svg?raw';
import pumpCentrifugalSvg from './svgs/pump-centrifugal.svg?raw';
import pumpDiaphragmSvg from './svgs/pump-diaphragm.svg?raw';
import pumpPistonSvg from './svgs/pump-piston.svg?raw';
import pumpCompressorSvg from './svgs/pump-compressor.svg?raw';
import pumpGearSvg from './svgs/pump-gear.svg?raw';
import pumpFanSvg from './svgs/pump-fan.svg?raw';
import pumpJetSvg from './svgs/pump-jet.svg?raw';

import cvPneumaticSvg from './svgs/cv-pneumatic.svg?raw';
import cvPositionerSvg from './svgs/cv-positioner.svg?raw';
import cvElectricSvg from './svgs/cv-electric.svg?raw';
import cvSolenoidSvg from './svgs/cv-solenoid.svg?raw';
import cvManualSvg from './svgs/cv-manual.svg?raw';
import cvPistonSvg from './svgs/cv-piston.svg?raw';

import instLocalSvg from './svgs/inst-local.svg?raw';
import instRemoteSvg from './svgs/inst-remote.svg?raw';
import instPanelSvg from './svgs/inst-panel.svg?raw';

import teeSvg from './svgs/tee.svg?raw';
import tankHorizontalSvg from './svgs/tank-horizontal.svg?raw';
import gasCoolerSvg from './svgs/gas-cooler.svg?raw';
import reactorFixedBedSvg from './svgs/reactor-fixed-bed.svg?raw';
import exchangerVerticalSvg from './svgs/exchanger-vertical.svg?raw';
import trapSvg from './svgs/trap.svg?raw';

export type PortDir = 'in' | 'out' | 'bi';
export interface PortData {
  dir?: PortDir;
  [key: string]: any;
}

// ç¡®ä¿ä½¿ç”¨ utf-8 ç¼–ç ï¼Œé˜²æ­¢ä¸­æ–‡ä¹±ç æˆ– SVG è§£æå¤±è´¥
const svgToDataUrl = (svgStr: string) => `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgStr)}`;

const PORT_ATTRS = {
  circle: { r: 3, magnet: true, stroke: '#FFFFFF', strokeWidth: 1, fill: '#e3dedeff' },
};

const LABEL_ATTRS = {
  label: { refY: '100%', refY2: 8, textAnchor: 'middle', textVerticalAnchor: 'top', fontSize: 12, fill: '#333' }
};
// [ä¼˜åŒ–] E-13 ç«¯å£å®šä¹‰ï¼šå¼•å…¥æ°”æ¶²åˆ†ç›¸è¯­ä¹‰
const E13_PORTS = {
  groups: { 
    top: { position: 'absolute', attrs: PORT_ATTRS }, 
    bottom: { position: 'absolute', attrs: PORT_ATTRS }, 
    left: { position: 'absolute', attrs: PORT_ATTRS }, 
    heater: { position: 'absolute', attrs: PORT_ATTRS } 
  },
  items: [
    // ========================================================================
    // 1. å£³ç¨‹-æ°”ç›¸åŒº (ShellSide:Vapor)
    //    ä½äºè®¾å¤‡ä¸ŠåŠéƒ¨åˆ†ï¼Œç”¨äºæ’å‡ºè˜è’¸æ±½ã€è¿æ¥å®‰å…¨é˜€æˆ–æ¶²ä½è®¡ä¸Šæ³•å…°
    // ========================================================================
    
    // é¡¶éƒ¨æ¥å£ (å¿…ç„¶æ˜¯æ°”ç›¸)
    { id: 't1', group: 'top', args: { x: '22%', y: '1.1%' }, data: { desc: 'é¡¶éƒ¨æ¥å£-1', region: 'ShellSide:Vapor', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 't2', group: 'top', args: { x: '34%', y: '1.1%' }, data: { desc: 'é¡¶éƒ¨æ¥å£-2', region: 'ShellSide:Vapor', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 't3', group: 'top', args: { x: '46%', y: '1.1%' }, data: { desc: 'é¡¶éƒ¨æ¥å£-3', region: 'ShellSide:Vapor', phase: 'Gas', dir: 'bi' } as PortData },
    { id: 't4', group: 'top', args: { x: '58%', y: '1.1%' }, data: { desc: 'é¡¶éƒ¨æ¥å£-4', region: 'ShellSide:Vapor', phase: 'Gas', dir: 'bi' } as PortData },

    // å·¦ä¾§ä¸ŠåŠéƒ¨æ¥å£ (æ°”ç›¸ç©ºé—´)
    { id: 'l1', group: 'left', args: { x: '3%', y: '17.7%' }, data: { desc: 'å·¦ä¾§æ¥å£-1(ä¸Š)', region: 'ShellSide:Vapor', phase: 'Gas', dir: 'in' } as PortData }, // y=80
    { id: 'l2', group: 'left', args: { x: '3%', y: '31.1%' }, data: { desc: 'å·¦ä¾§æ¥å£-2(ä¸Š)', region: 'ShellSide:Vapor', phase: 'Gas', dir: 'in' } as PortData }, // y=140
    { id: 'l3', group: 'left', args: { x: '3%', y: '44.4%' }, data: { desc: 'å·¦ä¾§æ¥å£-3(ä¸­ä¸Š)', region: 'ShellSide:Vapor', phase: 'Gas', dir: 'in' } as PortData }, // y=200

    // ========================================================================
    // 2. å£³ç¨‹-æ¶²ç›¸åŒº (ShellSide:Liquid)
    //    ä½äºè®¾å¤‡ä¸‹åŠéƒ¨åˆ†ï¼ŒåŠ çƒ­å™¨æµ¸æ²¡äºæ­¤ï¼Œç”¨äºè¿›æ–™ã€æ’æ±¡æˆ–æ¶²ä½è®¡ä¸‹æ³•å…°
    // ========================================================================

    // åº•éƒ¨æ¥å£ (å¿…ç„¶æ˜¯æ¶²ç›¸)
    { id: 'b1', group: 'bottom', args: { x: '22%', y: '98.9%' }, data: { desc: 'åº•éƒ¨æ¥å£-1', region: 'ShellSide:Liquid', phase: 'Liquid', dir: 'bi' } as PortData },
    { id: 'b2', group: 'bottom', args: { x: '34%', y: '98.9%' }, data: { desc: 'åº•éƒ¨æ¥å£-2', region: 'ShellSide:Liquid', phase: 'Liquid', dir: 'bi' } as PortData },
    { id: 'b3', group: 'bottom', args: { x: '46%', y: '98.9%' }, data: { desc: 'åº•éƒ¨æ¥å£-3', region: 'ShellSide:Liquid', phase: 'Liquid', dir: 'bi' } as PortData },
    { id: 'b4', group: 'bottom', args: { x: '58%', y: '98.9%' }, data: { desc: 'åº•éƒ¨æ¥å£-4', region: 'ShellSide:Liquid', phase: 'Liquid', dir: 'bi' } as PortData },

    // å·¦ä¾§ä¸‹åŠéƒ¨æ¥å£ (æ¶²ç›¸ç©ºé—´)
    { id: 'l4', group: 'left', args: { x: '3%', y: '57.7%' }, data: { desc: 'å·¦ä¾§æ¥å£-4(ä¸­ä¸‹)', region: 'ShellSide:Liquid', phase: 'Liquid', dir: 'in' } as PortData }, // y=260
    { id: 'l5', group: 'left', args: { x: '3%', y: '71.1%' }, data: { desc: 'å·¦ä¾§æ¥å£-5(ä¸‹)', region: 'ShellSide:Liquid', phase: 'Liquid', dir: 'in' } as PortData }, // y=320
    { id: 'l6', group: 'left', args: { x: '3%', y: '84.4%' }, data: { desc: 'å·¦ä¾§æ¥å£-6(ä¸‹)', region: 'ShellSide:Liquid', phase: 'Liquid', dir: 'in' } as PortData }, // y=380

    // ========================================================================
    // 3. ç®¡ç¨‹ (TubeSide)
    //    ç‹¬ç«‹çš„åŠ çƒ­å›è·¯ï¼Œä¸å£³ç¨‹ç‰©ç†éš”ç¦»
    // ========================================================================
    
    { id: 'h_in', group: 'heater', args: { x: '83%', y: '51.1%' }, data: { desc: 'è’¸æ±½å…¥å£', region: 'TubeSide', phase: 'Gas', dir: 'in' } as PortData },
    { id: 'h_out', group: 'heater', args: { x: '83%', y: '93.3%' }, data: { desc: 'å†·å‡æ°´å‡ºå£', region: 'TubeSide', phase: 'Liquid', dir: 'out' } as PortData },
  ],
};
// ... (ç«¯å£å®šä¹‰ä¿æŒä¸å˜ï¼Œæ­¤å¤„çœç•¥ä»¥èŠ‚çœç¯‡å¹…) ...
// å¦‚æœæ‚¨éœ€è¦å®Œæ•´çš„ç«¯å£å®šä¹‰ä»£ç ï¼Œè¯·å‘ŠçŸ¥ï¼Œé€šå¸¸è¿™éƒ¨åˆ†ä¸ä¼šå¯¼è‡´å›¾æ ‡ä¸¢å¤±ã€‚
// å…³é”®æ˜¯ä¸‹é¢çš„ registerCustomCells å‡½æ•°

const COMMON_PUMP_PORTS = {
  groups: { in: { position: 'absolute', attrs: PORT_ATTRS }, out: { position: 'absolute', attrs: PORT_ATTRS } },
  items: [
    { id: 'in', group: 'in', args: { x: '50%', y: '100%' }, attrs: { circle: { title: 'å…¥å£', cursor: 'help' } }, data: { desc: 'æ³µå…¥å£', dir: 'in' } as PortData },
    { id: 'out', group: 'out', args: { x: '50%', y: '0%' }, attrs: { circle: { title: 'å‡ºå£', cursor: 'help' } }, data: { desc: 'æ³µå‡ºå£', dir: 'out' } as PortData },
  ],
};

const VALVE_PORTS = {
  groups: { left: { position: 'absolute', attrs: PORT_ATTRS }, right: { position: 'absolute', attrs: PORT_ATTRS }, actuator: { position: 'absolute', attrs: PORT_ATTRS } },
  items: [
    { id: 'in', group: 'left', args: { x: '0%', y: '83.33%' }, data: { desc: 'é˜€é—¨å…¥å£', dir: 'bi' } as PortData },
    { id: 'out', group: 'right', args: { x: '100%', y: '83.33%' }, data: { desc: 'é˜€é—¨å‡ºå£', dir: 'bi' } as PortData },
    { id: 'actuator', group: 'actuator', args: { x: '50%', y: '0%' }, attrs: { circle: { r: 4, magnet: true, stroke: '#fa8c16', strokeWidth: 1, fill: '#fff' } }, data: { desc: 'æ‰§è¡Œæœºæ„', dir: 'in', type: 'signal' } as PortData },
  ],
};

const TEE_PORTS = {
  groups: { all: { position: 'absolute', attrs: PORT_ATTRS } },
  items: [
    { id: 'p1', group: 'all', args: { x: '0%', y: '50%' }, data: { desc: 'ä¸‰é€šæ¥å£-1', dir: 'bi' } as PortData },
    { id: 'p2', group: 'all', args: { x: '100%', y: '50%' }, data: { desc: 'ä¸‰é€šæ¥å£-2', dir: 'bi' } as PortData },
    { id: 'p3', group: 'all', args: { x: '50%', y: '100%' }, data: { desc: 'ä¸‰é€šæ¥å£-3', dir: 'bi' } as PortData },
  ],
};

const TANK_PORTS = {
  groups: { 
    top: { position: 'absolute', attrs: PORT_ATTRS }, 
    bottom: { position: 'absolute', attrs: PORT_ATTRS }, 
    left: { position: 'absolute', attrs: PORT_ATTRS }, 
    right: { position: 'absolute', attrs: PORT_ATTRS } 
  },
  items: [
    // é¡¶éƒ¨ç«¯å£ N1-N5
    { id: 'n1', group: 'top', args: { x: '20%', y: '0%' }, data: { desc: 'N1' } as PortData },
    { id: 'n2', group: 'top', args: { x: '35%', y: '0%' }, data: { desc: 'N2' } as PortData },
    { id: 'n3', group: 'top', args: { x: '50%', y: '0%' }, data: { desc: 'N3' } as PortData },
    { id: 'n4', group: 'top', args: { x: '65%', y: '0%' }, data: { desc: 'N4' } as PortData },
    { id: 'n5', group: 'top', args: { x: '80%', y: '0%' }, data: { desc: 'N5' } as PortData },
    // åº•éƒ¨ç«¯å£ N6-N10
    { id: 'n6', group: 'bottom', args: { x: '20%', y: '100%' }, data: { desc: 'N6' } as PortData },
    { id: 'n7', group: 'bottom', args: { x: '35%', y: '100%' }, data: { desc: 'N7' } as PortData },
    { id: 'n8', group: 'bottom', args: { x: '50%', y: '100%' }, data: { desc: 'N8' } as PortData },
    { id: 'n9', group: 'bottom', args: { x: '65%', y: '100%' }, data: { desc: 'N9' } as PortData },
    { id: 'n10', group: 'bottom', args: { x: '80%', y: '100%' }, data: { desc: 'N=10' } as PortData },
    // å·¦ä¾§ç«¯å£ N11-N13
    { id: 'n11', group: 'left', args: { x: '0%', y: '25%' }, data: { desc: 'N11' } as PortData },
    { id: 'n12', group: 'left', args: { x: '0%', y: '50%' }, data: { desc: 'N12' } as PortData },
    { id: 'n13', group: 'left', args: { x: '0%', y: '75%' }, data: { desc: 'N13' } as PortData },
    // å³ä¾§ç«¯å£ N14-N16
    { id: 'n14', group: 'right', args: { x: '100%', y: '25%' }, data: { desc: 'N14' } as PortData },
    { id: 'n15', group: 'right', args: { x: '100%', y: '50%' }, data: { desc: 'N15' } as PortData },
    { id: 'n16', group: 'right', args: { x: '100%', y: '75%' }, data: { desc: 'N16' } as PortData },
  ],
};

const GAS_COOLER_PORTS = {
  groups: { 
    main: { position: 'absolute', attrs: PORT_ATTRS }, 
    burst: { position: 'absolute', attrs: PORT_ATTRS }, 
    top_in: { position: 'absolute', attrs: PORT_ATTRS }, 
    top_out: { position: 'absolute', attrs: PORT_ATTRS }, 
    bottom_in: { position: 'absolute', attrs: PORT_ATTRS }, 
    bottom_out: { position: 'absolute', attrs: PORT_ATTRS } 
  },
  items: [
    // å£³ç¨‹
    { id: 'shell_in', group: 'main', args: { x: '0%', y: '58%' }, data: { desc: 'å£³ç¨‹å…¥å£', dir: 'in' } as PortData },
    { id: 'shell_out', group: 'main', args: { x: '100%', y: '58%' }, data: { desc: 'å£³ç¨‹å‡ºå£', dir: 'out' } as PortData },
    // çˆ†ç ´ç‰‡
    { id: 'burst_left', group: 'burst', args: { x: '8.75%', y: '19%' }, data: { desc: 'çˆ†ç ´ç‰‡æ¥å£(å·¦)', dir: 'bi' } as PortData },
    { id: 'burst_right', group: 'burst', args: { x: '91.25%', y: '19%' }, data: { desc: 'çˆ†ç ´ç‰‡æ¥å£(å³)', dir: 'bi' } as PortData },
    // é¡¶éƒ¨ç®¡æŸæ¥å£
    { id: 'tube_top_in_1', group: 'top_in', args: { x: '21.25%', y: '15%' }, data: { desc: 'é«˜æ¸©æ®µ', section: 'HighTemp', dir: 'in' } as PortData },
    { id: 'tube_top_out_1', group: 'top_out', args: { x: '31.25%', y: '15%' }, data: { desc: 'é«˜æ¸©æ®µ', section: 'HighTemp', dir: 'out' } as PortData },
    { id: 'tube_top_out_2', group: 'top_out', args: { x: '41.25%', y: '15%' }, data: { desc: 'ä½æ¸©æ®µ', section: 'LowTemp', dir: 'out' } as PortData },
    { id: 'tube_top_in_2', group: 'top_in', args: { x: '81.25%', y: '15%' }, data: { desc: 'ä½æ¸©æ®µ', section: 'LowTemp', dir: 'in' } as PortData },
    // åº•éƒ¨ç®¡æŸæ¥å£
    { id: 'tube_bot_in_1', group: 'bottom_in', args: { x: '21.25%', y: '92%' }, data: { desc: 'é«˜æ¸©æ®µ', section: 'HighTemp', dir: 'in' } as PortData },
    { id: 'tube_bot_out_1', group: 'bottom_out', args: { x: '31.25%', y: '92%' }, data: { desc: 'é«˜æ¸©æ®µ', section: 'HighTemp', dir: 'out' } as PortData },
    { id: 'tube_bot_out_2', group: 'bottom_out', args: { x: '41.25%', y: '92%' }, data: { desc: 'ä½æ¸©æ®µ', section: 'LowTemp', dir: 'out' } as PortData },
    { id: 'tube_bot_in_2', group: 'bottom_in', args: { x: '81.25%', y: '92%' }, data: { desc: 'ä½æ¸©æ®µ', section: 'LowTemp', dir: 'in' } as PortData },
  ],
};


const INSTRUMENT_PORTS = {
  groups: { all: { position: 'absolute', attrs: PORT_ATTRS } },
  items: [
    { id: 'top', group: 'all', args: { x: '50%', y: '0%' } },
    { id: 'bottom', group: 'all', args: { x: '50%', y: '100%' } },
    { id: 'left', group: 'all', args: { x: '0%', y: '50%' } },
    { id: 'right', group: 'all', args: { x: '100%', y: '50%' } },
  ],
};

const FIXED_BED_REACTOR_PORTS = {
  groups: { gas: { position: 'absolute', attrs: PORT_ATTRS }, upper_salt: { position: 'absolute', attrs: PORT_ATTRS }, lower_salt: { position: 'absolute', attrs: PORT_ATTRS } },
  items: [
    { id: 'gas_in', group: 'gas', args: { x: '50%', y: '0%' }, data: { desc: 'å·¥è‰ºæ°”å…¥å£', region: 'TubeSide', dir: 'in' } as PortData },
    { id: 'gas_out', group: 'gas', args: { x: '50%', y: '100%' }, data: { desc: 'æ°”ä½“å‡ºå£', region: 'TubeSide', dir: 'out' } as PortData },
    { id: 'upper_L1', group: 'upper_salt', args: { x: '7.7%', y: '21.6%' }, data: { desc: 'ä¸Šç›é“æ¥å£-L1', region: 'UpperSaltChannel', dir: 'in' } as PortData },
    { id: 'upper_L2', group: 'upper_salt', args: { x: '7.7%', y: '24.1%' }, data: { desc: 'ä¸Šç›é“æ¥å£-L2', region: 'UpperSaltChannel', dir: 'in' } as PortData },
    { id: 'upper_L3', group: 'upper_salt', args: { x: '7.7%', y: '26.6%' }, data: { desc: 'ä¸Šç›é“æ¥å£-L3', region: 'UpperSaltChannel', dir: 'out' } as PortData },
    { id: 'upper_R1', group: 'upper_salt', args: { x: '92.3%', y: '22.6%' }, data: { desc: 'ä¸Šç›é“æ¥å£-R1', region: 'UpperSaltChannel', dir: 'in' } as PortData },
    { id: 'upper_R2', group: 'upper_salt', args: { x: '92.3%', y: '25.6%' }, data: { desc: 'ä¸Šç›é“æ¥å£-R2', region: 'UpperSaltChannel', dir: 'out' } as PortData },
    { id: 'lower_L1', group: 'lower_salt', args: { x: '7.7%', y: '73.3%' }, data: { desc: 'ä¸‹ç›é“æ¥å£-L1', region: 'LowerSaltChannel', dir: 'in' } as PortData },
    { id: 'lower_L2', group: 'lower_salt', args: { x: '7.7%', y: '75.8%' }, data: { desc: 'ä¸‹ç›é“æ¥å£-L2', region: 'LowerSaltChannel', dir: 'out' } as PortData },
    { id: 'lower_L3', group: 'lower_salt', args: { x: '7.7%', y: '78.3%' }, data: { desc: 'ä¸‹ç›é“æ¥å£-L3', region: 'LowerSaltChannel', dir: 'out' } as PortData },
    { id: 'lower_R1', group: 'lower_salt', args: { x: '92.3%', y: '74.3%' }, data: { desc: 'ä¸‹ç›é“æ¥å£-R1', region: 'LowerSaltChannel', dir: 'in' } as PortData },
    { id: 'lower_R2', group: 'lower_salt', args: { x: '92.3%', y: '77.3%' }, data: { desc: 'ä¸‹ç›é“æ¥å£-R2', region: 'LowerSaltChannel', dir: 'out' } as PortData },
  ],
};

const VERTICAL_EXCHANGER_PORTS = {
  groups: { side: { position: 'absolute', attrs: PORT_ATTRS }, head: { position: 'absolute', attrs: PORT_ATTRS } },
  items: [
    { id: 'side_left_top', group: 'side', args: { x: '0%', y: '20%' }, data: { desc: 'å£³ç¨‹æ¥å£(å·¦ä¸Š)', dir: 'bi' } as PortData },
    { id: 'side_left_bottom', group: 'side', args: { x: '0%', y: '80%' }, data: { desc: 'å£³ç¨‹æ¥å£(å·¦ä¸‹)', dir: 'bi' } as PortData },
    { id: 'side_right_top', group: 'side', args: { x: '100%', y: '15%' }, data: { desc: 'å£³ç¨‹æ¥å£(å³ä¸Š)', dir: 'bi' } as PortData },
    { id: 'side_right_bottom', group: 'side', args: { x: '100%', y: '85%' }, data: { desc: 'å£³ç¨‹æ¥å£(å³ä¸‹)', dir: 'bi' } as PortData },
    { id: 'head_top_left', group: 'head', args: { x: '30%', y: '2.5%' }, data: { desc: 'ç®¡ç¨‹æ¥å£(ä¸Šå·¦)', dir: 'bi' } as PortData },
    { id: 'head_top_right', group: 'head', args: { x: '70%', y: '2.5%' }, data: { desc: 'ç®¡ç¨‹æ¥å£(ä¸Šå³)', dir: 'bi' } as PortData },
    { id: 'head_bottom_left', group: 'head', args: { x: '30%', y: '97.5%' }, data: { desc: 'ç®¡ç¨‹æ¥å£(ä¸‹å·¦)', dir: 'bi' } as PortData },
    { id: 'head_bottom_right', group: 'head', args: { x: '70%', y: '97.5%' }, data: { desc: 'ç®¡ç¨‹æ¥å£(ä¸‹å³)', dir: 'bi' } as PortData },
  ],
};

const TRAP_PORTS = {
  groups: { top_in: { position: 'absolute', attrs: PORT_ATTRS }, top_out: { position: 'absolute', attrs: PORT_ATTRS }, side: { position: 'absolute', attrs: PORT_ATTRS } },
  items: [
    { id: 'n1', group: 'top_in', args: { x: '73.3%', y: '10%' }, data: { desc: 'å…¥å£(N1)', dir: 'in' } as PortData },
    { id: 'n2', group: 'top_out', args: { x: '31.6%', y: '10%' }, data: { desc: 'å‡ºå£(N2)', dir: 'out' } as PortData },
    { id: 'm1', group: 'side', args: { x: '8.3%', y: '56%' }, data: { desc: 'æ’å‡€/äººå­”(M1)', dir: 'bi' } as PortData },
  ],
};

export const registerCustomCells = () => {
  Graph.registerEdge('signal-edge', {
    inherit: 'edge',
    attrs: { line: { stroke: '#888', strokeWidth: 1, strokeDasharray: '4 4', targetMarker: { name: 'classic', size: 3 } } },
    data: { type: 'Signal', fluid: 'Signal' },
  });

  Graph.registerNode('tapping-point', {
    width: 12, height: 12,
    markup: [{ tagName: 'circle', selector: 'hitArea' }, { tagName: 'circle', selector: 'body' }],
    attrs: {
      hitArea: { r: 10, fill: 'transparent', stroke: 'none', magnet: false, cursor: 'move', pointerEvents: 'all' },
      body: { r: 3, fill: '#333', stroke: 'none', pointerEvents: 'none' },
    },
    ports: { items: [] },
    data: { type: 'TappingPoint', desc: 'æµ‹é‡ç‚¹' },
  });

  Graph.registerNode('drawing-frame-a2', {
    inherit: 'image', width: 2245, height: 1587,
    imageUrl: `data:image/svg+xml;charset=utf-8,${encodeURIComponent(frameA2Svg)}`,
    ports: { items: [] }, attrs: { image: { style: { pointerEvents: 'none' } } },
    data: { type: 'Frame', isBackground: true }
  });
  
  Graph.registerNode('p-reactor', {
    inherit: 'image', width: 80, height: 120, imageUrl: svgToDataUrl(reactorSvg),
    ports: {
      groups: { feed: { position: 'absolute', attrs: PORT_ATTRS }, bottom: { position: 'absolute', attrs: PORT_ATTRS }, jacket: { position: 'absolute', attrs: PORT_ATTRS } },
      items: [
        { id: 'in_1', group: 'feed', args: { x: '31.25%', y: '0%' } },
        { id: 'in_2', group: 'feed', args: { x: '68.75%', y: '0%' } },
        { id: 'out_1', group: 'bottom', args: { x: '50%', y: '100%' } }, 
        { id: 'j_in', group: 'jacket', args: { x: '0%', y: '41.6%' } },
        { id: 'j_out', group: 'jacket', args: { x: '100%', y: '66.6%' } },
      ],
    },
    attrs: LABEL_ATTRS, data: { type: 'Reactor', tag: 'R-101', spec: 'STD-2000L', volume: '2.0', material: 'SS304', designPressure: '0.6', designTemp: '150' },
  });

  Graph.registerNode('p-exchanger', {
    inherit: 'image', width: 200, height: 80, imageUrl: svgToDataUrl(exchangerSvg),
    ports: {
      groups: { shell: { position: 'absolute', attrs: PORT_ATTRS }, tube_left: { position: 'absolute', attrs: PORT_ATTRS }, tube_right: { position: 'absolute', attrs: PORT_ATTRS } },
      items: [
        { id: 'n1', group: 'shell', args: { x: '35%', y: '0%' }, attrs: { circle: { title: 'N1 (å…¥å£)', cursor: 'help' } }, data: { desc: 'å£³ç¨‹å…¥å£(N1)', dir: 'in' } as PortData },
        { id: 'n2', group: 'shell', args: { x: '75%', y: '100%' }, attrs: { circle: { title: 'N2 (å‡ºå£)', cursor: 'help' } }, data: { desc: 'å£³ç¨‹å‡ºå£(N2)', dir: 'out' } as PortData },
        { id: 'n4', group: 'tube_left', args: { x: '0%', y: '32.5%' }, attrs: { circle: { title: 'N4 (å‡ºå£)', cursor: 'help' } }, data: { desc: 'ç®¡ç¨‹å‡ºå£(N4)', dir: 'out' } as PortData },
        { id: 'n3', group: 'tube_left', args: { x: '0%', y: '67.5%' }, attrs: { circle: { title: 'N3 (å…¥å£)', cursor: 'help' } }, data: { desc: 'ç®¡ç¨‹å…¥å£(N3)', dir: 'in' } as PortData },
        { id: 'n5', group: 'tube_right', args: { x: '98%', y: '12%' }, data: { desc: 'æ”¾ç©º(N5)', dir: 'out' } as PortData },
        { id: 'n6', group: 'tube_right', args: { x: '98%', y: '88%' }, data: { desc: 'æ’å‡€(N6)', dir: 'out' } as PortData },
      ],
    },
    attrs: LABEL_ATTRS, data: { type: 'Exchanger', tag: 'E-101', spec: 'BES-50', area: '50', material: 'CS/SS304', designPressure: '1.6' },
  });

  Graph.registerNode('p-naphthalene-evaporator', {
    inherit: 'image', 
    width: 200, 
    height: 90, // è°ƒæ•´é«˜åº¦ä»¥åŒ¹é… 1000:450 çš„æ¯”ä¾‹ (200 * 0.45 = 90)
    imageUrl: svgToDataUrl(e13Svg),
    ports: E13_PORTS,
    attrs: LABEL_ATTRS, 
    data: { type: 'Evaporator', spec: 'E-13', tag: 'E-13' },
  });

  const pumps = [
    { key: 'p-pump-liquid', name: 'æ¶²ä½“æ³µ', svg: pumpLiquidSvg, type: 'LiquidPump' },
    { key: 'p-pump-centrifugal', name: 'ç¦»å¿ƒæ³µ', svg: pumpCentrifugalSvg, type: 'CentrifugalPump' },
    { key: 'p-pump-diaphragm', name: 'éš”è†œæ³µ', svg: pumpDiaphragmSvg, type: 'DiaphragmPump' },
    { key: 'p-pump-piston', name: 'æ´»å¡æ³µ', svg: pumpPistonSvg, type: 'PistonPump' },
    { key: 'p-pump-compressor', name: 'å‹ç¼©æœº', svg: pumpCompressorSvg, type: 'Compressor' },
    { key: 'p-pump-gear', name: 'é½¿è½®æ³µ', svg: pumpGearSvg, type: 'GearPump' },
    { key: 'p-pump-fan', name: 'é£æ‰‡', svg: pumpFanSvg, type: 'Fan' },
    { key: 'p-pump-jet', name: 'å–·å°„æ³µ', svg: pumpJetSvg, type: 'JetPump' },
  ];

  pumps.forEach(item => {
    Graph.registerNode(item.key, {
      inherit: 'image', width: 60, height: 60, imageUrl: svgToDataUrl(item.svg),
      ports: COMMON_PUMP_PORTS, attrs: LABEL_ATTRS,
      data: { type: item.type, tag: 'P-101', spec: 'IH50-32-160', flow: '25', head: '30', power: '7.5', material: 'SS304' },
    });
  });

  const valves = [
    { key: 'p-cv-pneumatic', name: 'æ°”åŠ¨è°ƒèŠ‚é˜€', svg: cvPneumaticSvg, type: 'ControlValve' },
    { key: 'p-cv-positioner', name: 'å¸¦å®šä½å™¨é˜€', svg: cvPositionerSvg, type: 'ControlValve' },
    { key: 'p-cv-electric', name: 'ç”µåŠ¨è°ƒèŠ‚é˜€', svg: cvElectricSvg, type: 'ControlValve' },
    { key: 'p-cv-solenoid', name: 'å¸¦ç”µç£é˜€', svg: cvSolenoidSvg, type: 'ControlValve' },
    { key: 'p-cv-manual', name: 'æ‰‹åŠ¨è°ƒèŠ‚é˜€', svg: cvManualSvg, type: 'ControlValve' },
    { key: 'p-cv-piston', name: 'æ°”ç¼¸è°ƒèŠ‚é˜€', svg: cvPistonSvg, type: 'ControlValve' },
  ];

  valves.forEach(v => {
    Graph.registerNode(v.key, {
      inherit: 'image', width: 40, height: 60, imageUrl: svgToDataUrl(v.svg),
      ports: VALVE_PORTS, attrs: LABEL_ATTRS,
      data: { type: v.type || 'ControlValve', tag: 'FV-101', size: 'DN50', valveClass: 'PN16', failPosition: 'FC' },
    });
  });

  const instruments = [
    { key: 'p-inst-local', name: 'å°±åœ°ä»ªè¡¨', svg: instLocalSvg, type: 'Instrument' },
    { key: 'p-inst-remote', name: 'è¿œä¼ ä»ªè¡¨', svg: instRemoteSvg, type: 'Instrument' },
    { key: 'p-inst-panel', name: 'å°±åœ°ç›˜ä»ªè¡¨', svg: instPanelSvg, type: 'Instrument' },
  ];

  instruments.forEach(inst => {
    Graph.registerNode(inst.key, {
      width: 40, height: 40,
      markup: [{ tagName: 'image', selector: 'body' }, { tagName: 'text', selector: 'topLabel' }, { tagName: 'text', selector: 'bottomLabel' }],
      attrs: {
        body: { refWidth: '100%', refHeight: '100%', xlinkHref: svgToDataUrl(inst.svg) },
        topLabel: { refX: 0.5, refY: 0.35, textAnchor: 'middle', textVerticalAnchor: 'middle', fontSize: 9, fontWeight: 'bold', fill: '#000', text: 'PI' },
        bottomLabel: { refX: 0.5, refY: 0.65, textAnchor: 'middle', textVerticalAnchor: 'middle', fontSize: 9, fontWeight: 'bold', fill: '#000', text: '101' },
      },
      ports: INSTRUMENT_PORTS, data: { type: inst.type, tagId: 'PI', loopNum: '101', range: '0-1.6', unit: 'MPa' },
    });
  });

  Graph.registerNode('p-tee', {
    inherit: 'image', 
    width: 20, 
    height: 20, 
    imageUrl: svgToDataUrl(teeSvg),
    ports: TEE_PORTS,
    attrs: { 
      label: { 
        display: 'none', 
        text: '' 
      } 
    },
    data: { type: 'Fitting', spec: 'Tee', tag: 'TEE' },
  });

  Graph.registerNode('p-tank-horizontal', {
    inherit: 'image', width: 160, height: 80, imageUrl: svgToDataUrl(tankHorizontalSvg),
    ports: TANK_PORTS, attrs: { label: { text: 'V-100', refY: '100%', refY2: 10 } },
    data: { type: 'Tank', spec: 'Horizontal', volume: '5.0' },
  });

  Graph.registerNode('p-gas-cooler', {
    inherit: 'image', width: 200, height: 130, imageUrl: svgToDataUrl(gasCoolerSvg),
    ports: GAS_COOLER_PORTS, attrs: { label: { text: 'E-201', refY: '100%', refY2: 10 } },
    data: { type: 'GasCooler', spec: 'AirCooled', area: '200' },
  });

  Graph.registerNode('p-fixed-bed-reactor', {
    inherit: 'image', width: 130, height: 150, imageUrl: svgToDataUrl(reactorFixedBedSvg),
    ports: FIXED_BED_REACTOR_PORTS, attrs: { label: { text: 'D-14', refY: '100%', refY2: 10 } },
    data: { type: 'FixedBedReactor', spec: '20000 Tubes', catalyst: 'V2O5' },
  });

  Graph.registerNode('p-exchanger-vertical', {
    inherit: 'image', width: 60, height: 200, imageUrl: svgToDataUrl(exchangerVerticalSvg),
    ports: VERTICAL_EXCHANGER_PORTS, attrs: { label: { text: 'E-102', refY: '100%', refY2: 10 } },
    data: { type: 'VerticalExchanger', spec: 'Vertical', area: '100' },
  });

  Graph.registerNode('p-trap', {
    inherit: 'image', width: 120, height: 100, imageUrl: svgToDataUrl(trapSvg),
    ports: TRAP_PORTS,
    attrs: { label: { text: 'V-102', refY: '100%', refY2: 10, textAnchor: 'middle', textVerticalAnchor: 'top', fontSize: 12, fill: '#333' } },
    data: { type: 'Trap', spec: 'Gravity', material: 'SS304', volume: '500L' },
  });
};
</file>

</files>
